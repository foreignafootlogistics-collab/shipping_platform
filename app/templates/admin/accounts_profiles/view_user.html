{% extends 'layout_admin.html' %}

{% set current_tab = active_tab or 'packages' %}

{# ---- Money formatting macro (place right here) ---- #}
{% macro money(x) -%}{{ '%.2f'|format((x or 0)|float) }}{%- endmacro %}

{% block title %}View User{% endblock %}

{% block content %}
<div class="container mt-4">  
  <!-- PROFILE CARD -->
  <div class="card shadow-sm mb-4 w-100">

    <!-- TOP GREY BAR -->
    <div class="d-flex justify-content-between align-items-center p-2"
         style="background-color:#6c757d; border-bottom:1px solid black; position:relative">

      <!-- Left: Back to Manage Users -->
      <div>
        <a href="{{ url_for('accounts_profiles.manage_users') }}"
           class="text-white text-decoration-none fw-bold">
          <i class="bi bi-arrow-left"></i> Manage Users
        </a>
      </div>

      <!-- Middle: Centered Address Icons + Sensitive Info -->
      <div class="d-flex align-items-center position-absolute" style="left: 33%; gap: 1rem;">
        <!-- Icons grouped -->
        <div class="d-flex align-items-center" style="gap: 0.5rem;">
          <i class="bi bi-globe fs-5 text-white cursor-pointer"
             onclick="showAddress('overseas')" title="Overseas Address"></i>
          <i class="bi bi-house-door fs-5 text-white cursor-pointer"
             onclick="showAddress('home')" title="Home Address"></i>
        </div>

        <!-- Sensitive Info button (link to page) -->
        <button type="button" class="btn btn-outline-light btn-sm"
                data-bs-toggle="modal" data-bs-target="#sensitiveInfoModal">
          <i class="bi bi-shield-lock me-1"></i> Sensitive Info
        </button>


      </div>

      <!-- Right: Account Actions -->
      <div class="d-flex gap-2">
        <!-- Change Password -->
        <a href="{{ url_for('accounts_profiles.change_password', id=user.id) }}"
           class="btn btn-outline-light btn-sm"
           title="Change Password">
          <i class="bi bi-key"></i>
        </a>

        <!-- Delete Account -->
        <form action="{{ url_for('accounts_profiles.delete_account', id=user.id) }}"
              method="POST" class="m-0">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit"
                  class="btn btn-outline-light btn-sm"
                  onclick="return confirm('Are you sure you want to delete this account?');">
            <i class="bi bi-trash"></i>
          </button>
        </form>

        <!-- Manage Account (open modal) -->
        <button type="button"
                class="btn btn-outline-light btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#manageAccountModal">
          <i class="bi bi-pencil-square"></i>
        </button>

      </div>
    </div>

    <!-- CARD BODY (3 SECTIONS) -->
    <div class="card-body d-flex p-3" style="position:relative; z-index:2;">
      <!-- Vertical dividers -->
      <div class="position-absolute top-0 bottom-0" style="left:33.33%; border-left:1px solid black;"></div>
      <div class="position-absolute top-0 bottom-0" style="left:66.66%; border-left:1px solid black;"></div>
      <div class="position-absolute" style="left:0; right:0; bottom:0; border-top:1px solid black;"></div>

      <!-- LEFT COLUMN -->
      <div class="d-flex flex-column align-items-start pe-4" style="flex:1;">
        <!-- Profile Image / Initials -->
        <div class="d-flex align-items-center mb-3">
          {% if user.profile_picture %}
            <img src="{{ url_for('static', filename='profile_pics/' ~ user.profile_picture) }}"
                 alt="Profile" width="80" height="80"
                 class="rounded-circle me-3">
          {% else %}
            <div class="rounded-circle d-flex justify-content-center align-items-center me-3"
                 style="width:80px; height:80px; background-color:#4a148c; color:white;
                        font-family:'Poppins',sans-serif; font-size:28px; font-weight:700;">
              {{ user.full_name.split()[0][0] }}{{ user.full_name.split()[-1][0] }}
            </div>
          {% endif %}

          <h3 class="mb-0"
              style="color:#4a148c; font-family:'Poppins',sans-serif; font-weight:700; font-size:1.6rem;">
            {{ user.full_name }}
            {% if user.registration_number %}
              <span style="font-weight:500; font-size:1.2rem; color:#555;">
                ({{ user.registration_number }})
              </span>
            {% endif %}
          </h3>
        </div>

        <!-- Details -->
        <div class="mb-1"><strong>Email:</strong> {{ user.email }}</div>
        <div class="mb-1"><strong>Mobile:</strong> {{ user.mobile }}</div>
        <div class="mb-1"><strong>Referral Code:</strong> {{ user.referral_code }}</div>
        <div class="mb-1"><strong>Referrer:</strong> {{ user.referrer or 'None' }}</div>
      </div>

      <!-- MIDDLE COLUMN (ADDRESSES) -->
      <div class="d-flex flex-column px-4" style="flex:1;">
        <!-- Overseas Address -->
        <div id="overseas-address">
          <div class="label fw-bold text-dark mt-2">Street</div>
          <div class="value">{{ us_address.address_line1 }}</div>
          <div class="label fw-bold text-dark mt-2">Suite</div>
          <div class="value">{{ us_address.address_line2 }}</div>
          <div class="label fw-bold text-dark mt-2">City/State/ZIP</div>
          <div class="value">{{ us_address.city }}, {{ us_address.state }} {{ us_address.zip }}</div>
        </div>

        <!-- Home Address -->
        <div id="home-address" style="display:none;">
          <div class="label fw-bold text-dark mb-2">Home Address</div>
          <div class="value mb-3">{{ home_address if home_address else "Not set" }}</div>
          <a href="{{ url_for('customer.update_delivery_address') }}"
             class="btn btn-outline-dark btn-sm">Update Address</a>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="d-flex flex-column ps-4" style="flex:1;">
        <div class="mb-1"><strong>Authorized Person:</strong> {{ user.authorized_person or 'None' }}</div>
        <div class="mb-1"><strong>Branch:</strong> Main</div>
        <div class="mb-1"><strong>Status:</strong> {{ 'Active' if user.is_active else 'Inactive' }}</div>
        <div class="mb-1"><strong>Last Login:</strong> {{ user.last_login or 'Never' }}</div>

        <!-- Wallet Icon at the bottom -->
        <div class="position-absolute" style="bottom:1rem; right:1rem;">
          <button
            type="button"
            class="btn btn-purple btn-lg"
            style="font-size:1.5rem; background-color:#6c757d; border:none; color:white; padding:0.75rem 1.25rem;"
            data-bs-toggle="modal"
            data-bs-target="#editWalletModal"
          >
            <i class="bi bi-wallet2 me-2"></i>
            ${{ money(user.wallet_balance) }}
          </button>
        </div>
      </div>
    </div>

    <!-- ATTACHED TABS -->
    <div class="card-header bg-white p-0">
      <ul class="nav nav-tabs card-header-tabs px-3" id="profileTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'prealerts' %}active{% endif %}"
                  id="prealerts-tab" data-bs-toggle="tab"
                  data-bs-target="#prealerts" type="button" role="tab">
            <i class="bi bi-box-seam me-1"></i> Pre-Alert Shipments
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'packages' %}active{% endif %}"
                  id="packages-tab" data-bs-toggle="tab"
                  data-bs-target="#packages" type="button" role="tab">
            <i class="bi bi-box2 me-1"></i> Packages
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'payments' %}active{% endif %}"
                  id="payments-tab" data-bs-toggle="tab"
                  data-bs-target="#payments" type="button" role="tab">
            <i class="bi bi-credit-card"></i> Payments
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'invoices' %}active{% endif %}"
                  id="invoices-tab" data-bs-toggle="tab"
                  data-bs-target="#invoices" type="button" role="tab">
            <i class="bi bi-receipt"></i> Invoices
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'messages' %}active{% endif %}"
                  id="messages-tab" data-bs-toggle="tab"
                  data-bs-target="#messages" type="button" role="tab">
            <i class="bi bi-envelope me-1"></i> Messages
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'schedule' %}active{% endif %}"
                  id="schedule-delivery-tab" data-bs-toggle="tab"
                  data-bs-target="#schedule-delivery" type="button" role="tab">
            <i class="bi bi-truck"></i> Schedule Delivery
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'referrals' %}active{% endif %}"
                  id="referrals-tab" data-bs-toggle="tab"
                  data-bs-target="#referrals" type="button" role="tab">
            <i class="bi bi-people me-1"></i> Referrals
          </button>
        </li>
      </ul>

    </div>

    <!-- Tab Content -->
    <div class="tab-content p-3" id="profileTabContent">
      <!-- Packages Tab (server-side pagination; no DataTables init here) -->
      <div class="tab-pane fade {% if current_tab == 'packages' %}show active{% endif %}"
           id="packages" role="tabpanel" aria-labelledby="packages-tab">

        <!-- Header row + right actions -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-bold" style="color:#4a148c;">
            <i class="bi bi-box2 me-1"></i> Packages
          </div>

          <!-- Right-side actions -->
          <div class="d-flex align-items-center gap-2">
            <!-- Add Package (adjust route if you want) -->
            <a class="btn btn-sm btn-outline-purple"
               href="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}"
               title="Add Package">
              <i class="bi bi-plus-square"></i>
            </a>

            <!-- Add Pricing -->
            <button type="button"
                    class="btn btn-sm btn-outline-purple"
                    id="bulkPricingBtn"
                    title="Add Pricing">
              <i class="bi bi-cash-coin"></i>
            </button>

            <!-- Filter -->
            <button type="button"
                    class="btn btn-sm btn-outline-purple"
                    data-bs-toggle="modal"
                    data-bs-target="#packageFilterModal"
                    title="Filter Packages">
              <i class="bi bi-funnel"></i>
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table id="packagesTable" class="table table-striped table-bordered">

            <thead class="table-dark">
              <tr>
                <th class="text-center" style="width:38px;">
                  <input type="checkbox" id="pkgSelectAll">
                </th>
                <th>House AWB & Status</th>
                <th>Description</th>
                <th>Tracking Number</th>
                <th class="text-end">Weight (lbs)</th>
                <th>Date Received</th>
                <th class="text-end">Declared Value</th>
                <th class="text-end">Amount Due</th>
              </tr>
            </thead>
            <tbody>
              {% for pkg in packages %}
              <tr>
                {% set st = (pkg.status or '')|lower %}
                {% set bar_class =
                    'status-overseas' if 'overseas' in st
                    else 'status-ready' if ('ready' in st or 'pickup' in st or 'pick up' in st)
                    else 'status-delivered' if ('delivered' in st or st == 'delivery' or 'out for delivery' in st)
                    else 'status-unknown'
                %}
                <td class="text-center align-middle">
                  <input type="checkbox"
                         class="pkg-check"
                         value="{{ pkg.id }}"
                         data-weight="{{ pkg.weight or 0 }}"
                         data-value="{{ (pkg.declared_value if pkg.declared_value is defined and pkg.declared_value is not none else (pkg.value or 0)) }}"
                  >
                </td>

                <td class="pkg-cell">
                  <div class="pkg-status-bar {{ bar_class }}"></div>

                  <div>
                    <strong>{{ pkg.house_awb or '-' }}</strong><br>
                    <span class="badge pkg-status-badge {{ bar_class }}">
                      {{ pkg.status or 'Unknown' }}
                    </span>

                  </div>
                </td>

                <td>{{ pkg.description or '-' }}</td>
                <td>{{ pkg.tracking_number or '-' }}</td>
                <td class="text-end">{{ pkg.weight }}</td>
                <td>{{ pkg.date_received or 'N/A' }}</td>
                <td class="text-end">${{ money(pkg.declared_value) }}</td>
                <td class="text-end">${{ money(pkg.amount_due) }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="8" class="text-center text-muted py-4">No packages found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination footer (INSIDE Packages tab) -->
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">
            Showing {{ pkg_show_from }}â€“{{ pkg_show_to }} of {{ total_pkgs }}
          </small>

          <ul class="pagination pagination-sm mb-0">
            <!-- First -->
            <li class="page-item {% if pkg_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                href="{{ url_for('accounts_profiles.view_user',
                                 id=user_id, tab='packages', pkg_page=1,
                                 pkg_from=pkg_from, pkg_to=pkg_to, pkg_awb=pkg_awb, pkg_tn=pkg_tn) }}">
                &laquo;&laquo;
              </a>
            </li>

            <!-- Prev -->
            <li class="page-item {% if pkg_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                href="{{ url_for('accounts_profiles.view_user',
                                 id=user_id, tab='packages',
                                 pkg_page=(pkg_page-1 if pkg_page>1 else 1),
                                 pkg_from=pkg_from, pkg_to=pkg_to, pkg_awb=pkg_awb, pkg_tn=pkg_tn) }}">
                &laquo;
              </a>
            </li>

            <!-- Next -->
            <li class="page-item {% if pkg_page == pkg_total_pages %}disabled{% endif %}">
              <a class="page-link"
                href="{{ url_for('accounts_profiles.view_user',
                                 id=user_id, tab='packages',
                                 pkg_page=(pkg_page+1 if pkg_page < pkg_total_pages else pkg_total_pages),
                                 pkg_from=pkg_from, pkg_to=pkg_to, pkg_awb=pkg_awb, pkg_tn=pkg_tn) }}">
                &raquo;
              </a>
            </li>

            <!-- Last -->
            <li class="page-item {% if pkg_page == pkg_total_pages %}disabled{% endif %}">
              <a class="page-link"
                href="{{ url_for('accounts_profiles.view_user',
                                 id=user_id, tab='packages', pkg_page=pkg_total_pages,
                                 pkg_from=pkg_from, pkg_to=pkg_to, pkg_awb=pkg_awb, pkg_tn=pkg_tn) }}"
>
                &raquo;&raquo;
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Prealerts Tab -->
      <div class="tab-pane fade {% if current_tab == 'prealerts' %}show active{% endif %}"
           id="prealerts" role="tabpanel" aria-labelledby="prealerts-tab">
        <div class="table-responsive">
          <table id="prealertsTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Pre-Alert #</th>
                <th>Vendor</th>
                <th>Courier</th>
                <th>Tracking #</th>
                <th>Purchase Date</th>
                <th>Contents</th>
                <th>Value (USD)</th>
                <th>Invoice</th>
                <th>Submitted On</th>
              </tr>
            </thead>
            <tbody>
              {% for p in prealerts %}
              <tr>
                <td>
                  {% if p.prealert_number %}
                    PA-{{ "%05d"|format(p.prealert_number) }}
                  {% else %}
                    {{ p.id }}
                  {% endif %}
                </td>

                <td>{{ p.vendor_name }}</td>
                <td>{{ p.courier_name }}</td>
                <td>{{ p.tracking_number }}</td>
                <td>{{ p.purchase_date }}</td>
                <td>{{ p.package_contents }}</td>
                <td>${{ money(p.item_value_usd) }}</td>
                <td>
                  {% if p.invoice_filename %}
                    <a href="{{ url_for('static', filename='uploads/invoices/' ~ p.invoice_filename) }}" target="_blank">View</a>
                  {% else %}N/A{% endif %}
                </td>
                <td>{{ p.created_at }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Invoices Tab -->
      <div class="tab-pane fade {% if current_tab == 'invoices' %}show active{% endif %}"
           id="invoices" role="tabpanel" aria-labelledby="invoices-tab">

        <div class="mb-3">
          <strong>Total Owed:</strong>  ${{ money(total_owed) }} |
          <strong>Total Paid:</strong>  ${{ money(total_paid) }} |
          <strong>Balance:</strong>     ${{ money(balance) }}

          <a href="{{ url_for('admin.generate_pdf_invoice', user_id=user.id) }}" class="btn btn-sm btn-outline-secondary float-end">Export PDF</a>
        </div>
        <div class="table-responsive">
          <table id="invoiceTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Description</th>
                <th class="text-end">Amount Due</th>
                <th class="text-end">Amount Paid</th>
                <th class="text-end">Amount Owed</th>                
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for inv in invoices %}
              {% set inv_status = (inv.status or 'unpaid')|lower %}
              {# ---- Amount Due (robust fallback) ---- #}
              {% set due =
                  (inv.grand_total if inv.grand_total is defined and inv.grand_total is not none
                   else (inv.amount_due if inv.amount_due is defined and inv.amount_due is not none
                         else (inv.amount_display if inv.amount_display is defined and inv.amount_display is not none
                               else 0)))
              %}

              {# ---- Amount Paid (robust fallback) ---- #}
              {% set paid =
                  (inv.amount_paid if inv.amount_paid is defined and inv.amount_paid is not none
                   else (inv.total_paid if inv.total_paid is defined and inv.total_paid is not none
                         else (inv.paid_total if inv.paid_total is defined and inv.paid_total is not none
                               else 0)))
              %}

              {% set owed = (due|float - paid|float) %}
              {% if owed < 0 %}{% set owed = 0 %}{% endif %}
              <tr data-invoice-id="{{ inv.id }}">
                <td>
                  <button type="button"
                          class="btn btn-sm btn-outline-purple"
                          onclick="openInvoiceModal({{ inv.id }})"
                          title="Open invoice">
                    {{ inv.invoice_number or ('INV' ~ '%05d'|format(inv.id)) }}
                    <i class="bi bi-box-arrow-up-right ms-1"></i>
                  </button>
                </td>

                <!-- Description (fallback if not present) -->
                <td>
                  {% if inv.description is defined and inv.description %}
                    {{ inv.description }}
                  {% else %}
                    No description
                  {% endif %}
                </td>

                <td class="text-end">${{ money(due) }}</td>
                <td class="text-end">${{ money(paid) }}</td>
                
                <td class="text-end">
                  <span class="fw-bold {% if owed > 0 %}text-danger{% else %}text-success{% endif %}">
                    ${{ money(owed) }}
                  </span>
                </td>

                <td>
                  <span class="badge {% if inv_status == 'paid' or owed == 0 %}bg-success{% else %}bg-danger{% endif %}">
                    {{ 'Paid' if (inv_status == 'paid' or owed == 0) else 'Unpaid' }}
                  </span>
                </td>

                <td class="text-nowrap">
                  <button type="button"
                          class="btn btn-sm btn-outline-purple"
                          onclick="loadInvoiceInline({{ inv.id }})"
                          title="View inline">
                    <i class="bi bi-file-earmark-text"></i>
                  </button>

                  {% if owed > 0 %}
                    <button class="btn btn-sm btn-success mark-paid-btn"
                            data-invoice-id="{{ inv.id }}"
                            data-amount-owed="{{ money(owed) }}">
                      Add Payment
                    </button>
                  {% endif %}
                </td>
              </tr>              
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div id="invoiceInlineHost" class="mt-3"></div>
      </div>

      <!-- Payments Tab -->
      <div class="tab-pane fade {% if current_tab == 'payments' %}show active{% endif %}"
           id="payments" role="tabpanel" aria-labelledby="payments-tab">

        <h5 class="mt-3">Payments</h5>
        <div class="table-responsive">
          <table id="paymentsTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Bill #</th>
                <th>Date of Payment</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Authorized By</th>
                <th>Invoice</th>
              </tr>
            </thead>
            <tbody>
              {% for payment in payments %}
              <tr>
                <td>{{ payment.bill_number }}</td>
                <td>{{ payment.payment_date }}</td>
                <td>{{ payment.payment_type }}</td>
                <td>${{ money(payment.amount) }}</td>
                <td>{{ payment.authorized_by }}</td>
                <td>
                  {% if payment.invoice_number %}
                    <a href="{{ url_for('admin.view_invoice', invoice_id=payment.invoice_id) }}"
                       title="View Invoice {{ payment.invoice_number }}">
                      {{ payment.invoice_number }}
                    </a>
                  {% else %}
                    â€”
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Messages Tab -->
      <div class="tab-pane fade {% if current_tab == 'messages' %}show active{% endif %}"
           id="messages" role="tabpanel" aria-labelledby="messages-tab">
        <div class="table-responsive">
          <table id="messagesTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Subject</th>
                <th>Message</th>
                <th>Date Sent</th>
              </tr>
            </thead>
            <tbody>
              {% for msg in messages %}
              <tr>
                <td>{{ msg.subject }}</td>
                <td>{{ msg.body }}</td>
                <td>{{ msg.created_at }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Schedule Delivery Tab -->
      <div class="tab-pane fade {% if current_tab == 'schedule' %}show active{% endif %}"
           id="schedule-delivery" role="tabpanel" aria-labelledby="schedule-delivery-tab">

        <div class="mb-3">
          <button class="btn btn-primary mb-3" id="adminAddDeliveryBtn">+ Add Delivery</button>
        </div>
        <div class="table-responsive">
          <table id="scheduledeliveryTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Location</th>
                <th>Person Receiving</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for delivery in deliveries %}
              <tr>
                <td>{{ delivery.date }}</td>
                <td>{{ delivery.time }}</td>
                <td>{{ delivery.location }}</td>
                <td>{{ delivery.person_receiving }}</td>
                <td>{{ delivery.status }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Referrals Tab -->
      <div class="tab-pane fade {% if current_tab == 'referrals' %}show active{% endif %}"
           id="referrals" role="tabpanel" aria-labelledby="referrals-tab">
        <p>Referrals details go here.</p>
      </div>
    </div>
  </div>

  <!-- Manage Account Modal -->
  <div class="modal fade" id="manageAccountModal" tabindex="-1" aria-labelledby="manageAccountLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">

        <div class="modal-header" style="background-color:#4a148c; color:white;">
          <h5 class="modal-title" id="manageAccountLabel">Manage Account: {{ user.full_name }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form action="{{ url_for('accounts_profiles.manage_account', id=user.id) }}" method="POST">
          <!-- ðŸ” CSRF -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="modal-body">

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Full Name</label>
                <input type="text" name="full_name" class="form-control" value="{{ user.full_name }}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" value="{{ user.email }}" required>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Mobile</label>
                <input type="text" name="mobile" class="form-control" value="{{ user.mobile }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Address</label>
                <input type="text" name="address" class="form-control" value="{{ user.address }}">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Referral Code</label>
                <input type="text" name="referral_code" class="form-control" value="{{ user.referral_code }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Authorized Person</label>
                <input type="text" name="authorized_person" class="form-control" value="{{ user.authorized_person }}">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Branch</label>
                <input type="text" name="branch" class="form-control" value="Main" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Status</label>
                <select name="is_active" class="form-select">
                  <option value="1" {% if user.is_active %}selected{% endif %}>Active</option>
                  <option value="0" {% if not user.is_active %}selected{% endif %}>Inactive</option>
                </select>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Packages Filter Modal -->
  <div class="modal fade" id="packageFilterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header" style="background-color:#4a148c; color:white;">
          <h5 class="modal-title">
            <i class="bi bi-funnel me-1"></i> Filter Packages
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <form method="GET" action="{{ url_for('accounts_profiles.view_user', id=user_id) }}">
          <input type="hidden" name="tab" value="packages">
          <input type="hidden" name="pkg_page" value="1">

          <div class="modal-body">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">From Date</label>
                <input type="date" name="pkg_from" class="form-control" value="{{ pkg_from or '' }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">To Date</label>
                <input type="date" name="pkg_to" class="form-control" value="{{ pkg_to or '' }}">
              </div>
            </div>

            <div class="mt-2">
              <label class="form-label">House AWB</label>
              <input type="text" name="pkg_awb" class="form-control" value="{{ pkg_awb or '' }}"
                     placeholder="e.g. HAWB123...">
            </div>

            <div class="mt-2">
              <label class="form-label">Tracking Number</label>
              <input type="text" name="pkg_tn" class="form-control" value="{{ pkg_tn or '' }}"
                     placeholder="e.g. 1Z... / TBA...">
            </div>
          </div>

          <div class="modal-footer">
            <a class="btn btn-outline-secondary"
               href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='packages', pkg_page=1) }}">
              Clear
            </a>
            <button type="submit" class="btn" style="background-color:#4a148c; color:white;">
              Apply Filters
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
     
  <!-- ðŸ“„ Universal Invoice Preview Modal -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="invoiceModalLabel">
            <i class="bi bi-receipt"></i> Invoice
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body" id="invoiceModalBody">
          <p class="text-muted mb-0">Loading invoiceâ€¦</p>
        </div>
      </div>
    </div>
  </div>
 
  <!-- Sensitive Info Modal -->
  <div class="modal fade" id="sensitiveInfoModal" tabindex="-1" aria-labelledby="sensitiveInfoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header" style="background-color:#4a148c; color:white;">
          <h5 class="modal-title" id="sensitiveInfoLabel">
            <i class="bi bi-shield-lock me-1"></i> Sensitive Information
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            This information is sensitive. Handle and share securely.
          </div>

          <p><strong>Full Name:</strong> {{ user.full_name }}</p>
          <p><strong>TRN:</strong> {{ user.trn or 'Not stored' }}</p>
          <p><strong>Home Address:</strong> {{ user.address or 'Not set' }}</p>
          <p><strong>Mobile:</strong> {{ user.mobile }}</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn" style="background-color:#4a148c; color:white;" data-bs-dismiss="modal">
            Close
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Admin Schedule Delivery Modal -->
  <div class="modal fade" id="adminDeliveryModal" tabindex="-1" aria-labelledby="adminDeliveryLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="adminDeliveryForm">
          <div class="modal-header">
            <h5 class="modal-title" id="adminDeliveryLabel">Schedule Delivery</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="modalUserId" name="user_id">
            <div class="row g-2">
              <div class="col-md-4"><label>Date</label><input type="date" class="form-control" id="modalDeliveryDate" required></div>
              <div class="col-md-4"><label>Time</label><input type="time" class="form-control" id="modalDeliveryTime" required></div>
              <div class="col-md-4"><label>Location</label><input type="text" class="form-control" id="modalDeliveryLocation" required></div>
            </div>
            <div class="row mt-2 g-2">
              <div class="col-md-6"><label>Person Receiving</label><input type="text" class="form-control" id="modalPersonReceiving"></div>
              <div class="col-md-6"><label>Mobile #</label><input type="text" class="form-control" id="modalDeliveryMobile"></div>
            </div>
            <div class="mt-2">
              <label>Directions</label>
              <textarea class="form-control" id="modalDeliveryDirections"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Schedule Delivery</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Wallet Modal -->
  <div class="modal fade" id="editWalletModal" tabindex="-1" aria-labelledby="editWalletLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editWalletForm"
              method="POST"
              action="{{ url_for('accounts_profiles.update_wallet', id=user.id) }}">
          <!-- ðŸ” CSRF -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="modal-header" style="background-color:#4a148c; color:white;">
            <h5 class="modal-title" id="editWalletLabel">
              <i class="bi bi-wallet2 me-1"></i> Edit Wallet Balance
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="amount" class="form-label">Amount (JMD)</label>
              <input type="number" step="0.01" name="amount" id="amount" class="form-control" required>
              <div class="form-text">Use a negative value to subtract from the wallet.</div>
            </div>
            <div class="mb-3">
              <label for="description" class="form-label">Description (optional)</label>
              <input type="text" name="description" id="description" class="form-control"
                     placeholder="e.g. Adjustment for overcharge, manual top-up, promo, etc.">
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn" style="background-color:#4a148c; color:white;">
              Update Wallet
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
      
  <!-- Mark Paid Modal -->
  <div class="modal fade" id="markPaidModal" tabindex="-1" aria-labelledby="markPaidLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="markPaidForm" method="POST">
          <div class="modal-header">
            <h5 class="modal-title" id="markPaidLabel">Mark Invoice as Paid</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="invoice_id" id="modalInvoiceId">
            <div class="mb-3">
              <label for="payment_amount" class="form-label">Amount</label>
              <input type="number" step="0.01" name="payment_amount" id="payment_amount" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="payment_type" class="form-label">Payment Type</label>
              <select name="payment_type" id="payment_type" class="form-select" required>
                <option value="cash">Cash</option>
                <option value="card">Card</option>
                <option value="bank_transfer">Bank Transfer</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="authorized_by" class="form-label">Authorized By</label>
              <input type="text" name="authorized_by" id="authorized_by" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Confirm Payment</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bulk Pricing Modal -->
  <div class="modal fade" id="bulkPricingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header" style="background-color:#4a148c; color:white;">
          <h5 class="modal-title">
            <i class="bi bi-cash-coin me-1"></i> Bulk Pricing for Selected Packages
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <div class="alert alert-light border">
            <strong>Selected:</strong> <span id="bulkPricingCount">0</span> package(s)
          </div>

          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Category</label>
              <select id="bulkPricingCategory" class="form-select">
                {% for cat in categories %}
                  <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Override Value (USD) (optional)</label>
              <input type="number" step="0.01" id="bulkOverrideValueUsd" class="form-control" placeholder="Leave blank to use each package value">
            </div>

            <div class="col-md-4">
              <label class="form-label">Override Weight (lbs) (optional)</label>
              <input type="number" step="0.01" id="bulkOverrideWeight" class="form-control" placeholder="Leave blank to use each package weight">
            </div>
          </div>

          <hr class="my-3">

          <div class="alert alert-light border mb-0">
            <div class="d-flex justify-content-between">
              <strong>Total Grand Total (JMD)</strong>
              <strong id="bulkGrandTotal">â€”</strong>
            </div>
            <small class="text-muted">Calculate previews totals for all selected packages.</small>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="bulkCalcBtn">
            Calculate
          </button>
          <button type="button" class="btn btn-success" id="bulkApplyBtn" disabled>
            Apply Pricing
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Quick Add Delivery Modal -->
  <div class="modal fade" id="adminAddDeliveryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="adminAddDeliveryForm" method="POST">
          <div class="modal-header">
            <h5 class="modal-title">Add Delivery</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2"><input type="date" name="date" class="form-control" required></div>
            <div class="mb-2"><input type="time" name="time" class="form-control" required></div>
            <div class="mb-2"><input type="text" name="location" placeholder="Location" class="form-control" required></div>
            <div class="mb-2"><input type="text" name="person_receiving" placeholder="Person Receiving" class="form-control" required></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Save Delivery</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block styles %}
<style>
/* ================================
   Tabs: White background, black text
   Purple hover & active
   ================================ */

.card-header .nav-tabs {
  border-bottom: 1px solid #dee2e6;
  margin-bottom: 0;
  padding-left: 1rem;
  padding-right: 1rem;
}

/* Base tab */
.card-header .nav-tabs .nav-link {
  font-family: 'Poppins', sans-serif;
  background-color: #ffffff !important;
  color: #000000 !important;
  border: 1px solid #dee2e6 !important;
  border-bottom: none !important;
  border-radius: 0.25rem 0.25rem 0 0;
  margin-right: 4px;
  font-weight: 500;
  transition: all 0.2s ease-in-out;
}

/* Hover */
.card-header .nav-tabs .nav-link:hover {
  background-color: #f5f0fa !important;
  color: #4a148c !important;
  border-color: #4a148c #4a148c #dee2e6 !important;
}

/* Active */
.card-header .nav-tabs .nav-link.active,
.card-header .nav-tabs .nav-item.show .nav-link {
  background-color: #ffffff !important;
  color: #4a148c !important;
  font-weight: 600;
  border-color: #4a148c #4a148c #ffffff !important;
}

/* Icons inherit text color */
.card-header .nav-tabs .nav-link i {
  color: inherit;
}

/* ---------- Buttons ---------- */
.btn-outline-purple {
  border: 1px solid #4a148c !important;
  color: #4a148c !important;
  background: transparent !important;
}
.btn-outline-purple:hover {
  background: #4a148c !important;
  color: #fff !important;
}

/* ---------- Packages status bar + badge ---------- */
td.pkg-cell{
  position: relative;
  padding-left: 14px !important; /* room for bar */
}
td.pkg-cell .pkg-status-bar{
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 6px;
  border-radius: 2px;
}

/* Bar colors (keep these) */
td.pkg-cell .pkg-status-bar.status-overseas  { background-color: #dc3545 !important; }
td.pkg-cell .pkg-status-bar.status-ready     { background-color: #ffc107 !important; }
td.pkg-cell .pkg-status-bar.status-delivered { background-color: #198754 !important; }
td.pkg-cell .pkg-status-bar.status-unknown   { background-color: #adb5bd !important; }

/* Badge base */
td.pkg-cell span.badge.pkg-status-badge{
  display: inline-block !important;
  padding: .2rem .5rem !important;
  border-radius: .35rem !important;
  font-size: .75rem !important;
  font-weight: 700 !important;
  background-color: #6c757d !important;  /* fallback */
  color: #fff !important;
}

/* Badge colors (THIS is the real fix â€” forces background even if overridden elsewhere) */
td.pkg-cell span.badge.pkg-status-badge.status-overseas{
  background-color: #dc3545 !important;
  color: #fff !important;
}
td.pkg-cell span.badge.pkg-status-badge.status-ready{
  background-color: #ffc107 !important;
  color: #212529 !important;
}
td.pkg-cell span.badge.pkg-status-badge.status-delivered{
  background-color: #198754 !important;
  color: #fff !important;
}
td.pkg-cell span.badge.pkg-status-badge.status-unknown{
  background-color: #adb5bd !important;
  color: #212529 !important;
}
</style>
{% endblock %}

{% block scripts %}
<script>
/* Expose this globally for inline onclick icons */
function showAddress(type) {
  document.getElementById("overseas-address").style.display = (type === 'overseas') ? 'block' : 'none';
  document.getElementById("home-address").style.display = (type === 'home') ? 'block' : 'none';
}

$(document).ready(function () {
  /* IMPORTANT: Do NOT initialize DataTables for #packagesTable because we use server-side pagination */
  // $('#packagesTable').DataTable();  // <-- removed

  // Other tabs can use DataTables
  $('#prealertsTable').DataTable({ order: [[0, 'desc']], pageLength: 10 });
  $('#invoiceTable').DataTable({
    order: [[0, 'desc']],
    pageLength: 10,
    language: {
      emptyTable: "No invoices yet."
    }
  });
  $('#paymentsTable').DataTable();
  $('#messagesTable').DataTable();
  $('#scheduledeliveryTable').DataTable();

  // Quick add delivery launcher
  document.getElementById("adminAddDeliveryBtn").onclick = () => {
    new bootstrap.Modal(document.getElementById('adminAddDeliveryModal')).show();
  };

  // Full admin delivery modal launcher
  document.querySelectorAll('.open-admin-delivery-modal').forEach(btn => {
    btn.addEventListener('click', function() {
      const userId = this.getAttribute('data-user-id');
      document.getElementById('modalUserId').value = userId;
      document.getElementById('adminDeliveryForm').reset();
      new bootstrap.Modal(document.getElementById('adminDeliveryModal')).show();
    });
  });

  // Submit full admin delivery form (big modal)
  document.getElementById('adminDeliveryForm').addEventListener('submit', function(e){
    e.preventDefault();
    const payload = {
      user_id: document.getElementById('modalUserId').value,
      date: document.getElementById('modalDeliveryDate').value,
      time: document.getElementById('modalDeliveryTime').value,
      location: document.getElementById('modalDeliveryLocation').value,
      person_receiving: document.getElementById('modalPersonReceiving').value,
      mobile: document.getElementById('modalDeliveryMobile').value,
      directions: document.getElementById('modalDeliveryDirections').value
    };
    fetch("{{ url_for('logistics.add_scheduled_delivery') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === "success"){
        alert('Delivery scheduled successfully!');
        bootstrap.Modal.getInstance(document.getElementById('adminDeliveryModal')).hide();
      } else {
        alert(data.message || 'Error scheduling delivery.');
      }
    });
  });

  // Submit quick add delivery form (small modal)
  document.getElementById("adminAddDeliveryForm").onsubmit = function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{{ url_for('logistics.add_scheduled_delivery', user_id=user.id) }}", {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === "success"){
        const tbody = document.querySelector("#scheduledeliveryTable tbody");
        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${data.delivery.date}</td>
            <td>${data.delivery.time}</td>
            <td>${data.delivery.location}</td>
            <td>${data.delivery.person_receiving}</td>
            <td>${data.delivery.status}</td>
          </tr>
        `);
        bootstrap.Modal.getInstance(document.getElementById('adminAddDeliveryModal')).hide();
      }
    });
  };

  // Mark as Paid Modal
  $('.mark-paid-btn').click(function () {
    const invoiceId = $(this).data('invoice-id');
    $('#modalInvoiceId').val(invoiceId);

    const owed = $(this).data('amount-owed');
    $('#payment_amount').val(owed || 0);

    new bootstrap.Modal(document.getElementById('markPaidModal')).show();
  });


  $('#markPaidForm').submit(function (e) {
    e.preventDefault();
    const formData = $(this).serialize();
    fetch("/admin/invoice/mark_paid", {
      method: 'POST',
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/x-www-form-urlencoded"
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const row = $(`tr[data-invoice-id="${data.invoice_id}"]`);
        row.find('span.badge').removeClass('bg-danger').addClass('bg-success').text('paid');
        row.find('.mark-paid-btn').remove();

        $('#paymentsTable').DataTable().row.add([
          data.bill_number,
          data.payment_date,
          data.payment_type,
          `$${parseFloat(data.amount).toFixed(2)}`,
          data.authorized_by,
          data.invoice_path ? `<a href="${data.invoice_path}" target="_blank"><i class="fas fa-file-invoice fa-lg"></i></a>` : 'â€”'
        ]).draw();

        bootstrap.Modal.getInstance(document.getElementById('markPaidModal')).hide();
      } else {
        alert(data.error || 'Error marking invoice as paid.');
      }
    });
  });
});

(function(){
  const modalEl = document.getElementById('bulkPricingModal');
  const modal = modalEl ? new bootstrap.Modal(modalEl) : null;

  const btnOpen  = document.getElementById('bulkPricingBtn');
  const btnCalc  = document.getElementById('bulkCalcBtn');
  const btnApply = document.getElementById('bulkApplyBtn');

  const selectAll = document.getElementById('pkgSelectAll');

  let lastResults = null; // enriched results for APPLY

  function getSelectedChecks(){
    return Array.from(document.querySelectorAll('.pkg-check:checked'));
  }

  function nf(v){
    const n = parseFloat(v || 0) || 0;
    return n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function updateCount(){
    const count = getSelectedChecks().length;
    const el = document.getElementById('bulkPricingCount');
    if (el) el.textContent = String(count);
    return count;
  }

  function resetCalc(){
    lastResults = null;
    const gt = document.getElementById('bulkGrandTotal');
    if (gt) gt.textContent = 'â€”';
    if (btnApply) btnApply.disabled = true;
  }

  // Select all
  if (selectAll){
    selectAll.addEventListener('change', function(){
      const on = !!this.checked;
      document.querySelectorAll('.pkg-check').forEach(cb => cb.checked = on);
      updateCount();
      resetCalc();
    });
  }

  // Per-row checkbox changes
  document.querySelectorAll('.pkg-check').forEach(cb => {
    cb.addEventListener('change', () => {
      updateCount();
      resetCalc();
      if (selectAll && !cb.checked) selectAll.checked = false;
    });
  });

  // Open modal
  if (btnOpen){
    btnOpen.addEventListener('click', function(e){
      e.preventDefault(); // IMPORTANT since you used <a>
      const count = updateCount();
      if (!count){
        alert('Select at least one package first.');
        return;
      }
      resetCalc();
      modal.show();
    });
  }

  // CALCULATE
  if (btnCalc){
    btnCalc.addEventListener('click', function(){
      const selected = getSelectedChecks();
      if (!selected.length){
        alert('Select at least one package.');
        return;
      }

      const category = document.getElementById('bulkPricingCategory').value;
      const overrideValue  = document.getElementById('bulkOverrideValueUsd').value;
      const overrideWeight = document.getElementById('bulkOverrideWeight').value;

      // map pkg_id => base fields so APPLY always has invoice/weight/category
      const rowById = {};

      const rows = selected.map(cb => {
        const pkgId = parseInt(cb.value, 10);

        const w = (overrideWeight !== '' && overrideWeight != null)
          ? overrideWeight
          : cb.getAttribute('data-weight');

        const v = (overrideValue !== '' && overrideValue != null)
          ? overrideValue
          : cb.getAttribute('data-value');

        rowById[pkgId] = {
          invoice: parseFloat(v || 0) || 0,
          weight:  parseFloat(w || 0) || 0,
          category
        };

        return { pkg_id: pkgId, invoice: v, weight: w, category };
      });

      fetch("{{ url_for('logistics.bulk_calc_outstanding') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify({ rows })
      })
      .then(r => r.json())
      .then(data => {
        const results = data.results || [];
        if (!results.length) throw new Error('No results returned.');

        // âœ… ENRICH results with invoice/weight/category from rowById
        lastResults = results.map(r => {
          const base = rowById[r.pkg_id] || { invoice: 0, weight: 0, category };
          return {
            ...r,
            invoice: base.invoice,
            weight: base.weight,
            category: base.category
          };
        });

        const total = lastResults.reduce((sum, r) => sum + (parseFloat(r.grand_total || 0) || 0), 0);
        document.getElementById('bulkGrandTotal').textContent = 'JMD ' + nf(total);

        btnApply.disabled = false;
      })
      .catch(err => {
        alert(err.message || 'Unable to calculate.');
        resetCalc();
      });
    });
  }

  // APPLY
  if (btnApply){
    btnApply.addEventListener('click', async function(){
      if (!lastResults || !lastResults.length){
        alert('Please calculate first.');
        return;
      }

      btnApply.disabled = true;

      try {
        for (const r of lastResults){
          const pkgId = r.pkg_id;
          const b = r.breakdown || {};

          const payload = {
            category: r.category,

            // âœ… now guaranteed
            value:  parseFloat(r.invoice || 0) || 0,
            weight: parseFloat(r.weight  || 0) || 0,

            amount_due: parseFloat(r.grand_total || 0) || 0,

            duty:  parseFloat(b.duty  || 0) || 0,
            scf:   parseFloat(b.scf   || 0) || 0,
            envl:  parseFloat(b.envl  || 0) || 0,
            caf:   parseFloat(b.caf   || 0) || 0,
            gct:   parseFloat(b.gct   || 0) || 0,
            stamp: parseFloat(b.stamp || 0) || 0,

            freight:       parseFloat(b.freight       || 0) || 0,
            handling:      parseFloat(b.handling      || 0) || 0,
            freight_total: parseFloat(b.freight_total || 0) || 0,
            other_charges: parseFloat(b.other_charges || 0) || 0,

            grand_total:   parseFloat(b.grand_total   || r.grand_total || 0) || 0,
            customs_total: parseFloat(b.customs_total || 0) || 0
          };

          const url = "{{ url_for('logistics.api_update_package', pkg_id=0) }}".replace('0', String(pkgId));

          const res = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest"
            },
            body: JSON.stringify(payload)
          });

          const json = await res.json();
          if (!json.ok){
            throw new Error(json.error || `Failed saving pkg ${pkgId}`);
          }
        }

        modal.hide();
        window.location.reload();

      } catch (e){
        alert(e.message || 'Failed applying bulk pricing.');
        btnApply.disabled = false;
      }
    });
  }
})();

/* ================================
   Inline invoice behaviour (POS)
   ================================ */
function initInlineInvoice(rootElement) {
  // rootElement = container where the invoice snippet lives
  const root = rootElement || document;

  const payOverlay      = root.querySelector('#inlinePayOverlay');
  const discountOverlay = root.querySelector('#inlineDiscountOverlay');
  const bdOverlay       = root.querySelector('#inlineBreakdownOverlay');

  const showOverlay = (el) => { if (el) el.classList.remove('d-none'); };
  const hideOverlay = (el) => { if (el) el.classList.add('d-none'); };

  // Always start closed
  [payOverlay, discountOverlay, bdOverlay].forEach(el => el && el.classList.add('d-none'));

  /* ---------- open / close buttons ---------- */

  // Add Payment
  root.querySelectorAll('.js-open-pay').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      if (!payOverlay) return;
      showOverlay(payOverlay);
      setupPaymentLogic();
    });
  });

  // Discount
  root.querySelectorAll('.js-open-discount').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      if (!discountOverlay) return;
      showOverlay(discountOverlay);
      setupDiscountLogic();
    });
  });

  // Close X buttons on overlays
  root.querySelectorAll('.fa-inline-close').forEach(btn => {
    btn.addEventListener('click', function () {
      const type = this.getAttribute('data-close');
      if (type === 'pay')      hideOverlay(payOverlay);
      if (type === 'discount') hideOverlay(discountOverlay);
      if (type === 'bd')       hideOverlay(bdOverlay);
    });
  });

  /* ---------- PAYMENT keypad logic ---------- */
  function setupPaymentLogic() {
    if (!payOverlay) return;

    const display = payOverlay.querySelector('#payDisplayInline');
    const hidden  = payOverlay.querySelector('#payAmountInputInline');
    if (!display || !hidden) return;

    let current = hidden.value && hidden.value !== '0' ? String(hidden.value) : '0';

    function updateDisplay() {
      let num = parseFloat(current || '0');
      if (isNaN(num)) num = 0;
      hidden.value = num.toFixed(2);
      display.textContent =
        'JMD ' + num.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
    }

    function pushKey(key) {
      if (key === '.') {
        if (current.includes('.')) return;
        current += '.';
      } else if (key === '00') {
        if (current === '0') return;
        current += '00';
      } else {
        if (current === '0') current = key;
        else current += key;
      }
      updateDisplay();
    }

    // keypad buttons
    payOverlay.querySelectorAll('.payment-key-btn').forEach(btn => {
      btn.onclick = function () {
        pushKey(this.getAttribute('data-key'));
      };
    });

    // quick amounts
    payOverlay.querySelectorAll('.payment-quick-btn[data-quick]').forEach(btn => {
      btn.onclick = function () {
        current = String(this.getAttribute('data-quick') || '0');
        updateDisplay();
      };
    });

    // clear
    const clearBtn = payOverlay.querySelector('#payClearBtnInline');
    if (clearBtn) {
      clearBtn.onclick = function () {
        current = '0';
        updateDisplay();
      };
    }

    // payment method
    const methodInput = payOverlay.querySelector('#payMethodInputInline');
    const methodList  = payOverlay.querySelector('#paymentMethodListInline');
    if (methodInput && methodList) {
      methodList.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.onclick = function () {
          methodList.querySelectorAll('.payment-method-btn')
                    .forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          methodInput.value = this.getAttribute('data-method') || 'Cash';
        };
      });
    }

    // ---------- NEW: "Authorised by" dropdown + other ----------
    const authSelect = payOverlay.querySelector('#authBySelectInline');
    const authInput  = payOverlay.querySelector('#authByInputInline');
    const authHidden = payOverlay.querySelector('#authByHiddenInline');

    if (authSelect && authHidden) {
      // initialise from current select value
      if (authSelect.value !== '__other__') {
        authHidden.value = authSelect.value;
      }

      authSelect.addEventListener('change', function () {
        if (this.value === '__other__') {
          if (authInput) {
            authInput.classList.remove('d-none');
            authInput.value = '';
            authInput.focus();
          }
          authHidden.value = '';
        } else {
          if (authInput) {
            authInput.classList.add('d-none');
          }
          authHidden.value = this.value;
        }
      });

      if (authInput) {
        authInput.addEventListener('input', function () {
          if (authSelect.value === '__other__') {
            authHidden.value = this.value;
          }
        });
      }
    }
    updateDisplay();
  }

  /* ---------- DISCOUNT tabs logic ---------- */
  function setupDiscountLogic() {
    if (!discountOverlay) return;

    const form     = discountOverlay.querySelector('#inlineDiscountForm');
    if (!form) return;

    const balance  = parseFloat(form.getAttribute('data-balance') || '0') || 0;
    const tabs     = discountOverlay.querySelector('#discountTabsInline');
    const panePct  = discountOverlay.querySelector('#discountPercentPaneInline');
    const paneAmt  = discountOverlay.querySelector('#discountAmountPaneInline');
    const pctInput = discountOverlay.querySelector('#discountPercentInputInline');
    const pctLbl   = discountOverlay.querySelector('#discountPercentAmountInline');
    const amtInput = discountOverlay.querySelector('#discountAmountInputInline');
    const hidden   = discountOverlay.querySelector('#discountHiddenAmountInline');

    let mode = tabs?.querySelector('.discount-tab.active')?.getAttribute('data-mode') || 'percent';

    function formatJMD(v) {
      const n = parseFloat(v || '0') || 0;
      return 'JMD ' + n.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function recalc() {
      if (!hidden) return;
      if (mode === 'percent') {
        const pct  = parseFloat(pctInput?.value || '0') || 0;
        const disc = Math.max(0, balance * pct / 100);
        hidden.value = disc.toFixed(2);
        if (pctLbl) pctLbl.textContent = formatJMD(disc);
      } else {
        const v = parseFloat(amtInput?.value || '0') || 0;
        hidden.value = v.toFixed(2);
      }
    }

    if (tabs) {
      tabs.querySelectorAll('.discount-tab').forEach(btn => {
        btn.onclick = function () {
          tabs.querySelectorAll('.discount-tab').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          mode = this.getAttribute('data-mode') || 'percent';
          if (panePct && paneAmt) {
            if (mode === 'percent') {
              panePct.classList.remove('d-none');
              paneAmt.classList.add('d-none');
            } else {
              panePct.classList.add('d-none');
              paneAmt.classList.remove('d-none');
            }
          }
          recalc();
        };
      });
    }

    if (pctInput) pctInput.oninput = recalc;
    if (amtInput) amtInput.oninput = recalc;

    recalc();
  }

  /* ---------- Lightning (charges breakdown) ---------- */
  if (bdOverlay) {
    const ids = [
      'bd-duty-inline','bd-gct-inline','bd-freight-inline','bd-handling-inline',
      'bd-scf-inline','bd-envl-inline','bd-caf-inline','bd-stamp-inline',
      'bd-other-inline','bd-total-inline'
    ];
    const setField = (id, val) => {
      const el = bdOverlay.querySelector('#' + id);
      if (el) el.textContent = val;
    };

    root.querySelectorAll('.js-bd').forEach(btn => {
      btn.addEventListener('click', function () {
        const pkgId = this.getAttribute('data-pkg');
        if (!pkgId) return;

        ids.forEach(id => setField(id, 'â€¦'));

        fetch("{{ url_for('admin.invoice_breakdown', package_id=0) }}".replace('0', pkgId))
          .then(r => { if (!r.ok) throw new Error(); return r.json(); })
          .then(d => {
            const nf = new Intl.NumberFormat();
            setField('bd-duty-inline',     nf.format(d.duty || 0));
            setField('bd-gct-inline',      nf.format(d.gct || 0));
            setField('bd-freight-inline',  nf.format(d.freight || 0));
            setField('bd-handling-inline', nf.format(d.handling || 0));
            setField('bd-scf-inline',      nf.format(d.scf || 0));
            setField('bd-envl-inline',     nf.format(d.envl || 0));
            setField('bd-caf-inline',      nf.format(d.caf || 0));
            setField('bd-stamp-inline',    nf.format(d.stamp || 0));
            setField('bd-other-inline',    nf.format(d.other || 0));
            setField('bd-total-inline',    nf.format(d.total_jmd || 0));
          })
          .catch(() => ids.forEach(id => setField(id, 'â€”')));

        showOverlay(bdOverlay);
      });
    });
  }
}

function loadInvoiceInline(invoiceId){
  const url = "{{ url_for('admin.view_invoice', invoice_id=0) }}?inline=1"
                .replace('0', String(invoiceId));

  fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
    .then(r => { if(!r.ok) throw new Error('Failed to load invoice'); return r.text(); })
    .then(html => {
      const host = document.getElementById('invoiceInlineHost');
      host.innerHTML = html;
      host.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // ðŸ”Œ wire up Add Payment / Discount / Breakdown
      initInlineInvoice(host);
    })
    .catch(() => alert('âš ï¸ Unable to load invoice inline.'));
}


// Load invoice into modal
function openInvoiceModal(invoiceId) {
  const modalEl  = document.getElementById("invoiceModal");
  const modal    = new bootstrap.Modal(modalEl);
  const bodyEl   = document.getElementById("invoiceModalBody");

  bodyEl.innerHTML = "<p class='text-muted mb-0'>Loading invoiceâ€¦</p>";

  // Use Flask url_for so the path is always correct
  const base = "{{ url_for('admin.view_invoice', invoice_id=0) }}?inline=1";
  const url  = base.replace('0', String(invoiceId));

  fetch(url, {
      headers: { "X-Requested-With": "XMLHttpRequest" }
  })
  .then(r => {
      if (!r.ok) throw new Error("Failed");
      return r.text();
  })
    .then(html => {
      bodyEl.innerHTML = html;

      // ðŸ”Œ wire invoice controls inside the modal
      initInlineInvoice(modalEl);

      modal.show();
  })

}

</script>
{% endblock %}
