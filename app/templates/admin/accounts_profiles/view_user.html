{% extends 'layout_admin.html' %}

{% set current_tab = active_tab or 'packages' %}

{# ---- Money formatting macro (place right here) ---- #}
{% macro money(x) -%}{{ '%.2f'|format((x or 0)|float) }}{%- endmacro %}

{% block title %}View User{% endblock %}

{% block content %}
<div class="container mt-4">  
  <!-- PROFILE CARD -->
  <div class="card shadow-sm mb-4 w-100">

    <!-- TOP GREY BAR -->
    <div class="d-flex justify-content-between align-items-center p-2"
         style="background-color:#6c757d; border-bottom:1px solid black; position:relative">

      <!-- Left: Back to Manage Users -->
      <div>
        <a href="{{ request.args.get('next') or url_for('accounts_profiles.manage_users') }}"
           class="text-white text-decoration-none fw-bold">
          <i class="bi bi-arrow-left"></i> Manage Users
        </a>
      </div>

      <!-- Middle: Centered Address Icons + Sensitive Info -->
      <div class="d-flex align-items-center position-absolute" style="left: 33%; gap: 1rem;">
        <!-- Icons grouped -->
        <div class="d-flex align-items-center" style="gap: 0.5rem;">
          <i class="bi bi-globe fs-5 text-white cursor-pointer"
             onclick="showAddress('overseas')" title="Overseas Address"></i>
          <i class="bi bi-house-door fs-5 text-white cursor-pointer"
             onclick="showAddress('home')" title="Home Address"></i>
        </div>

        <!-- Sensitive Info button (link to page) -->
        <button type="button" class="btn btn-outline-light btn-sm"
                data-bs-toggle="modal" data-bs-target="#sensitiveInfoModal">
          <i class="bi bi-shield-lock me-1"></i> Sensitive Info
        </button>


      </div>

      <!-- Right: Account Actions -->
      <div class="d-flex gap-2">
        <!-- Change Password -->
        <a href="{{ url_for('accounts_profiles.change_password', id=user.id) }}"
           class="btn btn-outline-light btn-sm"
           title="Change Password">
          <i class="bi bi-key"></i>
        </a>

        <!-- Delete Account -->
        <form action="{{ url_for('accounts_profiles.delete_account', id=user.id, next=request.full_path) }}"
              method="POST" class="m-0">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="next" value="{{ next }}">
          <button type="submit"
                  class="btn btn-outline-light btn-sm"
                  onclick="return confirm('Are you sure you want to delete this account?');">
            <i class="bi bi-trash"></i>
          </button>
        </form>

        <!-- Manage Account (open modal) -->
        <button type="button"
                class="btn btn-outline-light btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#manageAccountModal">
          <i class="bi bi-pencil-square"></i>
        </button>

      </div>
    </div>

    <!-- CARD BODY (3 SECTIONS) -->
    <div class="card-body d-flex p-3" style="position:relative; z-index:2;">
      <!-- Vertical dividers -->
      <div class="position-absolute top-0 bottom-0" style="left:33.33%; border-left:1px solid black;"></div>
      <div class="position-absolute top-0 bottom-0" style="left:66.66%; border-left:1px solid black;"></div>
      <div class="position-absolute" style="left:0; right:0; bottom:0; border-top:1px solid black;"></div>

      <!-- LEFT COLUMN -->
      <div class="d-flex flex-column align-items-start pe-4" style="flex:1;">
        <!-- Profile Image / Initials -->
        <div class="d-flex align-items-center mb-3">
          {% if user.profile_picture %}
            <img src="{{ url_for('static', filename='profile_pics/' ~ user.profile_picture) }}"
                 alt="Profile" width="80" height="80"
                 class="rounded-circle me-3">
          {% else %}
            <div class="rounded-circle d-flex justify-content-center align-items-center me-3"
                 style="width:80px; height:80px; background-color:#4a148c; color:white;
                        font-family:'Poppins',sans-serif; font-size:28px; font-weight:700;">
              {{ user.full_name.split()[0][0] }}{{ user.full_name.split()[-1][0] }}
            </div>
          {% endif %}

          <h3 class="mb-0"
              style="color:#4a148c; font-family:'Poppins',sans-serif; font-weight:700; font-size:1.6rem;">
            {{ user.full_name }}
            {% if user.registration_number %}
              <span style="font-weight:500; font-size:1.2rem; color:#555;">
                ({{ user.registration_number }})
              </span>
            {% endif %}
          </h3>
        </div>

        <!-- Details -->
        <div class="mb-1"><strong>Email:</strong> {{ user.email }}</div>
        <div class="mb-1"><strong>Mobile:</strong> {{ user.mobile }}</div>
        <div class="mb-1"><strong>Referral Code:</strong> {{ user.referral_code }}</div>
        <div class="mb-1"><strong>Referrer:</strong> {{ user.referrer or 'None' }}</div>
      </div>

      <!-- MIDDLE COLUMN (ADDRESSES) -->
      <div class="d-flex flex-column px-4" style="flex:1;">
        <!-- Overseas Address -->
        <div id="overseas-address">
          <div class="label fw-bold text-dark mt-2">Street</div>
          <div class="value">{{ us_address.address_line1 }}</div>
          <div class="label fw-bold text-dark mt-2">Suite</div>
          <div class="value">{{ us_address.address_line2 }}</div>
          <div class="label fw-bold text-dark mt-2">City/State/ZIP</div>
          <div class="value">{{ us_address.city }}, {{ us_address.state }} {{ us_address.zip }}</div>
        </div>

        <!-- Home Address -->
        <div id="home-address" style="display:none;">
          <div class="label fw-bold text-dark mb-2">Home Address</div>
          <div class="value mb-3">{{ home_address if home_address else "Not set" }}</div>
          <a href="{{ url_for('customer.update_delivery_address') }}"
             class="btn btn-outline-dark btn-sm">Update Address</a>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="d-flex flex-column ps-4" style="flex:1;">
        <div class="mb-1"><strong>Authorized Person:</strong> {{ user.authorized_person or 'None' }}</div>
        <div class="mb-1"><strong>Branch:</strong> Main</div>
        <div class="mb-1">
          <strong>Status:</strong>
          <span class="badge {{ user.activity_badge }}">{{ user.activity_status }}</span>
        </div>

        <div class="mb-1">
          <strong>Last Login:</strong> {{ user.last_login_display }}
        </div>


        <!-- Wallet Icon at the bottom -->
        <div class="position-absolute" style="bottom:1rem; right:1rem;">
          <button
            type="button"
            class="btn btn-purple btn-lg"
            style="font-size:1.5rem; background-color:#6c757d; border:none; color:white; padding:0.75rem 1.25rem;"
            data-bs-toggle="modal"
            data-bs-target="#editWalletModal"
          >
            <i class="bi bi-wallet2 me-2"></i>
            ${{ money(user.wallet_balance) }}
          </button>
        </div>
      </div>
    </div>

    <!-- ATTACHED TABS -->
    <div class="card-header bg-white p-0">
      <ul class="nav nav-tabs card-header-tabs px-3" id="profileTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'prealerts' %}active{% endif %}"
                  id="prealerts-tab" data-bs-toggle="tab"
                  data-bs-target="#prealerts" type="button" role="tab">
            <i class="bi bi-box-seam me-1"></i> Pre-Alert Shipments
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'packages' %}active{% endif %}"
                  id="packages-tab" data-bs-toggle="tab"
                  data-bs-target="#packages" type="button" role="tab">
            <i class="bi bi-box2 me-1"></i> Packages
          </button>
        </li>

        

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'invoices' %}active{% endif %}"
                  id="invoices-tab" data-bs-toggle="tab"
                  data-bs-target="#invoices" type="button" role="tab">
            <i class="bi bi-receipt"></i> Invoices
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'payments' %}active{% endif %}"
                  id="payments-tab" data-bs-toggle="tab"
                  data-bs-target="#payments" type="button" role="tab">
            <i class="bi bi-credit-card"></i> Payments
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'messages' %}active{% endif %}"
                  id="messages-tab" data-bs-toggle="tab"
                  data-bs-target="#messages" type="button" role="tab">
            <i class="bi bi-envelope me-1"></i> Messages
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'schedule' %}active{% endif %}"
                  id="schedule-delivery-tab" data-bs-toggle="tab"
                  data-bs-target="#schedule-delivery" type="button" role="tab">
            <i class="bi bi-truck"></i> Schedule Delivery
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link {% if current_tab == 'referrals' %}active{% endif %}"
                  id="referrals-tab" data-bs-toggle="tab"
                  data-bs-target="#referrals" type="button" role="tab">
            <i class="bi bi-people me-1"></i> Referrals
          </button>
        </li>
      </ul>

    </div>

    <!-- Tab Content -->
    <div class="tab-content p-3" id="profileTabContent">
      <!-- Packages Tab (server-side pagination; no DataTables init here) -->
      <div class="tab-pane fade {% if current_tab == 'packages' %}show active{% endif %}"
           id="packages" role="tabpanel" aria-labelledby="packages-tab">

        <!-- Header row + right actions -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex align-items-center gap-2">
            <label class="small text-muted mb-0">Rows</label>

            <select id="pkgPerPageSelect" class="form-select form-select-sm" style="width:auto;"
                    onchange="location.href='{{ url_for('accounts_profiles.view_user', id=user_id, tab='packages', pkg_page=1, pkg_from=pkg_from, pkg_to=pkg_to, pkg_awb=pkg_awb, pkg_tn=pkg_tn) }}&pkg_per_page=' + this.value;">

              {% set current_pp = pkg_per_page|default(10) %}
              {% for n in [10,25,50,100,500,1000] %}
                <option value="{{ n }}" {% if current_pp|int == n %}selected{% endif %}>{{ n }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Right-side actions -->
          <div class="d-flex align-items-center gap-2">
            <!-- Add Package (adjust route if you want) -->
            <button type="button"
                    class="btn btn-sm btn-outline-purple"
                    data-bs-toggle="modal"
                    data-bs-target="#addSinglePackageModal"
                    title="Add Package">
              <i class="bi bi-plus-square"></i>
            </button>


            <!-- Bulk Delete -->
            <button type="button"
                    class="btn btn-sm btn-outline-purple"
                    id="bulkDeleteBtn"
                    disabled
                    title="Delete selected packages">
              <i class="bi bi-trash"></i>
            </button>

            <!-- Filter -->
            <button type="button"
                    class="btn btn-sm btn-outline-purple"
                    data-bs-toggle="modal"
                    data-bs-target="#packageFilterModal"
                    title="Filter Packages">
              <i class="bi bi-funnel"></i>
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table id="packagesTable" class="table table-striped table-bordered">

            <thead class="table-dark">
              <tr>
                <th class="text-center" style="width:38px;">
                  <input type="checkbox" id="pkgSelectAll">
                </th>
                <th>House AWB & Status</th>
                <th>Description</th>
                <th>Tracking Number</th>
                <th class="text-start">Weight (lbs)</th>
                <th>Date Received</th>
                <th class="text-end">Declared Value</th>
                <th class="text-end">Amount Due</th>                
              </tr>
            </thead>
            <tbody>
              {% for pkg in packages %}
              <tr>
                {% set st = (pkg.status or '')|lower %}
                {% set bar_class =
                    'status-overseas' if 'overseas' in st
                    else 'status-ready' if ('ready' in st or 'pickup' in st or 'pick up' in st)
                    else 'status-delivered' if ('delivered' in st or st == 'delivery' or 'out for delivery' in st)
                    else 'status-unknown'
                %}
                <td class="text-center align-middle">
                  <input type="checkbox"
                         class="pkg-check"
                         value="{{ pkg.id }}"
                         data-weight="{{ pkg.weight or 0 }}"
                         data-value="{{ (pkg.declared_value if pkg.declared_value is defined and pkg.declared_value is not none else (pkg.value or 0)) }}"
                  >
                </td>

                <td class="pkg-cell">
                  {% set status = pkg.status %}
                  {% include 'partials/status_vars.html' %}

                  {% set pc = (progress_color|default('secondary')) %}
                  {% set pc = pc|replace('bg-','')|replace('text-bg-','') %}
                  <div class="pkg-status-bar bar-{{ pc }}"></div>


                  <strong>{{ pkg.house_awb or '-' }}</strong><br>
                  {% include 'partials/status_tracker.html' with context %}
                </td>



                <td>
                  <div>{{ pkg.description or '-' }}</div>

                  {% if pkg.attachments and pkg.attachments|length > 0 %}
                    <div class="mt-1 d-flex flex-wrap gap-2">

                      {% for a in pkg.attachments %}
                        <a class="btn btn-sm"
                           style="background:#f5f0fa; border:1px solid #4a148c; color:#4a148c; padding:.2rem .45rem;"
                           target="_blank"
                           href="{{ url_for('logistics.admin_view_package_attachment', attachment_id=a.id) }}"
                           title="{{ a.original_name or 'Attachment' }}">
                          <i class="fa-solid fa-file-lines"></i>                          
                        </a>

                        <form method="POST"
                              action="{{ url_for('logistics.delete_package_attachment_admin', attachment_id=a.id) }}"
                              class="d-inline"
                              onsubmit="return confirm('Delete this attachment?');">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="tab" value="{{ current_tab }}">
                          <input type="hidden" name="pkg_page" value="{{ pkg_page }}">
                          <input type="hidden" name="pkg_per_page" value="{{ pkg_per_page }}">
                          <input type="hidden" name="pkg_from" value="{{ pkg_from or '' }}">
                          <input type="hidden" name="pkg_to" value="{{ pkg_to or '' }}">
                          <input type="hidden" name="pkg_awb" value="{{ pkg_awb or '' }}">
                          <input type="hidden" name="pkg_tn" value="{{ pkg_tn or '' }}">


                          <button type="submit" 
                                  class="btn btn-sm"
                                  style="background:#fff; border:1px solid #dc3545; color:#dc3545; padding:.2rem .45rem;"
                                  title="Delete attachment">
                            <i class="fa-solid fa-trash"></i>
                          </button>
                        </form>

                      {% endfor %}
                    </div>
                  {% endif %}
                </td>
                <td>{{ pkg.tracking_number or '-' }}</td>
                <td>{{ pkg.weight }}</td>
                <td>{{ pkg.date_received or 'N/A' }}</td>
                <td class="text-end">${{ money(pkg.declared_value) }}</td>
                <td class="text-end">${{ money(pkg.amount_due) }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="8" class="text-center text-muted py-4">No packages found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination footer (INSIDE Packages tab) -->
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">
            Showing {{ pkg_show_from }}â€“{{ pkg_show_to }} of {{ total_pkgs }}
          </small>

          <ul class="pagination pagination-sm mb-0">
            <!-- First -->
            <li class="page-item {% if pkg_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                href="{{ url_for('accounts_profiles.view_user',
                                 id=user_id, tab='packages', pkg_page=1,
                                 pkg_per_page=pkg_per_page,
                                 pkg_from=pkg_from, pkg_to=pkg_to, pkg_awb=pkg_awb, pkg_tn=pkg_tn) }}">
                &laquo;&laquo;
              </a>
            </li>

            <!-- Prev -->
            <li class="page-item {% if pkg_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                href="{{ url_for('accounts_profiles.view_user',
                                 id=user_id, tab='packages',
                                 pkg_page=(pkg_page-1 if pkg_page>1 else 1),
                                 pkg_per_page=pkg_per_page,
                                 pkg_from=pkg_from, pkg_to=pkg_to, pkg_awb=pkg_awb, pkg_tn=pkg_tn) }}">
                &laquo;
              </a>
            </li>

            <!-- Next -->
            <li class="page-item {% if pkg_page == pkg_total_pages %}disabled{% endif %}">
              <a class="page-link"
                href="{{ url_for('accounts_profiles.view_user',
                                 id=user_id, tab='packages',
                                 pkg_page=(pkg_page+1 if pkg_page < pkg_total_pages else pkg_total_pages),
                                 pkg_per_page=pkg_per_page,
                                 pkg_from=pkg_from, pkg_to=pkg_to, pkg_awb=pkg_awb, pkg_tn=pkg_tn) }}">
                &raquo;
              </a>
            </li>

            <!-- Last -->
            <li class="page-item {% if pkg_page == pkg_total_pages %}disabled{% endif %}">
              <a class="page-link"
                href="{{ url_for('accounts_profiles.view_user',
                                 id=user_id, tab='packages', pkg_page=pkg_total_pages,
                                 pkg_per_page=pkg_per_page,
                                 pkg_from=pkg_from, pkg_to=pkg_to, pkg_awb=pkg_awb, pkg_tn=pkg_tn) }}"
>
                &raquo;&raquo;
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Prealerts Tab -->
      <div class="tab-pane fade {% if current_tab == 'prealerts' %}show active{% endif %}"
           id="prealerts" role="tabpanel" aria-labelledby="prealerts-tab">
        <div class="table-responsive">
          <table id="prealertsTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Pre-Alert #</th>
                <th>Vendor</th>
                <th>Courier</th>
                <th>Tracking #</th>
                <th>Purchase Date</th>
                <th>Contents</th>
                <th>Value (USD)</th>
                <th>Invoice</th>
                <th>Submitted On</th>
              </tr>
            </thead>
            <tbody>
              {% for p in prealerts %}
              <tr>
                <td>
                  {% if p.prealert_number %}
                    PA-{{ "%05d"|format(p.prealert_number) }}
                  {% else %}
                    {{ p.id }}
                  {% endif %}
                </td>

                <td>{{ p.vendor_name }}</td>
                <td>{{ p.courier_name }}</td>
                <td>{{ p.tracking_number }}</td>
                <td>{{ p.purchase_date }}</td>
                <td>{{ p.package_contents }}</td>
                <td>${{ money(p.item_value_usd) }}</td>
                <td>
                  {% if p.invoice_filename %}
                    {% if is_url(p.invoice_filename) %}
                      <a href="{{ p.invoice_filename }}" target="_blank" rel="noopener">View</a>
                    {% else %}
                      <a href="{{ url_for('uploads.invoice_file', filename=p.invoice_filename) }}" target="_blank" rel="noopener">View</a>
                    {% endif %}
                  {% else %}
                    N/A
                  {% endif %}
                </td>


                <td>{{ p.created_at }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Invoices Tab -->
      <div class="tab-pane fade {% if current_tab == 'invoices' %}show active{% endif %}"
           id="invoices" role="tabpanel" aria-labelledby="invoices-tab">


        <!-- Top bar: Rows (left) + Filter (right) -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex align-items-center gap-2">
            <label class="small text-muted mb-0">Rows</label>

            <select class="form-select form-select-sm" style="width:auto;"
                    onchange="location.href='{{ url_for('accounts_profiles.view_user', id=user_id, tab='invoices', inv_page=1, inv_from=inv_from, inv_to=inv_to) }}&inv_per_page=' + this.value;">
              {% set current_pp = inv_per_page|default(10) %}
              {% for n in [10,20,50,100,500,1000] %}
                <option value="{{ n }}" {% if current_pp|int == n %}selected{% endif %}>{{ n }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="d-flex align-items-center gap-2">
            <button type="button"
                    class="btn btn-sm btn-outline-purple"
                    data-bs-toggle="modal"
                    data-bs-target="#invoiceFilterModal"
                    title="Filter invoices">
              <i class="bi bi-funnel"></i> Filter
            </button>
          </div>
        </div>

        <div class="mb-3">
          <strong>Total Owed:</strong>  ${{ money(total_owed) }} |
          <strong>Total Paid:</strong>  ${{ money(total_paid) }} |
          <strong>Balance:</strong>     ${{ money(balance) }}

          <a href="{{ url_for('admin.generate_pdf_invoice', user_id=user.id) }}" class="btn btn-sm btn-outline-secondary float-end">Export PDF</a>
        </div>
        <div class="table-responsive">
          <table id="invoiceTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Description</th>
                <th class="text-end">Amount Due</th>
                <th class="text-end">Amount Paid</th>
                <th class="text-end">Amount Owed</th>                
                <th>Status</th>
                <th class="text-center" style="width:60px;">Delete</th>                
              </tr>
            </thead>
            <tbody>
              {% for inv, paid_sum in invoices_rows %}
              {% set inv_status = (inv.status or 'unpaid')|lower %}
              {# ---- Amount Due (robust fallback) ---- #}
              {% set due =
                  (inv.grand_total if inv.grand_total is defined and inv.grand_total is not none
                   else (inv.amount_due if inv.amount_due is defined and inv.amount_due is not none
                         else 0))
              %}

              {% set paid = paid_sum|float %}
              {% set owed = (due|float - paid|float) %}
              {% if owed < 0 %}{% set owed = 0 %}{% endif %}

              <tr data-invoice-id="{{ inv.id }}">
                <td>
                  <button type="button"
                          class="btn btn-sm btn-outline-purple"
                          onclick="openInvoiceModal({{ inv.id }})"
                          title="Open invoice">
                    {{ inv.invoice_number or ('INV' ~ '%05d'|format(inv.id)) }}
                    <i class="bi bi-box-arrow-up-right ms-1"></i>
                  </button>
                </td>

                <!-- Description (fallback if not present) -->
                <td>
                  {% if inv.description is defined and inv.description %}
                    {{ inv.description }}
                  {% else %}
                    No description
                  {% endif %}
                </td>

                <td class="text-end">${{ money(due) }}</td>
                <td class="text-end">${{ money(paid) }}</td>
                
                <td class="text-end">
                  <span class="fw-bold {% if owed > 0 %}text-danger{% else %}text-success{% endif %}">
                    ${{ money(owed) }}
                  </span>
                </td>

                <td>
                  <div class="d-flex flex-column gap-1">
                    <!-- Status badge -->
                    <span class="badge {% if inv_status == 'paid' or owed == 0 %}bg-success{% else %}bg-danger{% endif %}">
                      {{ 'Paid' if (inv_status == 'paid' or owed == 0) else 'Unpaid' }}
                    </span>

                    <!-- Date line -->
                    {% if inv_status == 'paid' or owed == 0 %}
                      {% if inv.date_paid is defined and inv.date_paid %}
                        <small class="text-muted">
                          Paid on {{ inv.date_paid.strftime('%Y-%m-%d') }}
                        </small>
                      {% elif inv.updated_at is defined and inv.updated_at %}
                        <small class="text-muted">
                          Paid on {{ inv.updated_at.strftime('%Y-%m-%d') }}
                        </small>
                      {% endif %}
                    {% else %}
                      {% if inv.date_issued is defined and inv.date_issued %}
                        <small class="text-muted">
                          Received {{ inv.date_issued.strftime('%Y-%m-%d') }}
                        </small>
                      {% elif inv.created_at is defined and inv.created_at %}
                        <small class="text-muted">
                          Received {{ inv.created_at.strftime('%Y-%m-%d') }}
                        </small>
                      {% endif %}
                    {% endif %}
                  </div>
                </td>
                <td class="text-center">
                  {% if paid|float <= 0 %}
                    <button type="button"
                            class="btn btn-sm btn-outline-danger"
                            title="Delete invoice"
                            onclick="openDeleteInvoiceModal({{ inv.id }}, '{{ (inv.invoice_number or ('INV' ~ '%05d'|format(inv.id)))|e }}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  {% else %}
                    <i class="bi bi-lock text-muted"
                       title="Cannot delete: payment exists"
                       style="font-size: 1.1rem;"></i>
                  {% endif %}
                </td>               
              </tr>              
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div id="invoiceInlineHost" class="mt-3"></div>
        <!-- Pagination footer -->
        <div class="d-flex justify-content-between align-items-center mt-2">
          <small class="text-muted">
            Showing {{ inv_show_from }}â€“{{ inv_show_to }} of {{ total_invoices }}
          </small>

          <ul class="pagination pagination-sm mb-0">
            <li class="page-item {% if inv_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user',
                                  id=user_id, tab='invoices',
                                  inv_page=1,
                                  inv_per_page=inv_per_page,
                                  inv_from=inv_from, inv_to=inv_to) }}">
                &laquo;&laquo;
              </a>
            </li>

            <li class="page-item {% if inv_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user',
                                  id=user_id, tab='invoices',
                                  inv_page=(inv_page-1 if inv_page>1 else 1),
                                  inv_per_page=inv_per_page,
                                  inv_from=inv_from, inv_to=inv_to) }}">
                &laquo;
              </a>
            </li>

            <li class="page-item {% if inv_page == inv_total_pages %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user',
                                  id=user_id, tab='invoices',
                                  inv_page=(inv_page+1 if inv_page < inv_total_pages else inv_total_pages),
                                  inv_per_page=inv_per_page,
                                  inv_from=inv_from, inv_to=inv_to) }}">
                &raquo;
              </a>
            </li>

            <li class="page-item {% if inv_page == inv_total_pages %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user',
                                  id=user_id, tab='invoices',
                                  inv_page=inv_total_pages,
                                  inv_per_page=inv_per_page,
                                  inv_from=inv_from, inv_to=inv_to) }}">
                &raquo;&raquo;
              </a>
            </li>
          </ul>
        </div>

      </div>

      <!-- Payments Tab -->
      <div class="tab-pane fade {% if current_tab == 'payments' %}show active{% endif %}"
           id="payments" role="tabpanel" aria-labelledby="payments-tab">

        <!-- Top bar: Rows (left) + Filter (right) -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex align-items-center gap-2">
            <label class="small text-muted mb-0">Rows</label>

            <select class="form-select form-select-sm" style="width:auto;"
                    onchange="location.href='{{ url_for('accounts_profiles.view_user', id=user_id, tab='payments', pay_page=1, pay_from=pay_from, pay_to=pay_to) }}&pay_per_page=' + this.value;">
              {% set current_pp = pay_per_page|default(10) %}
              {% for n in [10,20,50,100,500,1000] %}
                <option value="{{ n }}" {% if current_pp|int == n %}selected{% endif %}>{{ n }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="d-flex align-items-center gap-2">
            <button type="button"
                    class="btn btn-sm btn-outline-purple"
                    data-bs-toggle="modal"
                    data-bs-target="#paymentFilterModal"
                    title="Filter payments">
              <i class="bi bi-funnel"></i> Filter
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table id="paymentsTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Bill #</th>
                <th>Date of Payment</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Authorized By</th>
                <th>Invoice</th>
              </tr>
            </thead>
            <tbody>
              {% for payment in payments %}
              <tr>
                <td>{{ payment.bill_number }}</td>
                <td>{{ payment.payment_date }}</td>
                <td>{{ payment.payment_type }}</td>
                <td>${{ money(payment.amount) }}</td>
                <td>{{ payment.authorized_by }}</td>
                <td>
                  {% if payment.invoice_number %}
                    <a href="{{ url_for('admin.view_invoice', invoice_id=payment.invoice_id) }}"
                       title="View Invoice {{ payment.invoice_number }}">
                      {{ payment.invoice_number }}
                    </a>
                  {% else %}
                    â€”
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
       
        <!-- Pagination footer -->
        <div class="d-flex justify-content-between align-items-center mt-2">
          <small class="text-muted">
            Showing {{ pay_show_from }}â€“{{ pay_show_to }} of {{ total_payments }}
          </small>

          <ul class="pagination pagination-sm mb-0">
            <!-- First -->
            <li class="page-item {% if pay_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user',
                                  id=user_id, tab='payments',
                                  pay_page=1,
                                  pay_per_page=pay_per_page,
                                  pay_from=pay_from, pay_to=pay_to) }}">
                &laquo;&laquo;
              </a>
            </li>

            <!-- Prev -->
            <li class="page-item {% if pay_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user',
                                  id=user_id, tab='payments',
                                  pay_page=(pay_page-1 if pay_page>1 else 1),
                                  pay_per_page=pay_per_page,
                                  pay_from=pay_from, pay_to=pay_to) }}">
                &laquo;
              </a>
            </li>

            <!-- Next -->
            <li class="page-item {% if pay_page == pay_total_pages %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user',
                                  id=user_id, tab='payments',
                                  pay_page=(pay_page+1 if pay_page < pay_total_pages else pay_total_pages),
                                  pay_per_page=pay_per_page,
                                  pay_from=pay_from, pay_to=pay_to) }}">
                &raquo;
              </a>
            </li>

            <!-- Last -->
            <li class="page-item {% if pay_page == pay_total_pages %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user',
                                  id=user_id, tab='payments',
                                  pay_page=pay_total_pages,
                                  pay_per_page=pay_per_page,
                                  pay_from=pay_from, pay_to=pay_to) }}">
                &raquo;&raquo;
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Messages Tab -->
      <div class="tab-pane fade {% if current_tab == 'messages' %}show active{% endif %}"
           id="messages" role="tabpanel" aria-labelledby="messages-tab">

        <!-- Top bar: Rows (left) + Search (middle) + Filter/Send (right) -->
        <div class="d-flex justify-content-between align-items-center mb-2">

          <!-- Left: Rows -->
          <div class="d-flex align-items-center gap-2">
            <label class="small text-muted mb-0">Rows</label>

            <select class="form-select form-select-sm" style="width:auto;"
                    onchange="location.href='{{ url_for('accounts_profiles.view_user', id=user_id, tab='messages', msg_page=1, msg_from=msg_from, msg_to=msg_to, msg_q=msg_q) }}&msg_per_page=' + this.value;">
              {% set current_pp = msg_per_page|default(10) %}
              {% for n in [10,20,50,100,500,1000] %}
                <option value="{{ n }}" {% if current_pp|int == n %}selected{% endif %}>{{ n }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Middle: Search -->
          <div class="d-flex align-items-center gap-2" style="min-width:260px; max-width:420px; width:100%;">
            <span class="small text-muted mb-0">Search</span>

            <input id="msgSearchInput"
                   type="text"
                   class="form-control form-control-sm"
                   placeholder="Search subject/body..."
                   value="{{ msg_q or '' }}">
          </div>

          <!-- Right: Filter + Send -->
          <div class="d-flex align-items-center gap-2">
            <button type="button"
                    class="btn btn-sm btn-outline-purple"
                    data-bs-toggle="modal"
                    data-bs-target="#messageFilterModal"
                    title="Filter messages">
              <i class="bi bi-funnel"></i> Filter
            </button>

            <button type="button"
                    class="btn btn-sm btn-outline-purple"
                    data-bs-toggle="modal"
                    data-bs-target="#sendMessageModal"
                    title="Send message">
              <i class="bi bi-envelope"></i> Send
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table id="messagesTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Subject</th>
                <th>Message</th>
                <th>Date Sent</th>
              </tr>
            </thead>
            <tbody>
              {% for msg in messages %}
              <tr>
                <td>{{ msg.subject or '' }}</td>
                <td>{{ msg.body or '' }}</td>
                <td>{{ msg.created_at or '' }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3" class="text-center text-muted py-4">No messages found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination footer -->
        <div class="d-flex justify-content-between align-items-center mt-2">
          <small class="text-muted">
            Showing {{ msg_show_from }}â€“{{ msg_show_to }} of {{ total_messages }}
          </small>

          <ul class="pagination pagination-sm mb-0">
            <li class="page-item {% if msg_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='messages',
                                  msg_page=1, msg_per_page=msg_per_page,
                                  msg_from=msg_from, msg_to=msg_to, msg_q=msg_q) }}">
                &laquo;&laquo;
              </a>
            </li>

            <li class="page-item {% if msg_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='messages',
                                  msg_page=(msg_page-1 if msg_page>1 else 1), msg_per_page=msg_per_page,
                                  msg_from=msg_from, msg_to=msg_to, msg_q=msg_q) }}">
                &laquo;
              </a>
            </li>

            <li class="page-item {% if msg_page == msg_total_pages %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='messages',
                                  msg_page=(msg_page+1 if msg_page < msg_total_pages else msg_total_pages),
                                  msg_per_page=msg_per_page,
                                  msg_from=msg_from, msg_to=msg_to, msg_q=msg_q) }}">
                &raquo;
              </a>
            </li>

            <li class="page-item {% if msg_page == msg_total_pages %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='messages',
                                  msg_page=msg_total_pages, msg_per_page=msg_per_page,
                                  msg_from=msg_from, msg_to=msg_to, msg_q=msg_q) }}">
                &raquo;&raquo;
              </a>
            </li>
          </ul>
        </div>
      </div>


      <!-- Schedule Delivery Tab -->
      <div class="tab-pane fade {% if current_tab == 'schedule' %}show active{% endif %}"
           id="schedule-delivery" role="tabpanel" aria-labelledby="schedule-delivery-tab">

        <div class="mb-3">
          <button type="button"
                  class="btn btn-primary mb-3"
                  data-bs-toggle="modal"
                  data-bs-target="#adminDeliveryModal">
            + Add Delivery
          </button>
        </div>
        <div class="table-responsive">
          <table id="scheduledeliveryTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Location</th>
                <th>Person Receiving</th>
                <th>Mobile</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for d in scheduled_deliveries %}
              <tr>
                <td>{{ d.scheduled_date.strftime("%Y-%m-%d") if d.scheduled_date else "" }}</td>

                <td class="text-nowrap">
                  {% if d.scheduled_time_from and d.scheduled_time_to %}
                    {{ d.scheduled_time_from }} - {{ d.scheduled_time_to }}
                  {% else %}
                    {{ d.scheduled_time or "" }}
                  {% endif %}
                </td>

                <td>{{ d.location or "" }}</td>
                <td>{{ d.person_receiving or "" }}</td>
                <td>{{ d.mobile_number or d.mobile or "" }}</td>
                <td>{{ d.status or "Scheduled" }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">No scheduled deliveries for this user.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Referrals Tab -->
      <div class="tab-pane fade {% if current_tab == 'referrals' %}show active{% endif %}"
           id="referrals" role="tabpanel" aria-labelledby="referrals-tab">
        <p>Referrals details go here.</p>
      </div>
    </div>
  </div>

  <!-- Manage Account Modal -->
  <div class="modal fade" id="manageAccountModal" tabindex="-1" aria-labelledby="manageAccountLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">

        <div class="modal-header" style="background-color:#4a148c; color:white;">
          <h5 class="modal-title" id="manageAccountLabel">Manage Account: {{ user.full_name }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form action="{{ url_for('accounts_profiles.manage_account', id=user.id) }}" method="POST">
          <!-- ðŸ” CSRF -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="tab" value="{{ current_tab }}">
          <div class="modal-body">

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Full Name</label>
                <input type="text" name="full_name" class="form-control" value="{{ user.full_name }}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" value="{{ user.email }}" required>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Mobile</label>
                <input type="text" name="mobile" class="form-control" value="{{ user.mobile }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Address</label>
                <input type="text" name="address" class="form-control" value="{{ user.address }}">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Referral Code</label>
                <input type="text" name="referral_code" class="form-control" value="{{ user.referral_code }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Authorized Person</label>
                <input type="text" name="authorized_person" class="form-control" value="{{ user.authorized_person }}">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Branch</label>
                <input type="text" name="branch" class="form-control" value="Main" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Status</label>
                <select name="is_active" class="form-select">
                  <option value="1" {% if user.is_active %}selected{% endif %}>Active</option>
                  <option value="0" {% if not user.is_active %}selected{% endif %}>Inactive</option>
                </select>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Packages Filter Modal -->
  <div class="modal fade" id="packageFilterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header" style="background-color:#4a148c; color:white;">
          <h5 class="modal-title">
            <i class="bi bi-funnel me-1"></i> Filter Packages
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <form method="GET" action="{{ url_for('accounts_profiles.view_user', id=user_id) }}">
          <input type="hidden" name="tab" value="packages">
          <input type="hidden" name="pkg_page" value="1">

          <div class="modal-body">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">From Date</label>
                <input type="date" name="pkg_from" class="form-control" value="{{ pkg_from or '' }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">To Date</label>
                <input type="date" name="pkg_to" class="form-control" value="{{ pkg_to or '' }}">
              </div>
            </div>

            <div class="mt-2">
              <label class="form-label">House AWB</label>
              <input type="text" name="pkg_awb" class="form-control" value="{{ pkg_awb or '' }}"
                     placeholder="e.g. HAWB123...">
            </div>

            <div class="mt-2">
              <label class="form-label">Tracking Number</label>
              <input type="text" name="pkg_tn" class="form-control" value="{{ pkg_tn or '' }}"
                     placeholder="e.g. 1Z... / TBA...">
            </div>
          </div>

          <div class="modal-footer">
            <a class="btn btn-outline-secondary"
               href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='packages', pkg_page=1) }}">
              Clear
            </a>
            <button type="submit" class="btn" style="background-color:#4a148c; color:white;">
              Apply Filters
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
  <!-- âœ… Add Single Package Modal (Admin -> View User) -->
  <div class="modal fade" id="addSinglePackageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header" style="background-color:#4a148c; color:white;">
          <h5 class="modal-title">
            <i class="bi bi-plus-square me-1"></i> Add Package for {{ user.full_name }}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <form id="addSinglePackageForm"
              method="POST"
              action="{{ url_for('accounts_profiles.create_single_package_for_user', id=user_id) }}">

          <input type="hidden" name="user_id" value="{{ user_id }}">
          <!-- CSRF (works with Flask-WTF CSRFProtect if enabled) -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="tab" value="{{ current_tab }}">
          <input type="hidden" name="pkg_page" value="{{ pkg_page }}">
          <input type="hidden" name="pkg_per_page" value="{{ pkg_per_page }}">
          <input type="hidden" name="pkg_from" value="{{ pkg_from or '' }}">
          <input type="hidden" name="pkg_to" value="{{ pkg_to or '' }}">
          <input type="hidden" name="pkg_awb" value="{{ pkg_awb or '' }}">
          <input type="hidden" name="pkg_tn" value="{{ pkg_tn or '' }}">


          <div class="modal-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">House AWB</label>
                <input type="text" name="house_awb" class="form-control" placeholder="e.g. HAWB123" required>
              </div>

              <div class="col-md-4">
                <label class="form-label">Tracking Number</label>
                <input type="text" name="tracking_number" class="form-control" placeholder="e.g. 1Z... / TBA...">
              </div>

              <div class="col-md-4">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                  <option value="Overseas">Overseas</option>
                  <option value="Ready for Pickup">Ready for Pickup</option>
                  <option value="Delivered">Delivered</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label">Description</label>
                <input type="text" name="description" class="form-control" placeholder="What is inside?">
              </div>

              <div class="col-md-3">
                <label class="form-label">Weight (lbs)</label>
                <input type="number" step="0.01" name="weight" class="form-control" placeholder="e.g. 3.5" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">Date Received</label>
                <input type="date" name="date_received" class="form-control">
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-4">
                <label class="form-label">Declared Value (USD)</label>
                <input type="number" step="0.01" name="declared_value" class="form-control" placeholder="e.g. 120.00">
              </div>

              <div class="col-md-8">
                <label class="form-label">Invoice File Name (optional)</label>
                <input type="text" name="invoice_file" class="form-control" placeholder="leave blank if none">
                <div class="form-text">Optional: only if your Package model uses invoice_file.</div>
              </div>
            </div>

            <div class="alert alert-light border mt-3 mb-0">
              <small class="text-muted">
                After saving, we will refresh this page so the new package shows immediately in the Packages tab
                and also appears under Logistics.
              </small>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check2-circle me-1"></i> Save Package
            </button>
          </div>

        </form>

      </div>
    </div>
  </div>
   
  
  <!-- Payments Filter Modal -->
  <div class="modal fade" id="paymentFilterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header" style="background-color:#4a148c; color:white;">
          <h5 class="modal-title">
            <i class="bi bi-funnel me-1"></i> Filter Payments
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <form method="GET" action="{{ url_for('accounts_profiles.view_user', id=user_id) }}">
          <input type="hidden" name="tab" value="payments">
          <input type="hidden" name="pay_page" value="1">
          <input type="hidden" name="pay_per_page" value="{{ pay_per_page }}">

          <div class="modal-body">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Start Date</label>
                <input type="date" name="pay_from" class="form-control" value="{{ pay_from or '' }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">End Date</label>
                <input type="date" name="pay_to" class="form-control" value="{{ pay_to or '' }}">
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <a class="btn btn-outline-secondary"
               href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='payments', pay_page=1, pay_per_page=pay_per_page) }}">
              Clear
            </a>
            <button type="submit" class="btn" style="background-color:#4a148c; color:white;">
              Apply Filters
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>


  <!-- Messages Filter Modal -->
  <div class="modal fade" id="messageFilterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header" style="background-color:#4a148c; color:white;">
          <h5 class="modal-title">
            <i class="bi bi-funnel me-1"></i> Filter Messages
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <form method="GET" action="{{ url_for('accounts_profiles.view_user', id=user_id) }}">
          <input type="hidden" name="tab" value="messages">
          <input type="hidden" name="msg_page" value="1">
          <input type="hidden" name="msg_per_page" value="{{ msg_per_page|default(10) }}">
          <input type="hidden" name="msg_q" value="{{ msg_q or '' }}">

          <div class="modal-body">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Start Date</label>
                <input type="date" name="msg_from" class="form-control" value="{{ msg_from or '' }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">End Date</label>
                <input type="date" name="msg_to" class="form-control" value="{{ msg_to or '' }}">
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <a class="btn btn-outline-secondary"
               href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='messages', msg_page=1) }}">
              Clear
            </a>
            <button type="submit" class="btn" style="background-color:#4a148c; color:white;">
              Apply
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
  <!-- Send Message Modal -->
  <div class="modal fade" id="sendMessageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <form method="POST" action="{{ url_for('accounts_profiles.send_message_to_user', id=user_id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="tab" value="{{ current_tab }}">

          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Subject</label>
              <input type="text" name="subject" class="form-control" required>
            </div>

            <div class="mb-0">
              <label class="form-label">Body</label>
              <textarea name="body" class="form-control" rows="6" required></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-outline-purple">Send</button>
            <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>

      </div>
    </div>
  </div>


  <!-- ðŸ“„ Universal Invoice Preview Modal -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="invoiceModalLabel">
            <i class="bi bi-receipt"></i> Invoice
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body" id="invoiceModalBody">
          <p class="text-muted mb-0">Loading invoiceâ€¦</p>
        </div>
      </div>
    </div>
  </div>
 
  <!-- Sensitive Info Modal -->
  <div class="modal fade" id="sensitiveInfoModal" tabindex="-1" aria-labelledby="sensitiveInfoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header" style="background-color:#4a148c; color:white;">
          <h5 class="modal-title" id="sensitiveInfoLabel">
            <i class="bi bi-shield-lock me-1"></i> Sensitive Information
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            This information is sensitive. Handle and share securely.
          </div>

          <p><strong>Full Name:</strong> {{ user.full_name }}</p>
          <p><strong>TRN:</strong> {{ user.trn or 'Not stored' }}</p>
          <p><strong>Home Address:</strong> {{ user.address or 'Not set' }}</p>
          <p><strong>Mobile:</strong> {{ user.mobile }}</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn" style="background-color:#4a148c; color:white;" data-bs-dismiss="modal">
            Close
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Admin Schedule Delivery Modal -->
  <div class="modal fade" id="adminDeliveryModal" tabindex="-1" aria-labelledby="adminDeliveryLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <form id="adminDeliveryForm"
              method="POST"
              action="{{ url_for('logistics.add_scheduled_delivery') }}">

          <!-- CSRF -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <!-- If you're scheduling from the View User page, keep user_id fixed -->
          <input type="hidden" id="modalUserId" name="user_id" value="{{ user_id }}">

          <div class="modal-header">
            <h5 class="modal-title" id="adminDeliveryLabel">Schedule Delivery</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="modalDeliveryDate" name="date" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">Time From</label>
                <input type="time" class="form-control" id="modalDeliveryTimeFrom" name="time_from" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">Time To</label>
                <input type="time" class="form-control" id="modalDeliveryTimeTo" name="time_to" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">Location</label>
                <input type="text" class="form-control" id="modalDeliveryLocation" name="location" required>
              </div>
            </div>

            <div class="row mt-2 g-2">
              <div class="col-md-6">
                <label class="form-label">Person Receiving</label>
                <input type="text" class="form-control" id="modalPersonReceiving" name="person_receiving">
              </div>

              <div class="col-md-6">
                <label class="form-label">Mobile #</label>
                <input type="text" class="form-control" id="modalDeliveryMobile" name="mobile_number">
              </div>
            </div>

            <div class="mt-2">
              <label class="form-label">Directions</label>
              <textarea class="form-control" id="modalDeliveryDirections" name="direction"></textarea>
            </div>
         </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Schedule Delivery</button>
          </div>

        </form>

      </div>
    </div>
  </div>

  <!-- Wallet Modal -->
  <div class="modal fade" id="editWalletModal" tabindex="-1" aria-labelledby="editWalletLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editWalletForm"
              method="POST"
              action="{{ url_for('accounts_profiles.update_wallet', id=user.id) }}">
          <!-- ðŸ” CSRF -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="tab" value="{{ current_tab }}">

          <div class="modal-header" style="background-color:#4a148c; color:white;">
            <h5 class="modal-title" id="editWalletLabel">
              <i class="bi bi-wallet2 me-1"></i> Edit Wallet Balance
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="amount" class="form-label">Amount (JMD)</label>
              <input type="number" step="0.01" name="amount" id="amount" class="form-control" required>
              <div class="form-text">Use a negative value to subtract from the wallet.</div>
            </div>
            <div class="mb-3">
              <label for="description" class="form-label">Description (optional)</label>
              <input type="text" name="description" id="description" class="form-control"
                     placeholder="e.g. Adjustment for overcharge, manual top-up, promo, etc.">
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn" style="background-color:#4a148c; color:white;">
              Update Wallet
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
      
  <!-- Mark Paid Modal -->
  <div class="modal fade" id="markPaidModal" tabindex="-1" aria-labelledby="markPaidLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="markPaidForm" method="POST">
          <div class="modal-header">
            <h5 class="modal-title" id="markPaidLabel">Mark Invoice as Paid</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="invoice_id" id="modalInvoiceId">
            <div class="mb-3">
              <label for="payment_amount" class="form-label">Amount</label>
              <input type="number" step="0.01" name="payment_amount" id="payment_amount" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="payment_type" class="form-label">Payment Type</label>
              <select name="payment_type" id="payment_type" class="form-select" required>
                <option value="cash">Cash</option>
                <option value="card">Card</option>
                <option value="bank_transfer">Bank Transfer</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="authorized_by" class="form-label">Authorized By</label>
              <input type="text" name="authorized_by" id="authorized_by" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Confirm Payment</button>
          </div>
        </form>
      </div>
    </div>
  </div>
 
  <div class="modal fade" id="deleteInvoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header" style="background:#dc3545; color:#fff;">
          <h5 class="modal-title">
            <i class="bi bi-exclamation-triangle me-1"></i> Delete Invoice
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <form id="deleteInvoiceForm" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="tab" value="{{ current_tab }}">
          <input type="hidden" name="tab" value="invoices">
          <input type="hidden" name="inv_page" value="{{ inv_page }}">
          <input type="hidden" name="inv_per_page" value="{{ inv_per_page }}">
          <input type="hidden" name="inv_from" value="{{ inv_from or '' }}">
          <input type="hidden" name="inv_to" value="{{ inv_to or '' }}">

          <div class="modal-body">
            <p class="mb-2">
              You are about to delete: <strong id="delInvoiceLabel">â€”</strong>
            </p>
            <div class="alert alert-warning mb-0">
              This will remove the invoice record. Any packages linked to it will be unassigned.
              Payments linked to it will be handled by the server rule.
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">
              <i class="bi bi-trash me-1"></i> Delete
            </button>
          </div>
        </form>

      </div>
    </div>
  </div> 

</div>
{% endblock %}

{% block styles %}
<style>
/* ================================
   Tabs: White background, black text
   Purple hover & active
   ================================ */

.card-header .nav-tabs {
  border-bottom: 1px solid #dee2e6;
  margin-bottom: 0;
  padding-left: 1rem;
  padding-right: 1rem;
}

/* Base tab */
.card-header .nav-tabs .nav-link {
  font-family: 'Poppins', sans-serif;
  background-color: #ffffff !important;
  color: #000000 !important;
  border: 1px solid #dee2e6 !important;
  border-bottom: none !important;
  border-radius: 0.25rem 0.25rem 0 0;
  margin-right: 4px;
  font-weight: 500;
  transition: all 0.2s ease-in-out;
}

/* Hover */
.card-header .nav-tabs .nav-link:hover {
  background-color: #f5f0fa !important;
  color: #4a148c !important;
  border-color: #4a148c #4a148c #dee2e6 !important;
}

/* Active */
.card-header .nav-tabs .nav-link.active,
.card-header .nav-tabs .nav-item.show .nav-link {
  background-color: #ffffff !important;
  color: #4a148c !important;
  font-weight: 600;
  border-color: #4a148c #4a148c #ffffff !important;
}

/* Icons inherit text color */
.card-header .nav-tabs .nav-link i {
  color: inherit;
}

/* ---------- Buttons ---------- */
.btn-outline-purple {
  border: 1px solid #4a148c !important;
  color: #4a148c !important;
  background: transparent !important;
}
.btn-outline-purple:hover {
  background: #4a148c !important;
  color: #fff !important;
}

/* ---------- Packages status bar + badge ---------- */
td.pkg-cell{
  position: relative;
  padding-left: 14px !important; /* room for bar */
}
td.pkg-cell .pkg-status-bar{
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 6px;
  border-radius: 2px;
}

/* left bar uses same progress_color keywords */
td.pkg-cell .pkg-status-bar.bar-danger  { background-color: #dc3545 !important; }  /* red */
td.pkg-cell .pkg-status-bar.bar-warning { background-color: #ffc107 !important; }  /* yellow */
td.pkg-cell .pkg-status-bar.bar-primary { background-color: #0d6efd !important; }  /* blue */
td.pkg-cell .pkg-status-bar.bar-success { background-color: #198754 !important; }  /* green */
td.pkg-cell .pkg-status-bar.bar-secondary { background-color: #adb5bd !important; }

/* Badge base */
td.pkg-cell span.badge.pkg-status-badge{
  display: inline-block !important;
  padding: .2rem .5rem !important;
  border-radius: .35rem !important;
  font-size: .75rem !important;
  font-weight: 700 !important;
  background-color: #6c757d !important;  /* fallback */
  color: #fff !important;
}

/* Badge colors (THIS is the real fix â€” forces background even if overridden elsewhere) */
td.pkg-cell span.badge.pkg-status-badge.status-overseas{
  background-color: #dc3545 !important;
  color: #fff !important;
}
td.pkg-cell span.badge.pkg-status-badge.status-ready{
  background-color: #ffc107 !important;
  color: #212529 !important;
}
td.pkg-cell span.badge.pkg-status-badge.status-delivered{
  background-color: #198754 !important;
  color: #fff !important;
}
td.pkg-cell span.badge.pkg-status-badge.status-unknown{
  background-color: #adb5bd !important;
  color: #212529 !important;
}

/* ================================
   MOBILE / RESPONSIVE FIXES
   ================================ */

/* Make icons clickable (you used cursor-pointer class) */
.cursor-pointer { cursor: pointer; }

/* ---------- Top grey bar: stop overlap on phones ---------- */
@media (max-width: 768px) {

  /* This targets your top grey bar inside the profile card */
  .card .d-flex.justify-content-between.align-items-center.p-2[style*="background-color:#6c757d"]{
    flex-wrap: wrap;
    gap: .5rem;
    position: relative !important; /* keep relative */
  }

  /* The middle group was position-absolute; kill that on mobile */
  .card .d-flex.justify-content-between.align-items-center.p-2
  .position-absolute[style*="left: 33%"]{
    position: static !important;
    left: auto !important;
    width: 100%;
    justify-content: space-between;
    gap: .5rem;
    margin-top: .25rem;
  }

  /* Right-side buttons wrap nicely */
  .card .d-flex.justify-content-between.align-items-center.p-2 > .d-flex.gap-2{
    width: 100%;
    justify-content: flex-end;
    flex-wrap: wrap;
    gap: .4rem !important;
  }

  /* ---------- Profile body: stack columns ---------- */
  .card-body.d-flex.p-3{
    flex-direction: column !important;
    gap: 1rem;
    padding-bottom: 5rem !important; /* space for wallet button */
  }

  /* Hide your vertical divider lines on mobile */
  .card-body.d-flex.p-3 .position-absolute[style*="border-left"],
  .card-body.d-flex.p-3 .position-absolute[style*="border-top"]{
    display: none !important;
  }

  /* Remove extra column paddings that cause squeeze */
  .card-body.d-flex.p-3 > div[style*="flex:1"]{
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  /* Name sizing */
  .card-body h3{
    font-size: 1.25rem !important;
    line-height: 1.2;
  }

  /* ---------- Wallet button: stop absolute overlap ---------- */
  .card-body .position-absolute[style*="bottom:1rem"][style*="right:1rem"]{
    position: static !important;
    margin-top: .75rem;
    width: 100%;
  }

  .card-body .position-absolute[style*="bottom:1rem"][style*="right:1rem"] .btn{
    width: 100%;
    font-size: 1.1rem !important;
    padding: .65rem 1rem !important;
  }

  /* ---------- Tabs: allow horizontal scroll instead of wrapping ugly ---------- */
  .card-header .nav-tabs{
    flex-wrap: nowrap !important;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
  }

  .card-header .nav-tabs .nav-link{
    white-space: nowrap;
    flex: 0 0 auto;
  }

  /* ---------- Tables: make them readable on phones ---------- */
  .table-responsive{
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Make the Packages table not feel cramped */
  #packagesTable th, #packagesTable td{
    white-space: nowrap;
    font-size: .9rem;
  }

  /* Give House/Status cell ability to wrap inside if needed */
  #packagesTable td.pkg-cell{
    white-space: normal;
    min-width: 180px;
  }

  /* Buttons row above tables should wrap */
  .tab-pane .d-flex.justify-content-between.align-items-center.mb-2{
    flex-wrap: wrap;
    gap: .5rem;
  }

  /* The search area in Messages tab */
  #msgSearchInput{
    min-width: 0 !important;
  }
}

</style>
{% endblock %}

{% block scripts %}
<script>
/* Expose this globally for inline onclick icons */
function showAddress(type) {
  document.getElementById("overseas-address").style.display = (type === 'overseas') ? 'block' : 'none';
  document.getElementById("home-address").style.display = (type === 'home') ? 'block' : 'none';
}

/* ----------------------------------------------------
   âœ… KEEP ACTIVE TAB IN THE URL (?tab=...)
   This ensures reload/redirect stays on invoices tab
---------------------------------------------------- */
(function syncTabsToUrl(){
  // Bootstrap tab triggers are your <button data-bs-toggle="tab"...>
  const tabButtons = document.querySelectorAll('button[data-bs-toggle="tab"]');
  if (!tabButtons.length) return;

  tabButtons.forEach(btn => {
    btn.addEventListener('shown.bs.tab', function (event) {
      const target = event.target.getAttribute('data-bs-target'); // e.g. "#invoices"
      if (!target) return;

      const tabName = target.replace('#', ''); // "invoices"
      const url = new URL(window.location.href);

      url.searchParams.set('tab', tabName);

      // Optional: reset page for some tabs when switching (safe)
      if (tabName === 'invoices') url.searchParams.set('inv_page', url.searchParams.get('inv_page') || '1');
      if (tabName === 'packages') url.searchParams.set('pkg_page', url.searchParams.get('pkg_page') || '1');
      if (tabName === 'payments') url.searchParams.set('pay_page', url.searchParams.get('pay_page') || '1');
      if (tabName === 'messages') url.searchParams.set('msg_page', url.searchParams.get('msg_page') || '1');

      window.history.replaceState({}, '', url.toString());
    });
  });
})();

$(document).ready(function () {
  /* IMPORTANT: Do NOT initialize DataTables for #packagesTable */
  // $('#packagesTable').DataTable();  // intentionally removed

  // Prealerts
  if ($('#prealertsTable').length) {
    $('#prealertsTable').DataTable({
      order: [[0, 'desc']],
      pageLength: 10
    });
  }

  // -----------------------------
  // Messages: server-side search (NO DataTables)
  // -----------------------------
  (function initServerSideMessageSearch() {
    const input = document.getElementById('msgSearchInput');
    if (!input) return;

    let t = null;

    function goSearch() {
      const q = (input.value || '').trim();

      const url = new URL(window.location.href);

      // stay on Messages tab
      url.searchParams.set('tab', 'messages');

      // reset to page 1 on new search
      url.searchParams.set('msg_page', '1');

      // set/clear q
      if (q) url.searchParams.set('msg_q', q);
      else url.searchParams.delete('msg_q');

      window.location.href = url.toString();
    }

    // Enter triggers search immediately
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        goSearch();
      }
    });

    // Debounced search while typing (optional)
    input.addEventListener('input', () => {
      clearTimeout(t);
      t = setTimeout(goSearch, 450);
    });
  })();

  // Scheduled deliveries (client-side ok)
  if ($('#scheduledeliveryTable').length) {
    $('#scheduledeliveryTable').DataTable();
  }

  // Mark as Paid Modal
  $('.mark-paid-btn').click(function () {
    const invoiceId = $(this).data('invoice-id');
    $('#modalInvoiceId').val(invoiceId);

    const owed = $(this).data('amount-owed');
    $('#payment_amount').val(owed || 0);

    new bootstrap.Modal(document.getElementById('markPaidModal')).show();
  });

  $('#markPaidForm').submit(function (e) {
    e.preventDefault();
    const formData = $(this).serialize();
    fetch("/admin/invoice/mark_paid", {
      method: 'POST',
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/x-www-form-urlencoded"
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const row = $(`tr[data-invoice-id="${data.invoice_id}"]`);
        row.find('span.badge').removeClass('bg-danger').addClass('bg-success').text('paid');
        row.find('.mark-paid-btn').remove();

        $('#paymentsTable').DataTable().row.add([
          data.bill_number,
          data.payment_date,
          data.payment_type,
          `$${parseFloat(data.amount).toFixed(2)}`,
          data.authorized_by,
          data.invoice_path ? `<a href="${data.invoice_path}" target="_blank"><i class="fas fa-file-invoice fa-lg"></i></a>` : 'â€”'
        ]).draw();

        bootstrap.Modal.getInstance(document.getElementById('markPaidModal')).hide();
      } else {
        alert(data.error || 'Error marking invoice as paid.');
      }
    });
  });
});

/* -----------------------------
   Delivery modals (outside jQuery)
   ----------------------------- */

// Full admin delivery modal launcher
document.querySelectorAll('.open-admin-delivery-modal').forEach(btn => {
  btn.addEventListener('click', function() {
    const userId = this.getAttribute('data-user-id');
    document.getElementById('modalUserId').value = userId;
    document.getElementById('adminDeliveryForm').reset();
    new bootstrap.Modal(document.getElementById('adminDeliveryModal')).show();
  });
});

// Submit full admin delivery form (big modal)
document.getElementById('adminDeliveryForm')?.addEventListener('submit', function(e){
  e.preventDefault();

  const payload = {
    user_id: document.getElementById('modalUserId').value,
    date: document.getElementById('modalDeliveryDate').value,
    time_from: document.getElementById('modalDeliveryTimeFrom').value,
    time_to: document.getElementById('modalDeliveryTimeTo').value,
    location: document.getElementById('modalDeliveryLocation').value,
    person_receiving: document.getElementById('modalPersonReceiving').value,
    mobile_number: document.getElementById('modalDeliveryMobile').value,
    direction: document.getElementById('modalDeliveryDirections').value
  };

  fetch("{{ url_for('logistics.add_scheduled_delivery') }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if(data.status === "success"){
      bootstrap.Modal.getInstance(document.getElementById('adminDeliveryModal')).hide();
      window.location.reload();   // âœ… simplest + guarantees table updates
    } else {
      alert(data.message || 'Error scheduling delivery.');
    }
  })
  .catch(() => alert("Network/server error scheduling delivery."));
});

/* ================================
   Bulk delete behaviour
   ================================ */
document.addEventListener("DOMContentLoaded", () => {
  const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
  const selectAll = document.getElementById("pkgSelectAll");

  function selectedIds(){
    return Array.from(document.querySelectorAll(".pkg-check:checked"))
      .map(cb => parseInt(cb.value, 10))
      .filter(n => !isNaN(n));
  }

  function toggleBulkBtn(){
    if (!bulkDeleteBtn) return;
    bulkDeleteBtn.disabled = selectedIds().length === 0;
  }

  // Select all
  if (selectAll){
    selectAll.addEventListener("change", () => {
      document.querySelectorAll(".pkg-check").forEach(cb => cb.checked = selectAll.checked);
      toggleBulkBtn();
    });
  }

  // Per checkbox
  document.querySelectorAll(".pkg-check").forEach(cb => {
    cb.addEventListener("change", () => {
      if (selectAll && !cb.checked) selectAll.checked = false;
      toggleBulkBtn();
    });
  });

  // Click bulk delete
  if (bulkDeleteBtn){
    bulkDeleteBtn.addEventListener("click", async () => {
      const ids = selectedIds();
      if (!ids.length) return;

      if (!confirm(`Delete ${ids.length} selected package(s)?`)) return;

      const csrf = document.querySelector('input[name="csrf_token"]')?.value || "";

      const res = await fetch(
        "{{ url_for('accounts_profiles.bulk_delete_user_packages', id=user_id) }}",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": csrf
          },
          body: JSON.stringify({ package_ids: ids })
        }
      );

      const data = await res.json();

      if (!data.success) {
        alert(data.error || "Delete failed");
        return;
      }

      window.location.reload();
    });
  }

  toggleBulkBtn();
});

/* ================================
   Inline invoice behaviour (POS)
   ================================ */
function initInlineInvoice(rootElement) {
  const root = rootElement || document;

  const payOverlay      = root.querySelector('#inlinePayOverlay');
  const discountOverlay = root.querySelector('#inlineDiscountOverlay');
  const bdOverlay       = root.querySelector('#inlineBreakdownOverlay');

  const showOverlay = (el) => { if (el) el.classList.remove('d-none'); };
  const hideOverlay = (el) => { if (el) el.classList.add('d-none'); };

  [payOverlay, discountOverlay, bdOverlay].forEach(el => el && el.classList.add('d-none'));

  // Add Payment
  root.querySelectorAll('.js-open-pay').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      if (!payOverlay) return;
      showOverlay(payOverlay);
      setupPaymentLogic();
    });
  });

  // Discount
  root.querySelectorAll('.js-open-discount').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      if (!discountOverlay) return;
      showOverlay(discountOverlay);
      setupDiscountLogic();
    });
  });

  // Close overlay buttons
  root.querySelectorAll('.fa-inline-close').forEach(btn => {
    btn.addEventListener('click', function () {
      const type = this.getAttribute('data-close');
      if (type === 'pay')      hideOverlay(payOverlay);
      if (type === 'discount') hideOverlay(discountOverlay);
      if (type === 'bd')       hideOverlay(bdOverlay);
    });
  });

  function setupPaymentLogic() {
    if (!payOverlay) return;

    const display = payOverlay.querySelector('#payDisplayInline');
    const hidden  = payOverlay.querySelector('#payAmountInputInline');
    if (!display || !hidden) return;

    let current = hidden.value && hidden.value !== '0' ? String(hidden.value) : '0';

    function updateDisplay() {
      let num = parseFloat(current || '0');
      if (isNaN(num)) num = 0;
      hidden.value = num.toFixed(2);
      display.textContent =
        'JMD ' + num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function pushKey(key) {
      if (key === '.') {
        if (current.includes('.')) return;
        current += '.';
      } else if (key === '00') {
        if (current === '0') return;
        current += '00';
      } else {
        if (current === '0') current = key;
        else current += key;
      }
      updateDisplay();
    }

    payOverlay.querySelectorAll('.payment-key-btn').forEach(btn => {
      btn.onclick = function () { pushKey(this.getAttribute('data-key')); };
    });

    payOverlay.querySelectorAll('.payment-quick-btn[data-quick]').forEach(btn => {
      btn.onclick = function () { current = String(this.getAttribute('data-quick') || '0'); updateDisplay(); };
    });

    const clearBtn = payOverlay.querySelector('#payClearBtnInline');
    if (clearBtn) clearBtn.onclick = function () { current = '0'; updateDisplay(); };

    // payment method
    const methodInput = payOverlay.querySelector('#payMethodInputInline');
    const methodList  = payOverlay.querySelector('#paymentMethodListInline');
    if (methodInput && methodList) {
      methodList.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.onclick = function () {
          methodList.querySelectorAll('.payment-method-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          methodInput.value = this.getAttribute('data-method') || 'Cash';
        };
      });
    }

    // authorised by
    const authSelect = payOverlay.querySelector('#authBySelectInline');
    const authInput  = payOverlay.querySelector('#authByInputInline');
    const authHidden = payOverlay.querySelector('#authByHiddenInline');

    if (authSelect && authHidden) {
      if (authSelect.value !== '__other__') authHidden.value = authSelect.value;

      authSelect.addEventListener('change', function () {
        if (this.value === '__other__') {
          if (authInput) {
            authInput.classList.remove('d-none');
            authInput.value = '';
            authInput.focus();
          }
          authHidden.value = '';
        } else {
          if (authInput) authInput.classList.add('d-none');
          authHidden.value = this.value;
        }
      });

      if (authInput) {
        authInput.addEventListener('input', function () {
          if (authSelect.value === '__other__') authHidden.value = this.value;
        });
      }
    }

    updateDisplay();
  }

  function setupDiscountLogic() {
    if (!discountOverlay) return;

    const form = discountOverlay.querySelector('#inlineDiscountForm');
    if (!form) return;

    const balance  = parseFloat(form.getAttribute('data-balance') || '0') || 0;
    const tabs     = discountOverlay.querySelector('#discountTabsInline');
    const panePct  = discountOverlay.querySelector('#discountPercentPaneInline');
    const paneAmt  = discountOverlay.querySelector('#discountAmountPaneInline');
    const pctInput = discountOverlay.querySelector('#discountPercentInputInline');
    const pctLbl   = discountOverlay.querySelector('#discountPercentAmountInline');
    const amtInput = discountOverlay.querySelector('#discountAmountInputInline');
    const hidden   = discountOverlay.querySelector('#discountHiddenAmountInline');

    let mode = tabs?.querySelector('.discount-tab.active')?.getAttribute('data-mode') || 'percent';

    function formatJMD(v) {
      const n = parseFloat(v || '0') || 0;
      return 'JMD ' + n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function recalc() {
      if (!hidden) return;
      if (mode === 'percent') {
        const pct  = parseFloat(pctInput?.value || '0') || 0;
        const disc = Math.max(0, balance * pct / 100);
        hidden.value = disc.toFixed(2);
        if (pctLbl) pctLbl.textContent = formatJMD(disc);
      } else {
        const v = parseFloat(amtInput?.value || '0') || 0;
        hidden.value = v.toFixed(2);
      }
    }

    if (tabs) {
      tabs.querySelectorAll('.discount-tab').forEach(btn => {
        btn.onclick = function () {
          tabs.querySelectorAll('.discount-tab').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          mode = this.getAttribute('data-mode') || 'percent';
          if (panePct && paneAmt) {
            if (mode === 'percent') { panePct.classList.remove('d-none'); paneAmt.classList.add('d-none'); }
            else { panePct.classList.add('d-none'); paneAmt.classList.remove('d-none'); }
          }
          recalc();
        };
      });
    }

    if (pctInput) pctInput.oninput = recalc;
    if (amtInput) amtInput.oninput = recalc;

    recalc();
  }

  // charges breakdown overlay
  if (bdOverlay) {
    const ids = [
      'bd-duty-inline','bd-gct-inline','bd-freight-inline','bd-handling-inline',
      'bd-scf-inline','bd-envl-inline','bd-caf-inline','bd-stamp-inline',
      'bd-other-inline','bd-total-inline'
    ];
    const setField = (id, val) => {
      const el = bdOverlay.querySelector('#' + id);
      if (el) el.textContent = val;
    };

    root.querySelectorAll('.js-bd').forEach(btn => {
      btn.addEventListener('click', function () {
        const pkgId = this.getAttribute('data-pkg');
        if (!pkgId) return;

        ids.forEach(id => setField(id, 'â€¦'));

        fetch("{{ url_for('admin.invoice_breakdown', package_id=0) }}".replace('0', pkgId))
          .then(r => { if (!r.ok) throw new Error(); return r.json(); })
          .then(d => {
            const nf = new Intl.NumberFormat();
            setField('bd-duty-inline',     nf.format(d.duty || 0));
            setField('bd-gct-inline',      nf.format(d.gct || 0));
            setField('bd-freight-inline',  nf.format(d.freight || 0));
            setField('bd-handling-inline', nf.format(d.handling || 0));
            setField('bd-scf-inline',      nf.format(d.scf || 0));
            setField('bd-envl-inline',     nf.format(d.envl || 0));
            setField('bd-caf-inline',      nf.format(d.caf || 0));
            setField('bd-stamp-inline',    nf.format(d.stamp || 0));
            setField('bd-other-inline',    nf.format(d.other || 0));
            setField('bd-total-inline',    nf.format(d.total_jmd || 0));
          })
          .catch(() => ids.forEach(id => setField(id, 'â€”')));

        showOverlay(bdOverlay);
      });
    });
  }
}

function loadInvoiceInline(invoiceId){
  const url = "{{ url_for('admin.view_invoice', invoice_id=0) }}?inline=1"
                .replace('0', String(invoiceId));

  fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
    .then(r => { if(!r.ok) throw new Error('Failed to load invoice'); return r.text(); })
    .then(html => {
      const host = document.getElementById('invoiceInlineHost');
      host.innerHTML = html;
      host.scrollIntoView({ behavior: 'smooth', block: 'start' });
      initInlineInvoice(host);
    })
    .catch(() => alert('âš ï¸ Unable to load invoice inline.'));
}

// Load invoice into modal
function openInvoiceModal(invoiceId) {
  const modalEl  = document.getElementById("invoiceModal");
  const modal    = new bootstrap.Modal(modalEl);
  const bodyEl   = document.getElementById("invoiceModalBody");

  bodyEl.innerHTML = "<p class='text-muted mb-0'>Loading invoiceâ€¦</p>";

  const base = "{{ url_for('admin.view_invoice', invoice_id=0) }}?inline=1";
  const url  = base.replace('0', String(invoiceId));

  fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }})
    .then(r => { if (!r.ok) throw new Error("Failed"); return r.text(); })
    .then(html => {
      bodyEl.innerHTML = html;
      initInlineInvoice(modalEl);
      modal.show();
    });
}

// âœ… Add Single Package via AJAX (no page reload)
document.getElementById('addSinglePackageForm')
  .addEventListener('submit', function (e) {
    e.preventDefault();

    const form = this;
    const formData = new FormData(form);

    fetch(form.getAttribute('action'), {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        alert(data.error || 'Failed to add package');
        return;
      }

      const tbody = document.querySelector('#packagesTable tbody');
      const st = String(data.pkg.status || '').toLowerCase();

      let progressColor = 'secondary';
      if (st === 'overseas') progressColor = 'danger';
      else if (st.includes('local port') || st.includes('received at local port') || st.includes('arrived')) progressColor = 'warning';
      else if (st.includes('ready') || st.includes('pickup') || st.includes('pick up')) progressColor = 'primary';
      else if (st.includes('deliver') || st === 'delivery' || st === 'delivered' || st.includes('out for delivery')) progressColor = 'success';
      else if (st === 'unassigned') progressColor = 'warning';

      const csrf = document.querySelector('input[name="csrf_token"]')?.value || "";
      const attachments = Array.isArray(data.pkg.attachments) ? data.pkg.attachments : [];
      const attachmentsHtml = attachments.length
        ? `
          <div class="mt-1 d-flex flex-wrap gap-2">
            ${attachments.map(a => `
              <a class="btn btn-sm"
                 style="background:#f5f0fa; border:1px solid #4a148c; color:#4a148c; padding:.2rem .45rem;"
                 target="_blank"
                 href="${a.view_url}"
                 title="${(a.original_name || 'Attachment').replace(/"/g, '&quot;')}">
                <i class="fa-solid fa-file-lines"></i>
              </a>

              <form method="POST"
                    action="${a.delete_url}"
                    class="d-inline"
                    onsubmit="return confirm('Delete this attachment?');">
                <input type="hidden" name="csrf_token" value="${csrf}">
                <button type="submit"
                        class="btn btn-sm"
                        style="background:#fff; border:1px solid #dc3545; color:#dc3545; padding:.2rem .45rem;"
                        title="Delete attachment">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </form>
            `).join('')}
          </div>
        `
        : ``;

      const row = `
        <tr>
          <td class="text-center align-middle">
            <input type="checkbox" class="pkg-check" value="${data.pkg.id}">
          </td>

          <td class="pkg-cell">
            <div class="pkg-status-bar bar-${progressColor}"></div>
            <strong>${data.pkg.house_awb || '-'}</strong><br>

            <span class="badge ${
              progressColor === 'danger' ? 'bg-danger' :
              progressColor === 'warning' ? 'bg-warning text-dark' :
              progressColor === 'primary' ? 'bg-primary' :
              progressColor === 'success' ? 'bg-success' : 'bg-secondary'
            }">
              ${data.pkg.status || 'Unknown'}
            </span>

            <div class="status-progress mt-1 ${progressColor}">
              <div class="fill" style="width:${
                progressColor === 'danger' ? 33 :
                progressColor === 'warning' ? (st === 'unassigned' ? 0 : 66) :
                progressColor === 'primary' ? 80 :
                progressColor === 'success' ? 100 : 0
              }%;"></div>
            </div>
          </td>

          <td>
            <div>${data.pkg.description || '-'}</div>
            ${attachmentsHtml}
          </td>

          <td>${data.pkg.tracking_number || '-'}</td>
          <td class="text-start">${data.pkg.weight || ''}</td>
          <td>${data.pkg.date_received || 'â€”'}</td>
          <td class="text-end">$${parseFloat(data.pkg.declared_value || 0).toFixed(2)}</td>
          <td class="text-end">$${parseFloat(data.pkg.amount_due || 0).toFixed(2)}</td>
        </tr>
      `;

      tbody.insertAdjacentHTML('afterbegin', row);

      const newCheckbox = tbody.querySelector('tr:first-child .pkg-check');
      if (newCheckbox) {
        newCheckbox.addEventListener("change", () => {
          const selectAll = document.getElementById("pkgSelectAll");
          const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");

          const checked = document.querySelectorAll(".pkg-check:checked").length;
          if (bulkDeleteBtn) bulkDeleteBtn.disabled = checked === 0;
          if (selectAll && !newCheckbox.checked) selectAll.checked = false;
        });
      }

      const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
      if (bulkDeleteBtn) {
        const checked = document.querySelectorAll(".pkg-check:checked").length;
        bulkDeleteBtn.disabled = checked === 0;
      }

      bootstrap.Modal.getInstance(document.getElementById('addSinglePackageModal')).hide();
      form.reset();
    })
    .catch(() => alert('Server error adding package'));
});

function openDeleteInvoiceModal(invoiceId, invoiceLabel){
  const modalEl = document.getElementById('deleteInvoiceModal');
  const formEl  = document.getElementById('deleteInvoiceForm');
  const labelEl = document.getElementById('delInvoiceLabel');

  if (!modalEl || !formEl) return;

  labelEl.textContent = invoiceLabel || ('Invoice #' + invoiceId);
  formEl.action = "{{ url_for('admin.delete_invoice', invoice_id=0) }}".replace('0', String(invoiceId));

  new bootstrap.Modal(modalEl).show();
}

/* ----------------------------------------------------
   âœ… INVOICE DELETE: redirect back with tab=invoices
   (instead of reload which defaults back to packages)
---------------------------------------------------- */
document.getElementById('deleteInvoiceForm')?.addEventListener('submit', function(e){
  e.preventDefault();

  const form = this;
  const action = form.action;
  const formData = new FormData(form);

  fetch(action, {
    method: 'POST',
    headers: { 'X-Requested-With': 'XMLHttpRequest' },
    body: formData
  })
  .then(r => r.json())
  .then(data => {
    if (!data.success) {
      alert(data.error || 'Delete failed');
      return;
    }

    // âœ… force invoices tab in URL
    const url = new URL(window.location.href);
    url.searchParams.set('tab', 'invoices');
    // keep current invoice page if present
    if (!url.searchParams.get('inv_page')) url.searchParams.set('inv_page', '1');

    window.location.href = url.toString();
  })
  .catch(() => alert('Server error deleting invoice'));
});
</script>
{% endblock %}
