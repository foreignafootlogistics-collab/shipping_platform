{% extends 'layout_admin.html' %}

{# ---- Money formatting macro (place right here) ---- #}
{% macro money(x) -%}{{ '%.2f'|format((x or 0)|float) }}{%- endmacro %}

{% block title %}View User{% endblock %}

{% block content %}
<div class="container mt-4">  
  <!-- PROFILE CARD -->
  <div class="card shadow-sm mb-4 w-100">

    <!-- TOP GREY BAR -->
    <div class="d-flex justify-content-between align-items-center p-2"
         style="background-color:#6c757d; border-bottom:1px solid black; position:relative">

      <!-- Left: Back to Manage Users -->
      <div>
        <a href="{{ url_for('accounts_profiles.manage_users') }}"
           class="text-white text-decoration-none fw-bold">
          <i class="bi bi-arrow-left"></i> Manage Users
        </a>
      </div>

      <!-- Middle: Centered Address Icons + Sensitive Info -->
      <div class="d-flex justify-content-center align-items-center position-absolute start-50 translate-middle-x" style="gap: 13rem;">
        <!-- Icons grouped -->
        <div class="d-flex align-items-center" style="gap: 0.5rem;">
          <i class="bi bi-globe fs-5 text-white cursor-pointer"
             onclick="showAddress('overseas')" title="Overseas Address"></i>
          <i class="bi bi-house-door fs-5 text-white cursor-pointer"
             onclick="showAddress('home')" title="Home Address"></i>
        </div>

        <!-- Sensitive Info button -->
        <button type="button" class="btn btn-outline-light btn-sm"
                data-bs-toggle="modal" data-bs-target="#sensitiveInfoModal">
          <i class="bi bi-shield-lock me-1"></i> Sensitive Info
        </button>
      </div>

      <!-- Right: Account Actions -->
      <div class="d-flex gap-2">
        <!-- Change Password -->
        <form action="{{ url_for('accounts_profiles.change_password', id=user.id) }}"
              method="POST" class="m-0">
          <button type="submit" class="btn btn-outline-light btn-sm">
            <i class="bi bi-key"></i>
          </button>
        </form>

        <!-- Delete Account -->
        <form action="{{ url_for('accounts_profiles.delete_account', id=user.id) }}"
              method="POST" class="m-0">
          <button type="submit"
                  class="btn btn-outline-light btn-sm"
                  onclick="return confirm('Are you sure you want to delete this account?');">
            <i class="bi bi-trash"></i>
          </button>
        </form>

        <!-- Manage Account -->
        <a href="{{ url_for('accounts_profiles.manage_account', id=user.id) }}"
           class="btn btn-outline-light btn-sm">
          <i class="bi bi-pencil-square"></i>
        </a>
      </div>
    </div>

    <!-- CARD BODY (3 SECTIONS) -->
    <div class="card-body d-flex p-3" style="position:relative; z-index:2;">
      <!-- Vertical dividers -->
      <div class="position-absolute top-0 bottom-0" style="left:33.33%; border-left:1px solid black;"></div>
      <div class="position-absolute top-0 bottom-0" style="left:66.66%; border-left:1px solid black;"></div>
      <div class="position-absolute" style="left:0; right:0; bottom:0; border-top:1px solid black;"></div>

      <!-- LEFT COLUMN -->
      <div class="d-flex flex-column align-items-start pe-4" style="flex:1;">
        <!-- Profile Image / Initials -->
        <div class="d-flex align-items-center mb-3">
          {% if user.profile_picture %}
            <img src="{{ url_for('static', filename='profile_pics/' ~ user.profile_picture) }}"
                 alt="Profile" width="80" height="80"
                 class="rounded-circle me-3">
          {% else %}
            <div class="rounded-circle d-flex justify-content-center align-items-center me-3"
                 style="width:80px; height:80px; background-color:#4a148c; color:white;
                        font-family:'Poppins',sans-serif; font-size:28px; font-weight:700;">
              {{ user.full_name.split()[0][0] }}{{ user.full_name.split()[-1][0] }}
            </div>
          {% endif %}

          <h3 class="mb-0"
              style="color:#4a148c; font-family:'Poppins',sans-serif; font-weight:700; font-size:1.6rem;">
            {{ user.full_name }}
            {% if user.registration_number %}
              <span style="font-weight:500; font-size:1.2rem; color:#555;">
                ({{ user.registration_number }})
              </span>
            {% endif %}
          </h3>
        </div>

        <!-- Details -->
        <div class="mb-1"><strong>Email:</strong> {{ user.email }}</div>
        <div class="mb-1"><strong>Mobile:</strong> {{ user.mobile }}</div>
        <div class="mb-1"><strong>Referral Code:</strong> {{ user.referral_code }}</div>
        <div class="mb-1"><strong>Referrer:</strong> {{ user.referrer or 'None' }}</div>
      </div>

      <!-- MIDDLE COLUMN (ADDRESSES) -->
      <div class="d-flex flex-column px-4" style="flex:1;">
        <!-- Overseas Address -->
        <div id="overseas-address">
          <div class="label fw-bold text-dark mt-2">Street</div>
          <div class="value">{{ us_address.address_line1 }}</div>
          <div class="label fw-bold text-dark mt-2">Suite</div>
          <div class="value">{{ us_address.address_line2 }}</div>
          <div class="label fw-bold text-dark mt-2">City/State/ZIP</div>
          <div class="value">{{ us_address.city }}, {{ us_address.state }} {{ us_address.zip }}</div>
        </div>

        <!-- Home Address -->
        <div id="home-address" style="display:none;">
          <div class="label fw-bold text-dark mb-2">Home Address</div>
          <div class="value mb-3">{{ home_address if home_address else "Not set" }}</div>
          <a href="{{ url_for('customer.update_delivery_address') }}"
             class="btn btn-outline-dark btn-sm">Update Address</a>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="d-flex flex-column ps-4" style="flex:1;">
        <div class="mb-1"><strong>Authorized Person:</strong> {{ user.authorized_person or 'None' }}</div>
        <div class="mb-1"><strong>Branch:</strong> Main</div>
        <div class="mb-1"><strong>Status:</strong> {{ 'Active' if user.is_active else 'Inactive' }}</div>
        <div class="mb-1"><strong>Last Login:</strong> {{ user.last_login or 'Never' }}</div>

        <!-- Wallet Icon at the bottom -->
        <div class="position-absolute" style="bottom:1rem; right:1rem;">
          <button class="btn btn-purple btn-lg" 
                  style="font-size:1.5rem; background-color:#6c757d; border:none; color:white; padding:0.75rem 1.25rem;">
            <i class="bi bi-wallet2 me-2"></i> ${{ money(user.wallet_balance) }}
          </button>
        </div>
      </div>
    </div>

    <!-- ATTACHED TABS -->
    <div class="card-header bg-white p-0">
      <ul class="nav nav-tabs card-header-tabs px-3" id="profileTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="prealerts-tab" data-bs-toggle="tab"
                  data-bs-target="#prealerts" type="button" role="tab">
            <i class="bi bi-box-seam me-1"></i> Pre-Alert Shipments
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="packages-tab" data-bs-toggle="tab"
                  data-bs-target="#packages" type="button" role="tab">
            <i class="bi bi-box2 me-1"></i> Packages
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="payments-tab" data-bs-toggle="tab"
                  data-bs-target="#payments" type="button" role="tab">
            <i class="bi bi-credit-card"></i> Payments
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if active_tab == 'invoices' %}active{% endif %}" 
                  id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices" type="button" role="tab">
            <i class="bi bi-receipt"></i> Invoices
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="messages-tab" data-bs-toggle="tab"
                  data-bs-target="#messages" type="button" role="tab">
            <i class="bi bi-envelope me-1"></i> Messages
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="schedule-delivery-tab" data-bs-toggle="tab"
                  data-bs-target="#schedule-delivery" type="button" role="tab">
            <i class="bi bi-truck"></i> Schedule Delivery
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="referrals-tab" data-bs-toggle="tab"
                  data-bs-target="#referrals" type="button" role="tab">
            <i class="bi bi-people me-1"></i> Referrals
          </button>
        </li>
      </ul>
    </div>

    <!-- Tab Content -->
    <div class="tab-content p-3" id="profileTabContent">

      <!-- Packages Tab (server-side pagination; no DataTables init here) -->
      <div class="tab-pane fade show active" id="packages" role="tabpanel" aria-labelledby="packages-tab">
        <div class="table-responsive">
          <table id="packagesTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>House AWB & Status</th>
                <th>Description</th>
                <th>Tracking Number</th>
                <th class="text-end">Weight (lbs)</th>
                <th>Date Received</th>
                <th class="text-end">Declared Value</th>
                <th class="text-end">Amount Due</th>
              </tr>
            </thead>
            <tbody>
              {% for pkg in packages %}
              <tr>
                <td><strong>{{ pkg.house_awb or '-' }}</strong><br><small>Status: {{ pkg.status or '-' }}</small></td>
                <td>{{ pkg.description or '-' }}</td>
                <td>{{ pkg.tracking_number or '-' }}</td>
                <td class="text-end">{{ pkg.weight }}</td>
                <td>{{ pkg.date_received or 'N/A' }}</td>
                <td class="text-end">${{ money(pkg.declared_value) }}</td>
                <td class="text-end">${{ money(pkg.amount_due) }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">No packages found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination footer (INSIDE Packages tab) -->
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">
            Showing {{ pkg_show_from }}–{{ pkg_show_to }} of {{ total_pkgs }}
          </small>

          <ul class="pagination pagination-sm mb-0">
            <!-- First -->
            <li class="page-item {% if pkg_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='packages', pkg_page=1) }}">
                &laquo;&laquo;
              </a>
            </li>

            <!-- Prev -->
            <li class="page-item {% if pkg_page == 1 %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='packages', pkg_page=(pkg_page-1 if pkg_page>1 else 1)) }}">
                &laquo;
              </a>
            </li>

            <!-- Next -->
            <li class="page-item {% if pkg_page == pkg_total_pages %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='packages', pkg_page=(pkg_page+1 if pkg_page < pkg_total_pages else pkg_total_pages)) }}">
                &raquo;
              </a>
            </li>

            <!-- Last -->
            <li class="page-item {% if pkg_page == pkg_total_pages %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('accounts_profiles.view_user', id=user_id, tab='packages', pkg_page=pkg_total_pages) }}">
                &raquo;&raquo;
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Prealerts Tab -->
      <div class="tab-pane fade" id="prealerts" role="tabpanel" aria-labelledby="prealerts-tab">
        <div class="table-responsive">
          <table id="prealertsTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Pre-Alert #</th>
                <th>Vendor</th>
                <th>Courier</th>
                <th>Tracking #</th>
                <th>Purchase Date</th>
                <th>Contents</th>
                <th>Value (USD)</th>
                <th>Invoice</th>
                <th>Submitted On</th>
              </tr>
            </thead>
            <tbody>
              {% for p in prealerts %}
              <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.vendor_name }}</td>
                <td>{{ p.courier_name }}</td>
                <td>{{ p.tracking_number }}</td>
                <td>{{ p.purchase_date }}</td>
                <td>{{ p.package_contents }}</td>
                <td>${{ money(p.item_value_usd) }}</td>
                <td>
                  {% if p.invoice_filename %}
                    <a href="{{ url_for('static', filename='uploads/invoices/' ~ p.invoice_filename) }}" target="_blank">View</a>
                  {% else %}N/A{% endif %}
                </td>
                <td>{{ p.created_at }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Invoices Tab -->
      <div class="tab-pane fade {% if active_tab == 'invoices' %}show active{% endif %}" id="invoices" role="tabpanel">
        <div class="mb-3">
          <strong>Total Owed:</strong>  ${{ money(total_owed) }} |
          <strong>Total Paid:</strong>  ${{ money(total_paid) }} |
          <strong>Balance:</strong>     ${{ money(balance) }}

          <a href="{{ url_for('admin.generate_pdf_invoice', user_id=user.id) }}" class="btn btn-sm btn-outline-secondary float-end">Export PDF</a>
        </div>
        <div class="table-responsive">
          <table id="invoiceTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Due Date</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for invoice in invoices %}
              <tr data-invoice-id="{{ invoice[0] }}">
                <td>{{ invoice[0] }}</td>
                <td>{{ invoice[1] or 'No description' }}</td>
                <td>${{ money(invoice[2]) }}</td>
                <td>{{ invoice[3] }}</td>
                <td>
                  <span class="badge {% if invoice[4] == 'paid' %}bg-success{% else %}bg-danger{% endif %}">{{ invoice[4] }}</span>
                </td>
                <td class="text-nowrap">
                  <button type="button" class="btn btn-sm btn-outline-purple"
                          onclick="loadInvoiceInline({{ invoice[0] }})" title="View inline">
                    <i class="bi bi-file-earmark-text"></i>
                  </button>
                  {% if invoice[4] != 'paid' %}
                    <button class="btn btn-sm btn-success mark-paid-btn" data-invoice-id="{{ invoice[0] }}">
                      Mark as Paid
                    </button>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div id="invoiceInlineHost" class="mt-3"></div>
      </div>

      <!-- Payments Tab -->
      <div class="tab-pane fade" id="payments" role="tabpanel" aria-labelledby="payments-tab">
        <h5 class="mt-3">Payments</h5>
        <div class="table-responsive">
          <table id="paymentsTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Bill #</th>
                <th>Date of Payment</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Authorized By</th>
                <th>Invoice</th>
              </tr>
            </thead>
            <tbody>
              {% for payment in payments %}
              <tr>
                <td>{{ payment.bill_number }}</td>
                <td>{{ payment.payment_date }}</td>
                <td>{{ payment.payment_type }}</td>
                <td>${{ money(payment.amount) }}</td>
                <td>{{ payment.authorized_by }}</td>
                <td>
                  {% if payment.invoice_path %}
                    <a href="{{ url_for('static', filename=payment.invoice_path) }}" target="_blank"><i class="fas fa-file-invoice fa-lg"></i></a>
                  {% else %}—{% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Messages Tab -->
      <div class="tab-pane fade" id="messages" role="tabpanel" aria-labelledby="messages-tab">
        <div class="table-responsive">
          <table id="messagesTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Subject</th>
                <th>Message</th>
                <th>Date Sent</th>
              </tr>
            </thead>
            <tbody>
              {% for msg in messages %}
              <tr>
                <td>{{ msg.subject }}</td>
                <td>{{ msg.body }}</td>
                <td>{{ msg.date_sent }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Schedule Delivery Tab -->
      <div class="tab-pane fade" id="schedule-delivery" role="tabpanel" aria-labelledby="schedule-delivery-tab">
        <div class="mb-3">
          <button class="btn btn-primary mb-3" id="adminAddDeliveryBtn">+ Add Delivery</button>
        </div>
        <div class="table-responsive">
          <table id="scheduledeliveryTable" class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Location</th>
                <th>Person Receiving</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for delivery in deliveries %}
              <tr>
                <td>{{ delivery.date }}</td>
                <td>{{ delivery.time }}</td>
                <td>{{ delivery.location }}</td>
                <td>{{ delivery.person_receiving }}</td>
                <td>{{ delivery.status }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Referrals Tab -->
      <div class="tab-pane fade" id="referrals" role="tabpanel" aria-labelledby="referrals-tab">
        <p>Referrals details go here.</p>
      </div>
    </div>
  </div>

  <!-- Admin Schedule Delivery Modal -->
  <div class="modal fade" id="adminDeliveryModal" tabindex="-1" aria-labelledby="adminDeliveryLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="adminDeliveryForm">
          <div class="modal-header">
            <h5 class="modal-title" id="adminDeliveryLabel">Schedule Delivery</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="modalUserId" name="user_id">
            <div class="row g-2">
              <div class="col-md-4"><label>Date</label><input type="date" class="form-control" id="modalDeliveryDate" required></div>
              <div class="col-md-4"><label>Time</label><input type="time" class="form-control" id="modalDeliveryTime" required></div>
              <div class="col-md-4"><label>Location</label><input type="text" class="form-control" id="modalDeliveryLocation" required></div>
            </div>
            <div class="row mt-2 g-2">
              <div class="col-md-6"><label>Person Receiving</label><input type="text" class="form-control" id="modalPersonReceiving"></div>
              <div class="col-md-6"><label>Mobile #</label><input type="text" class="form-control" id="modalDeliveryMobile"></div>
            </div>
            <div class="mt-2">
              <label>Directions</label>
              <textarea class="form-control" id="modalDeliveryDirections"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Schedule Delivery</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Wallet Modal -->
  <div class="modal fade" id="editWalletModal" tabindex="-1" aria-labelledby="editWalletLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editWalletForm" method="POST">
          <div class="modal-header">
            <h5 class="modal-title" id="editWalletLabel">Edit Wallet Balance</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="amount" class="form-label">Amount</label>
              <input type="number" step="0.01" name="amount" id="amount" class="form-control" required>
              <div class="form-text">Use a negative value to subtract</div>
            </div>
            <div class="mb-3">
              <label for="description" class="form-label">Description (optional)</label>
              <input type="text" name="description" id="description" class="form-control">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Update Wallet</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Mark Paid Modal -->
  <div class="modal fade" id="markPaidModal" tabindex="-1" aria-labelledby="markPaidLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="markPaidForm" method="POST">
          <div class="modal-header">
            <h5 class="modal-title" id="markPaidLabel">Mark Invoice as Paid</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="invoice_id" id="modalInvoiceId">
            <div class="mb-3">
              <label for="payment_amount" class="form-label">Amount</label>
              <input type="number" step="0.01" name="payment_amount" id="payment_amount" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="payment_type" class="form-label">Payment Type</label>
              <select name="payment_type" id="payment_type" class="form-select" required>
                <option value="cash">Cash</option>
                <option value="card">Card</option>
                <option value="bank_transfer">Bank Transfer</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="authorized_by" class="form-label">Authorized By</label>
              <input type="text" name="authorized_by" id="authorized_by" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Confirm Payment</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Quick Add Delivery Modal -->
  <div class="modal fade" id="adminAddDeliveryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="adminAddDeliveryForm" method="POST">
          <div class="modal-header">
            <h5 class="modal-title">Add Delivery</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2"><input type="date" name="date" class="form-control" required></div>
            <div class="mb-2"><input type="time" name="time" class="form-control" required></div>
            <div class="mb-2"><input type="text" name="location" placeholder="Location" class="form-control" required></div>
            <div class="mb-2"><input type="text" name="person_receiving" placeholder="Person Receiving" class="form-control" required></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Save Delivery</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block styles %}
<style>
/* ---------- Tabs: Base ---------- */
.card-header .nav-tabs {
  border-bottom: 0 !important;
  margin-bottom: -1px;
  padding-left: 1rem;
  padding-right: 1rem;
}
.card-header .nav-tabs .nav-link {
  font-family: 'Poppins', sans-serif;
  color: #fff !important;
  background-color: #4a148c !important;
  border: 1px solid transparent !important;
  border-radius: 0.25rem 0.25rem 0 0;
  transition: background-color 0.2s;
}
.card-header .nav-tabs .nav-link:hover {
  background-color: #6a1b9a !important;
  color: #fff !important;
}
.card-header .nav-tabs .nav-link.active,
.card-header .nav-tabs .nav-item.show .nav-link {
  color: #fff !important;
  background-color: #4a148c !important;
  border-color: #4a148c #4a148c #fff !important;
  font-weight: 600;
}
.card-header .nav-tabs.card-header-tabs { margin-bottom: 0; }
</style>
{% endblock %}

{% block scripts %}
<script>
/* Expose this globally for inline onclick icons */
function showAddress(type) {
  document.getElementById("overseas-address").style.display = (type === 'overseas') ? 'block' : 'none';
  document.getElementById("home-address").style.display = (type === 'home') ? 'block' : 'none';
}

$(document).ready(function () {
  /* IMPORTANT: Do NOT initialize DataTables for #packagesTable because we use server-side pagination */
  // $('#packagesTable').DataTable();  // <-- removed

  // Other tabs can use DataTables
  $('#prealertsTable').DataTable({ order: [[0, 'desc']], pageLength: 10 });
  $('#invoiceTable').DataTable();
  $('#paymentsTable').DataTable();
  $('#messagesTable').DataTable();
  $('#scheduledeliveryTable').DataTable();

  // Quick add delivery launcher
  document.getElementById("adminAddDeliveryBtn").onclick = () => {
    new bootstrap.Modal(document.getElementById('adminAddDeliveryModal')).show();
  };

  // Full admin delivery modal launcher
  document.querySelectorAll('.open-admin-delivery-modal').forEach(btn => {
    btn.addEventListener('click', function() {
      const userId = this.getAttribute('data-user-id');
      document.getElementById('modalUserId').value = userId;
      document.getElementById('adminDeliveryForm').reset();
      new bootstrap.Modal(document.getElementById('adminDeliveryModal')).show();
    });
  });

  // Submit full admin delivery form (big modal)
  document.getElementById('adminDeliveryForm').addEventListener('submit', function(e){
    e.preventDefault();
    const payload = {
      user_id: document.getElementById('modalUserId').value,
      date: document.getElementById('modalDeliveryDate').value,
      time: document.getElementById('modalDeliveryTime').value,
      location: document.getElementById('modalDeliveryLocation').value,
      person_receiving: document.getElementById('modalPersonReceiving').value,
      mobile: document.getElementById('modalDeliveryMobile').value,
      directions: document.getElementById('modalDeliveryDirections').value
    };
    fetch("{{ url_for('logistics.add_scheduled_delivery') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === "success"){
        alert('Delivery scheduled successfully!');
        bootstrap.Modal.getInstance(document.getElementById('adminDeliveryModal')).hide();
      } else {
        alert(data.message || 'Error scheduling delivery.');
      }
    });
  });

  // Submit quick add delivery form (small modal)
  document.getElementById("adminAddDeliveryForm").onsubmit = function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{{ url_for('logistics.add_scheduled_delivery', user_id=user.id) }}", {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === "success"){
        const tbody = document.querySelector("#scheduledeliveryTable tbody");
        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${data.delivery.date}</td>
            <td>${data.delivery.time}</td>
            <td>${data.delivery.location}</td>
            <td>${data.delivery.person_receiving}</td>
            <td>${data.delivery.status}</td>
          </tr>
        `);
        bootstrap.Modal.getInstance(document.getElementById('adminAddDeliveryModal')).hide();
      }
    });
  };

  // Mark as Paid Modal
  $('.mark-paid-btn').click(function () {
    const invoiceId = $(this).data('invoice-id');
    $('#modalInvoiceId').val(invoiceId);
    $('#payment_amount').val($(this).closest('tr').find('td:nth-child(3)').text().replace('$',''));
    new bootstrap.Modal(document.getElementById('markPaidModal')).show();
  });

  $('#markPaidForm').submit(function (e) {
    e.preventDefault();
    const formData = $(this).serialize();
    fetch("/admin/invoice/mark_paid", {
      method: 'POST',
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/x-www-form-urlencoded"
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const row = $(`tr[data-invoice-id="${data.invoice_id}"]`);
        row.find('span.badge').removeClass('bg-danger').addClass('bg-success').text('paid');
        row.find('.mark-paid-btn').remove();

        $('#paymentsTable').DataTable().row.add([
          data.bill_number,
          data.payment_date,
          data.payment_type,
          `$${parseFloat(data.amount).toFixed(2)}`,
          data.authorized_by,
          data.invoice_path ? `<a href="${data.invoice_path}" target="_blank"><i class="fas fa-file-invoice fa-lg"></i></a>` : '—'
        ]).draw();

        bootstrap.Modal.getInstance(document.getElementById('markPaidModal')).hide();
      } else {
        alert(data.error || 'Error marking invoice as paid.');
      }
    });
  });
});

// Inline invoice loader
function loadInvoiceInline(invoiceId){
  const url = "{{ url_for('admin.view_invoice', invoice_id=0) }}?inline=1".replace('0', String(invoiceId));
  fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
    .then(r => { if(!r.ok) throw new Error('Failed to load invoice'); return r.text(); })
    .then(html => {
      const host = document.getElementById('invoiceInlineHost');
      host.innerHTML = html;
      host.scrollIntoView({ behavior: 'smooth', block: 'start' });
    })
    .catch(() => alert('⚠️ Unable to load invoice inline.'));
}
</script>
{% endblock %}
