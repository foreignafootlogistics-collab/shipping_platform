<!-- Admin Inline Calculator Modal -->
<div class="modal fade" id="adminCalculatorModal" tabindex="-1" aria-labelledby="adminCalculatorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-purple text-white rounded-top-4">
        <h5 class="modal-title" id="adminCalculatorModalLabel">Customs & Freight Calculator</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">

        <!-- Admin Calculator Form -->
        <form id="adminCalculatorForm" method="POST" class="row g-3">
          {{ admin_calculator_form.hidden_tag() }}

          <div class="col-md-6">
            {{ admin_calculator_form.category.label(class="form-label") }}
            {{ admin_calculator_form.category(class="form-select", required=True) }}
          </div>

          <div class="col-md-3">
            {{ admin_calculator_form.invoice_usd.label(class="form-label") }}
            {{ admin_calculator_form.invoice_usd(class="form-control", step="0.01", required=True) }}
          </div>

          <div class="col-md-3">
            {{ admin_calculator_form.weight.label(class="form-label") }}
            {{ admin_calculator_form.weight(class="form-control", step="1", required=True) }}
          </div>

          <div class="col-12 mt-2">
            {{ admin_calculator_form.submit(class="btn btn-purple w-100 py-2 fw-bold") }}
          </div>
        </form>

        <!-- Calculation Result -->
        <div id="adminCalculatorResult" class="mt-4" style="display:none;">
          <div class="row g-3">

            <!-- Customs Charges -->
            <div class="col-md-6">
              <div class="card p-3 shadow-sm">
                <h6 class="fw-bold text-purple mb-3">Customs Charges</h6>
                <div><b>Base JMD:</b> <span id="admin_base_jmd"></span></div>
                <div><b>Duty:</b> <span id="admin_duty"></span></div>
                <div><b>SCF:</b> <span id="admin_scf"></span></div>
                <div><b>ENVL:</b> <span id="admin_envl"></span></div>
                <div><b>CAF:</b> <span id="admin_caf"></span></div>
                <div><b>GCT:</b> <span id="admin_gct"></span></div>
                <div><b>Stamp:</b> <span id="admin_stamp"></span></div>
                <div class="fw-bold mt-2"><b>Customs Total:</b> <span id="admin_customs_total"></span></div>
              </div>
            </div>

            <!-- Freight Charges -->
            <div class="col-md-6">
              <div class="card p-3 shadow-sm">
                <h6 class="fw-bold text-purple mb-3">Freight Charges</h6>
                <div><b>Freight:</b> <span id="admin_freight"></span></div>
                <div><b>Handling:</b> <span id="admin_handling"></span></div>
                <div class="fw-bold mt-2"><b>Freight Total:</b> <span id="admin_freight_total"></span></div>
              </div>
            </div>

            <!-- Grand Total -->
            <div class="col-12">
              <div class="card p-3 shadow-sm bg-purple text-white fw-bold text-center">
                <b>Grand Total:</b> <span id="admin_grand_total"></span>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Styles -->
<style>
.bg-purple { background-color: #4a148c !important; }
.text-purple { color: #4a148c !important; }
.btn-purple { background-color: #4a148c; color: #fff; }
.btn-purple:hover { background-color: #3a0f63; color: #fff; }
.card { border-radius: 0.75rem; }
@media (max-width: 576px) {
  #adminCalculatorForm .col-md-6, 
  #adminCalculatorForm .col-md-3 { flex: 0 0 100%; max-width: 100%; }
}
</style>

<!-- Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('adminCalculatorForm');

  if(form){
    form.addEventListener('submit', async function(e){
      e.preventDefault();

      const csrfToken = form.querySelector('input[name="csrf_token"]').value;
      const payload = {
        category: form.category.value,
        invoice_usd: parseFloat(form.invoice_usd.value),
        weight: parseFloat(form.weight.value),
        csrf_token: csrfToken
      };

      try {
        const res = await fetch('{{ url_for("admin_calculator.admin_calculator") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if(data.error){
          alert(data.error);
          return;
        }

        // Update Customs
        ["base_jmd","duty","scf","envl","caf","gct","stamp","customs_total"].forEach(f=>{
          const el = document.getElementById('admin_'+f);
          if(el && data[f] !== undefined) el.innerText = parseFloat(data[f]).toLocaleString();
        });

        // Update Freight
        ["freight","handling","freight_total"].forEach(f=>{
          const el = document.getElementById('admin_'+f);
          if(el && data[f] !== undefined) el.innerText = parseFloat(data[f]).toLocaleString();
        });

        // Grand total
        const grandEl = document.getElementById('admin_grand_total');
        if(grandEl){
          const customs = parseFloat(data.customs_total) || 0;
          const freight = parseFloat(data.freight_total) || 0;
          grandEl.innerText = (customs + freight).toLocaleString();
        }

        document.getElementById('adminCalculatorResult').style.display = 'block';

      } catch(err){
        console.error(err);
        alert('Calculation failed. Please try again.');
      }
    });
  }
});
</script>
