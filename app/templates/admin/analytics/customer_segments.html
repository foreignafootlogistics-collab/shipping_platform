{% extends 'layout_admin.html' %}
{% block title %}Analytics & Insights — Customer Segments{% endblock %}

{% block content %}
<div class="container-fluid">
  <h2 class="fw-bold" style="color:#4a148c;">Analytics &amp; Insights — Customer Segments</h2>
  <p class="text-muted mb-4">
    Segmentation based on the number of packages per customer in the last 90 days
    (from {{ d90.isoformat() }} to {{ today.isoformat() }}).
  </p>

  <!-- TOP SUMMARY ROW -->
  <div class="row g-4 mb-4">
    <!-- Total Customers -->
    <div class="col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">
            <i class="bi bi-people-fill me-1"></i> Total Customers
          </h6>
          <h3 class="mb-0">{{ total_customers }}</h3>
          <small class="text-muted">All registered customers</small>
        </div>
      </div>
    </div>

    <!-- Active (Last 90 days) -->
    <div class="col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">
            <i class="bi bi-lightning-charge-fill me-1"></i> Active (Last 90 Days)
          </h6>
          <h3 class="mb-0">{{ active_customers_90 }}</h3>
          <small class="text-muted">
            With at least 1 shipment in the last 90 days
          </small>
        </div>
      </div>
    </div>

    <!-- Inactive (Last 90 days) -->
    <div class="col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">
            <i class="bi bi-person-x-fill me-1"></i> Inactive (Last 90 Days)
          </h6>
          <h3 class="mb-0">{{ inactive_customers_90 }}</h3>
          <small class="text-muted">
            No shipments in the last 90 days
          </small>
        </div>
      </div>
    </div>

    <!-- Avg Shipments per Active -->
    <div class="col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">
            <i class="bi bi-bar-chart-line-fill me-1"></i> Avg Shipments / Active
          </h6>
          <h3 class="mb-0">
            {{ avg_shipments_per_active }}
          </h3>
          <small class="text-muted">
            Average shipments (last 90 days) for active customers
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- SEGMENT DISTRIBUTION: CHART + TABLE -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Customer Segment Distribution</h5>
        </div>
        <div class="card-body">
          <canvas id="segmentsChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <h5 class="mb-0">Segment Breakdown</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-sm mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Segment</th>
                  <th class="text-end">Customers</th>
                  <th class="text-end">% of Total</th>
                </tr>
              </thead>
              <tbody>
                {% if segment_stats and segment_stats|length > 0 %}
                  {% for row in segment_stats %}
                    <tr>
                      <td>{{ row.label }}</td>
                      <td class="text-end">{{ row.count }}</td>
                      <td class="text-end">{{ row.percent }}%</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="3" class="text-center text-muted py-3">
                      No segmentation data available.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SEGMENT DETAIL TABLES -->
  <div class="row g-4 mb-4">
    <!-- Occasional -->
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">
            <i class="bi bi-calendar-event me-2"></i>Occasional (1–2 shipments)
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped mb-0 table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Reg #</th>
                  <th class="text-end">Shipments (90d)</th>
                </tr>
              </thead>
              <tbody>
                {% if customers_occasional and customers_occasional|length > 0 %}
                  {% for u in customers_occasional %}
                    <tr>
                      <td>{{ u.full_name }}</td>
                      <td>{{ u.registration_number }}</td>
                      <td class="text-end">{{ u.shipments_90 }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="3" class="text-center text-muted py-3">
                      No occasional customers in this period.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Regular -->
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-repeat me-2"></i>Regular (3–5 shipments)
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped mb-0 table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Reg #</th>
                  <th class="text-end">Shipments (90d)</th>
                </tr>
              </thead>
              <tbody>
                {% if customers_regular and customers_regular|length > 0 %}
                  {% for u in customers_regular %}
                    <tr>
                      <td>{{ u.full_name }}</td>
                      <td>{{ u.registration_number }}</td>
                      <td class="text-end">{{ u.shipments_90 }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="3" class="text-center text-muted py-3">
                      No regular customers in this period.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Power Users -->
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-lightning-fill me-2"></i>Power Users (6+ shipments)
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped mb-0 table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Reg #</th>
                  <th class="text-end">Shipments (90d)</th>
                </tr>
              </thead>
              <tbody>
                {% if customers_power and customers_power|length > 0 %}
                  {% for u in customers_power %}
                    <tr>
                      <td>{{ u.full_name }}</td>
                      <td>{{ u.registration_number }}</td>
                      <td class="text-end">{{ u.shipments_90 }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="3" class="text-center text-muted py-3">
                      No power users in this period.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info note -->
  <div class="alert alert-info small">
    <strong>How this works:</strong>
    <ul class="mb-0">
      <li>We count shipments per customer using package dates (received/created) in the last 90 days.</li>
      <li>Customers are grouped as:
        0 = No Shipments, 1–2 = Occasional, 3–5 = Regular, 6+ = Power Users.
      </li>
      <li>Only the first 10 customers per segment are shown in the tables for brevity.</li>
    </ul>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const segmentLabels = {{ segment_labels|tojson }};
    const segmentCounts = {{ segment_counts|tojson }};

    (function () {
      const ctx = document.getElementById('segmentsChart');
      if (!ctx) return;

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: segmentLabels,
          datasets: [{
            data: segmentCounts
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    })();
  </script>
{% endblock %}
