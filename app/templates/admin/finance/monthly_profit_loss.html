{% extends 'layout_admin.html' %}
{% block title %}Monthly Profit & Loss{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Monthly Profit / Loss</h2>

  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card border-success">
        <div class="card-body">
          <h5>Total Income</h5>
          <p class="fs-4 text-success">${{ "%.2f"|format(total_income) }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-danger">
        <div class="card-body">
          <h5>Total Expenses</h5>
          <p class="fs-4 text-danger">${{ "%.2f"|format(total_expenses) }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-primary">
        <div class="card-body">
          <h5>Net Profit / Loss</h5>
          <p class="fs-4 {% if net_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
            ${{ "%.2f"|format(net_profit) }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Profit/Loss Chart -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title mb-3">Monthly Profit/Loss Chart</h5>
      <canvas id="profitChart" height="100"></canvas>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const canvas = document.getElementById('profitChart');

  // Prepare data from backend summary
  const months  = {{ (summary | map(attribute='month')  | list | default([])) | tojson }};
  const profits = {{ (summary | map(attribute='profit') | list | default([])) | tojson }};

  // If no data, show message and stop
  if (!months.length || !profits.length) {
    canvas.replaceWith(
      Object.assign(document.createElement('div'), {
        className: 'alert alert-warning mb-0',
        innerText: 'No profit/loss data yet (no paid invoices or expenses found).'
      })
    );
  } else {
    // Convert "YYYY-MM" → "Mon YYYY"
    function formatMonth(label) {
      const parts = String(label).split("-");
      if (parts.length !== 2) return label;
      const year = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      if (!year || !month) return label;
      const date = new Date(year, month - 1, 1);
      return date.toLocaleString("en-US", { month: "short", year: "numeric" });
    }

    const prettyMonths = months.map(formatMonth);

    // Set bar colors based on positive/negative
    const barColors = profits.map(p => p >= 0
      ? 'rgba(75, 192, 192, 0.7)'
      : 'rgba(255, 99, 132, 0.7)'
    );

    new Chart(canvas, {
      type: 'bar',
      data: {
        labels: prettyMonths,   // ✅ fixed case
        datasets: [{
          label: 'Profit / Loss ($)',
          data: profits,
          backgroundColor: barColors,
          borderRadius: 5,
          barThickness: 40
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Amount ($)' }
          },
          x: {
            title: { display: true, text: 'Month' }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const val = Number(context.raw || 0);
              return '$' + val.toFixed(2);
            }
          }
        }
      }
    });
  }
</script>
{% endblock %}
