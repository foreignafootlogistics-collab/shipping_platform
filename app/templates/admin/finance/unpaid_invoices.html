{% extends 'layout_admin.html' %}
{% block title %}Receivables — Issued / Unpaid{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Receivables <small class="text-muted">Issued / Unpaid</small></h3>
    <h5 class="text-warning mb-0">Total Due: ${{ '%.2f'|format((total_due or 0)|float) }}</h5>
  </div>

  <!-- ✅ Filters (GET) -->
  <form class="card shadow-sm mb-3" method="get" action="{{ url_for('finance.unpaid_invoices') }}">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-2">
          <label class="form-label mb-0 small">Start</label>
          <input type="date" name="start" value="{{ start }}" class="form-control">
        </div>

        <div class="col-md-2">
          <label class="form-label mb-0 small">End</label>
          <input type="date" name="end" value="{{ end }}" class="form-control">
        </div>

        <div class="col-md-3">
          <label class="form-label mb-0 small">Customer (name or reg #)</label>
          <input type="text" name="q" value="{{ q }}" placeholder="Search…" class="form-control">
        </div>

        <div class="col-md-2">
          <label class="form-label mb-0 small">Min Due</label>
          <input type="number" step="0.01" name="min_due" value="{{ min_due }}" class="form-control">
        </div>

        <div class="col-md-2">
          <label class="form-label mb-0 small">Max Due</label>
          <input type="number" step="0.01" name="max_due" value="{{ max_due }}" class="form-control">
        </div>

        <div class="col-md-1">
          <label class="form-label mb-0 small">Status</label>
          <select name="status" class="form-select">
            <option value="issued,unpaid,pending" {{ 'selected' if status_selected=='issued,unpaid,pending' }}>All Open</option>
            <option value="issued,unpaid" {{ 'selected' if status_selected=='issued,unpaid' }}>Issued + Unpaid</option>
            <option value="issued" {{ 'selected' if status_selected=='issued' }}>Issued</option>
            <option value="unpaid" {{ 'selected' if status_selected=='unpaid' }}>Unpaid</option>
            <option value="pending" {{ 'selected' if status_selected=='pending' }}>Pending</option>
          </select>
        </div>
      </div>

      <div class="mt-3 d-flex gap-2 align-items-center flex-wrap">
        <button class="btn btn-primary" type="submit">Apply</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('finance.unpaid_invoices') }}">Reset</a>

        <div class="ms-auto d-flex align-items-center gap-2">
          <span class="small text-muted">
            issued: {{ status_counts.get('issued',0) }}
            • unpaid: {{ status_counts.get('unpaid',0) }}
            • pending: {{ status_counts.get('pending',0) }}
          </span>
        </div>
      </div>
    </div>
  </form>

  <!-- ✅ Bulk actions (POST) -->
  <form method="POST"
        action="{{ url_for('finance.bulk_mark_invoices_paid', start=start, end=end, q=q, status=status_selected, min_due=min_due, max_due=max_due) }}"
        onsubmit="return confirm('Mark selected invoices as PAID?');">

    {# ✅ Always include CSRF if you use Flask-WTF globally #}
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="d-flex gap-2 mb-2 align-items-center flex-wrap">
      <button class="btn btn-success btn-sm" type="submit">
        ✅ Mark Selected Paid
      </button>

      <button class="btn btn-outline-secondary btn-sm" type="button" id="btnSelectAll">
        Select all on page
      </button>

      <button class="btn btn-outline-secondary btn-sm" type="button" id="btnClearAll">
        Clear
      </button>

      <div class="ms-auto d-flex align-items-center gap-2">
        <label class="small text-muted mb-0" for="dtPageSize">Show</label>
        <select id="dtPageSize" class="form-select form-select-sm" style="width:110px;">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="200">200</option>
          <option value="500">500</option>
        </select>
        <div class="small text-muted" id="selectedCount">0 selected</div>
      </div>
    </div>

    <div class="table-responsive shadow-sm">
      <table id="unpaidTable" class="table table-striped table-hover align-middle w-100">
        <thead class="table-dark">
          <tr>
            <th style="width:30px;">
              <input type="checkbox" id="checkAll">
            </th>
            <th>Invoice #</th>
            <th>Customer</th>
            <th>Reg #</th>
            <th>Status</th>
            <th class="text-end">Amount Due</th>
            <th>Date Issued</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody>
          {% if invoices %}
            {% for r in invoices %}
            <tr>
              <td>
                <input class="row-check"
                       type="checkbox"
                       name="invoice_ids[]"
                       value="{{ r['invoice_id'] }}">
              </td>

              <td>
                <a href="{{ url_for('admin.view_invoice', invoice_id=r['invoice_id']) }}"
                   class="text-decoration-none">
                  {{ r['invoice_number'] or r['invoice_id'] }}
                </a>
              </td>

              <td>{{ r['customer'] }}</td>
              <td>{{ r['registration_number'] }}</td>

              <td>
                {% set s = (r['status'] or '')|lower %}
                <span class="badge
                  {% if s == 'issued' %}bg-info
                  {% elif s == 'pending' %}bg-secondary
                  {% elif s == 'unpaid' %}bg-warning
                  {% else %}bg-light text-dark
                  {% endif %}">
                  {{ r['status']|capitalize }}
                </span>
              </td>

              <td class="text-end">
                ${{ '%.2f'|format((r['amount_due'] or 0)|float) }}
              </td>

              <td>{{ r['date_issued'] }}</td>

              <td>
                <a href="{{ url_for('admin.view_invoice', invoice_id=r['invoice_id']) }}"
                   class="btn btn-sm btn-outline-primary">
                  View
                </a>
              </td>
            </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>

      {% if not invoices %}
        <div class="alert alert-info text-center mb-0">
          No matching invoices.
        </div>
      {% endif %}
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
  function updateSelectedCount() {
    const n = document.querySelectorAll('.row-check:checked').length;
    const el = document.getElementById('selectedCount');
    if (el) el.textContent = `${n} selected`;
  }

  $(function(){
    if ($.fn.DataTable.isDataTable('#unpaidTable')) {
      $('#unpaidTable').DataTable().destroy();
    }

    const table = $('#unpaidTable').DataTable({
      stateSave: false,
      pageLength: 15,
      lengthChange: false, // ✅ we control via our own dropdown
      dom: 'Bfrtip',
      buttons: ['copyHtml5','excelHtml5','csvHtml5','print'],
      columnDefs: [
        { targets: [0], orderable: false },
        { targets: [5], className: 'text-end' }
      ]
    });

    // external page size dropdown
    $('#dtPageSize').val('15'); // default to match pageLength
    $('#dtPageSize').on('change', function(){
      table.page.len(parseInt(this.value || '15', 10)).draw();
    });

    // header check all (current page)
    $('#checkAll').on('change', function(){
      const checked = this.checked;
      table.rows({ page: 'current' }).nodes().to$().find('input.row-check').prop('checked', checked);
      updateSelectedCount();
    });

    $('#btnSelectAll').on('click', function(){
      table.rows({ page: 'current' }).nodes().to$().find('input.row-check').prop('checked', true);
      $('#checkAll').prop('checked', true);
      updateSelectedCount();
    });

    $('#btnClearAll').on('click', function(){
      $('input.row-check').prop('checked', false);
      $('#checkAll').prop('checked', false);
      updateSelectedCount();
    });

    $(document).on('change', 'input.row-check', updateSelectedCount);

    table.on('draw', function(){
      updateSelectedCount();
      $('#checkAll').prop('checked', false);
    });

    updateSelectedCount();
  });
</script>
{% endblock %}
