{% extends 'layout_admin.html' %}
{% block title %}Receivables — Issued / Unpaid{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Receivables <small class="text-muted">Issued / Unpaid</small></h3>
    <h5 class="text-warning mb-0">Total Due: ${{ '%.2f'|format((total_due or 0)|float) }}</h5>
  </div>

  <form class="card shadow-sm mb-3" method="get">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-2"><label class="form-label mb-0 small">Start</label>
          <input type="date" name="start" value="{{ start }}" class="form-control"></div>
        <div class="col-md-2"><label class="form-label mb-0 small">End</label>
          <input type="date" name="end" value="{{ end }}" class="form-control"></div>
        <div class="col-md-3"><label class="form-label mb-0 small">Customer (name or reg #)</label>
          <input type="text" name="q" value="{{ q }}" placeholder="Search…" class="form-control"></div>
        <div class="col-md-2"><label class="form-label mb-0 small">Min Due</label>
          <input type="number" step="0.01" name="min_due" value="{{ min_due }}" class="form-control"></div>
        <div class="col-md-2"><label class="form-label mb-0 small">Max Due</label>
          <input type="number" step="0.01" name="max_due" value="{{ max_due }}" class="form-control"></div>
        <div class="col-md-1"><label class="form-label mb-0 small">Status</label>
          <select name="status" class="form-select">
            <option value="issued,unpaid" {{ 'selected' if status_selected=='issued,unpaid' }}>Both</option>
            <option value="issued" {{ 'selected' if status_selected=='issued' }}>Issued</option>
            <option value="unpaid" {{ 'selected' if status_selected=='unpaid' }}>Unpaid</option>
          </select>
        </div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary">Apply</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('finance.unpaid_invoices') }}">Reset</a>
        <div class="ms-auto small text-muted">
          issued: {{ status_counts.get('issued',0) }} • unpaid: {{ status_counts.get('unpaid',0) }}
        </div>
      </div>
    </div>
  </form>

  <div class="table-responsive shadow-sm">
    <table id="unpaidTable" class="table table-striped table-hover align-middle w-100">
      <thead class="table-dark">
        <tr>
          <th>Invoice #</th><th>Customer</th><th>Reg #</th><th>Status</th>
          <th class="text-end">Amount Due</th><th>Date Issued</th><th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% if invoices %}
          {% for r in invoices %}
          <tr>
            <td>
              <a href="{{ url_for('admin.view_invoice', invoice_id=r['invoice_id']) }}"
                 class="text-decoration-none">
                {{ r['invoice_number'] or r['invoice_id'] }}
              </a>
            </td>
            <td>{{ r['customer'] }}</td>
            <td>{{ r['registration_number'] }}</td>
            <td>
              <span class="badge {{ 'bg-info' if r['status']|lower=='issued' else 'bg-warning' }}">
                {{ r['status']|capitalize }}
              </span>
            </td>
            <td class="text-end">
              ${{ '%.2f'|format((r['amount_due'] or 0)|float) }}
            </td>
            <td>{{ r['date_issued'] }}</td>
            <td>
              <a href="{{ url_for('admin.view_invoice', invoice_id=r['invoice_id']) }}"
                 class="btn btn-sm btn-outline-primary">
                View
              </a>
            </td>
          </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>

    {% if not invoices %}
      <div class="alert alert-info text-center mb-0">
        No matching invoices.
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script>
  $(function(){
    $('#unpaidTable').DataTable({
      pageLength: 15,
      dom: 'Bfrtip',
      buttons: ['copyHtml5','excelHtml5','csvHtml5','print'],
      columnDefs: [{ targets: [4], className: 'text-end' }]
    });
  });
</script>
{% endblock %}


