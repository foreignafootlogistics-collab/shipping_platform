<!-- templates/admin/invoices/_invoice_inline.html -->
{% set inv_no = invoice.number or ('INV' ~ '%05d'|format(invoice.id)) %}
<style>
  .text-purple{color:#4a148c!important}
  .bg-purple{background:#4a148c!important;color:#fff!important}
  .btn-outline-purple{border:1px solid #4a148c;color:#4a148c}
  .btn-outline-purple:hover{background:#4a148c;color:#fff}
  .panel{border:1px solid #e5e5e5;border-radius:.5rem}
  .icon-left{width:36px;height:36px;border:1px solid #bfb3da;border-radius:.5rem;display:flex;align-items:center;justify-content:center}
  .icon-left i{color:#6c757d}
  .toolbar .btn{border-radius:0}
  .table td,.table th{vertical-align:middle}
</style>

<div class="panel p-3 mb-3">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      <div class="h4 mb-0">{{ inv_no or "—" }}</div>
      <div class="text-muted">Invoice</div>
      <small class="text-muted">
        {% if invoice.date %}{{ invoice.date.strftime('%d.%m.%Y') }}{% endif %}
      </small>
    </div>
    <div class="text-end">
      <div>Package Amt: <span class="fw-semibold">JMD {{ "%.2f"|format(invoice.subtotal or 0) }}</span></div>
      <div>Sub-Total: <span class="fw-semibold">JMD {{ "%.2f"|format(invoice.subtotal or 0) }}</span></div>
      <div class="fs-5">Total Due: <span class="fw-bold">JMD {{ "%.2f"|format(invoice.total_due or 0) }}</span></div>
    </div>
  </div>
</div>

<div class="panel p-3 mb-3">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <div class="h5 mb-1">{{ invoice.customer_code }} {{ invoice.customer_name }}</div>
      <div class="small text-muted">Branch: Main Branch</div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-outline-purple" data-bs-toggle="modal" data-bs-target="#addPaymentModal" title="Add Payment">
        <i class="bi bi-cash-coin"></i>
      </button>
      <button class="btn btn-outline-purple" data-bs-toggle="modal" data-bs-target="#addDiscountModal" title="Add Discount">
        <i class="bi bi-percent"></i>
      </button>
      <div class="toolbar d-inline-flex border rounded ms-2">
        {% if invoice.id %}
        <a class="btn btn-light" href="{{ url_for('admin.invoice_receipt', invoice_id=invoice.id) }}" title="Receipt (PDF)">
          <i class="bi bi-receipt"></i>
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-md-6">
      <label class="form-label small text-muted">Description/Notes</label>
      <form method="POST" action="{{ url_for('admin.save_invoice_notes', invoice_id=invoice.id or 0) }}">
        <textarea name="notes" class="form-control" rows="3" placeholder="Notes...">{{ invoice.description or "" }}</textarea>
        <button class="btn btn-sm btn-outline-purple mt-2">
          <i class="bi bi-save"></i> Save
        </button>
      </form>
    </div>
    <div class="col-md-6 text-end">
      <div class="h5 text-danger mb-3">Balance&nbsp;&nbsp;<span class="fw-bold">JMD {{ "%.2f"|format(invoice.total_due or 0) }}</span></div>
    </div>
  </div>
</div>

<div class="panel p-0">
  <div class="table-responsive">
    <table class="table table-sm mb-0">
      <thead class="table-light">
        <tr>
          <th style="width:60px;"></th>
          <th style="width:36px;"><input type="checkbox"></th>
          <th>House AWB#</th>
          <th>Description</th>
          <th class="text-end">LBS</th>
          <th class="text-end">Value (USD)</th>
          <th class="text-end">Due (JMD)</th>
        </tr>
      </thead>
      <tbody>
        {% for p in invoice.packages %}
        <tr>
          <td>
            {% if p.id %}
              <div class="icon-left" role="button"
                   data-pkg="{{ p.id }}"
                   data-bs-toggle="modal"
                   data-bs-target="#breakdownModal"
                   title="Charges breakdown"
                   style="cursor:pointer">
                <i class="bi bi-lightning-charge"></i>
              </div>
            {% else %}
              <div class="icon-left" title="No package id" style="opacity:.45; cursor:not-allowed;">
                <i class="bi bi-lightning-charge"></i>
              </div>
            {% endif %}
          </td>
          <td><input type="checkbox"></td>
          <td>{{ p.house_awb or "—" }}</td>
          <td>{{ p.description or "—" }}</td>
          <td class="text-end">{{ "%.2f"|format(p.weight or 0) }}</td>
          <td class="text-end">${{ "%.2f"|format(p.value_usd or 0) }}</td>
          <td class="text-end">JMD {{ "%.2f"|format(p.amount_due or 0) }}</td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="text-center text-muted py-4">No items.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modals -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" method="POST" action="{{ url_for('admin.add_payment', invoice_id=invoice.id or 0) }}">
      <div class="modal-header">
        <h5 class="modal-title">Add Payment — {{ inv_no }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Amount (JMD)</label>
          <input type="number" step="0.01" name="amount_jmd" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Method</label>
          <select name="method" class="form-select">
            <option>Cash</option><option>Card</option><option>Bank</option><option>Wallet</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Authorized By</label>
          <input name="authorized_by" class="form-control" placeholder="Admin name">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-purple"><i class="bi bi-cash-coin"></i> Add Payment</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="addDiscountModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" method="POST" action="{{ url_for('admin.add_discount', invoice_id=invoice.id or 0) }}">
      <div class="modal-header">
        <h5 class="modal-title">Add Discount — {{ inv_no }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Amount (JMD)</label>
          <input type="number" step="0.01" name="amount_jmd" class="form-control" required>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-purple"><i class="bi bi-percent"></i> Add Discount</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="breakdownModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Charges Breakdown</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <tbody>
              <tr><th>Duty</th>     <td class="text-end" id="bd-duty">—</td></tr>
              <tr><th>GCT</th>      <td class="text-end" id="bd-gct">—</td></tr>
              <tr><th>Freight</th>  <td class="text-end" id="bd-freight">—</td></tr>
              <tr><th>Handling</th> <td class="text-end" id="bd-handling">—</td></tr>
              <tr><th>SCF</th>      <td class="text-end" id="bd-scf">—</td></tr>
              <tr><th>ENVL</th>     <td class="text-end" id="bd-envl">—</td></tr>
              <tr><th>CAF</th>      <td class="text-end" id="bd-caf">—</td></tr>
              <tr><th>Stamp</th>    <td class="text-end" id="bd-stamp">—</td></tr>
              <tr><th>Other</th>    <td class="text-end" id="bd-other">—</td></tr>
              <tr class="table-light"><th>Total</th><td class="text-end fw-bold" id="bd-total">—</td></tr>
            </tbody>
          </table>
          <small class="text-muted">USD→JMD rate: {{ USD_TO_JMD }}</small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("click", (e) => {
  const btn = e.target.closest(".icon-left");
  if (!btn) return;

  const pkgId = btn.getAttribute("data-pkg");
  if (!pkgId || pkgId === "null" || pkgId === "undefined") return;

  const ids = ["bd-duty","bd-gct","bd-freight","bd-handling","bd-scf","bd-envl","bd-caf","bd-stamp","bd-other","bd-total"];
  ids.forEach(id => document.getElementById(id).textContent = "…");

  fetch(`{{ url_for('admin.invoice_breakdown', package_id=0) }}`.replace('0', pkgId))
    .then(r => { if (!r.ok) throw new Error(); return r.json(); })
    .then(d => {
      const nf = new Intl.NumberFormat();
      document.getElementById("bd-duty").textContent     = nf.format(d.duty || 0);
      document.getElementById("bd-gct").textContent      = nf.format(d.gct || 0);
      document.getElementById("bd-freight").textContent  = nf.format(d.freight || 0);
      document.getElementById("bd-handling").textContent = nf.format(d.handling || 0);
      document.getElementById("bd-scf").textContent      = nf.format(d.scf || 0);
      document.getElementById("bd-envl").textContent     = nf.format(d.envl || 0);
      document.getElementById("bd-caf").textContent      = nf.format(d.caf || 0);
      document.getElementById("bd-stamp").textContent    = nf.format(d.stamp || 0);
      document.getElementById("bd-other").textContent    = nf.format(d.other || 0);
      document.getElementById("bd-total").textContent    = nf.format(d.total_jmd || 0);
    })
    .catch(() => ids.forEach(id => document.getElementById(id).textContent = "—"));
});
</script>
