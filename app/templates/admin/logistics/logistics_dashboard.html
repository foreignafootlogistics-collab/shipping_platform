{% extends "layout_admin.html" %}
{% block title %}Manage Logistics{% endblock %}

{% block content %}
<div class="container mt-4 logistics-dashboard">

  <!-- Header -->
  <h2 class="mb-4 text-white p-3 rounded shadow-sm logistics-header">üì¶ Logistics</h2>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Tabs -->
  <ul class="nav nav-tabs logistics-tabs" id="logisticsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link {% if active_tab == 'prealert' %}active{% endif %}"
         id="prealerts-tab"
         href="{{ url_for('logistics.logistics_dashboard', tab='prealert') }}">
        Pre-Alert Shipments
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link {% if active_tab == 'view_packages' %}active{% endif %}"
         id="view-tab"
         href="{{ url_for('logistics.logistics_dashboard', tab='view_packages') }}">
        View Packages
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link {% if active_tab == 'shipmentLog' %}active{% endif %}"
         id="shipment-tab"
         href="{{ url_for('logistics.logistics_dashboard', tab='shipmentLog') }}">
        Shipment Log
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link {% if active_tab == 'uploadPackages' %}active{% endif %}"
         id="upload-tab"
         href="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}">
        Upload Packages
      </a>
    </li>
  </ul>

  <!-- Tab content -->
  <div class="tab-content mt-3" id="logisticsTabsContent">

    {# ---------------- PREALERT TAB ---------------- #}
    {% if active_tab == 'prealert' %}
    <div class="tab-pane show active" id="prealerts" role="tabpanel" aria-labelledby="prealerts-tab">
      <div class="table-responsive mt-3">
        <table id="dashboardPrealertsTable" class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Pre-Alert #</th>
              <th>Customer</th>
              <th>Vendor</th>
              <th>Courier</th>
              <th>Tracking #</th>
              <th>Purchase Date</th>
              <th>Contents</th>
              <th>Value (USD)</th>
              <th>Invoice</th>
              <th>Submitted On</th>
            </tr>
          </thead>
          <tbody>
            {% if prealerts %}
              {% for p in prealerts %}
              <tr>
                <td>{{ p.code }}</td>
                <td>
                  {{ p.customer_name or 'N/A' }}<br>
                  <small class="text-muted">{{ p.registration_number or '' }}</small>
                </td>
                <td>{{ p.vendor_name or 'N/A' }}</td>
                <td>{{ p.courier_name or 'N/A' }}</td>
                <td>{{ p.tracking_number or 'N/A' }}</td>
                <td>{% if p.purchase_date %}{{ p.purchase_date }}{% else %}N/A{% endif %}</td>
                <td>{{ p.package_contents or 'N/A' }}</td>
                <td>${{ '%.2f'|format(p.item_value_usd or 0) }}</td>
                <td>
                  {% if p.invoice_filename %}
                    {% if is_url(p.invoice_filename) %}
                      <a href="{{ p.invoice_filename }}" target="_blank" rel="noopener">View</a>
                    {% else %}
                      <a href="{{ url_for('uploads.invoice_file', filename=p.invoice_filename) }}" target="_blank" rel="noopener">View</a>
                    {% endif %}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>{% if p.created_at %}{{ p.created_at }}{% else %}N/A{% endif %}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="10" class="text-center text-muted">No pre-alert shipments found.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    {# ---------------- VIEW PACKAGES TAB ---------------- #}
    {% if active_tab == 'view_packages' %}
    <div class="tab-pane show active" id="viewPackages" role="tabpanel" aria-labelledby="view-tab">
      {% include "admin/logistics/view_packages.html" %}
    </div>
    {% endif %}

    {# ---------------- SHIPMENT LOG TAB ---------------- #}
    {% if active_tab == 'shipmentLog' %}
    <div class="tab-pane show active" id="shipmentLog" role="tabpanel" aria-labelledby="shipment-tab">

      <div class="row mb-3">

        <!-- Sidebar: Shipments -->
        <div class="col-md-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-purple mb-0">üì¶ Shipment Batches</h5>

            <div class="btn-group btn-group-sm" role="group" aria-label="Shipment toolbar">
              <form method="POST" action="{{ url_for('logistics.create_empty_shipment') }}" class="d-inline">
                {{ bulk_form.hidden_tag() }}
                <button type="submit" class="btn btn-outline-primary" title="Create a blank shipment log">
                  <i class="fas fa-plus"></i>
                </button>
              </form>

              <button class="btn btn-outline-success" title="Search packages"
                      data-bs-toggle="modal" data-bs-target="#shipmentSearchModal">
                <i class="fas fa-search"></i>
              </button>

              <button class="btn btn-outline-danger" title="Delete current shipment"
                      data-bs-toggle="modal" data-bs-target="#deleteShipmentModal"
                      {% if not selected_shipment %}disabled{% endif %}>
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>

          <ul class="list-group shadow-sm">
            {% if shipments %}
              {% for s in shipments %}
                <li class="list-group-item d-flex justify-content-between align-items-start border-0
                           {% if selected_shipment and s.id == (selected_shipment.id if selected_shipment else None) %}active bg-purple text-white{% endif %}">
                  <a class="flex-grow-1 text-decoration-none
                            {% if selected_shipment and s.id == (selected_shipment.id if selected_shipment else None) %}text-white{% else %}text-dark{% endif %}"
                     href="{{ url_for('logistics.logistics_dashboard', tab='shipmentLog', shipment_id=s.id) }}">
                    <strong>{{ s.sl_name or s.sl_id }}</strong>
                    <small class="text-muted">{{ s.sl_id }}</small><br>
                    <small class="text-muted {% if selected_shipment and s.id == (selected_shipment.id if selected_shipment else None) %}text-light{% endif %}">
                      {{ (s.created_at or now()) | datetimeformat('%Y-%m-%d %H:%M') }}
                    </small>
                  </a>
                </li>
              {% endfor %}
            {% else %}
              <li class="list-group-item text-muted">
                No shipment batches found.
                <br>
                <a href="{{ url_for('logistics.logistics_dashboard', tab='view_packages') }}"
                   class="btn btn-sm btn-purple mt-2">‚ûï Create Shipment</a>
              </li>
            {% endif %}
          </ul>
        </div>

        <!-- Main: Packages -->
        <div class="col-md-9">

          <div class="d-flex justify-content-between align-items-center mb-3">
            {% if selected_shipment %}
            <div class="d-flex align-items-center gap-2">
              <h5 class="fw-bold text-purple mb-0">
                üöö Shipment Packages -
                <span id="shipmentNameDisplay">{{ selected_shipment.sl_name or selected_shipment.sl_id }}</span>
              </h5>

              <button class="btn btn-sm btn-outline-purple" data-bs-toggle="modal" data-bs-target="#renameShipmentModal">
                ‚úèÔ∏è Rename
              </button>
            </div>
            {% endif %}
          </div>

          {% if selected_shipment %}
          <form method="POST"
                id="shipmentForm"
                class="d-block"
                action="{{ url_for('logistics.bulk_shipment_action', shipment_id=selected_shipment.id) }}"
                novalidate>

            {{ bulk_form.hidden_tag() }}
            <input type="hidden" name="tab" value="shipmentLog">

            <!-- ‚úÖ Filters card -->
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-body py-2">
                <div class="row g-2 align-items-end">

                  <div class="col-md-3">
                    <label class="form-label small mb-0">Customer Name</label>
                    <input type="text" id="fltName" class="form-control form-control-sm" placeholder="e.g. Jane Doe">
                  </div>

                  <div class="col-md-3">
                    <label class="form-label small mb-0">Tracking #</label>
                    <input type="text" id="fltTracking" class="form-control form-control-sm" placeholder="e.g. 1Z...">
                  </div>

                  <div class="col-md-3">
                    <label class="form-label small mb-0">Registration #</label>
                    <input type="text" id="fltReg" class="form-control form-control-sm" placeholder="e.g. FA12345">
                  </div>

                  <div class="col-md-3">
                    <label class="form-label small mb-0">Weight Range (lbs)</label>
                    <div class="d-flex gap-2">
                      <input type="number" step="0.01" id="fltWMin" class="form-control form-control-sm" placeholder="Min">
                      <input type="number" step="0.01" id="fltWMax" class="form-control form-control-sm" placeholder="Max">
                    </div>
                  </div>

                  <div class="col-12 d-flex justify-content-between align-items-center mt-1">
                    <div class="d-flex gap-2 flex-wrap">
                      <button type="button" id="btnApplyFilters" class="btn btn-sm btn-outline-purple">
                        <i class="bi bi-funnel"></i> Apply
                      </button>
                      <button type="button" id="btnClearFilters" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Clear
                      </button>
                    </div>

                    <button type="button" id="btnDeleteSelectedPkgs" class="btn btn-sm btn-danger">
                      <i class="bi bi-trash"></i> Delete Selected Package(s)
                    </button>
                  </div>

                </div>
              </div>
            </div>

            <!-- Bulk action bar -->
            <div class="shipment-bulkbar d-flex justify-content-between align-items-center gap-2 mb-3 w-100 flex-wrap">

              <div class="d-flex align-items-center gap-2">
                <label for="shipmentLengthSelect" class="small text-muted mb-0">Show</label>
                <select id="shipmentLengthSelect" class="form-select form-select-sm w-auto">
                  <option value="10" selected>10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="500">500</option>
                  <option value="1000">1000</option>
                </select>
              </div>

              <div class="d-flex align-items-center gap-2">
                <select name="action" class="form-select form-select-sm w-auto" required>
                  <option value="" selected disabled>Select Action</option>
                  <option value="calc_outstanding">üßÆ Calculate Outstanding</option>
                  <option value="move">üîÅ Move to Shipment‚Ä¶</option>
                  <option value="received_local_port">üìç Received at Local Port</option>
                  <option value="ready">‚úÖ Mark Ready for Pick Up</option>
                  <option value="revert_overseas">‚Ü©Ô∏è Revert to Overseas</option>
                  <option value="generate_invoice">üßæ Generate Invoice</option>
                  <option value="finance_invoice">üíº Finance Invoice</option>
                  <option value="notify_ready">üì£ Email: Ready for Pick-Up</option>
                  <option value="send_invoices">üìß Email: Invoices (Totals)</option>
                  <option value="remove_from_shipment">üóë Remove from this Shipment</option>
                </select>

                <button type="button"
                        id="shipmentApplyBtn"
                        class="btn btn-purple btn-sm"
                        onclick="handleShipmentApply(event)">
                  Apply
                </button>
              </div>

            </div>

            {% if shipment_packages %}
            <div class="table-responsive shadow-sm">
              <table id="shipmentTable" class="table table-bordered table-striped table-hover align-middle table-sm">
                <thead class="bg-purple text-white small">
                  <tr>
                    <th style="width:30px;">
                      <input type="checkbox" id="selectAll" onclick="toggleShipmentSelectAll(this)">
                    </th>
                    <th>Action</th>
                    <th>User</th>
                    <th>Package</th>
                    <th>House AWB</th>
                    <th>Description</th>
                    <th>Date Received</th>
                    <th>Weight</th>
                    <th>Item Value ($)</th>
                    <th>Outstanding ($)</th>
                  </tr>
                </thead>
                <tbody class="small">
                  {% for pkg in shipment_packages %}
                  <tr>
                    <td>
                      <input type="checkbox"
                             name="package_ids"
                             value="{{ pkg.id }}"
                             class="package-checkbox"
                             onclick="updateShipmentHeaderCheckbox()">
                    </td>

                    <td class="text-center align-middle">
                      <!-- ‚úÖ IMPORTANT: include data-category so modal opens correctly -->
                      <button type="button"
                              class="btn btn-sm btn-outline-primary mb-1 js-open-charges"
                              data-bs-toggle="modal"
                              data-bs-target="#chargesModalSL"
                              data-pkg-id="{{ pkg.id }}"
                              data-desc="{{ pkg.description or pkg.tracking_number or ('Package #' ~ pkg.id) }}" 
                              data-category="{{ pkg.category or 'Other' }}">                           
                        <i class="bi bi-calculator"></i>
                      </button>
                      <br>
                      <button type="button"
                              class="btn btn-sm btn-outline-secondary js-open-attach"
                              data-pkg-id="{{ pkg.id }}"
                              title="Attach invoice / files">
                        <i class="bi bi-paperclip"></i>
                      </button>
                    </td>

                    <td>
                      <strong>{{ pkg.full_name }}</strong><br>
                      <small class="text-muted">{{ pkg.registration_number }}</small>
                    </td>

                    <td>
                      {% set status = pkg.status %}
                      {% include 'partials/status_vars.html' %}
                      {% include 'partials/status_tracker.html' %}
                      <br>
                      <small class="text-muted">{{ pkg.tracking_number }}</small>
                    </td>

                    <td>{{ pkg.house_awb or '-' }}</td>

                    <td>
                      <div>{{ pkg.description or '-' }}</div>

                      {% set atts = pkg.attachments %}
                      {% if atts and atts|length %}
                        <div class="mt-1 d-flex flex-wrap gap-2 pkg-attach-wrap">
                          {% for a in atts %}
                            <a class="badge text-decoration-none"
                               style="background:#f5f0fa; border:1px solid #4a148c; color:#4a148c;"
                               target="_blank"
                               href="{{ url_for('logistics.view_package_attachment', attachment_id=a.id) }}"
                               title="{{ a.original_name }}">
                              <i class="fa-solid fa-paperclip me-1"></i>
                              {{ (a.original_name or 'file')[:18] }}{% if (a.original_name or '')|length > 18 %}‚Ä¶{% endif %}
                            </a>

                            <form method="POST"
                                  action="{{ url_for('logistics.delete_package_attachment_admin', attachment_id=a.id) }}"
                                  class="d-inline"
                                  onsubmit="return confirm('Delete this attachment?');">
                              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                              <button type="submit" class="btn btn-link btn-sm p-0 text-danger" title="Delete">
                                <i class="bi bi-x-circle"></i>
                              </button>
                            </form>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </td>

                    <td>{{ pkg.date_received.strftime('%Y-%m-%d') if pkg.date_received else '-' }}</td>

                    <!-- ‚úÖ MUST HAVE name=weight_{id} -->
                    <td>
                      <input id="weight_{{ pkg.id }}"
                             name="weight_{{ pkg.id }}"
                             type="number" step="0.01" min="0"
                             class="form-control form-control-sm text-end"
                             value="{{ pkg.weight or 0 }}">
                    </td>

                    <!-- ‚úÖ MUST HAVE name=value_{id} -->
                    <td>
                      <input id="value_{{ pkg.id }}"
                             name="value_{{ pkg.id }}"
                             type="number" step="0.01" min="0"
                             class="form-control form-control-sm text-end"
                             value="{{ pkg.value if pkg.value is not none else 0 }}">
                    </td>

                    <td>
                      <input id="amount_due_{{ pkg.id }}" type="number" step="0.01"
                             class="form-control form-control-sm text-end"
                             value="{{ pkg.amount_due or 0 }}"
                             readonly>

                      <!-- ‚úÖ CRITICAL: category per row for server calc -->
                      <input type="hidden"
                             id="category_{{ pkg.id }}"
                             name="category_{{ pkg.id }}"
                             value="{{ pkg.category or 'Other' }}">
                      <input type="hidden" id="locked_{{ pkg.id }}" name="locked_{{ pkg.id }}" value="{{ 1 if pkg.pricing_locked else 0 }}">
                      <!-- ‚úÖ Hidden manual override fields -->
                      <input type="hidden" name="duty_{{ pkg.id }}"    id="duty_{{ pkg.id }}"    value="{{ pkg.duty or 0 }}">
                      <input type="hidden" name="gct_{{ pkg.id }}"     id="gct_{{ pkg.id }}"     value="{{ pkg.gct or 0 }}">
                      <input type="hidden" name="scf_{{ pkg.id }}"     id="scf_{{ pkg.id }}"     value="{{ pkg.scf or 0 }}">
                      <input type="hidden" name="envl_{{ pkg.id }}"    id="envl_{{ pkg.id }}"    value="{{ pkg.envl or 0 }}">
                      <input type="hidden" name="caf_{{ pkg.id }}"     id="caf_{{ pkg.id }}"     value="{{ pkg.caf or 0 }}">
                      <input type="hidden" name="stamp_{{ pkg.id }}"   id="stamp_{{ pkg.id }}"   value="{{ pkg.stamp or 0 }}">

                      <input type="hidden" name="freight_{{ pkg.id }}"  id="freight_{{ pkg.id }}"  value="{{ pkg.freight_fee or 0 }}">
                      <input type="hidden" name="handling_{{ pkg.id }}" id="handling_{{ pkg.id }}" value="{{ pkg.storage_fee or 0 }}">
                      <input type="hidden" name="other_{{ pkg.id }}"    id="other_{{ pkg.id }}"    value="{{ pkg.other_charges or 0 }}">
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
              <p class="text-muted">No packages in this shipment.</p>
            {% endif %}

          </form>
          {% endif %}

        </div>
      </div>

      <!-- Move to Shipment Modal -->
      <div class="modal fade" id="moveShipmentModal" tabindex="-1" aria-labelledby="moveShipmentLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
          <div class="modal-content">
            <form method="POST"
                  action="{{ url_for('logistics.move_packages_between_shipments') }}"
                  id="moveShipmentForm"
                  onsubmit="return validateMoveShipmentForm();">
              <div class="modal-header">
                <h5 class="modal-title" id="moveShipmentLabel">Move Packages</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="from_shipment_id" value="{{ selected_shipment.id if selected_shipment else 0 }}">
                <div id="movePackageIdsContainer"></div>

                <label class="form-label small">Destination Shipment</label>
                <select class="form-select form-select-sm" name="to_shipment_id" required>
                  <option value="">Select‚Ä¶</option>
                  {% for s in shipments %}
                    {% if not selected_shipment or s.id != selected_shipment.id %}
                      <option value="{{ s.id }}">{{ s.sl_id }}</option>
                    {% endif %}
                  {% endfor %}
                </select>

                <div class="form-text mt-2">
                  Selected packages will be moved to the chosen shipment.
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-purple btn-sm">Move</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Charges / Fees Modal -->
      <div class="modal fade" id="chargesModalSL" tabindex="-1" aria-labelledby="chargesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">

            <div class="modal-header" style="background:#4a148c; color:#fff;">
              <h5 class="modal-title" id="chargesModalLabel">Calculate Charges for Package</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <form id="chargesForm" onsubmit="return false;">
                <input type="hidden" id="chargesPkgId">

                <div class="row g-3 mb-2">
                  <div class="col-12">
                    <label class="form-label fw-semibold">Package</label>
                    <input type="text" id="chargesPkgDesc" class="form-control form-control-sm" readonly>
                  </div>

                  <div class="col-md-4">
                    <label for="chargesCategory" class="form-label fw-semibold">Category</label>
                    <select id="chargesCategory" class="form-select form-select-sm">
                      {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label for="chargesWeight" class="form-label fw-semibold">Weight (lbs)</label>
                    <input type="number" step="0.01" id="chargesWeight" class="form-control form-control-sm">
                  </div>

                  <div class="col-md-4">
                    <label for="chargesValue" class="form-label fw-semibold">Item Value (USD)</label>
                    <input type="number" step="0.01" id="chargesValue" class="form-control form-control-sm">
                  </div>
                </div>
                
                <div class="d-flex align-items-center justify-content-between
                            border rounded p-2 mb-2"
                     style="background:#f8f9fa;">
                  <div class="small">
                    <div class="fw-semibold">Manual override</div>
                    <div class="text-muted">When ON, auto-calc won‚Äôt overwrite your typed values.</div>
                  </div>

                  <div class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" id="pricingLockedToggle">
                    <label class="form-check-label small" for="pricingLockedToggle">Lock</label>
                  </div>
                </div>
                <hr class="my-3">

                <div id="chargesResult" style="display:none;">
                  <h6 class="fw-bold mb-2">Breakdown</h6>
                  <div class="row g-2 small">
                    <div class="col-md-4"><div class="border rounded p-2"><div class="text-muted">Duty</div><input type="number" step="0.01" id="resDuty" class="form-control form-control-sm text-end"></div></div>
                    <div class="col-md-4"><div class="border rounded p-2"><div class="text-muted">GCT</div><input type="number" step="0.01" id="resGct" class="form-control form-control-sm text-end"></div></div>
                    <div class="col-md-4"><div class="border rounded p-2"><div class="text-muted">SCF</div><input type="number" step="0.01" id="resScf" class="form-control form-control-sm text-end"></div></div>

                    <div class="col-md-4"><div class="border rounded p-2"><div class="text-muted">ENVL</div><input type="number" step="0.01" id="resEnvl" class="form-control form-control-sm text-end"></div></div>
                    <div class="col-md-4"><div class="border rounded p-2"><div class="text-muted">CAF</div><input type="number" step="0.01" id="resCaf" class="form-control form-control-sm text-end"></div></div>
                    <div class="col-md-4"><div class="border rounded p-2"><div class="text-muted small">Stamp</div><input type="number" step="0.01" id="resStamp" class="form-control form-control-sm text-end"></div></div>

                    <div class="col-md-4"><div class="border rounded p-2"><div class="text-muted small">Customs Total</div><input type="number" step="0.01" id="resCustomsTotal" class="form-control form-control-sm text-end"></div></div>
                    <div class="col-md-4"><div class="border rounded p-2"><div class="text-muted">Freight</div><input type="number" step="0.01" id="resFreight" class="form-control form-control-sm text-end"></div></div>
                    <div class="col-md-4"><div class="border rounded p-2"><div class="text-muted">Handling</div><input type="number" step="0.01" id="resHandling" class="form-control form-control-sm text-end"></div></div>

                    <div class="col-md-4"><div class="border rounded p-2"><div class="text-muted small">Freight Total</div><input type="number" step="0.01" id="resFreightTotal" class="form-control form-control-sm text-end"></div></div>
                    <div class="col-md-4"><div class="border rounded p-2"><div class="text-muted small">Other Charges</div><input type="number" step="0.01" id="resOther" class="form-control form-control-sm text-end"></div></div>
                    <div class="col-md-8"><div class="border rounded p-2 bg-light"><div class="text-muted">Grand Total (JMD)</div><input type="number" step="0.01" id="resTotal" class="form-control form-control-sm text-end"></div></div>
                  </div>
                </div>

                <div id="chargesError" class="alert alert-danger mt-3 py-2 px-3 small" style="display:none;"></div>
              </form>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Close</button>
              <button type="button" id="btnApplyToPkg" class="btn btn-outline-success btn-sm" style="display:none;">Apply & Save</button>
              <button type="button" id="btnCalcCharges" class="btn btn-purple btn-sm">
                <i class="bi bi-calculator"></i> Calculate Charges
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Attach Files Modal -->
      <div class="modal fade" id="attachInvoiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header" style="background:#4a148c; color:#fff;">
              <h5 class="modal-title"><i class="bi bi-paperclip me-1"></i> Attach Files</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <input type="hidden" id="attachPkgId" value="">
              <input type="hidden" id="attachCsrfToken" value="{{ csrf_token() }}">

              <div class="small text-muted mb-2">
                Package ID: <strong id="attachPkgLabel">‚Äî</strong>
              </div>

              <label class="form-label">Select file(s)</label>
              <input type="file" id="attachFiles" class="form-control" multiple accept=".pdf,.png,.jpg,.jpeg,.webp">
              <div class="form-text">Allowed: PDF, PNG, JPG, WEBP</div>

              <div id="attachUploadStatus" class="small text-muted mt-2">Select a file to upload.</div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-success" id="btnAttachUpload">
                <i class="bi bi-upload me-1"></i> Upload
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Search Packages Modal -->
      <div class="modal fade" id="shipmentSearchModal" tabindex="-1" aria-labelledby="shipmentSearchLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="shipmentSearchLabel">Search Packages</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <form id="shipmentSearchForm" class="row g-2 mb-3">
                <div class="col-md-6">
                  <label class="form-label small mb-0">Customer Name</label>
                  <input type="text" class="form-control form-control-sm" name="name" placeholder="e.g., Jane Doe">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-0">Registration #</label>
                  <input type="text" class="form-control form-control-sm" name="reg" placeholder="e.g., FA12345">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-0">Tracking #</label>
                  <input type="text" class="form-control form-control-sm" name="tracking" placeholder="e.g., 1Z...">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-0">House AWB</label>
                  <input type="text" class="form-control form-control-sm" name="house" placeholder="e.g., 06978687">
                </div>

                <div class="col-12 d-flex justify-content-end">
                  <button type="submit" class="btn btn-sm btn-purple">Search</button>
                </div>
              </form>

              <div class="table-responsive">
                <table class="table table-sm table-striped align-middle mb-0" id="shipmentSearchResults">
                  <thead class="table-light">
                    <tr>
                      <th>Customer</th>
                      <th>Reg #</th>
                      <th>Tracking #</th>
                      <th>House AWB</th>
                      <th>Description</th>
                      <th>Shipment Batch</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="6" class="text-muted">Enter criteria and click Search.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Shipment Batch Modal -->
      <div class="modal fade" id="deleteShipmentModal" tabindex="-1" aria-labelledby="deleteShipmentLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
          <div class="modal-content">
            <form method="POST" action="{{ url_for('logistics.delete_shipment', shipment_id=(selected_shipment.id if selected_shipment else 0)) }}">
              <div class="modal-header">
                <h5 class="modal-title" id="deleteShipmentLabel">Delete Shipment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                {% if selected_shipment %}
                  <p class="mb-0">Delete <strong>{{ selected_shipment.sl_id }}</strong>?</p>
                  <small class="text-muted">Packages stay in the system; only the batch is removed.</small>
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% else %}
                  <p class="mb-0 text-muted">Select a shipment on the left first.</p>
                {% endif %}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger btn-sm" {% if not selected_shipment %}disabled{% endif %}>Delete</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- Bulk Invoice Preview Modal -->
      <div class="modal fade" id="bulkInvoicePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">

            <div class="modal-header">
              <h5 class="modal-title">Invoice Preview</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <p id="detained-note" class="text-muted small mb-2"></p>

              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Select</th>
                      <th>Customer</th>
                      <th class="text-center">Packages</th>
                      <th class="text-end">Total Due</th>
                    </tr>
                  </thead>

                  <tbody id="inv-prev-tbody"></tbody>

                  <tfoot>
                    <tr class="table-light">
                      <th colspan="3" class="text-end">Total Amount Due</th>
                      <th class="text-end" id="inv-prev-total">0.00</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Cancel
              </button>
              <button id="btn-finalize-invoices"
                      class="btn btn-purple"
                      type="button"
                      onclick="finalizeInvoicesFromModal(event)">
                Generate Customer Invoice(s)
              </button>
            </div>

          </div>
        </div>
      </div>
      
      <!-- ‚úÖ Shipment Finance Invoice Preview Modal (Supplier Cost) -->
      <div class="modal fade" id="shipmentFinanceInvoiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Shipment Finance Invoice</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="shipmentFinanceInvoiceBody">
              <p class="text-muted mb-0">Loading shipment invoice‚Ä¶</p>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Close
              </button>
              <button type="button" class="btn btn-purple" id="btnPrintShipmentFinance">
                Print / Save
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Rename Shipment Modal -->
      <div class="modal fade" id="renameShipmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
          <div class="modal-content">
            <form method="POST"
                  action="{{ url_for('logistics.rename_shipment', shipment_id=selected_shipment.id if selected_shipment else 0) }}">
              <div class="modal-header">
                <h5 class="modal-title">Rename Shipment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>

              <div class="modal-body">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label class="form-label small">Shipment Name</label>
                <input type="text" name="sl_name" class="form-control form-control-sm"
                       value="{{ selected_shipment.sl_name or selected_shipment.sl_id }}" required>
                <div class="form-text mt-1">
                  This is just a display name. The system ID remains unchanged.
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-purple btn-sm">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    </div>
    {% endif %}

    {# ---------------- UPLOAD PACKAGES TAB ---------------- #}
    {% if active_tab == 'uploadPackages' %}
    <div class="tab-pane show active"
         id="uploadPackages"
         role="tabpanel"
         aria-labelledby="upload-tab">

      <div class="card shadow-sm mt-3 border-0">

        <div class="card-header text-white"
             style="background-color:#4a148c; border-top-left-radius:.5rem; border-top-right-radius:.5rem;">
          <h4 class="mb-0">Upload Packages from Excel/CSV</h4>
        </div>

        <div class="card-body p-4">

          <!-- 1) Upload-for-Preview Form -->
          <form id="uploadForm"
                method="POST"
                enctype="multipart/form-data"
                action="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}">

            {{ upload_form.hidden_tag() }}
            <input type="hidden" name="tab" value="uploadPackages">
            <input type="hidden" name="stage" value="preview">

            <div class="mb-3">
              {{ upload_form.file.label(class_="form-label") }}
              {{ upload_form.file(class_="form-control", accept=".xlsx,.csv") }}

              {% for error in upload_form.file.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>

            <div class="d-flex align-items-center gap-2">
              {{ upload_form.submit(class_="btn btn-purple", id="uploadBtn", value="Preview All") }}

              <a href="{{ url_for('static', filename='templates/sample_upload.xlsx') }}"
                 class="btn btn-outline-purple">
                Download Sample
              </a>

              <div id="spinner"
                   class="spinner-border text-purple ms-2"
                   role="status"
                   style="display:none;">
                <span class="visually-hidden">Uploading...</span>
              </div>
            </div>
          </form>

          <!-- Messages -->
          {% if message %}
            <div class="alert alert-success mt-4">
              {{ message }}
            </div>
          {% endif %}

          {% if errors and errors|length %}
            <div class="alert alert-danger mt-4">
              <ul class="mb-0">
                {% for error in errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          <!-- 2) Full Preview Table + Confirm -->
          {% if preview_headers and preview_rows %}

            <hr class="my-4">

            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="mb-0">Preview All Rows</h5>

              {% if summary_counts %}
                <div class="small">
                  <span class="badge badge-purple">Total: {{ summary_counts.total }}</span>
                  <span class="badge badge-purple-soft">Valid: {{ summary_counts.valid }}</span>
                  <span class="badge bg-danger">Invalid: {{ summary_counts.invalid }}</span>
                </div>
              {% endif %}

              {% if preview_token and summary_counts and summary_counts.invalid %}
                <a class="btn btn-sm btn-outline-danger"
                   href="{{ url_for('logistics.download_preview_invalid', token=preview_token) }}">
                  <i class="fas fa-file-csv me-1"></i> Download Invalid Rows
                </a>
              {% endif %}
            </div>

            <div class="table-responsive border rounded shadow-sm">
              <table id="previewTable"
                     class="table table-sm table-bordered table-striped align-middle mb-0">

                <thead class="bg-purple text-white">
                  <tr>
                    <th style="width:30px;">
                      <input type="checkbox" id="selectAllPreview">
                    </th>

                    {% for h in preview_headers %}
                      <th>{{ h }}</th>
                    {% endfor %}

                    <th>Status</th>
                    <th style="display:none;">__row_index</th>
                  </tr>
                </thead>

                <tbody>
                  {% for row in preview_rows %}
                    {% set i = loop.index0 %}
                    {% set errs = (preview_errors.get(i) or preview_errors.get(i|string)) if preview_errors else None %}

                    <tr class="{% if errs %}table-danger{% else %}table-light{% endif %}">
                      <td>
                        <input type="checkbox"
                               class="row-select"
                               value="{{ i }}"
                               {% if not errs %}checked{% endif %}>
                      </td>

                      {% for h in preview_headers %}
                        {% set val = row.get(h) %}
                        <td class="{% if errs and ('Missing ' ~ h.replace('_',' ').title()) in errs %}bg-warning-subtle{% endif %}">
                          {{ '' if val is none else val }}
                        </td>
                      {% endfor %}

                      <td>
                        {% if not errs %}
                          <span class="badge badge-purple">Valid</span>
                        {% else %}
                          <span class="badge bg-danger">Invalid</span>
                          <div class="small text-muted mt-1">
                            {% for e in errs %}
                              <div>‚Ä¢ {{ e }}</div>
                            {% endfor %}
                          </div>
                        {% endif %}
                      </td>

                      <td style="display:none;">{{ i }}</td>
                    </tr>
                  {% endfor %}
                </tbody>

              </table>
            </div>

            <!-- Confirm form -->
            <form id="confirmForm"
                  method="POST"
                  action="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}"
                  class="mt-3 d-flex flex-wrap align-items-end gap-2"
                  onsubmit="return handleConfirmSubmit(event);">

              {{ upload_form.csrf_token }}
              <input type="hidden" name="tab" value="uploadPackages">
              <input type="hidden" name="stage" value="confirm">
              <input type="hidden" name="preview_token" value="{{ preview_token }}">
              <input type="hidden" id="selectedIndicesInput" name="selected_indices" value="[]">

              <div>
                <label class="form-label mb-1 text-purple">Batch Size (optional)</label>
                <input type="number"
                       name="batch_size"
                       class="form-control form-control-sm border-purple"
                       placeholder="e.g. 50">
                <div class="form-text">Limit per submit to avoid timeouts.</div>
              </div>

              <div class="ms-auto d-flex align-items-center gap-2">
                <button type="button"
                        id="selectValidBtn"
                        class="btn btn-outline-purple btn-sm">
                  Select All Valid
                </button>

                <button type="submit"
                        class="btn btn-purple btn-sm">
                  <i class="fas fa-check-circle me-1"></i> Import Selected
                </button>

                <a href="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}"
                   class="btn btn-outline-danger btn-sm"
                   onclick="return confirm('Cancel this upload and discard preview?');">
                  <i class="fas fa-times-circle me-1"></i> Cancel Upload
                </a>
              </div>
            </form>

          {% endif %}
          {# end if preview_headers and preview_rows #}

        </div>
        <!-- /card-body -->

      </div>
      <!-- /card -->

    </div>
    <!-- /uploadPackages tab-pane -->
    {% endif %}


  </div>
</div>

<script>
/* ============================================================
   FAFL Shipment Log JS (UPDATED COPY/PASTE)
   - Keeps ALL your existing features
   - Adds URL-for based endpoints (no hardcoding)
   - Charges modal:
        ‚úÖ pulls latest row values (DT-safe)
        ‚úÖ calculates via calculator_ajax
        ‚úÖ SAVES via logistics.api_save_package_charges (correct route)
        ‚úÖ updates row amount_due / grand_total for later "Generate Invoice"
   ============================================================ */

const categoryRates = {{ CATEGORIES|tojson }};
const USD_TO_JMD    = {{ USD_TO_JMD }};

/* ============================================================
   ‚úÖ URLS from Flask (prevents prefix bugs)
   ============================================================ */
window.PKG_API_URL      = "{{ url_for('logistics.api_get_package', pkg_id=0) }}";           // .../0
window.CALC_API_URL     = "{{ url_for('logistics.shipment_calc_charges') }}";              // calc endpoint (if you use it)
window.SAVE_CHARGES_URL = "{{ url_for('logistics.api_save_package_charges', pkg_id=0) }}"; // .../0
window.UPDATE_PKG_URL   = "{{ url_for('logistics.api_update_package', pkg_id=0) }}";        // .../0
window.INVOICE_PREVIEW_URL  = "{{ url_for('logistics.bulk_invoice_preview') }}";
window.INVOICE_FINALIZE_URL = "{{ url_for('logistics.bulk_invoice_finalize_json') }}";


function apiUrl(base, id) {
  // base ends with "/0"
  return String(base || '').replace(/0$/, String(id));
}

async function postJSON(url, body) {
  const r = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify(body)
  });
  if (!r.ok) {
    const txt = await r.text();
    throw new Error('Request failed: ' + txt);
  }
  return r.json();
}

function hasDataTables() {
  return window.jQuery && $.fn && $.fn.DataTable;
}

function getShipmentIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const sid = params.get('shipment_id');
  return sid ? Number(sid) : 0;
}

function validateMoveShipmentForm() {
  const holder = document.getElementById('movePackageIdsContainer');
  const count = holder ? holder.querySelectorAll('input[name="package_ids"]').length : 0;
  if (!count) {
    alert("‚ö†Ô∏è Please select at least one package before moving.");
    return false;
  }
  return true;
}

/* ==========================
   FILTERS helpers
   ========================== */
function getFilterValues() {
  const name = (document.getElementById('fltName')?.value || '').trim().toLowerCase();
  const tracking = (document.getElementById('fltTracking')?.value || '').trim().toLowerCase();
  const reg = (document.getElementById('fltReg')?.value || '').trim().toLowerCase();

  const wMinRaw = (document.getElementById('fltWMin')?.value || '').trim();
  const wMaxRaw = (document.getElementById('fltWMax')?.value || '').trim();
  const wMin = wMinRaw === '' ? null : Number(wMinRaw);
  const wMax = wMaxRaw === '' ? null : Number(wMaxRaw);

  return { name, tracking, reg, wMin, wMax };
}

function parseCellText(td) {
  if (!td) return '';
  return (td.textContent || '').replace(/\s+/g, ' ').trim().toLowerCase();
}

function parseWeightFromRow(tr) {
  const inp = tr.querySelector('input[id^="weight_"]');
  const v = inp ? Number(inp.value || 0) : 0;
  return isNaN(v) ? 0 : v;
}

/* ==========================
   DATATABLES
   ========================== */
let dt = null;
let dtInitialized = false;

function installShipmentFilterHook() {
  if (!window.jQuery || !$.fn || !$.fn.dataTable) return;
  if ($.fn.dataTable.__faflShipmentFilterInstalled) return;
  $.fn.dataTable.__faflShipmentFilterInstalled = true;

  $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
    if (!settings || settings.nTable?.id !== 'shipmentTable') return true;

    const f = getFilterValues();
    const api = new $.fn.dataTable.Api(settings);
    const rowNode = api.row(dataIndex).node();
    if (!rowNode) return true;

    const userText = parseCellText(rowNode.querySelector('td:nth-child(3)'));
    const pkgText  = parseCellText(rowNode.querySelector('td:nth-child(4)'));
    const w = parseWeightFromRow(rowNode);

    if (f.name && !userText.includes(f.name)) return false;
    if (f.reg && !userText.includes(f.reg)) return false;
    if (f.tracking && !pkgText.includes(f.tracking)) return false;

    if (f.wMin != null && w < f.wMin) return false;
    if (f.wMax != null && w > f.wMax) return false;

    return true;
  });
}

function bindShipmentLengthSelect() {
  const sel = document.getElementById('shipmentLengthSelect');
  if (!sel) return;
  if (sel.dataset.bound === "1") return;
  sel.dataset.bound = "1";

  sel.addEventListener('change', function () {
    const len = Number(this.value || 10);
    if (dt) dt.page.len(len).draw();
  });

  syncShipmentLengthSelect();
}

function syncShipmentLengthSelect() {
  const sel = document.getElementById('shipmentLengthSelect');
  if (!sel) return;
  const current = (dt && typeof dt.page.len === 'function') ? dt.page.len() : 10;
  sel.value = String(current);
}

function initShipmentTable() {
  if (dtInitialized) return;
  if (!hasDataTables()) return;

  const $table = $('#shipmentTable');
  if (!$table.length) return;
  if ($.fn.DataTable.isDataTable('#shipmentTable')) return;

  installShipmentFilterHook();

  dt = $table.DataTable({
    pageLength: 10,
    lengthChange: true,
    lengthMenu: [[10, 25, 50, 100, 500, 1000], [10, 25, 50, 100, 500, 1000]],
    dom:
      "<'shipment-topbar d-flex justify-content-between align-items-center mb-2'<'shipment-pager-top'p><'shipment-show-top d-flex align-items-center gap-2'<'small text-muted'>l>>" +
      "rt" +
      "<'d-none'<'col-12'i><'col-12'p>>",
    order: [[2, 'asc']],
    columnDefs: [{ orderable: false, targets: [0, 1] }],
    language: { emptyTable: 'No packages in this shipment.' }
  });
  window.dt = dt;

  bindShipmentLengthSelect();

  $(document)
    .off('click.shipmentHeader', '#shipmentTable thead th:first-child, #selectAll')
    .on('click.shipmentHeader', '#shipmentTable thead th:first-child, #selectAll', function (e) {
      e.stopPropagation();
    });

  dt.on('draw.shipment', function () {
    updateShipmentHeaderCheckbox();
    syncShipmentLengthSelect();
  });

  dtInitialized = true;
  updateShipmentHeaderCheckbox();
  syncShipmentLengthSelect();
}

/* ==========================
   FILTERS bind
   ========================== */
(function bindShipmentFilters(){
  const btnApply = document.getElementById('btnApplyFilters');
  const btnClear = document.getElementById('btnClearFilters');

  function doApply() {
    if (dt) { dt.draw(); return; }
    const tbody = document.querySelector('#shipmentTable tbody');
    if (!tbody) return;
    const f = getFilterValues();

    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
      const userText = parseCellText(tr.querySelector('td:nth-child(3)'));
      const pkgText  = parseCellText(tr.querySelector('td:nth-child(4)'));
      const w = parseWeightFromRow(tr);

      let ok = true;
      if (f.name && !userText.includes(f.name)) ok = false;
      if (f.reg && !userText.includes(f.reg)) ok = false;
      if (f.tracking && !pkgText.includes(f.tracking)) ok = false;
      if (f.wMin != null && w < f.wMin) ok = false;
      if (f.wMax != null && w > f.wMax) ok = false;

      tr.style.display = ok ? '' : 'none';
    });
  }

  function doClear() {
    ['fltName','fltTracking','fltReg','fltWMin','fltWMax'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });

    if (dt) { dt.draw(); return; }
    const tbody = document.querySelector('#shipmentTable tbody');
    if (!tbody) return;
    Array.from(tbody.querySelectorAll('tr')).forEach(tr => tr.style.display = '');
  }

  btnApply?.addEventListener('click', doApply);
  btnClear?.addEventListener('click', doClear);

  ['fltName','fltTracking','fltReg','fltWMin','fltWMax'].forEach(id => {
    document.getElementById(id)?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); doApply(); }
    });
  });
})();

/* ============================================================
   ‚úÖ KEY FIX: Ensure DT pagination still posts weight/value/overrides
   - We copy the selected rows‚Äô fields into hidden inputs before submit.
   ============================================================ */
function rebuildHiddenPostPayloadForSelected(form, ids) {
  // remove old
  document.getElementById('selectedIdsContainer')?.remove();

  const holder = document.createElement('div');
  holder.id = 'selectedIdsContainer';

  function appendHidden(name, value) {
    if (value === null || value === undefined) return;
    const v = String(value).trim();
    if (v === "") return; // ‚úÖ DO NOT POST BLANKS
    const i = document.createElement('input');
    i.type = 'hidden';
    i.name = name;
    i.value = v;
    holder.appendChild(i);
  }

  function getValById(prefix, id) {
    const el = document.getElementById(prefix + id);
    if (!el) return null;     // ‚úÖ return null instead of ""
    return el.value;
  }


  ids.forEach(id => {
    appendHidden('package_ids', id);

    // weight/value/category
    appendHidden(`weight_${id}`, getValById('weight_', id));
    appendHidden(`value_${id}`,  getValById('value_',  id));
    appendHidden(`category_${id}`, getValById('category_', id));

    // manual overrides
    appendHidden(`duty_${id}`,    getValById('duty_', id));
    appendHidden(`gct_${id}`,     getValById('gct_', id));
    appendHidden(`scf_${id}`,     getValById('scf_', id));
    appendHidden(`envl_${id}`,    getValById('envl_', id));
    appendHidden(`caf_${id}`,     getValById('caf_', id));
    appendHidden(`stamp_${id}`,   getValById('stamp_', id));
    appendHidden(`freight_${id}`, getValById('freight_', id));
    appendHidden(`handling_${id}`,getValById('handling_', id));
    appendHidden(`other_${id}`,   getValById('other_', id));
  });

  // ‚úÖ Disable ALL visible row inputs so ONLY our hidden selected payload is posted
  form.querySelectorAll(`
    input[name^="weight_"],
    input[name^="value_"],
    input[name^="category_"],
    input[name^="duty_"],
    input[name^="gct_"],
    input[name^="scf_"],
    input[name^="envl_"],
    input[name^="caf_"],
    input[name^="stamp_"],
    input[name^="freight_"],
    input[name^="handling_"],
    input[name^="other_"]
  `).forEach(el => { el.disabled = true; });

  form.appendChild(holder);
}

/* ============================================================
   BULK ACTION handler (FINAL FIXED)
   ============================================================ */
async function handleShipmentApply(e) {
  if (e && e.preventDefault) e.preventDefault();

  const form = document.getElementById('shipmentForm');
  if (!form) { console.error('shipmentForm not found'); return; }

  const actionSel = form.querySelector('select[name="action"]');
  const action = actionSel ? actionSel.value : '';
  if (!action) { alert('‚ö†Ô∏è Please select an action.'); return; }

  // gather selected IDs (across all DT pages)
  let ids = [];
  if (dt && window.jQuery && $.fn.DataTable && $.fn.DataTable.isDataTable('#shipmentTable')) {
    ids = dt.$('.package-checkbox:checked').map(function () { return this.value; }).get();
  } else {
    ids = Array.from(document.querySelectorAll('.package-checkbox:checked')).map(cb => cb.value);
  }

  if (action === 'finance_invoice') {
    const shipmentId = getShipmentIdFromUrl();
    if (!shipmentId) { alert("‚ö†Ô∏è No shipment selected (missing shipment_id in URL)."); return; }
    await openShipmentFinanceInvoicePreviewJSON(shipmentId, []);
    return;
  }

  if (!ids.length) { alert('‚ö†Ô∏è Please select at least one package.'); return; }

  if (action === 'generate_invoice') {
    try { await openInvoicePreview(ids); }
    catch (err) { console.error(err); alert('‚ö†Ô∏è Could not load invoice preview.'); }
    return;
  }

  if (action === 'move') {
    const holder = document.getElementById('movePackageIdsContainer');
    if (holder) holder.innerHTML = '';
    ids.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'package_ids';
      input.value = id;
      holder.appendChild(input);
    });

    const fromInput = document.querySelector('#moveShipmentForm input[name="from_shipment_id"]');
    if (fromInput) fromInput.value = getShipmentIdFromUrl() || fromInput.value || 0;

    const modalEl = document.getElementById('moveShipmentModal');
    if (modalEl) bootstrap.Modal.getOrCreateInstance(modalEl).show();
    return;
  }

  // ‚úÖ DT-safe payload
  rebuildHiddenPostPayloadForSelected(form, ids);

  if (!confirm(`Perform "${action}" on ${ids.length} package(s)?`)) return;
  form.submit();
}

/* ==========================
   Init on ready
   ========================== */
(function () {
  if (!window.jQuery) return;
  $(function () {
    if (hasDataTables() && $('#dashboardPrealertsTable').length) {
      $('#dashboardPrealertsTable').DataTable({
        order: [[0, 'desc']],
        pageLength: 10,
        language: { emptyTable: "No pre-alert shipments found." }
      });
    }
    if (document.getElementById('shipmentTable')) initShipmentTable();
    else bindShipmentLengthSelect();
  });
})();

/* ==========================
   Select all helpers
   ========================== */
function toggleShipmentSelectAll(master) {
  if (dt && window.jQuery && $.fn.DataTable && $.fn.DataTable.isDataTable('#shipmentTable')) {
    dt.$('.package-checkbox').prop('checked', master.checked);
    updateShipmentHeaderCheckbox();
    return;
  }
  const tbody = document.querySelector('#shipmentTable tbody');
  if (!tbody) return;
  tbody.querySelectorAll('.package-checkbox').forEach(cb => cb.checked = master.checked);
  updateShipmentHeaderCheckbox();
}

function updateShipmentHeaderCheckbox() {
  const header = document.getElementById('selectAll');
  const tbody  = document.querySelector('#shipmentTable tbody');
  if (!header || !tbody) return;

  if (dt && window.jQuery && $.fn.DataTable && $.fn.DataTable.isDataTable('#shipmentTable')) {
    const all = dt.$('.package-checkbox').length;
    const chk = dt.$('.package-checkbox:checked').length;
    header.checked = (all > 0 && all === chk);
    return;
  }

  const boxes = tbody.querySelectorAll('.package-checkbox');
  const checked = tbody.querySelectorAll('.package-checkbox:checked');
  header.checked = (boxes.length > 0 && boxes.length === checked.length);
}

/* ============================================================
   CHARGES MODAL (single) - FINAL FIXED (NO BLANK MODAL)
   - Fixes Bootstrap relatedTarget sometimes null
   - Pulls weight/value from current row inputs (DataTables safe)
   - Loads category from button OR hidden input
   - Live sync override fields into hidden inputs for bulk posting
   ============================================================ */
(function initChargesModal(){
  const chargesModal = document.getElementById('chargesModalSL');
  if (!chargesModal) return;

  const pkgIdInput     = document.getElementById('chargesPkgId');
  const pkgDescInput   = document.getElementById('chargesPkgDesc');
  const weightInput    = document.getElementById('chargesWeight');
  const valueInput     = document.getElementById('chargesValue');
  const categorySelect = document.getElementById('chargesCategory');

  const btnCalc        = document.getElementById('btnCalcCharges');
  const btnApply       = document.getElementById('btnApplyToPkg');
  const resultBox      = document.getElementById('chargesResult');
  const errorBox       = document.getElementById('chargesError');

  const resDuty         = document.getElementById('resDuty');
  const resGct          = document.getElementById('resGct');
  const resScf          = document.getElementById('resScf');
  const resEnvl         = document.getElementById('resEnvl');
  const resCaf          = document.getElementById('resCaf');
  const resStamp        = document.getElementById('resStamp');
  const resCustomsTotal = document.getElementById('resCustomsTotal');

  const resFreight      = document.getElementById('resFreight');
  const resHandling     = document.getElementById('resHandling');
  const resFreightTotal = document.getElementById('resFreightTotal');
  const resOther        = document.getElementById('resOther');
  const resTotal        = document.getElementById('resTotal');

  // ‚úÖ Manual override toggle
  const lockToggle = document.getElementById('pricingLockedToggle');

  function isLocked() {
    return !!lockToggle?.checked;
  }
  function setLocked(v) {
    if (lockToggle) lockToggle.checked = !!v;
  }


  // ‚úÖ remember last clicked trigger so we can recover when relatedTarget is null
  let lastTriggerBtn = null;

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.js-open-charges');
    if (!btn) return;
    lastTriggerBtn = btn;
  },   true); // ‚úÖ capture mode


  function numVal(el) {
    if (!el) return 0;
    const v = parseFloat(el.value || '0');
    return isNaN(v) ? 0 : v;
  }

  function setHidden(id, val) {
    const el = document.getElementById(id);
    if (el) el.value = Number(val || 0).toFixed(2);
  }

  function syncHiddenOverridesFromModal(pkgId) {
    if (!pkgId) return;
    setHidden(`duty_${pkgId}`,     numVal(resDuty));
    setHidden(`gct_${pkgId}`,      numVal(resGct));
    setHidden(`scf_${pkgId}`,      numVal(resScf));
    setHidden(`envl_${pkgId}`,     numVal(resEnvl));
    setHidden(`caf_${pkgId}`,      numVal(resCaf));
    setHidden(`stamp_${pkgId}`,    numVal(resStamp));
    setHidden(`freight_${pkgId}`,  numVal(resFreight));
    setHidden(`handling_${pkgId}`, numVal(resHandling));
    setHidden(`other_${pkgId}`,    numVal(resOther));
  }

  function recalcTotalsFromManual() {
    const duty  = numVal(resDuty);
    const gct   = numVal(resGct);
    const scf   = numVal(resScf);
    const envl  = numVal(resEnvl);
    const caf   = numVal(resCaf);
    const stamp = numVal(resStamp);

    const customsTotal = duty + gct + scf + envl + caf + stamp;
    if (resCustomsTotal) resCustomsTotal.value = customsTotal.toFixed(2);

    const freight  = numVal(resFreight);
    const handling = numVal(resHandling);
    const other    = numVal(resOther);

    const freightTotal = freight + handling + other;
    if (resFreightTotal) resFreightTotal.value = freightTotal.toFixed(2);

    const grandTotal = customsTotal + freightTotal;
    if (resTotal) resTotal.value = grandTotal.toFixed(2);

    const pkgId = (pkgIdInput?.value || '').trim();
    syncHiddenOverridesFromModal(pkgId);
  }

    [resDuty,resGct,resScf,resEnvl,resCaf,resStamp,resFreight,resHandling,resOther].forEach(el => {
      if (!el) return;
      el.addEventListener('input', () => {
        setLocked(true);          // ‚úÖ if user edits manually, lock it
        recalcTotalsFromManual();
      });
    });


  // ‚úÖ DT-safe get weight/value from inputs
  function getRowWeightValue(pkgId) {
    // normal DOM
    let wEl = document.getElementById(`weight_${pkgId}`);
    let vEl = document.getElementById(`value_${pkgId}`);

    // DataTables fallback
    if ((!wEl || !vEl) && window.dt && window.jQuery) {
      const $row = dt.$(`input.package-checkbox[value="${pkgId}"]`).closest('tr');
      if ($row && $row.length) {
        if (!wEl) wEl = $row.find(`#weight_${pkgId}`)[0] || $row.find(`[name="weight_${pkgId}"]`)[0];
        if (!vEl) vEl = $row.find(`#value_${pkgId}`)[0]  || $row.find(`[name="value_${pkgId}"]`)[0];
      }
    }

    const weight = wEl ? (wEl.value || "0") : "0";
    const value  = vEl ? (vEl.value  || "0") : "0";
    return { weight, value };
  }

  // ‚úÖ IMPORTANT: Use relatedTarget OR lastTriggerBtn
  chargesModal.addEventListener('show.bs.modal', function (event) {
    const btn = event.relatedTarget || lastTriggerBtn;

    if (!btn) {
      console.warn("chargesModal opened but no trigger button found (relatedTarget missing).");
      return;
    }

    const pkgId = (btn.getAttribute('data-pkg-id') || '').trim();
    const desc  = (btn.getAttribute('data-desc') || '').trim();

    if (!pkgId) {
      console.warn("Trigger button missing data-pkg-id:", btn);
      return;
    }

    if (pkgIdInput)   pkgIdInput.value = pkgId;
    if (pkgDescInput) pkgDescInput.value = desc;

    // ‚úÖ load pricing lock state from row
    const lockedHidden = document.getElementById(`locked_${pkgId}`);
    setLocked((lockedHidden?.value || '0') === '1');


    // ‚úÖ set category (button OR hidden row OR default)
    const catBtn = (btn.getAttribute('data-category') || '').trim();
    const catHidden = document.getElementById(`category_${pkgId}`);
    const catRow = (catHidden?.value || '').trim();
    if (categorySelect) categorySelect.value = catBtn || catRow || 'Other';

    // ‚úÖ pull current values
    const { weight, value } = getRowWeightValue(pkgId);
    if (weightInput) weightInput.value = weight;
    if (valueInput)  valueInput.value  = value;

    // preload overrides
    const getHidden = (id) => Number(document.getElementById(id)?.value || 0).toFixed(2);
    if (resDuty)  resDuty.value  = getHidden(`duty_${pkgId}`);
    if (resGct)   resGct.value   = getHidden(`gct_${pkgId}`);
    if (resScf)   resScf.value   = getHidden(`scf_${pkgId}`);
    if (resEnvl)  resEnvl.value  = getHidden(`envl_${pkgId}`);
    if (resCaf)   resCaf.value   = getHidden(`caf_${pkgId}`);
    if (resStamp) resStamp.value = getHidden(`stamp_${pkgId}`);
    if (resFreight)  resFreight.value  = getHidden(`freight_${pkgId}`);
    if (resHandling) resHandling.value = getHidden(`handling_${pkgId}`);
    if (resOther)    resOther.value    = getHidden(`other_${pkgId}`);

    recalcTotalsFromManual();

    if (errorBox) { errorBox.style.display = 'none'; errorBox.textContent = ''; }
    if (resultBox) resultBox.style.display = 'block';
    if (btnApply) btnApply.style.display = 'inline-block';
  });

  btnCalc?.addEventListener('click', async function () {
    const category = (categorySelect?.value || 'Other');
    const pkgId    = (pkgIdInput?.value || '').trim();
    if (!pkgId) return;
 
    if (isLocked()) {
      alert("Manual override is ON. Turn it OFF to auto-calculate.");
      return;
    }

    // ‚úÖ refresh weight/value from row right before calculation
    const { weight, value } = getRowWeightValue(pkgId);
    if (weightInput) weightInput.value = weight;
    if (valueInput)  valueInput.value  = value;

    try {
      const res = await fetch("{{ url_for('logistics.api_calculate_charges') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": "{{ csrf_token() }}"
        },
        body: JSON.stringify({
          category: category,
          weight: Number(weight || 0),
          invoice_usd: Number(value || 0)
        })
      });

      const d = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(d.error || `HTTP ${res.status}`);

      const pick = (obj, keys, fallback=0) => {
        for (const k of keys) {
          if (obj && obj[k] != null && obj[k] !== "") return Number(obj[k]);
        }
        return fallback;
      };
      const fmt = (x) => Number(x || 0).toFixed(2);

      // customs
      if (resDuty)  resDuty.value  = fmt(pick(d, ['duty']));
      if (resGct)   resGct.value   = fmt(pick(d, ['gct']));
      if (resScf)   resScf.value   = fmt(pick(d, ['scf']));
      if (resEnvl)  resEnvl.value  = fmt(pick(d, ['envl']));
      if (resCaf)   resCaf.value   = fmt(pick(d, ['caf']));
      if (resStamp) resStamp.value = fmt(pick(d, ['stamp']));

      // freight/handling keys vary across versions
      if (resFreight)  resFreight.value  = fmt(pick(d, ['freight_fee', 'freight']));
      if (resHandling) resHandling.value = fmt(pick(d, ['handling_fee', 'handling', 'storage_fee']));
      if (resOther)    resOther.value    = fmt(pick(d, ['other_charges', 'other', 'other_fee'], 0));


      recalcTotalsFromManual();

      if (errorBox) errorBox.style.display = 'none';
      if (resultBox) resultBox.style.display = 'block';
      if (btnApply) btnApply.style.display = 'inline-block';

    } catch (err) {
      console.error(err);
      if (errorBox) {
        errorBox.textContent = "Failed to calculate charges: " + (err.message || err);
        errorBox.style.display = 'block';
      }
      if (resultBox) resultBox.style.display = 'none';
      if (btnApply) btnApply.style.display = 'none';
    }
  });

  btnApply?.addEventListener('click', async function () {
    const pkgId = (pkgIdInput?.value || '').trim();
    if (!pkgId) return;

    const cat = (categorySelect?.value || 'Other');
    const catHidden = document.getElementById(`category_${pkgId}`);
    if (catHidden) catHidden.value = cat;

    recalcTotalsFromManual();

    const payload = {
      category: cat,
      value:    numVal(valueInput),
      weight:   numVal(weightInput),

      duty:          numVal(resDuty),
      gct:           numVal(resGct),
      scf:           numVal(resScf),
      envl:          numVal(resEnvl),
      caf:           numVal(resCaf),
      stamp:         numVal(resStamp),

      customs_total: numVal(resCustomsTotal),

      freight:       numVal(resFreight),
      handling:      numVal(resHandling),
      other_charges: numVal(resOther),

      freight_total: numVal(resFreightTotal),
      grand_total:   numVal(resTotal),

      amount_due:    numVal(resTotal),
      pricing_locked: isLocked(),
      force: true
    };

    // update visible row inputs (SAFE - no optional chaining on assignment)
    const amountEl = document.getElementById(`amount_due_${pkgId}`);
    if (amountEl) amountEl.value = payload.amount_due.toFixed(2);

    const valueEl = document.getElementById(`value_${pkgId}`);
    if (valueEl) valueEl.value = payload.value.toFixed(2);

    const weightEl = document.getElementById(`weight_${pkgId}`);
    if (weightEl) weightEl.value = payload.weight.toFixed(2);


    // sync hidden override fields
    setHidden(`duty_${pkgId}`, payload.duty);
    setHidden(`gct_${pkgId}`, payload.gct);
    setHidden(`scf_${pkgId}`, payload.scf);
    setHidden(`envl_${pkgId}`, payload.envl);
    setHidden(`caf_${pkgId}`, payload.caf);
    setHidden(`stamp_${pkgId}`, payload.stamp);
    setHidden(`freight_${pkgId}`, payload.freight);
    setHidden(`handling_${pkgId}`, payload.handling);
    setHidden(`other_${pkgId}`, payload.other_charges);

    const updateUrl = "{{ url_for('logistics.api_update_package', pkg_id=0) }}".replace(/\/0$/, `/${pkgId}`);

    try {
      const res = await fetch(updateUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(payload)
      });

      const out = await res.json().catch(() => ({}));
      if (!res.ok || out.ok === false) throw new Error(out.error || `HTTP ${res.status}`);

      // ‚úÖ remember lock state in the row for next time modal opens
      const lockedEl = document.getElementById(`locked_${pkgId}`);
      if (lockedEl) lockedEl.value = payload.pricing_locked ? '1' : '0';

      alert(`Saved charges for package ${pkgId}.`);
      bootstrap.Modal.getInstance(chargesModal)?.hide();
    } catch (err) {
      console.error(err);
      alert('‚ö†Ô∏è Error saving charges for this package.');
    }
  });

})();

// ===============================
// BULK INVOICE FINALIZE (GLOBAL) - robust
// supports: {selections:[{user_id, package_ids}]} OR {package_ids:[...]} OR {user_ids:[...]}
// handles non-JSON responses safely
// ===============================
window.finalizeInvoicesFromModal = async function (e) {
  if (e) e.preventDefault();

  const btn = document.getElementById("btn-finalize-invoices");
  const oldText = btn ? btn.innerText : "";

  if (btn) {
    btn.disabled = true;
    btn.innerText = "Generating‚Ä¶";
  }

  try {
    const checks = Array.from(
      document.querySelectorAll("#inv-prev-tbody .inv-user:checked")
    );

    if (!checks.length) {
      alert("‚ö†Ô∏è Please select at least one customer.");
      return;
    }

    // Build selections (per-user)
    const selections = checks
      .map(cb => ({
        user_id: Number(cb.dataset.uid || 0),
        package_ids: String(cb.dataset.pkgs || "")
          .split(",")
          .map(x => parseInt(x, 10))
          .filter(n => Number.isFinite(n) && n > 0)
      }))
      .filter(x => x.user_id && x.package_ids.length);

    if (!selections.length) {
      alert("‚ö†Ô∏è Nothing to invoice (missing package ids).");
      return;
    }

    // Also build a flat package_ids list (for backends that expect it)
    const package_ids = Array.from(
      new Set(selections.flatMap(s => s.package_ids))
    );

    const url = "{{ url_for('logistics.bulk_invoice_finalize_json') }}";

    let res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "X-CSRFToken": "{{ csrf_token() }}",
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify({ selections, package_ids, shipment_id: getShipmentIdFromUrl() })
    });

    const ct = (res.headers.get("content-type") || "").toLowerCase();
    let data = null;

    if (ct.includes("application/json")) {
      data = await res.json().catch(() => null);
    } else {
      const txt = await res.text().catch(() => "");
      if (!res.ok) {
        throw new Error(txt || `Finalize failed (HTTP ${res.status})`);
      }
      data = { ok: true };
    }

    if (!res.ok || (data && data.ok === false)) {
      throw new Error(
        (data && data.error) || `Finalize failed (HTTP ${res.status})`
      );
    }

    const modalEl = document.getElementById("bulkInvoicePreviewModal");
    if (modalEl) {
      bootstrap.Modal.getInstance(modalEl)?.hide();
    }

    if (data && data.redirect_url) {
      window.location.href = data.redirect_url;
    } else {
      window.location.reload();
    }

  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Could not generate invoices.\n\n" + (err?.message || err));
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerText = oldText;
    }
  }
};

/* ==========================
   SHIPMENT SEARCH MODAL
   ========================== */
document.getElementById('shipmentSearchForm')?.addEventListener('submit', async function (e) {
  e.preventDefault();
  const params = new URLSearchParams(new FormData(this));
  const res = await fetch('{{ url_for("logistics.search_shipment_packages") }}?' + params.toString(), {
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  });
  const data = await res.json();

  const tbody = document.querySelector('#shipmentSearchResults tbody');
  tbody.innerHTML = '';

  if (!data.rows || !data.rows.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-muted">No results.</td></tr>';
    return;
  }

  for (const r of data.rows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.full_name || '-'}</td>
      <td>${r.registration_number || '-'}</td>
      <td>${r.tracking_number || '-'}</td>
      <td>${r.house_awb || '-'}</td>
      <td>${r.description || '-'}</td>
      <td>${r.sl_id || '-'}</td>
    `;
    tbody.appendChild(tr);
  }
});

window.openChargesModal = function (btn) {
  const chargesModal = document.getElementById('chargesModalSL');
  if (!chargesModal || !btn) return;

  const pkgIdInput   = document.getElementById('chargesPkgId');
  const pkgDescInput = document.getElementById('chargesPkgDesc');
  const weightInput  = document.getElementById('chargesWeight');
  const valueInput   = document.getElementById('chargesValue');
  const catSelect    = document.getElementById('chargesCategory');
  const lockToggle   = document.getElementById('pricingLockedToggle');

  const pkgId = (btn.getAttribute('data-pkg-id') || '').trim();
  const desc  = (btn.getAttribute('data-desc') || '').trim();
  const cat   = (btn.getAttribute('data-category') || 'Other').trim();

  if (pkgIdInput) pkgIdInput.value = pkgId;
  if (pkgDescInput) pkgDescInput.value = desc;
  if (catSelect) catSelect.value = cat || 'Other';

  // Pull weight/value from the SAME row the button is in (most reliable)
  const tr = btn.closest('tr');
  const wEl = tr?.querySelector(`#weight_${pkgId}`) || document.getElementById(`weight_${pkgId}`);
  const vEl = tr?.querySelector(`#value_${pkgId}`)  || document.getElementById(`value_${pkgId}`);

  if (weightInput) weightInput.value = wEl ? (wEl.value || "0") : "0";
  if (valueInput)  valueInput.value  = vEl ? (vEl.value || "0") : "0";

  // Load lock state from hidden
  const lockedHidden = document.getElementById(`locked_${pkgId}`);
  if (lockToggle) lockToggle.checked = (lockedHidden?.value || '0') === '1';

  bootstrap.Modal.getOrCreateInstance(chargesModal).show();
};

/* ============================================================
   HOTFIX: Always populate charges modal on click
   - Works even when Bootstrap relatedTarget is missing
   - Works even when DataTables swaps DOM rows
   - Also fixes Select All with DataTables
   ============================================================ */

(function hotfixChargesAndSelectAll(){
  // ---------- CHARGES MODAL POPULATE ----------
  const modalEl = document.getElementById('chargesModalSL');
  if (modalEl) {
    const pkgIdInput     = document.getElementById('chargesPkgId');
    const pkgDescInput   = document.getElementById('chargesPkgDesc');
    const weightInput    = document.getElementById('chargesWeight');
    const valueInput     = document.getElementById('chargesValue');
    const categorySelect = document.getElementById('chargesCategory');

    function findRowByPkgId(pkgId) {
      // normal DOM
      let tr = document.querySelector(`input.package-checkbox[value="${pkgId}"]`)?.closest('tr');
      if (tr) return tr;

      // DataTables: search all row nodes
      if (window.dt && window.jQuery && $.fn.DataTable && $.fn.DataTable.isDataTable('#shipmentTable')) {
        const nodes = dt.rows().nodes().toArray();
        for (const n of nodes) {
          const cb = n.querySelector(`input.package-checkbox[value="${pkgId}"]`);
          if (cb) return n;
        }
      }
      return null;
    }

    function populateFromButton(btn) {
      const pkgId = (btn.getAttribute('data-pkg-id') || '').trim();
      const desc  = (btn.getAttribute('data-desc') || '').trim();
      const catBtn = (btn.getAttribute('data-category') || '').trim();

      if (!pkgId) return;

      if (pkgIdInput)   pkgIdInput.value = pkgId;
      if (pkgDescInput) pkgDescInput.value = desc;

      // category
      const catHidden = document.getElementById(`category_${pkgId}`);
      const catRow = (catHidden?.value || '').trim();
      if (categorySelect) categorySelect.value = catBtn || catRow || 'Other';

      // weight/value from row inputs (DT safe)
      const row = findRowByPkgId(pkgId);

      const wEl = row?.querySelector(`#weight_${pkgId}`) || document.getElementById(`weight_${pkgId}`);
      const vEl = row?.querySelector(`#value_${pkgId}`)  || document.getElementById(`value_${pkgId}`);

      if (weightInput) weightInput.value = (wEl?.value ?? '0');
      if (valueInput)  valueInput.value  = (vEl?.value ?? '0');
    }

    // Populate BEFORE Bootstrap opens modal
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.js-open-charges');
      if (!btn) return;
      populateFromButton(btn);
    }, true);
  }

  // ---------- SELECT ALL FIX (DataTables safe) ----------
  document.addEventListener('change', function(e){
    const master = e.target;
    if (!master || master.id !== 'selectAll') return;

    const checked = !!master.checked;

    if (window.dt && window.jQuery && $.fn.DataTable && $.fn.DataTable.isDataTable('#shipmentTable')) {
      // select across all DT rows
      dt.rows().nodes().to$().find('.package-checkbox').prop('checked', checked);
    } else {
      document.querySelectorAll('#shipmentTable .package-checkbox').forEach(cb => cb.checked = checked);
    }
  }, true);

})();

/* ================================
   BULK INVOICE PREVIEW + FINALIZE
================================ */

async function openInvoicePreview(selectedPkgIds) {

  const data = await postJSON(
    "{{ url_for('logistics.bulk_invoice_preview') }}",
    { package_ids: selectedPkgIds }
  );

  const tbody = document.querySelector('#inv-prev-tbody');

  if (!tbody) {
    alert('Preview table body #inv-prev-tbody not found in DOM.');
    return;
  }

  tbody.innerHTML = '';

  let grand = 0;

  for (const row of (data.rows || [])) {

    grand += Number(row.total_due || 0);

    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td>
        <input type="checkbox"
               class="inv-user"
               data-uid="${row.user_id}"
               data-pkgs="${(row.package_ids || []).join(',')}"
               checked>
      </td>
      <td>
        <strong>${row.registration_number || ''}</strong>
        ${row.full_name || ''}
      </td>
      <td class="text-center">
        ${row.package_count || 0}
      </td>
      <td class="text-end">
        ${Number(row.total_due || 0).toFixed(2)}
      </td>
    `;

    tbody.appendChild(tr);
  }

  if (!(data.rows || []).length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="text-muted">
          No eligible packages to invoice
          (detained / already invoiced were skipped).
        </td>
      </tr>
    `;
  }

  const totalCell = document.getElementById('inv-prev-total');
  if (totalCell) {
    totalCell.textContent = grand.toFixed(2);
  }

  const note = document.getElementById('detained-note');
  if (note) {
    const parts = [];

    if (data.detained_skipped)
      parts.push(`‚Ä¢ ${data.detained_skipped} detained package(s) skipped`);

    if (data.already_invoiced_skipped)
      parts.push(`‚Ä¢ ${data.already_invoiced_skipped} already-invoiced package(s) skipped`);

    note.textContent = parts.join(' ');
  }

  const modalEl = document.getElementById('bulkInvoicePreviewModal');
  const modal = new bootstrap.Modal(modalEl);
  modal.show();
}

/* =====================================
   SHIPMENT FINANCE INVOICE (OPTION A)
===================================== */

function openShipmentFinanceInvoiceModalWithHtml(html) {
  const bodyEl = document.getElementById('shipmentFinanceInvoiceBody');
  if (bodyEl) bodyEl.innerHTML = html;

  const modalEl = document.getElementById('shipmentFinanceInvoiceModal');
  if (!modalEl) {
    alert("Shipment finance invoice modal not found.");
    return;
  }

  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
}


async function openShipmentFinanceInvoicePreviewJSON(shipmentId, packageIds) {

  const url = "{{ url_for('logistics.shipment_finance_invoice_preview_json', shipment_id=0) }}"
    .replace("/0/", `/${shipmentId}/`);

  try {

    const r = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token() }}",
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify({ package_ids: packageIds || [] })
    });

    const data = await r.json();

    if (!r.ok || !data.ok) {
      console.error("Finance preview-json failed:", r.status, data);
      alert(`‚ö†Ô∏è Finance invoice preview failed (${r.status}). ${data.error || ""}`);
      return;
    }

    const fmt2 = (n) => Number(n || 0).toFixed(2);

    const usd_to_jmd     = Number(data.usd_to_jmd || 0);
    const pkgCount       = Number(data.package_count || 0);
    const freightUsd     = Number(data.freight_usd || 0);
    const freightJmd     = freightUsd * usd_to_jmd;
    const rateUsdPerKg   = Number(data.rate_usd_per_kg || 0);

    let rowsHtml = "";

    /* ===== Freight Row ===== */
    rowsHtml += `
      <tr>
        <td><strong>Freight</strong></td>
        <td class="text-end">${pkgCount}</td>
        <td class="text-end">$${fmt2(rateUsdPerKg)}</td>
        <td class="text-end">$${fmt2(freightUsd)}</td>
        <td class="text-end">${fmt2(freightJmd)}</td>
      </tr>
    `;

    /* ===== Service Bands ===== */
    let serviceUsdSum = 0;
    let serviceJmdSum = 0;

    (data.service_bands || []).forEach(b => {

      const count    = Number(b.count || 0);
      const rateUsd  = Number(b.rate_usd || 0);
      const lineUsd  = Number(b.line_usd || 0);
      const lineJmd  = lineUsd * usd_to_jmd;

      serviceUsdSum += lineUsd;
      serviceJmdSum += lineJmd;

      rowsHtml += `
        <tr>
          <td>${b.band}</td>
          <td class="text-end">${count}</td>
          <td class="text-end">$${fmt2(rateUsd)}</td>
          <td class="text-end">$${fmt2(lineUsd)}</td>
          <td class="text-end">${fmt2(lineJmd)}</td>
        </tr>
      `;
    });

    rowsHtml += `
      <tr class="table-light fw-bold">
        <td colspan="3" class="text-end">Service Total</td>
        <td class="text-end">$${fmt2(serviceUsdSum)}</td>
        <td class="text-end">${fmt2(serviceJmdSum)}</td>
      </tr>
    `;

    const tableUsdTotal = freightUsd + serviceUsdSum;
    const tableJmdTotal = freightJmd + serviceJmdSum;

    /* ===== Full HTML ===== */
    const html = `
      <div class="mb-2">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 fw-bold text-purple">
            Shipment Finance Invoice (Supplier Cost)
          </h6>
          <span class="badge bg-purple">
            Shipment #${data.shipment_id}
          </span>
        </div>
        <div class="small text-muted">
          Packages: ${pkgCount}
        </div>
      </div>

      <div class="row g-2 small mb-3">

        <div class="col-md-3">
          <div class="border rounded p-2">
            <div class="text-muted">Total lbs</div>
            <div class="fw-bold">${fmt2(data.total_lbs)}</div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="border rounded p-2">
            <div class="text-muted">Total kg</div>
            <div class="fw-bold">${fmt2(data.total_kg)}</div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="border rounded p-2">
            <div class="text-muted">Freight (USD)</div>
            <div class="fw-bold">$${fmt2(freightUsd)}</div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="border rounded p-2">
            <div class="text-muted">USD‚ÜíJMD</div>
            <div class="fw-bold">${fmt2(usd_to_jmd)}</div>
          </div>
        </div>

      </div>

      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">

          <thead class="table-dark">
            <tr>
              <th>Service Band (lbs)</th>
              <th class="text-end">Count</th>
              <th class="text-end">Rate (USD)</th>
              <th class="text-end">Amount (USD)</th>
              <th class="text-end">Amount (JMD)</th>
            </tr>
          </thead>

          <tbody>
            ${rowsHtml}
          </tbody>

          <tfoot>
            <tr class="fw-bold">
              <th colspan="3" class="text-end">Total</th>
              <th class="text-end">$${fmt2(tableUsdTotal)}</th>
              <th class="text-end">${fmt2(tableJmdTotal)}</th>
            </tr>
          </tfoot>

        </table>
      </div>

      <div class="row g-2 small mt-3">

        <div class="col-md-4">
          <div class="border rounded p-2">
            <div class="text-muted">Subtotal (USD)</div>
            <div class="fw-bold">$${fmt2(data.subtotal_usd)}</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="border rounded p-2">
            <div class="text-muted">Subtotal (JMD)</div>
            <div class="fw-bold">${fmt2(data.subtotal_jmd)}</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="border rounded p-2">
            <div class="text-muted">Extra Service (JMD)</div>
            <div class="fw-bold">${fmt2(data.extra_service_jmd)}</div>
          </div>
        </div>

      </div>

      <div class="mt-3 border rounded p-3" style="background:#f8f9fa;">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted">TOTAL (JMD)</div>
          <div class="fw-bold" style="font-size:1.6rem;">
            ${fmt2(data.total_jmd)}
          </div>
        </div>
      </div>
    `;

    openShipmentFinanceInvoiceModalWithHtml(html);

  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Unable to load shipment finance invoice preview (JSON).");
  }
}


/* ===== Print Button ===== */

document.getElementById('btnPrintShipmentFinance')
  ?.addEventListener('click', function () {

    const body = document.getElementById('shipmentFinanceInvoiceBody');
    if (!body) return;

    const w = window.open('', '_blank');

    w.document.write(`
      <html>
        <head>
          <title>Shipment Finance Invoice</title>
          <meta name="viewport" content="width=device-width, initial-scale=1" />
        </head>
        <body>
          ${body.innerHTML}
        </body>
      </html>
    `);

    w.document.close();
    w.focus();
    w.print();
  });
  
/* ======================
   UPLOAD SPINNER
====================== */

(function () {

  const form     = document.getElementById('uploadForm');
  const spinner  = document.getElementById('spinner');
  const uploadBtn = document.getElementById('uploadBtn');

  if (form) {
    form.addEventListener('submit', () => {
      if (uploadBtn) uploadBtn.disabled = true;
      if (spinner) spinner.style.display = 'inline-block';
    });
  }

  window.addEventListener('pageshow', () => {
    if (uploadBtn) uploadBtn.disabled = false;
    if (spinner) spinner.style.display = 'none';
  });

})();


/* ==========================
   UPLOAD PREVIEW TABLE (CSV)
========================== */

document.addEventListener('DOMContentLoaded', function () {

  const tableEl = document.getElementById('previewTable');
  if (!tableEl) return;

  const getRowCheckboxes = () =>
    Array.from(document.querySelectorAll('#previewTable input.row-select'));

  const selectAll = document.getElementById('selectAllPreview');

  if (selectAll) {
    selectAll.addEventListener('change', function () {
      const checked = this.checked;

      getRowCheckboxes().forEach(cb => {
        cb.checked = checked;
      });
    });
  }

  const selectValidBtn = document.getElementById('selectValidBtn');

  if (selectValidBtn) {
    selectValidBtn.addEventListener('click', function () {

      getRowCheckboxes().forEach(cb => {
        const tr = cb.closest('tr');
        const isInvalid = tr && tr.classList.contains('table-danger');

        cb.checked = !isInvalid;
      });

    });
  }

});


function handleConfirmSubmit(e) {

  const table = document.getElementById('previewTable');
  if (!table) return true;

  const checkboxes = table.querySelectorAll('input.row-select:checked');
  const indices = Array.from(checkboxes).map(cb => parseInt(cb.value, 10));

  if (!indices.length) {
    if (e) e.preventDefault();
    alert('‚ö†Ô∏è Please select at least one valid row to import.');
    return false;
  }

  const hidden = document.getElementById('selectedIndicesInput');
  if (hidden) hidden.value = JSON.stringify(indices);

  return true;
}


/* ==========================
   PACKAGE ATTACHMENTS (ADMIN)
   ========================== */
(function attachAdminFilesNew(){
  const modalEl  = document.getElementById('attachInvoiceModal');
  if (!modalEl) return;

  const pkgIdInput = document.getElementById('attachPkgId');
  const pkgLbl     = document.getElementById('attachPkgLabel');
  const fileInput  = document.getElementById('attachFiles');
  const statusEl   = document.getElementById('attachUploadStatus');
  const uploadBtn  = document.getElementById('btnAttachUpload');

  let currentPkgId = null;

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.js-open-attach');
    if (!btn) return;

    currentPkgId = btn.getAttribute('data-pkg-id') || btn.getAttribute('data-pkg') || '';

    if (pkgIdInput) pkgIdInput.value = currentPkgId;
    if (pkgLbl) pkgLbl.textContent = currentPkgId || '‚Äî';
    if (fileInput) fileInput.value = '';
    if (statusEl) statusEl.textContent = 'Select a file to upload.';

    bootstrap.Modal.getOrCreateInstance(modalEl).show();
  });

  async function doUpload() {
    const pkgId = (currentPkgId || pkgIdInput?.value || '').trim();
    if (!pkgId) { alert('Package id missing.'); return; }

    const files = fileInput?.files;
    if (!files || !files.length) { alert('Please choose at least one file.'); return; }

    const csrf = document.getElementById('attachCsrfToken')?.value || '';
    const fd = new FormData();
    if (csrf) fd.append('csrf_token', csrf);
    for (const f of files) fd.append('attachments', f);

    if (statusEl) statusEl.textContent = 'Uploading‚Ä¶';

    const url = `/admin/logistics/packages/${pkgId}/attachments`;

    let res, data = {};
    try {
      res = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: fd });
      try { data = await res.json(); } catch (e) {}
    } catch (err) {
      console.error(err);
      if (statusEl) statusEl.textContent = '';
      alert('Upload failed (network error).');
      return;
    }

    if (!res.ok || !data.success) {
      if (statusEl) statusEl.textContent = '';
      alert(data.error || `Upload failed (HTTP ${res.status}).`);
      return;
    }

    if (statusEl) statusEl.textContent = 'Uploaded!';
    bootstrap.Modal.getInstance(modalEl)?.hide();
    setTimeout(() => window.location.reload(), 350);
  }

  uploadBtn?.addEventListener('click', (e) => { e.preventDefault(); doUpload(); });

  modalEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); doUpload(); }
  });
})();
</script>

<style>
  .logistics-header { background-color: #4a148c; }
  .logistics-tabs .nav-link { color: #4a148c; font-weight: 500; }
  .logistics-tabs .nav-link.active { background-color: #4a148c; color: #fff !important; }
  .bg-purple { background-color: #4a148c !important; }
  .text-purple { color: #4a148c !important; }
  .btn-purple { background-color: #4a148c; color: white; border: none; }
  .btn-purple:hover { background-color: #6a1b9a; }
  .table-hover tbody tr:hover { background-color: #f3e5f5; }
  .table-sm th, .table-sm td { padding: 0.25rem 0.4rem; font-size: 0.75rem; }

  .badge-purple-soft {
    background: rgba(74, 20, 140, 0.12);
    color: #4a148c;
    border: 1px solid rgba(74, 20, 140, 0.3);
  }

  .border-purple { border-color: #4a148c !important; }
  .btn-outline-purple {
    background: transparent; color: #4a148c;
    border: 1px solid #4a148c; transition: .2s;
  }
  .btn-outline-purple:hover { background-color: #4a148c; color: #fff; }
  .badge-purple { background-color: #4a148c; color: #fff; }

  #shipmentTable thead th * { pointer-events: auto !important; }
  #shipmentLengthSelect { min-width: 85px; }

  .tab-content > .tab-pane { display: none; }
  .tab-content > .tab-pane.active,
  .tab-content > .tab-pane.show { display: block !important; }

  .shipment-bulkbar { row-gap: .5rem; }

  .shipment-topbar .dataTables_paginate { margin: 0 !important; }
  .shipment-show-top .dataTables_length { margin: 0 !important; }
  .shipment-show-top .dataTables_length label{
    display:flex; align-items:center; gap:8px; margin:0; white-space:nowrap;
  }
  .shipment-show-top .dataTables_length select { min-width: 90px; }
</style>
{% endblock %}
