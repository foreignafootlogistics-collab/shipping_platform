{% extends "layout_admin.html" %}
{% block title %}Manage Logistics{% endblock %}

{% block content %}
<div class="container mt-4 logistics-dashboard">

  <!-- Header -->
  <h2 class="mb-4 text-white p-3 rounded shadow-sm logistics-header">üì¶ Logistics</h2>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Tabs -->
  <ul class="nav nav-tabs logistics-tabs" id="logisticsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link {% if active_tab == 'prealert' %}active{% endif %}"
         id="prealerts-tab"
         href="{{ url_for('logistics.logistics_dashboard', tab='prealert') }}">
        Pre-Alert Shipments
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link {% if active_tab == 'view_packages' %}active{% endif %}"
         id="view-tab"
         href="{{ url_for('logistics.logistics_dashboard', tab='view_packages') }}">
        View Packages
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link {% if active_tab == 'shipmentLog' %}active{% endif %}"
         id="shipment-tab"
         href="{{ url_for('logistics.logistics_dashboard', tab='shipmentLog') }}">
        Shipment Log
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link {% if active_tab == 'uploadPackages' %}active{% endif %}"
         id="upload-tab"
         href="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}">
        Upload Packages
      </a>
    </li>
  </ul>

  <!-- Tab content (ALL panes live only in here) -->
  <div class="tab-content mt-3" id="logisticsTabsContent">

    {# ---------------- PREALERT TAB ---------------- #}
    {% if active_tab == 'prealert' %}
    <div class="tab-pane show active"
         id="prealerts" role="tabpanel" aria-labelledby="prealerts-tab">
      <div class="table-responsive mt-3">
        <table id="dashboardPrealertsTable" class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Pre-Alert #</th>
              <th>Customer</th>
              <th>Vendor</th>
              <th>Courier</th>
              <th>Tracking #</th>
              <th>Purchase Date</th>
              <th>Contents</th>
              <th>Value (USD)</th>
              <th>Invoice</th>
              <th>Submitted On</th>
            </tr>
          </thead>
          <tbody>
            {% if prealerts %}
              {% for p in prealerts %}
              <tr>
                <!-- 1. Pre-Alert # -->
                <td>{{ p.code }}</td>

                <!-- 2. Customer -->
                <td>
                  {{ p.customer_name or 'N/A' }}<br>
                  <small class="text-muted">{{ p.registration_number or '' }}</small>
                </td>

                <!-- 3. Vendor -->
                <td>{{ p.vendor_name or 'N/A' }}</td>

                <!-- 4. Courier -->
                <td>{{ p.courier_name or 'N/A' }}</td>

                <!-- 5. Tracking # -->
                <td>{{ p.tracking_number or 'N/A' }}</td>

                <!-- 6. Purchase Date -->
                <td>
                  {% if p.purchase_date %}
                    {{ p.purchase_date }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>

                <!-- 7. Contents -->
                <td>{{ p.package_contents or 'N/A' }}</td>

                <!-- 8. Value (USD) -->
                <td>${{ '%.2f'|format(p.item_value_usd or 0) }}</td>

                <!-- 9. Invoice -->
                <td>
                  {% if p.invoice_filename %}
                    <a href="{{ url_for('static', filename='uploads/invoices/' ~ p.invoice_filename) }}"
                       target="_blank">
                      View
                    </a>
                  {% else %}
                    N/A
                  {% endif %}
                </td>

                <!-- 10. Submitted On -->
                <td>
                  {% if p.created_at %}
                    {{ p.created_at }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="10" class="text-center text-muted">
                  No pre-alert shipments found.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

    </div>
    {% endif %}

    {# ---------------- VIEW PACKAGES TAB ---------------- #}
    {% if active_tab == 'view_packages' %}
    <div class="tab-pane show active"
         id="viewPackages" role="tabpanel" aria-labelledby="view-tab">
      {% include "admin/logistics/view_packages.html" %}
    </div>
    {% endif %}

    {# ---------------- SHIPMENT LOG TAB ---------------- #}
    {% if active_tab == 'shipmentLog' %}
    <div class="tab-pane show active"
         id="shipmentLog" role="tabpanel" aria-labelledby="shipment-tab">

      <div class="row mb-3">

        <!-- Sidebar: Shipments -->
        <div class="col-md-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-purple mb-0">üì¶ Shipment Batches</h5>

            <!-- Toolbar -->
            <div class="btn-group btn-group-sm" role="group" aria-label="Shipment toolbar">
              <!-- Create new shipment (blank batch) -->
              <form method="POST"
                    action="{{ url_for('logistics.create_empty_shipment') }}"
                    class="d-inline">
                {{ bulk_form.hidden_tag() }}
                <button type="submit" class="btn btn-outline-primary" title="Create a blank shipment log">
                  <i class="fas fa-plus"></i>
                </button>
              </form>

              <!-- Search packages (open modal) -->
              <button class="btn btn-outline-success" title="Search packages"
                      data-bs-toggle="modal" data-bs-target="#shipmentSearchModal">
                <i class="fas fa-search"></i>
              </button>

              <!-- Delete selected shipment (open modal) -->
              <button class="btn btn-outline-danger" title="Delete current shipment"
                      data-bs-toggle="modal" data-bs-target="#deleteShipmentModal"
                      {% if not selected_shipment %}disabled{% endif %}>
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>

          <ul class="list-group shadow-sm">
            {% if shipments %}
              {% for s in shipments %}
                <li class="list-group-item d-flex justify-content-between align-items-start border-0
                           {% if selected_shipment and s.id == (selected_shipment.id if selected_shipment else None) %}active bg-purple text-white{% endif %}">
                  <a class="flex-grow-1 text-decoration-none
                            {% if selected_shipment and s.id == (selected_shipment.id if selected_shipment else None) %}text-white{% else %}text-dark{% endif %}"
                     href="{{ url_for('logistics.logistics_dashboard', tab='shipmentLog', shipment_id=s.id) }}">
                    <strong>{{ s.sl_id }}</strong><br>
                    <small class="text-muted {% if selected_shipment and s.id == (selected_shipment.id if selected_shipment else None) %}text-light{% endif %}">
                      {{ (s.created_at or now()) | datetimeformat('%Y-%m-%d %H:%M') }}
                    </small>
                  </a>
                </li>
              {% endfor %}
            {% else %}
              <li class="list-group-item text-muted">
                No shipment batches found.
                <br>
                <a href="{{ url_for('logistics.logistics_dashboard', tab='view_packages') }}"
                   class="btn btn-sm btn-purple mt-2">‚ûï Create Shipment</a>
              </li>
            {% endif %}
          </ul>
        </div>

        <!-- Main: Packages -->
        <div class="col-md-9">

          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold text-purple mb-0">
              üöö Shipment Packages
              {% if selected_shipment %}- <span>{{ selected_shipment.sl_id }}</span>{% endif %}
            </h5>
          </div>
          {% if selected_shipment %}
          <form method="POST"
                id="shipmentForm"
                class="d-block"
                action="{{ url_for('logistics.bulk_shipment_action', shipment_id=selected_shipment.id) }}"
                novalidate>
            {{ bulk_form.hidden_tag() }}
            <input type="hidden" name="tab" value="shipmentLog">

            <!-- Bulk action bar -->
            <div class="d-flex justify-content-between align-items-center gap-2 mb-3">

              <!-- LEFT SIDE: Page length selector -->
              <select id="shipmentLengthSelect" class="form-select form-select-sm w-auto">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="500">500</option>
                <option value="1000">1000</option>
              </select>
            <div class="d-flex align-items-center gap-2">
              <select name="action" class="form-select w-auto" required>
                <option value="" selected disabled>Select Action</option>
                <option value="calc_outstanding">üßÆ Calculate Outstanding</option>
                <option value="move">üîÅ Move to Shipment‚Ä¶</option>
                <option value="ready">‚úÖ Mark Ready for Pick Up</option>
                <option value="revert_overseas">‚Ü©Ô∏è Revert to Overseas</option>
                <option value="generate_invoice">üßæ Generate Invoice</option>
                <option value="finance_invoice">üíº Finance Invoice</option>
                <option value="notify_ready">üì£ Email: Ready for Pick-Up</option>
                <option value="send_invoices">üìß Email: Invoices (Totals)</option>
                <option value="remove_from_shipment">üóë Remove from this Shipment</option>
              </select>

              <button type="button"
                      id="shipmentApplyBtn"
                      class="btn btn-purple btn-sm"
                      onclick="handleShipmentApply(event)">
                Apply
              </button>
            </div>

            {% if shipment_packages %}
            <div class="table-responsive shadow-sm">
              <table id="shipmentTable" class="table table-bordered table-striped table-hover align-middle table-sm">
                <thead class="bg-purple text-white small">
                  <tr>
                    <th style="width:30px;">
                      <input type="checkbox" id="selectAll" onclick="toggleShipmentSelectAll(this)">
                    </th>
                    <th>Action</th>
                    <th>User</th>
                    <th>Package</th>
                    <th>House AWB</th>
                    <th>Description</th>
                    <th>Date Received</th>
                    <th>Weight</th>
                    <th>Item Value ($)</th>                  
                    <th>Outstanding ($)</th>
                  </tr>
                </thead>
                <tbody class="small">
                  {% for pkg in shipment_packages %}
                  <tr>
                    <td>
                      <input type="checkbox" 
                             name="package_ids"
                             value="{{ pkg.id }}"
                             class="package-checkbox"                          
                             onclick="updateShipmentHeaderCheckbox()">
                    </td>
                    <td class="text-center">
                      <button type="button"
                              class="btn btn-sm btn-outline-primary"
                              data-bs-toggle="modal"
                              data-bs-target="#chargesModal"
                              data-pkg-id="{{ pkg.id }}"
                              data-desc="{{ pkg.description or '' }}"
                              data-weight="{{ pkg.weight or 0 }}"
                              data-value="{{ pkg.value if pkg.value is not none else 0 }}">
                        <i class="bi bi-calculator"></i>
                      </button>
                    </td>

                    <td>
                      <strong>{{ pkg.full_name }}</strong><br>
                      <small class="text-muted">{{ pkg.registration_number }}</small>
                    </td>

                    <td>
                      {% set status = pkg.status %}
                      {% include 'partials/status_tracker.html' with context %}
                      <br>
                      <small class="text-muted">{{ pkg.tracking_number }}</small>
                    </td>

                    <td>{{ pkg.house_awb or '-' }}</td>

                    <td>
                      <div>{{ pkg.description or '-' }}</div>

                      {# attachments under description #}
                      {% if pkg.attachments and pkg.attachments|length > 0 %}
                        <div class="mt-1 d-flex flex-wrap gap-2">
                          {% for a in pkg.attachments %}
                            <a class="badge text-decoration-none"
                               style="background:#f5f0fa; border:1px solid #4a148c; color:#4a148c;"
                               target="_blank"
                               href="{{ url_for('logistics.view_package_attachment', attachment_id=a.id) }}"
                               title="{{ a.original_name }}">
                              <i class="fa-solid fa-paperclip me-1"></i>
                              {{ (a.original_name or 'file')[:18] }}{% if (a.original_name or '')|length > 18 %}‚Ä¶{% endif %}
                            </a>

                            {# optional: allow delete from shipment log too #}
                            <form method="POST"
                                  action="{{ url_for('logistics.delete_package_attachment_admin', attachment_id=a.id) }}"
                                  class="d-inline"
                                  onsubmit="return confirm('Delete this attachment?');">
                              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                              <button type="submit" class="btn btn-link btn-sm p-0 text-danger">
                                <i class="bi bi-x-circle"></i>
                              </button>
                            </form>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </td>

                    <td>{{ pkg.date_received.strftime('%Y-%m-%d') if pkg.date_received else '-' }}</td>
                    <td><input id="weight_{{ pkg.id }}" type="number" step="0.01" min="0" class="form-control form-control-sm text-end" value="{{ pkg.weight or 0 }}"></td>
                    <td>
                      <input id="value_{{ pkg.id }}" type="number" step="0.01" min="0"
                             class="form-control form-control-sm text-end"
                             value="{{ pkg.value if pkg.value is not none else 0 }}">
                    </td>
                  
                    <td><input id="amount_due_{{ pkg.id }}" type="number" step="0.01" class="form-control form-control-sm text-end" value="{{ pkg.amount_due or 0 }}" readonly></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
              <p class="text-muted">No packages in this shipment.</p>
            {% endif %}

          </form>  {# closes form opened near the bulk actions #}
          {% endif %} {# end if selected_shipment #}

        </div> <!-- /col-md-9 -->
      </div>  <!-- /row mb-3 -->

      

      <!-- Move to Shipment Modal -->
      <div class="modal fade" id="moveShipmentModal" tabindex="-1" aria-labelledby="moveShipmentLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
          <div class="modal-content">
            <form method="POST" 
                  action="{{ url_for('logistics.move_packages_between_shipments') }}" 
                  id="moveShipmentForm"
                  onsubmit="return validateMoveShipmentForm();">
              <div class="modal-header">
                <h5 class="modal-title" id="moveShipmentLabel">Move Packages</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="from_shipment_id" value="{{ selected_shipment.id if selected_shipment else 0 }}">
                <div id="movePackageIdsContainer"></div>

                <label class="form-label small">Destination Shipment</label>
                <select class="form-select form-select-sm" name="to_shipment_id" required>
                  <option value="">Select‚Ä¶</option>
                  {% for s in shipments %}
                    {% if not selected_shipment or s.id != selected_shipment.id %}
                      <option value="{{ s.id }}">{{ s.sl_id }}</option>
                    {% endif %}
                  {% endfor %}
                </select>

                <div class="form-text mt-2">
                  Selected packages will be moved to the chosen shipment.
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-purple btn-sm">Move</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Search Packages Modal -->
      <div class="modal fade" id="shipmentSearchModal" tabindex="-1" aria-labelledby="shipmentSearchLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="shipmentSearchLabel">Search Packages</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <form id="shipmentSearchForm" class="row g-2 mb-3">
                <div class="col-md-6">
                  <label class="form-label small mb-0">Customer Name</label>
                  <input type="text" class="form-control form-control-sm" name="name" placeholder="e.g., Jane Doe">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-0">Registration #</label>
                  <input type="text" class="form-control form-control-sm" name="reg" placeholder="e.g., FA12345">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-0">Tracking #</label>
                  <input type="text" class="form-control form-control-sm" name="tracking" placeholder="e.g., 1Z...">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-0">House AWB</label>
                  <input type="text" class="form-control form-control-sm" name="house" placeholder="e.g., 06978687">
                </div>

                <div class="col-12 d-flex justify-content-end">
                  <button type="submit" class="btn btn-sm btn-purple">Search</button>
                </div>
              </form>

              <div class="table-responsive">
                <table class="table table-sm table-striped align-middle mb-0" id="shipmentSearchResults">
                  <thead class="table-light">
                    <tr>
                      <th>Customer</th>
                      <th>Reg #</th>
                      <th>Tracking #</th>
                      <th>House AWB</th>
                      <th>Description</th>
                      <th>Shipment Batch</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="6" class="text-muted">Enter criteria and click Search.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Shipment Batch Modal -->
      <div class="modal fade" id="deleteShipmentModal" tabindex="-1" aria-labelledby="deleteShipmentLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
          <div class="modal-content">
            <form method="POST" action="{{ url_for('logistics.delete_shipment', shipment_id=(selected_shipment.id if selected_shipment else 0)) }}">
              <div class="modal-header">
                <h5 class="modal-title" id="deleteShipmentLabel">Delete Shipment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                {% if selected_shipment %}
                  <p class="mb-0">Delete <strong>{{ selected_shipment.sl_id }}</strong>?</p>
                  <small class="text-muted">Packages stay in the system; only the batch is removed.</small>
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% else %}
                  <p class="mb-0 text-muted">Select a shipment on the left first.</p>
                {% endif %}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger btn-sm" {% if not selected_shipment %}disabled{% endif %}>Delete</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Charges / Fees Modal -->
      <div class="modal fade" id="chargesModal" tabindex="-1" aria-labelledby="chargesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">

            <div class="modal-header" style="background:#4a148c; color:#fff;">
              <h5 class="modal-title" id="chargesModalLabel">
                Calculate Charges for Package
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <form id="chargesForm" onsubmit="return false;">
                <input type="hidden" id="chargesPkgId">

                <!-- Basic Info -->
                <div class="row g-3 mb-2">
                  <div class="col-12">
                    <label class="form-label fw-semibold">Package</label>
                    <input type="text" id="chargesPkgDesc" class="form-control form-control-sm" readonly>
                  </div>

                  <div class="col-md-4">
                    <label for="chargesCategory" class="form-label fw-semibold">Category</label>
                    <select id="chargesCategory" class="form-select form-select-sm">
                      {% for cat in categories %}
                        <option value="{{ cat }}"
                                {% if (pkg.category if pkg is defined and pkg.category else 'Other') == cat %}selected{% endif %}>
                          {{ cat }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label for="chargesWeight" class="form-label fw-semibold">Weight (lbs)</label>
                    <input type="number" step="0.01" id="chargesWeight" class="form-control form-control-sm">
                  </div>

                  <div class="col-md-4">
                    <label for="chargesValue" class="form-label fw-semibold">Item Value (USD)</label>
                    <input type="number" step="0.01" id="chargesValue" class="form-control form-control-sm">
                  </div>
                </div>

                <hr class="my-3">

                <!-- Results -->
                <div id="chargesResult" style="display:none;">
                  <h6 class="fw-bold mb-2">Breakdown</h6>
                  <div class="row g-2 small">
                    <div class="col-md-4">
                      <div class="border rounded p-2">
                        <div class="text-muted">Duty</div>
                        <input type="number" step="0.01" id="resDuty" class="form-control form-control-sm text-end">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="border rounded p-2">
                        <div class="text-muted">GCT</div>
                        <input type="number" step="0.01" id="resGct" class="form-control form-control-sm text-end">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="border rounded p-2">
                        <div class="text-muted">SCF</div>
                        <input type="number" step="0.01" id="resScf" class="form-control form-control-sm text-end">
                      </div>
                    </div>

                    <div class="col-md-4">
                      <div class="border rounded p-2">
                        <div class="text-muted">ENVL</div>
                        <input type="number" step="0.01" id="resEnvl" class="form-control form-control-sm text-end">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="border rounded p-2">
                        <div class="text-muted">CAF</div>
                        <input type="number" step="0.01" id="resCaf" class="form-control form-control-sm text-end">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="border rounded p-2">
                        <div class="text-muted small">Stamp</div>
                        <input type="number" step="0.01" id="resStamp" class="form-control form-control-sm text-end">
                      </div>
                    </div>

                    <!-- Customs Total / Freight / Handling -->
                    <div class="col-md-4">
                      <div class="border rounded p-2">
                        <div class="text-muted small">Customs Total</div>
                        <input type="number" step="0.01" id="resCustomsTotal" class="form-control form-control-sm text-end">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="border rounded p-2">
                        <div class="text-muted">Freight</div>
                        <input type="number" step="0.01" id="resFreight" class="form-control form-control-sm text-end">
                      </div>
                    </div>

                    <div class="col-md-4">
                      <div class="border rounded p-2">
                        <div class="text-muted">Handling</div>
                        <input type="number" step="0.01" id="resHandling" class="form-control form-control-sm text-end">
                      </div>
                    </div>
                    <!-- Freight Total / Other Charges -->
                    <div class="col-md-4">
                      <div class="border rounded p-2">
                        <div class="text-muted small">Freight Total</div>
                        <input type="number" step="0.01" id="resFreightTotal" class="form-control form-control-sm text-end">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="border rounded p-2">
                        <div class="text-muted small">Other Charges</div>
                        <input type="number" step="0.01" id="resOther" class="form-control form-control-sm text-end">
                      </div>
                    </div>
                    <div class="col-md-8">
                      <div class="border rounded p-2 bg-light">
                        <div class="text-muted">Grand Total (JMD)</div>
                        <input type="number" step="0.01" id="resTotal" class="form-control form-control-sm text-end">
                      </div>
                    </div>
                  </div>
                </div>

                <div id="chargesError"
                     class="alert alert-danger mt-3 py-2 px-3 small"
                     style="display:none;"></div>
              </form>
            </div>

            <div class="modal-footer">
              <button type="button"
                      class="btn btn-outline-secondary btn-sm"
                      data-bs-dismiss="modal">
                Close
              </button>
              <button type="button"
                      id="btnApplyToPkg"
                      class="btn btn-outline-success btn-sm"
                      style="display:none;">
                Apply & Save
              </button>
              <button type="button"
                      id="btnCalcCharges"
                      class="btn btn-purple btn-sm">
                <i class="bi bi-calculator"></i> Calculate Charges
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Bulk Invoice Preview Modal -->
      <div class="modal fade" id="bulkInvoicePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Invoice Preview</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <p id="detained-note" class="text-muted small mb-2"></p>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Select</th>
                      <th>Customer</th>
                      <th class="text-center">Packages</th>
                      <th class="text-end">Total Due</th>
                    </tr>
                  </thead>
                  <tbody id="inv-prev-tbody"></tbody>
                  <tfoot>
                    <tr class="table-light">
                      <th colspan="3" class="text-end">Total Amount Due</th>
                      <th class="text-end" id="inv-prev-total">0.00</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" 
                      class="btn btn-secondary"
                      data-bs-dismiss="modal">
                Cancel
              </button>
              <button id="btn-finalize-invoices"
                      class="btn btn-purple"
                      type="button"                      
                      onclick="finalizeInvoicesFromModal(event)">
                Generate Customer Invoice(s)
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- ‚úÖ Shipment Finance Invoice Preview Modal (Supplier Cost) -->
      <div class="modal fade" id="shipmentFinanceInvoiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Shipment Finance Invoice</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="shipmentFinanceInvoiceBody">
              <p class="text-muted mb-0">Loading shipment invoice‚Ä¶</p>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

              <!-- optional later: save/export -->
              <button type="button" class="btn btn-purple" id="btnPrintShipmentFinance">
                Print / Save
              </button>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- /shipmentLog tab-pane -->
    {% endif %}


     
    <!-- ======================= -->
    <!-- Upload Packages Tab     -->
    <!-- ======================= -->
    {% if active_tab == 'uploadPackages' %}
    <div class="tab-pane show active"
         id="uploadPackages" role="tabpanel" aria-labelledby="upload-tab">

      <div class="card shadow-sm mt-3 border-0">
        <div class="card-header text-white"
             style="background-color:#4a148c; border-top-left-radius:.5rem; border-top-right-radius:.5rem;">
          <h4 class="mb-0">Upload Packages from Excel/CSV</h4>
        </div>

        <div class="card-body p-4">

          <!-- 1) Upload-for-Preview Form -->
          <form id="uploadForm"
                method="POST"
                enctype="multipart/form-data"
                action="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}">
            {{ upload_form.hidden_tag() }}
            <input type="hidden" name="tab" value="uploadPackages">
            <input type="hidden" name="stage" value="preview">

            <div class="mb-3">
              {{ upload_form.file.label(class_="form-label") }}
              {{ upload_form.file(class_="form-control", accept=".xlsx,.csv") }}
              {% for error in upload_form.file.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>

            <div class="d-flex align-items-center gap-2">
              {{ upload_form.submit(class_="btn btn-purple", id="uploadBtn", value="Preview All") }}
              <a href="{{ url_for('static', filename='templates/sample_upload.xlsx') }}"
                 class="btn btn-outline-purple">Download Sample</a>
              <div id="spinner" class="spinner-border text-purple ms-2" role="status" style="display:none;">
                <span class="visually-hidden">Uploading...</span>
              </div>
            </div>
          </form>

          <!-- Messages -->
          {% if message %}
            <div class="alert alert-success mt-4">{{ message }}</div>
          {% endif %}
          {% if errors and errors|length %}
            <div class="alert alert-danger mt-4">
              <ul class="mb-0">
                {% for error in errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          <!-- 2) Full Preview Table + Confirm -->
          {% if preview_headers and preview_rows %}
          <hr class="my-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h5 class="mb-0">Preview All Rows</h5>
            {% if summary_counts %}
              <div class="small">
                <span class="badge badge-purple">Total: {{ summary_counts.total }}</span>
                <span class="badge badge-purple-soft">Valid: {{ summary_counts.valid }}</span>
                <span class="badge bg-danger">Invalid: {{ summary_counts.invalid }}</span>
              </div>
            {% endif %}
            {% if preview_token and summary_counts and summary_counts.invalid %}
              <a class="btn btn-sm btn-outline-danger"
                 href="{{ url_for('logistics.download_preview_invalid', token=preview_token) }}">
                <i class="fas fa-file-csv me-1"></i> Download Invalid Rows
              </a>
            {% endif %}
          </div>

          <div class="table-responsive border rounded shadow-sm">
            <table id="previewTable" class="table table-sm table-bordered table-striped align-middle mb-0">
              <thead class="bg-purple text-white">
                <tr>
                  <th style="width:30px;"><input type="checkbox" id="selectAllPreview"></th>
                  {% for h in preview_headers %}
                    <th>{{ h }}</th>
                  {% endfor %}
                  <th>Status</th>
                  <th style="display:none;">__row_index</th>
                </tr>
              </thead>
              <tbody>
                {% for row in preview_rows %}
                  {% set i = loop.index0 %}
                  {% set errs = (preview_errors.get(i) or preview_errors.get(i|string)) if preview_errors else None %}
                  <tr class="{% if errs %}table-danger{% else %}table-light{% endif %}">
                    <td>
                      <input type="checkbox"
                             class="row-select"
                             value="{{ i }}"
                             {% if not errs %}checked{% endif %}>
                    </td>

                    {% for h in preview_headers %}
                      {% set val = row.get(h) %}
                      <td class="{% if errs and ('Missing ' ~ h.replace('_',' ').title()) in errs %}bg-warning-subtle{% endif %}">
                        {{ '' if val is none else val }}
                      </td>
                    {% endfor %}

                    <td>
                      {% if not errs %}
                        <span class="badge badge-purple">Valid</span>
                      {% else %}
                        <span class="badge bg-danger">Invalid</span>
                        <div class="small text-muted mt-1">
                          {% for e in errs %}
                            <div>‚Ä¢ {{ e }}</div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </td>

                    <td style="display:none;">{{ i }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Confirm form -->
          <form id="confirmForm" method="POST"
                action="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}"
                class="mt-3 d-flex flex-wrap align-items-end gap-2"
                onsubmit="return handleConfirmSubmit(event);">
            {{ upload_form.csrf_token }}
            <input type="hidden" name="tab" value="uploadPackages">
            <input type="hidden" name="stage" value="confirm">
            <input type="hidden" name="preview_token" value="{{ preview_token }}">
            <input type="hidden" id="selectedIndicesInput" name="selected_indices" value="[]">

            <div>
              <label class="form-label mb-1 text-purple">Batch Size (optional)</label>
              <input type="number" name="batch_size" class="form-control form-control-sm border-purple" placeholder="e.g. 50">
              <div class="form-text">Limit per submit to avoid timeouts.</div>
            </div>

            <div class="ms-auto d-flex align-items-center gap-2">
              <button type="button" id="selectValidBtn" class="btn btn-outline-purple btn-sm">
                Select All Valid
              </button>
              <button type="submit" class="btn btn-purple btn-sm">
                <i class="fas fa-check-circle me-1"></i> Import Selected
              </button>
              <a href="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}"
                 class="btn btn-outline-danger btn-sm"
                 onclick="return confirm('Cancel this upload and discard preview?');">
                <i class="fas fa-times-circle me-1"></i> Cancel Upload
              </a>
            </div>
          </form>
          {% endif %}  {# end if preview_headers and preview_rows #}

        </div> <!-- /card-body -->
      </div>   <!-- /card -->

    </div>     <!-- /uploadPackages tab-pane -->
    {% endif %}
  </div> <!-- /tab-content -->
</div>  <!-- /container -->


<script>
const categoryRates = {{ CATEGORIES|tojson }};
const USD_TO_JMD    = {{ USD_TO_JMD }};

// ---------- helper for JSON POST ----------
async function postJSON(url, body) {
  const r = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify(body)
  });
  if (!r.ok) {
    const txt = await r.text();
    throw new Error('Request failed: ' + txt);
  }
  return r.json();
}

function hasDataTables() {
  return window.jQuery && $.fn && $.fn.DataTable;
}

function getShipmentIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const sid = params.get('shipment_id');
  return sid ? Number(sid) : 0;
}

function validateMoveShipmentForm() {
  const holder = document.getElementById('movePackageIdsContainer');
  const count = holder ? holder.querySelectorAll('input[name="package_ids"]').length : 0;

  if (!count) {
    alert("‚ö†Ô∏è Please select at least one package before moving.");
    return false;
  }
  return true;
}


/* ============================
   CHARGES MODAL / CALCULATOR
   ============================ */
(function() {
  const chargesModal   = document.getElementById('chargesModal');
  if (!chargesModal) return;

  const pkgIdInput     = document.getElementById('chargesPkgId');
  const pkgDescInput   = document.getElementById('chargesPkgDesc');
  const weightInput    = document.getElementById('chargesWeight');
  const valueInput     = document.getElementById('chargesValue');
  const categorySelect = document.getElementById('chargesCategory');
  const btnCalc        = document.getElementById('btnCalcCharges');
  const btnApply       = document.getElementById('btnApplyToPkg');
  const resultBox      = document.getElementById('chargesResult');
  const errorBox       = document.getElementById('chargesError');

  // Editable result inputs
  const resDuty         = document.getElementById('resDuty');
  const resGct          = document.getElementById('resGct');
  const resScf          = document.getElementById('resScf');
  const resEnvl         = document.getElementById('resEnvl');
  const resCaf          = document.getElementById('resCaf');
  const resStamp        = document.getElementById('resStamp');
  const resCustomsTotal = document.getElementById('resCustomsTotal');
  const resFreight      = document.getElementById('resFreight');
  const resHandling     = document.getElementById('resHandling');
  const resFreightTotal = document.getElementById('resFreightTotal');
  const resOther        = document.getElementById('resOther');
  const resTotal        = document.getElementById('resTotal');

  // When the modal opens, fill in data from the button
  chargesModal.addEventListener('show.bs.modal', function(event) {
    const btn = event.relatedTarget;
    if (!btn) return;

    const pkgId  = btn.getAttribute('data-pkg-id');
    const weight = btn.getAttribute('data-weight') || "0";
    const value  = btn.getAttribute('data-value')  || "0";
    const desc   = btn.getAttribute('data-desc')   || "";

    pkgIdInput.value   = pkgId;
    pkgDescInput.value = desc;
    weightInput.value  = weight;
    valueInput.value   = value;

    // reset UI state
    resultBox.style.display = 'none';
    errorBox.style.display  = 'none';
    errorBox.textContent    = '';
    btnApply.style.display  = 'none';

    // clear result inputs
    [
      resDuty, resGct, resScf, resEnvl, resCaf, resStamp,
      resCustomsTotal, resFreight, resHandling, resFreightTotal,
      resOther, resTotal
    ].forEach(el => { if (el) el.value = ''; });
  });

  // Calculate charges via backend endpoint
  btnCalc.addEventListener('click', function() {
    const category = categorySelect.value;
    const weight   = weightInput.value || "0";
    const value    = valueInput.value  || "0";

    if (!category) {
      errorBox.style.display  = 'block';
      errorBox.textContent    = "Please select a category.";
      resultBox.style.display = 'none';
      btnApply.style.display  = 'none';
      return;
    }

    const url = new URL("{{ url_for('logistics.shipment_calc_charges') }}", window.location.origin);
    url.searchParams.set("category",  category);
    url.searchParams.set("weight",    weight);
    url.searchParams.set("value_usd", value);

    fetch(url.toString(), {
      method: "GET",
      headers: { "Accept": "application/json" }
    })
      .then(r => r.json())
      .then(data => {
        if (!data.ok) throw new Error(data.error || "Unknown error");
        const d   = data.data || {};
        const fmt = (x) => (x == null ? "0.00" : Number(x).toFixed(2));

        if (resDuty)         resDuty.value         = fmt(d.duty);
        if (resGct)          resGct.value          = fmt(d.gct);
        if (resScf)          resScf.value          = fmt(d.scf);
        if (resEnvl)         resEnvl.value         = fmt(d.envl);
        if (resCaf)          resCaf.value          = fmt(d.caf);
        if (resStamp)        resStamp.value        = fmt(d.stamp);
        if (resCustomsTotal) resCustomsTotal.value = fmt(d.customs_total);
        if (resFreight)      resFreight.value      = fmt(d.freight);
        if (resHandling)     resHandling.value     = fmt(d.handling);
        if (resFreightTotal) resFreightTotal.value = fmt(d.freight_total);
        if (resOther)        resOther.value        = fmt(d.other_charges || 0);

        const total = d.grand_total || d.total_jmd || 0;
        if (resTotal) resTotal.value = fmt(total);

        errorBox.style.display  = 'none';
        resultBox.style.display = 'block';
        btnApply.style.display  = 'inline-block';
      })
      .catch(err => {
        console.error(err);
        errorBox.textContent    = "Failed to calculate charges: " + err.message;
        errorBox.style.display  = 'block';
        resultBox.style.display = 'none';
        btnApply.style.display  = 'none';
      });
  });

  // Helper: safe number from input
  function numVal(el) {
    if (!el) return 0;
    const v = parseFloat(el.value || '0');
    return isNaN(v) ? 0 : v;
  }

  // Apply + save back to table + DB
  btnApply.addEventListener('click', async function() {
    const pkgId = pkgIdInput.value;
    if (!pkgId) return;

    // Read current inputs (manual edits included)
    const payload = {
      category: (categorySelect.value || 'Other'),
      value:    numVal(valueInput),
      weight:   numVal(weightInput),

      duty:          numVal(resDuty),
      gct:           numVal(resGct),
      scf:           numVal(resScf),
      envl:          numVal(resEnvl),
      caf:           numVal(resCaf),
      stamp:         numVal(resStamp),
      customs_total: numVal(resCustomsTotal),
      freight:       numVal(resFreight),
      handling:      numVal(resHandling),
      freight_total: numVal(resFreightTotal),
      other_charges: numVal(resOther)
    };

    // Grand total: use field if entered, else recompute
    let grand = numVal(resTotal);
    if (!grand) {
      grand = payload.customs_total + payload.freight + payload.handling + payload.other_charges;
    }
    payload.grand_total = grand;
    payload.amount_due  = grand;

    // Update the row inputs so UI matches
    const amountField = document.getElementById('amount_due_' + pkgId);
    if (amountField) amountField.value = grand.toFixed(2);

    const valueField = document.getElementById('value_' + pkgId);
    if (valueField) valueField.value = payload.value.toFixed(2);

    const weightField = document.getElementById('weight_' + pkgId);
    if (weightField) weightField.value = payload.weight.toFixed(2);

    // Save to DB via API
    const updateUrl = "{{ url_for('logistics.api_update_package', pkg_id=0) }}".replace(/\/0$/, `/${pkgId}`);

    try {
      const res = await fetch(updateUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error('Update API failed');
      await res.json();

      alert(`Saved charges for package ${pkgId}.`);
      // Optional: close modal after save
      const modalObj = bootstrap.Modal.getInstance(chargesModal);
      if (modalObj) modalObj.hide();
    } catch (err) {
      console.error(err);
      alert('‚ö†Ô∏è Error saving charges for this package.');
    }
  });

})();

/* ================================
   BULK INVOICE PREVIEW + FINALIZE
   ================================ */
async function openInvoicePreview(selectedPkgIds) {
  console.log('openInvoicePreview, ids =', selectedPkgIds);

  const data = await postJSON("{{ url_for('logistics.bulk_invoice_preview') }}", {
    package_ids: selectedPkgIds
  });

  console.log('bulk_invoice_preview response:', data);

  const tbody = document.querySelector('#inv-prev-tbody');
  if (!tbody) {
    alert('Preview table body #inv-prev-tbody not found in DOM.');
    return;
  }
  tbody.innerHTML = '';

  let grand = 0;

  for (const row of (data.rows || [])) {
    grand += Number(row.total_due || 0);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="checkbox" class="inv-user" data-uid="${row.user_id}"
               data-pkgs="${row.package_ids.join(',')}" checked>
      </td>
      <td><strong>${row.registration_number || ''}</strong> ${row.full_name || ''}</td>
      <td class="text-center">${row.package_count}</td>
      <td class="text-end">${Number(row.total_due || 0).toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  }

  const totalCell = document.getElementById('inv-prev-total');
  if (totalCell) totalCell.textContent = grand.toFixed(2);

  const note = document.getElementById('detained-note');
  if (note) {
    note.textContent = data.detained_skipped
      ? `‚Ä¢ ${data.detained_skipped} detained package(s) skipped`
      : '';
  }

  const modalEl = document.getElementById('bulkInvoicePreviewModal');
  const modal = new bootstrap.Modal(modalEl);
  modal.show();
}

async function finalizeInvoicesFromModal(ev) {
  // This will stop any default form submit behaviour
  if (ev && ev.preventDefault) ev.preventDefault();

  console.log('Finalize button clicked');

  const checks = [...document.querySelectorAll('.inv-user:checked')];
  const selections = checks.map(ch => ({
    user_id: Number(ch.dataset.uid),
    package_ids: ch.dataset.pkgs.split(',').map(x => Number(x))
  }));

  console.log('Selections:', selections);

  if (!selections.length) {
    alert('Select at least one customer.');
    return;
  }

  try {
    const res = await postJSON(
      "{{ url_for('logistics.bulk_invoice_finalize_json') }}",
      { selections }
    );
    console.log('bulk_invoice_finalize_json response:', res);

    if (res.error) {
      alert('‚ö†Ô∏è Server error: ' + res.error);
      return;
    }

    alert(`Created ${res.created} invoice(s).`);

    // reload to show updated invoice_id on packages / invoice list
    setTimeout(() => window.location.reload(), 500);
  } catch (err) {
    console.error('Error calling finalize-json:', err);
    alert('‚ö†Ô∏è Error generating invoices: ' + (err.message || err));
  }
}

/* =====================================
   SHIPMENT FINANCE INVOICE (OPTION A)
   ===================================== */
function openShipmentFinanceInvoiceModalWithHtml(html) {
  const bodyEl = document.getElementById('shipmentFinanceInvoiceBody');
  if (bodyEl) bodyEl.innerHTML = html;

  const modalEl = document.getElementById('shipmentFinanceInvoiceModal');
  if (!modalEl) {
    alert("Shipment finance invoice modal not found.");
    return;
  }
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
}

async function openShipmentFinanceInvoicePreviewJSON(shipmentId, packageIds) {
  const url = "{{ url_for('logistics.shipment_finance_invoice_preview_json', shipment_id=0) }}"
              .replace("/0/", `/${shipmentId}/`);

  try {
    const r = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token() }}",
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify({ package_ids: packageIds || [] })
    });

    // ‚úÖ safer: if server returns HTML/redirect, this will throw and hit catch
    const data = await r.json();

    if (!r.ok || !data.ok) {
      console.error("Finance preview-json failed:", r.status, data);
      alert(`‚ö†Ô∏è Finance invoice preview failed (${r.status}). ${data.error || ""}`);
      return;
    }

    const fmt2 = (n) => Number(n || 0).toFixed(2);

    const usd_to_jmd = Number(data.usd_to_jmd || 0);

    const pkgCount = Number(data.package_count || 0);

    const freightUsd = Number(data.freight_usd || 0);
    const freightJmd = freightUsd * usd_to_jmd;

    // ‚úÖ backend returns rate_usd_per_kg (NOT base_rate_usd_per_kg)
    const rateUsdPerKg = Number(data.rate_usd_per_kg || 0);

    // Build rows (Freight + Service Bands)
    let rowsHtml = "";

    // ‚úÖ Freight row (Count = total packages)
    rowsHtml += `
      <tr>
        <td><strong>Freight</strong></td>
        <td class="text-end">${pkgCount}</td>
        <td class="text-end">$${fmt2(rateUsdPerKg)}</td>
        <td class="text-end">$${fmt2(freightUsd)}</td>
        <td class="text-end">${fmt2(freightJmd)}</td>
      </tr>
    `;

    // Service bands
    let serviceUsdSum = 0;
    let serviceJmdSum = 0;

    (data.service_bands || []).forEach(b => {
      const count   = Number(b.count || 0);
      const rateUsd = Number(b.rate_usd || 0);
      const lineUsd = Number(b.line_usd || 0);
      const lineJmd = lineUsd * usd_to_jmd;

      serviceUsdSum += lineUsd;
      serviceJmdSum += lineJmd;

      rowsHtml += `
        <tr>
          <td>${b.band}</td>
          <td class="text-end">${count}</td>
          <td class="text-end">$${fmt2(rateUsd)}</td>
          <td class="text-end">$${fmt2(lineUsd)}</td>
          <td class="text-end">${fmt2(lineJmd)}</td>
        </tr>
      `;
    });

    // ‚úÖ Service Total row (sum of band lines ONLY)
    rowsHtml += `
      <tr class="table-light fw-bold">
        <td colspan="3" class="text-end">Service Total</td>
        <td class="text-end">$${fmt2(serviceUsdSum)}</td>
        <td class="text-end">${fmt2(serviceJmdSum)}</td>
      </tr>
    `;

    // ‚úÖ totals for the table (Freight + Service)
    const tableUsdTotal = freightUsd + serviceUsdSum;
    const tableJmdTotal = freightJmd + serviceJmdSum;

    const html = `
      <div class="mb-2">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 fw-bold text-purple">Shipment Finance Invoice (Supplier Cost)</h6>
          <span class="badge bg-purple">Shipment #${data.shipment_id}</span>
        </div>
        <div class="small text-muted">Packages: ${pkgCount}</div>
      </div>

      <div class="row g-2 small mb-3">
        <div class="col-md-3">
          <div class="border rounded p-2">
            <div class="text-muted">Total lbs</div>
            <div class="fw-bold">${fmt2(data.total_lbs)}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="border rounded p-2">
            <div class="text-muted">Total kg</div>
            <div class="fw-bold">${fmt2(data.total_kg)}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="border rounded p-2">
            <div class="text-muted">Freight (USD)</div>
            <div class="fw-bold">$${fmt2(freightUsd)}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="border rounded p-2">
            <div class="text-muted">USD‚ÜíJMD</div>
            <div class="fw-bold">${fmt2(usd_to_jmd)}</div>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
          <thead class="table-dark">
            <tr>
              <th>Service Band (lbs)</th>
              <th class="text-end">Count</th>
              <th class="text-end">Rate (USD)</th>
              <th class="text-end">Amount (USD)</th>
              <th class="text-end">Amount (JMD)</th>
            </tr>
          </thead>

          <tbody>
            ${rowsHtml}
          </tbody>

          <tfoot>
            <tr class="fw-bold">
              <th colspan="3" class="text-end">Total</th>
              <th class="text-end">$${fmt2(tableUsdTotal)}</th>
              <th class="text-end">${fmt2(tableJmdTotal)}</th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="row g-2 small mt-3">
        <div class="col-md-4">
          <div class="border rounded p-2">
            <div class="text-muted">Subtotal (USD)</div>
            <div class="fw-bold">$${fmt2(data.subtotal_usd)}</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="border rounded p-2">
            <div class="text-muted">Subtotal (JMD)</div>
            <div class="fw-bold">${fmt2(data.subtotal_jmd)}</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="border rounded p-2">
            <div class="text-muted">Extra Service (JMD)</div>
            <div class="fw-bold">${fmt2(data.extra_service_jmd)}</div>
          </div>
        </div>
      </div>

      <div class="mt-3 border rounded p-3" style="background:#f8f9fa;">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted">TOTAL (JMD)</div>
          <div class="fw-bold" style="font-size:1.6rem;">${fmt2(data.total_jmd)}</div>
        </div>
      </div>
    `;

    openShipmentFinanceInvoiceModalWithHtml(html);

  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Unable to load shipment finance invoice preview (JSON).");
  }
}


// Optional: Print button (prints modal content)
document.getElementById('btnPrintShipmentFinance')?.addEventListener('click', function () {
  const body = document.getElementById('shipmentFinanceInvoiceBody');
  if (!body) return;

  const w = window.open('', '_blank');
  w.document.write(`
    <html><head><title>Shipment Finance Invoice</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    </head><body>${body.innerHTML}</body></html>
  `);
  w.document.close();
  w.focus();
  w.print();
});

/* ============================
   SHIPMENT TABLE / BULK ACTION
   ============================ */

let dt = null;
let dtInitialized = false;

function initShipmentTable() {
  if (dtInitialized) return;
  if (!hasDataTables()) return;

  const $table = $('#shipmentTable');
  if (!$table.length) return;
  if ($.fn.DataTable.isDataTable('#shipmentTable')) return;

  dt = $table.DataTable({
    pageLength: 10,
    lengthChange: true,
    lengthMenu: [[10, 25, 50, 100, 500], [10, 25, 50, 100, 500]],
    dom:
      "<'row g-2 align-items-center mb-2'<'col-md-12 text-md-end'B>>" +
  "rt" +
    "<'row align-items-center mt-2'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
    order: [[2, 'asc']],
    buttons: [
      { extend: 'copyHtml5',  className: 'btn btn-sm btn-purple'   },
      { extend: 'excelHtml5', className: 'btn btn-sm btn-success'  },
      { extend: 'csvHtml5',   className: 'btn btn-sm btn-info'     },
      { extend: 'print',      className: 'btn btn-sm btn-secondary'}
    ],
    columnDefs: [
      { orderable: false, targets: [0, 1] }
    ],
    rowCallback: function (row) {
      if ($(row).hasClass('no-dt') || $(row).hasClass('d-none')) {
        return false;
      }
    },
    language: { emptyTable: 'No packages in this shipment.' }
  });

  // Sync custom length dropdown with DataTables
  $('#shipmentLengthSelect').on('change', function () {
    const len = Number(this.value);
    if (dt) dt.page.len(len).draw();
  });

  // stop header checkbox cell from triggering sort
  $(document)
    .off('click.shipmentHeader', '#shipmentTable thead th:first-child, #selectAll')
    .on('click.shipmentHeader', '#shipmentTable thead th:first-child, #selectAll', function (e) {
      e.stopPropagation();
    });

  // whenever DataTables redraws (paging/search), resync header checkbox
  dt.on('draw.shipment', function () {
    updateShipmentHeaderCheckbox();
  });

  // style length dropdown
  $('#shipmentTable_wrapper .dataTables_length select')
    .addClass('form-select form-select-sm');
  $('#shipmentTable_wrapper .dataTables_length label')
    .addClass('mb-0 small');

  dtInitialized = true;

  // initial sync
  updateShipmentHeaderCheckbox();
}

// üîë GLOBAL handler so we can bind it anywhere
async function handleShipmentApply(e) {
  if (e && e.preventDefault) e.preventDefault();

  const form = document.getElementById('shipmentForm');
  if (!form) {
    console.error('shipmentForm not found');
    return;
  }

  const actionSel = form.querySelector('select[name="action"]');
  const action    = actionSel ? actionSel.value : '';

  if (!action) {
    alert('‚ö†Ô∏è Please select an action.');
    return;
  }

  // Collect selected package IDs (use DataTables if active)
  let ids = [];
  if (dt && $.fn && $.fn.DataTable && $.fn.DataTable.isDataTable('#shipmentTable')) {
    // Use DataTables API so it can see all rows, not just the current page
    ids = dt.$('.package-checkbox:checked').map(function () {
      return this.value;
    }).get();
  } else {
    // Fallback: plain DOM query
    ids = Array.from(document.querySelectorAll('.package-checkbox:checked'))
               .map(cb => cb.value);
  }

  console.log('handleShipmentApply action=', action, 'ids=', ids);

  // ‚úÖ Finance Invoice (Supplier / Shipment totals) ‚Üí OPTION A entire shipment

  if (action === 'finance_invoice') {
    const shipmentId = getShipmentIdFromUrl();

    if (!shipmentId) {
      alert("‚ö†Ô∏è No shipment selected (missing shipment_id in URL).");
    return;
    }

    await openShipmentFinanceInvoicePreviewJSON(shipmentId, []);
    return;
  }


  // All other actions require selection
  if (!ids.length) {
    alert('‚ö†Ô∏è Please select at least one package.');
    return;
  }

  // üîπ Generate Invoice (Customer) ‚Üí JSON preview modal
  if (action === 'generate_invoice') {
    try {
      await openInvoicePreview(ids);
    } catch (err) {
      console.error('Error in openInvoicePreview:', err);
      alert('‚ö†Ô∏è Could not load invoice preview.');
    }
    return;
  }
  
  // üîπ Move to another shipment ‚Üí open "Move" modal
  if (action === 'move') {
    // 1) Clear previous injected inputs
    const holder = document.getElementById('movePackageIdsContainer');
    if (holder) holder.innerHTML = '';

    // 2) Inject one hidden input per selected pkg
    ids.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'package_ids';   // IMPORTANT: matches getlist('package_ids')
      input.value = id;
      holder.appendChild(input);
    });

    // 3) Also ensure from_shipment_id is correct (optional safety)
    const fromInput = document.querySelector('#moveShipmentForm input[name="from_shipment_id"]');
    if (fromInput) {
      fromInput.value = getShipmentIdFromUrl() || fromInput.value || 0;
    }

    // 4) Show modal
    const modalEl = document.getElementById('moveShipmentModal');
    if (modalEl) bootstrap.Modal.getOrCreateInstance(modalEl).show();

    return; // do not submit shipmentForm
  }


  // For all other actions, attach hidden inputs then POST to /bulk-action as before
  const oldHolder = document.getElementById('selectedIdsContainer');
  if (oldHolder) oldHolder.remove();

  const holder = document.createElement('div');
  holder.id = 'selectedIdsContainer';
  ids.forEach(id => {
    const input = document.createElement('input');
    input.type  = 'hidden';
    input.name  = 'package_ids';
    input.value = id;
    holder.appendChild(input);
  });
  form.appendChild(holder);

  // Optional: handle a create_shipment action
  if (action === 'create_shipment') {
    window.location.href = "{{ url_for('logistics.logistics_dashboard', tab='view_packages', create_shipment=1) }}";
    return;
  }

  if (!confirm(`Perform "${action}" on ${ids.length} package(s)?`)) {
    return;
  }

  // Normal submit for non-invoice, non-move actions
  form.submit();
}

$(document).ready(function () {
  // Pre-Alerts table
  if (hasDataTables() && $('#dashboardPrealertsTable').length) {
    $('#dashboardPrealertsTable').DataTable({
      order: [[0, 'desc']],
      pageLength: 10,
      language: { emptyTable: "No pre-alert shipments found." }
    });
  }

  // Shipment Log table
  if (document.querySelector('#shipmentLog.tab-pane.show.active, #shipmentLog.tab-pane.active')) {
    initShipmentTable();
  }
});

/* ======================
   VARIOUS SAVE HELPERS
   ====================== */

function readRowInputs(pkgId) {
  const catEl     = document.getElementById(`cat_${pkgId}`);
  const valEl     = document.getElementById(`pricing_value_${pkgId}`) || document.getElementById(`value_${pkgId}`);
  const weightEl  = document.getElementById(`pricing_weight_${pkgId}`) || document.getElementById(`weight_${pkgId}`);

  const category  = (catEl && catEl.value) ? catEl.value : 'Other';
  const invoice   = parseFloat((valEl && valEl.value) ? valEl.value : 0) || 0;
  const weight    = parseFloat((weightEl && weightEl.value) ? weightEl.value : 0) || 0;

  return { category, invoice, weight };
}

async function runCalculator(pkgId) {
  const cat     = document.getElementById(`cat_${pkgId}`).value;
  const invoice = parseFloat(document.getElementById(`pricing_value_${pkgId}`).value || 0);
  const weight  = parseFloat(document.getElementById(`pricing_weight_${pkgId}`).value || 0);

  try {
    const res = await fetch("{{ url_for('logistics.api_calculate_charges') }}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
      body: JSON.stringify({ category: cat, invoice: invoice, weight: weight })
    });
    if (!res.ok) throw new Error('Network response was not ok');
    const data = await res.json();

    document.getElementById(`duty_${pkgId}`).value          = data.duty.toFixed(2);
    document.getElementById(`scf_${pkgId}`).value           = data.scf.toFixed(2);
    document.getElementById(`envl_${pkgId}`).value          = data.envl.toFixed(2);
    document.getElementById(`caf_${pkgId}`).value           = data.caf.toFixed(2);
    document.getElementById(`gct_${pkgId}`).value           = data.gct.toFixed(2);
    document.getElementById(`stamp_${pkgId}`).value         = data.stamp.toFixed(2);
    document.getElementById(`customs_total_${pkgId}`).value = data.customs_total.toFixed(2);
    document.getElementById(`freight_${pkgId}`).value       = data.freight.toFixed(2);
    document.getElementById(`handling_${pkgId}`).value      = data.handling.toFixed(2);
    document.getElementById(`freight_total_${pkgId}`).value = data.freight_total.toFixed(2);
    document.getElementById(`grandtotal_${pkgId}`).value    = data.grand_total.toFixed(2);
  } catch (err) {
    console.error(err);
    alert('‚ö†Ô∏è Error calculating charges. See console.');
  }
}

const updateUrlTemplate = "{{ url_for('logistics.api_update_package', pkg_id=0) }}";

async function savePricing(pkgId) {
  const invoice = parseFloat(document.getElementById(`pricing_value_${pkgId}`).value || 0);
  const grand   = parseFloat(document.getElementById(`grandtotal_${pkgId}`).value || 0);

  const updateUrl = updateUrlTemplate.replace(/\/0$/, `/${pkgId}`);

  try {
    const res = await fetch(updateUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ value: invoice, amount_due: grand })
    });

    if (!res.ok) throw new Error('Update API failed');
    await res.json();

    const amountField = document.getElementById(`amount_due_${pkgId}`);
    if (amountField) amountField.value = grand.toFixed(2);

    alert(`üíæ Package ${pkgId} updated. Amount Due: $${grand.toFixed(2)}`);
  } catch (err) {
    console.error(err);
    alert('‚ö†Ô∏è Error saving pricing. See console.');
  }
}

function readNumber(id) {
  const el = document.getElementById(id);
  return el ? (parseFloat(el.value || '0') || 0) : 0;
}

async function saveValueOnly(pkgId) {
  const invoice = readNumber(`pricing_value_${pkgId}`) || readNumber(`value_${pkgId}`);
  const url = "{{ url_for('logistics.api_update_package', pkg_id=0) }}".replace(/\/0$/, `/${pkgId}`);

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ value: invoice })
    });
    if (!res.ok) throw new Error('Save Value Only failed');
    await res.json();

    alert(`Saved invoice value ($${invoice.toFixed(2)}) for package ${pkgId}.`);
  } catch (e) {
    console.error(e);
    alert('‚ö†Ô∏è Could not save invoice value.');
  }
}

async function saveManualCharges(pkgId) {
  const payload = {
    category: (document.getElementById(`cat_${pkgId}`)?.value) || undefined,
    value: readNumber(`pricing_value_${pkgId}`) || readNumber(`value_${pkgId}`),
    weight: readNumber(`pricing_weight_${pkgId}`) || readNumber(`weight_${pkgId}`),
    duty: readNumber(`duty_${pkgId}`),
    scf: readNumber(`scf_${pkgId}`),
    envl: readNumber(`envl_${pkgId}`),
    caf: readNumber(`caf_${pkgId}`),
    gct: readNumber(`gct_${pkgId}`),
    stamp: readNumber(`stamp_${pkgId}`),
    customs_total: readNumber(`customs_total_${pkgId}`),
    freight: readNumber(`freight_${pkgId}`),
    handling: readNumber(`handling_${pkgId}`),
    freight_total: readNumber(`freight_total_${pkgId}`),
    other_charges: readNumber(`other_charges_${pkgId}`),
    grand_total: (function () {
      const gt = readNumber(`grandtotal_${pkgId}`);
      if (gt > 0) return gt;
      const sum = (
        readNumber(`customs_total_${pkgId}`) +
        readNumber(`freight_${pkgId}`) +
        readNumber(`handling_${pkgId}`) +
        readNumber(`other_charges_${pkgId}`)
      );
      return sum;
    })()
  };

  payload.amount_due = payload.grand_total;

  const url = "{{ url_for('logistics.api_update_package', pkg_id=0) }}".replace(/\/0$/, `/${pkgId}`);

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('Save manual charges failed');
    await res.json();

    const amountField = document.getElementById(`amount_due_${pkgId}`);
    if (amountField) amountField.value = (payload.amount_due || 0).toFixed(2);

    const grandEl = document.getElementById(`grandtotal_${pkgId}`);
    if (grandEl) grandEl.value = (payload.grand_total || 0).toFixed(2);

    alert(`Saved charges for package ${pkgId}.`);
  } catch (e) {
    console.error(e);
    alert('‚ö†Ô∏è Could not save charges.');
  }
}

function bindAutoSum(pkgId) {
  const ids = [
    `customs_total_${pkgId}`,
    `freight_${pkgId}`,
    `handling_${pkgId}`,
    `other_charges_${pkgId}`
  ];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', () => {
      const sum = ids.reduce((acc, x) => acc + readNumber(x), 0);
      const gt = document.getElementById(`grandtotal_${pkgId}`);
      if (gt) gt.value = sum.toFixed(2);
    });
  });
}

function togglePricing(pkgId) {
  const row = document.getElementById('pricing_' + pkgId);
  if (!row) return;
  row.classList.toggle('d-none');
  if (!row.classList.contains('d-none')) bindAutoSum(pkgId);
}

/* ======================
   UPLOAD SPINNER
   ====================== */
(function () {
  const form = document.getElementById('uploadForm');
  const spinner = document.getElementById('spinner');
  const uploadBtn = document.getElementById('uploadBtn');

  if (form) {
    form.addEventListener('submit', () => {
      if (uploadBtn) uploadBtn.disabled = true;
      if (spinner) spinner.style.display = 'inline-block';
    });
  }

  window.addEventListener('pageshow', () => {
    if (uploadBtn) uploadBtn.disabled = false;
    if (spinner) spinner.style.display = 'none';
  });
})();

/* ==========================
   UPLOAD PREVIEW TABLE (CSV)
   ========================== */
document.addEventListener('DOMContentLoaded', function () {
  const tableEl = document.getElementById('previewTable');
  if (!tableEl) return;

  const getRowCheckboxes = () =>
    Array.from(document.querySelectorAll('#previewTable input.row-select'));

  // Header "select all" checkbox
  const selectAll = document.getElementById('selectAllPreview');
  if (selectAll) {
    selectAll.addEventListener('change', function () {
      const checked = this.checked;
      getRowCheckboxes().forEach(cb => { cb.checked = checked; });
    });
  }

  // "Select All Valid" button
  const selectValidBtn = document.getElementById('selectValidBtn');
  if (selectValidBtn) {
    selectValidBtn.addEventListener('click', function () {
      getRowCheckboxes().forEach(cb => {
        const tr = cb.closest('tr');
        const isInvalid = tr && tr.classList.contains('table-danger');
        cb.checked = !isInvalid;   // only non-error rows
      });
    });
  }
});

// Called by the Confirm form's onsubmit
function handleConfirmSubmit(e) {
  const table = document.getElementById('previewTable');
  if (!table) {
    // no preview table ‚Äì let submit continue; backend will just bail
    return true;
  }

  const checkboxes = table.querySelectorAll('input.row-select:checked');
  const indices = Array.from(checkboxes).map(cb => parseInt(cb.value, 10));

  if (!indices.length) {
    if (e) e.preventDefault();
    alert('‚ö†Ô∏è Please select at least one valid row to import.');
    return false;
  }

  // Put the selected row indexes into the hidden input as JSON
  const hidden = document.getElementById('selectedIndicesInput');
  if (hidden) {
    hidden.value = JSON.stringify(indices);
  }

  // allow the form to submit
  return true;
}

/* ==========================
   SHIPMENT SEARCH MODAL
   ========================== */
document.getElementById('shipmentSearchForm')?.addEventListener('submit', async function (e) {
  e.preventDefault();
  const params = new URLSearchParams(new FormData(this));
  const res = await fetch('{{ url_for("logistics.search_shipment_packages") }}?' + params.toString(), {
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  });
  const data = await res.json();

  const tbody = document.querySelector('#shipmentSearchResults tbody');
  tbody.innerHTML = '';

  if (!data.rows || !data.rows.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-muted">No results.</td></tr>';
    return;
  }

  for (const r of data.rows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.full_name || '-'}</td>
      <td>${r.registration_number || '-'}</td>
      <td>${r.tracking_number || '-'}</td>
      <td>${r.house_awb || '-'}</td>
      <td>${r.description || '-'}</td>
      <td>${r.sl_id || '-'}</td>
    `;
    tbody.appendChild(tr);
  }
});

/* ==========================
   SIMPLE SELECT-ALL HELPERS
   ========================== */
function toggleShipmentSelectAll(master) {
  // If DataTables active: apply to all rows (all pages)
  if (dt && window.jQuery && $.fn.DataTable && $.fn.DataTable.isDataTable('#shipmentTable')) {
    dt.$('.package-checkbox').prop('checked', master.checked);
    updateShipmentHeaderCheckbox();
    return;
  }

  // fallback: plain DOM
  const tbody = document.querySelector('#shipmentTable tbody');
  if (!tbody) return;

  tbody.querySelectorAll('.package-checkbox').forEach(cb => {
    cb.checked = master.checked;
  });

  updateShipmentHeaderCheckbox();
}

function updateShipmentHeaderCheckbox() {
  const header = document.getElementById('selectAll');
  const tbody  = document.querySelector('#shipmentTable tbody');
  if (!header || !tbody) return;

  // If DataTables active, measure across all rows/pages
  if (dt && window.jQuery && $.fn.DataTable && $.fn.DataTable.isDataTable('#shipmentTable')) {
    const all = dt.$('.package-checkbox').length;
    const chk = dt.$('.package-checkbox:checked').length;
    header.checked = (all > 0 && all === chk);
    return;
  }

  // fallback: plain DOM
  const boxes   = tbody.querySelectorAll('.package-checkbox');
  const checked = tbody.querySelectorAll('.package-checkbox:checked');
  header.checked = (boxes.length > 0 && boxes.length === checked.length);
}
</script>



<style>
  .logistics-header { background-color: #4a148c; }
  .logistics-tabs .nav-link { color: #4a148c; font-weight: 500; }
  .logistics-tabs .nav-link.active { background-color: #4a148c; color: #fff !important; }
  .bg-purple { background-color: #4a148c !important; }
  .text-purple { color: #4a148c !important; }
  .btn-purple { background-color: #4a148c; color: white; border: none; }
  .btn-purple:hover { background-color: #6a1b9a; }
  .table-hover tbody tr:hover { background-color: #f3e5f5; }
  .table-sm th, .table-sm td { padding: 0.25rem 0.4rem; font-size: 0.75rem; }
  .no-dt { }
  .badge-purple-soft {
    background: rgba(74, 20, 140, 0.12);
    color: #4a148c;
    border: 1px solid rgba(74, 20, 140, 0.3);
  }
  #previewTable tbody tr.table-danger td {
    border-top: 2px solid #dc3545;
    border-bottom: 2px solid #dc3545;
  }
  #previewTable tbody tr.table-light td {
    background-color: #f8f9fa;
  }
  .border-purple { border-color: #4a148c !important; }
  .btn-outline-purple {
    background: transparent; color: #4a148c;
    border: 1px solid #4a148c; transition: .2s;
  }
  .btn-outline-purple:hover { background-color: #4a148c; color: #fff; }
  .badge-purple { background-color: #4a148c; color: #fff; }
  #previewTable td, #previewTable th { vertical-align: middle; }
  #shipmentTable thead th * { pointer-events: auto !important; }
  /* üîë Force Bootstrap tab behaviour in case theme CSS broke it */
  .tab-content > .tab-pane { display: none; }
  .tab-content > .tab-pane.active,
  .tab-content > .tab-pane.show { display: block !important; }
</style>
{% endblock %}


