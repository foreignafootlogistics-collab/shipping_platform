{% extends "layout_admin.html" %}
{% block title %}Manage Logistics{% endblock %}

{% block content %}
<div class="container mt-4 logistics-dashboard">

    <!-- Header -->
    <h2 class="mb-4 text-white p-3 rounded shadow-sm logistics-header">
        üì¶ Logistics
    </h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="container mt-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}


    <!-- Tabs -->
    <ul class="nav nav-tabs logistics-tabs" id="logisticsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'prealert' %}active{% endif %}" 
                    id="prealerts-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#prealerts" 
                    type="button" 
                    role="tab">Pre-Alert Shipments</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'view_packages' %}active{% endif %}" 
                    id="view-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#viewPackages" 
                    type="button" 
                    role="tab">View Packages</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'shipment' %}active{% endif %}" 
                    id="shipment-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#shipmentLog" 
                    type="button" 
                    role="tab">Shipment Log</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'upload' %}active{% endif %}" 
                    id="upload-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#uploadPackages" 
                    type="button" 
                    role="tab">Upload Packages</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content mt-3">

        <!-- Pre-Alerts Tab -->
        <div class="tab-pane fade {% if active_tab == 'prealert' %}show active{% endif %}" id="prealerts" role="tabpanel">
            {% include "admin/logistics/prealerts.html" %}
        </div>

        <!-- View Packages Tab -->
        <div class="tab-pane fade {% if active_tab == 'view_packages' %}show active{% endif %}" id="viewPackages" role="tabpanel">
            {% include "admin/logistics/view_packages.html" %}
        </div>

        <!-- Shipment Log Tab -->
        <div class="tab-pane fade {% if active_tab == 'shipment' %}show active{% endif %}" id="shipmentLog" role="tabpanel">
            <div class="row mb-3">

                <!-- Sidebar: Shipment Batches -->
                <div class="col-md-3">
                    <h5 class="fw-bold text-purple">üì¶ Shipment Batches</h5>
                    <ul class="list-group shadow-sm">
                        {% if shipments %}
                            {% for shipment in shipments %}
                                <li class="list-group-item border-0 {% if selected_shipment and shipment.id == selected_shipment.id %}active bg-purple text-white{% endif %}">
                                    <a href="{{ url_for('logistics.logistics_dashboard', shipment_id=shipment.id, tab='shipment') }}"
                                       class="d-block text-decoration-none {% if selected_shipment and shipment.id == selected_shipment.id %}text-white{% else %}text-dark{% endif %}">
                                        <strong>{{ shipment.sl_id }}</strong><br>
                                        <small class="text-muted {% if selected_shipment and shipment.id == selected_shipment.id %}text-light{% endif %}">
                                            {{ shipment.created_at.strftime('%Y-%m-%d %H:%M') if shipment.created_at else '-' }}
                                        </small>
                                    </a>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item text-muted">
                                No shipments found.  
                                <br>
                                <a href="{{ url_for('logistics.create_shipment') }}" class="btn btn-sm btn-purple mt-2">‚ûï Create Shipment</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>

                <!-- Main Content: Packages -->
                <div class="col-md-9">
                    <!-- Header + Bulk Actions -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold text-purple mb-0">
                            üöö Shipment Packages
                            {% if selected_shipment %} - <span>{{ selected_shipment.sl_id }}</span>{% endif %}
                        </h5>

                        <!-- Bulk Actions Dropdown -->
                        {% if selected_shipment %}
                        <form method="POST" id="shipmentForm" class="d-flex gap-2"
                              action="{{ url_for('logistics.bulk_shipment_action', shipment_id=selected_shipment.id) }}">
                            {{ bulk_form.hidden_tag() }}                            
                            <input type="hidden" name="tab" value="shipment">
                            <select name="action" class="form-select w-auto" required>
                                <option value="">Select Action</option>
                                <option value="ready">‚úÖ Mark Ready for Pick Up</option>
                                <option value="generate_invoice">üßæ Generate Invoices</option>
                                <option value="send_email">üìß Send Emails</option>
                                <option value="create_shipment">‚ûï Create Shipment</option>
                            </select>
                            <button type="submit" class="btn btn-purple btn-sm">Apply</button>
                        </form>
                        {% endif %}
                    </div>

                    <!-- Packages Table -->
                    {% if shipment_packages %}
                    <div class="table-responsive shadow-sm">
                        <table id="shipmentTable" class="table table-bordered table-striped table-hover align-middle table-sm">
                            <thead class="bg-purple text-white small">
                                <tr>
                                    <th style="width:30px;"><input type="checkbox" id="selectAll"></th>
                                    <th>Action</th>
                                    <th>User</th>
                                    <th>Package</th>
                                    <th>House AWB</th>
                                    <th>Description</th>
                                    <th>Date Received</th>
                                    <th>Weight</th>
                                    <th>Item Value ($)</th>
                                    <th>Outstanding ($)</th>
                                </tr>
                            </thead>
                            <tbody class="small">
{% for pkg in shipment_packages %}
<tr>
    <td><input type="checkbox" name="package_ids" value="{{ pkg.id }}" class="package-checkbox"></td>
    <td class="text-center">
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="togglePricing({{ pkg.id }})">‚öôÔ∏è</button>
    </td>
    <td>
        <strong>{{ pkg.full_name }}</strong><br>
        <small class="text-muted">{{ pkg.registration_number }}</small>
    </td>
    <td>
        {% set status = pkg.status %}
        {% include 'partials/status_tracker.html' with context %}
        <br>
        <small class="text-muted">{{ pkg.tracking_number }}</small>
    </td>
    <td>{{ pkg.house_awb or '-' }}</td>
    <td>{{ pkg.description or '-' }}</td>
    <td>{{ pkg.date_received.strftime('%Y-%m-%d') if pkg.date_received else '-' }}</td>
    <td>
        <input id="weight_{{ pkg.id }}" type="number" class="form-control form-control-sm text-end" value="{{ pkg.weight or 0 }}">
      </td>
      <td>
        <!-- Editable on Shipment Log -->
        <input id="value_{{ pkg.id }}" type="number" class="form-control form-control-sm text-end" value="{{ pkg.value or 50 }}">
      </td>
      <td>
        <input id="amount_due_{{ pkg.id }}" type="number" class="form-control form-control-sm text-end" value="{{ pkg.amount_due or 0 }}" readonly>
      </td>
    </tr>

    <!-- Inline Pricing Row: colspan must equal number of <th> (10) -->
    <tr id="pricing_{{ pkg.id }}" class="d-none bg-light small">
      <td colspan="10">
        <div class="row">
          <div class="col-md-4 border-end">
            <div class="mb-1">
              <label class="small">Category</label>
              <select id="cat_{{ pkg.id }}" class="form-control form-control-sm">
                {% for cat in categories %}
                  <option value="{{ cat }}" {% if pkg.category == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-1">
              <label class="small">Invoice USD</label>
              <input id="pricing_value_{{ pkg.id }}" type="number" class="form-control form-control-sm" value="{{ pkg.value or 50 }}">
            </div>
            <div class="mb-1">
              <label class="small">Weight (lbs)</label>
              <input id="pricing_weight_{{ pkg.id }}" type="number" class="form-control form-control-sm" value="{{ pkg.weight or 0 }}">
            </div>
          </div>

          <div class="col-md-8">
            <div class="row g-2">
              <div class="col-md-4"><label class="small">Duty</label><input id="duty_{{ pkg.id }}" class="form-control form-control-sm" readonly></div>
              <div class="col-md-4"><label class="small">SCF</label><input id="scf_{{ pkg.id }}" class="form-control form-control-sm" readonly></div>
              <div class="col-md-4"><label class="small">ENVL</label><input id="envl_{{ pkg.id }}" class="form-control form-control-sm" readonly></div>
              <div class="col-md-4"><label class="small">CAF</label><input id="caf_{{ pkg.id }}" class="form-control form-control-sm" readonly></div>
              <div class="col-md-4"><label class="small">GCT</label><input id="gct_{{ pkg.id }}" class="form-control form-control-sm" readonly></div>
              <div class="col-md-4"><label class="small">Stamp</label><input id="stamp_{{ pkg.id }}" class="form-control form-control-sm" readonly></div>

              <div class="col-md-6"><label class="small fw-bold">Customs Total</label><input id="customs_total_{{ pkg.id }}" class="form-control form-control-sm fw-bold" readonly></div>
              <div class="col-md-3"><label class="small">Freight</label><input id="freight_{{ pkg.id }}" class="form-control form-control-sm" readonly></div>
              <div class="col-md-3"><label class="small">Handling</label><input id="handling_{{ pkg.id }}" class="form-control form-control-sm" readonly></div>

              <div class="col-md-6"><label class="small fw-bold">Freight Total</label><input id="freight_total_{{ pkg.id }}" class="form-control form-control-sm fw-bold" readonly></div>
              <div class="col-md-6"><label class="small fw-bold text-success">Grand Total</label><input id="grandtotal_{{ pkg.id }}" class="form-control form-control-sm fw-bold text-success" readonly></div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-2">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="runCalculator({{ pkg.id }})">‚öôÔ∏è Calculate</button>
              <button type="button" class="btn btn-sm btn-success" onclick="savePricing({{ pkg.id }})">üíæ Save</button>
            </div>
          </div>
        </div>
      </td>
    </tr>

    {% endfor %}
  </tbody>
</table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Upload Packages Tab -->
        <div class="tab-pane fade {% if active_tab == 'upload' %}show active{% endif %}" id="uploadPackages" role="tabpanel">
            {% include "admin/logistics/upload_packages.html" %}
        </div>

    </div>
</div>

<!-- JS + DataTables + Bulk Actions -->
<script>
const categoryRates = {{ CATEGORIES|tojson }}; // optional for client fallback
const USD_TO_JMD = {{ USD_TO_JMD }}; // Currency conversion (optional if needed)
$(document).ready(function () {
    // Initialize DataTable for Shipment Packages
    function initShipmentTable() {
        if (!$.fn.DataTable.isDataTable('#shipmentTable')) {
            $('#shipmentTable').DataTable({
                order: [[2, 'asc']],
                pageLength: 10,
                dom: 'Bfrtip',
                buttons: [
                    { extend: 'copyHtml5', className: 'btn btn-sm btn-purple' },
                    { extend: 'excelHtml5', className: 'btn btn-sm btn-success' },
                    { extend: 'csvHtml5', className: 'btn btn-sm btn-info' },
                    { extend: 'print', className: 'btn btn-sm btn-secondary' }
                ],
                rowCallback: function (row, data) {
                    if ($(row).hasClass('no-dt')) {
                        $(row).remove(); // remove it from DataTables processing
                    }
                },

                language: { emptyTable: "No packages in this shipment." }
            });
        }
    }

    initShipmentTable();

    // Select all / individual checkbox logic
    $('#selectAll').on('change', function () {
        $('.package-checkbox').prop('checked', this.checked);
    });
    $('.package-checkbox').on('change', function () {
        $('#selectAll').prop('checked', $('.package-checkbox:checked').length === $('.package-checkbox').length);
    });

    // Bulk action form submission
    $('#shipmentForm').on('submit', function (e) {
        const action = $(this).find('select[name="action"]').val();
        if (!action) { e.preventDefault(); alert("‚ö†Ô∏è Please select an action."); return; }

        if (action === 'create_shipment') {
            e.preventDefault();
            window.location.href = "{{ url_for('logistics.logistics_dashboard', tab='view_packages', create_shipment=1) }}";
            return;
        }

        const selected = $('.package-checkbox:checked').length;
        if (selected === 0) { e.preventDefault(); alert("‚ö†Ô∏è Please select at least one package."); return; }

        if (!confirm(`Are you sure you want to perform "${action}" on ${selected} package(s)?`)) { e.preventDefault(); }
    });

    // Reinitialize table when tab shown
    $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        const target = $(e.target).attr('data-bs-target');
        if (target === '#shipmentLog') { initShipmentTable(); }
    });
});

// Toggle inline pricing row
function togglePricing(pkgId) {
    document.getElementById("pricing_" + pkgId).classList.toggle("d-none");
}

async function runCalculator(pkgId) {
    const cat = document.getElementById(`cat_${pkgId}`).value;
    const invoice = parseFloat(document.getElementById(`pricing_value_${pkgId}`).value || 0);

    const weight = parseFloat(document.getElementById(`pricing_weight_${pkgId}`).value || 0);

    try {
        const res = await fetch("{{ url_for('logistics.api_calculate_charges') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token() }}"
            },
            body: JSON.stringify({ category: cat, invoice:invoice, weight: weight })
        });

        if (!res.ok) throw new Error("Network response was not ok");

        const data = await res.json();

        // Populate fields with returned values
        document.getElementById(`duty_${pkgId}`).value = data.duty.toFixed(2);
        document.getElementById(`scf_${pkgId}`).value = data.scf.toFixed(2);
        document.getElementById(`envl_${pkgId}`).value = data.envl.toFixed(2);
        document.getElementById(`caf_${pkgId}`).value = data.caf.toFixed(2);
        document.getElementById(`gct_${pkgId}`).value = data.gct.toFixed(2);
        document.getElementById(`stamp_${pkgId}`).value = data.stamp.toFixed(2);
        document.getElementById(`customs_total_${pkgId}`).value = data.customs_total.toFixed(2);
        document.getElementById(`freight_${pkgId}`).value = data.freight.toFixed(2);
        document.getElementById(`handling_${pkgId}`).value = data.handling.toFixed(2);
        document.getElementById(`freight_total_${pkgId}`).value = data.freight_total.toFixed(2);
        document.getElementById(`grandtotal_${pkgId}`).value = data.grand_total.toFixed(2);

    } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Error calculating charges. See console for details.");
    }
}

// Save the calculated value + amount_due to DB and update both templates (if visible)
async function savePricing(pkgId) {
    const invoice = parseFloat(document.getElementById(`pricing_value_${pkgId}`).value || 0);

    const grand = parseFloat(document.getElementById(`grandtotal_${pkgId}`).value || 0);

    try {
        const res = await fetch("{{ url_for('logistics.api_update_package', pkg_id=0).rsplit('/',1)[0] }}" + "/" + pkgId, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token() }}"
            },
            body: JSON.stringify({ value: invoice, amount_due: grand })
        });

        if (!res.ok) throw new Error("Update API failed");
        const data = await res.json();

        // ‚úÖ update amount_due in View Packages table if present
        const amountField = document.getElementById(`amount_due_${pkgId}`);
        if (amountField) {
            amountField.value = grand.toFixed(2);
        }

        alert(`üíæ Package ${pkgId} updated. Amount Due: $${grand.toFixed(2)}`);

    } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Error saving pricing. See console.");
    }
}
</script>
<style>
.logistics-header { background-color: #4a148c; }
.logistics-tabs .nav-link { color: #4a148c; font-weight: 500; }
.logistics-tabs .nav-link.active { background-color: #4a148c; color: #fff !important; }
.bg-purple { background-color: #4a148c !important; }
.text-purple { color: #4a148c !important; }
.btn-purple { background-color: #4a148c; color: white; border: none; }
.btn-purple:hover { background-color: #6a1b9a; }
.table-hover tbody tr:hover { background-color: #f3e5f5; }
.table-sm th, .table-sm td { padding: 0.25rem 0.4rem; font-size: 0.75rem; }
</style>
{% endblock %}
