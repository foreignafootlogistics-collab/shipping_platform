{% extends 'layout_admin.html' %}

{% block title %}Scheduled Deliveries{% endblock %}

{% block content %}

{# ------------------------------------------------------------
   Helpers
   ------------------------------------------------------------ #}
{% macro fmt_time(t) -%}
  {# t may be:
     - "14:30"
     - datetime.time
     - None
  #}
  {% if not t %}
    ‚Äî
  {% else %}
    {% set s = (t|string).strip() %}
    {% if ':' in s %}
      {% set hh = s.split(':')[0]|int %}
      {% set mm = s.split(':')[1]|int %}
      {% set ap = 'AM' if hh < 12 else 'PM' %}
      {% set h12 = hh % 12 %}
      {% if h12 == 0 %}{% set h12 = 12 %}{% endif %}
      {{ h12 }}:{% if mm < 10 %}0{% endif %}{{ mm }} {{ ap }}
    {% else %}
      {{ s }}
    {% endif %}
  {% endif %}
{%- endmacro %}

<style>
  /* ====== FAFL Scheduled Deliveries polish ====== */
  .sd-card{
    border:0;
    border-radius:16px;
    overflow:hidden;
    box-shadow: 0 10px 25px rgba(17,24,39,.08);
  }
  .sd-header{
    background: #4a148c;
    color:#fff;
    padding: 16px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .sd-header h4{
    margin:0;
    font-weight:700;
    letter-spacing:.2px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .sd-header .sub{
    opacity:.9;
    font-size:.9rem;
    margin-top:2px;
  }

  .sd-filters{
    background:#fff;
    padding: 14px 18px;
    border-bottom:1px solid #eef2f7;
  }
  .sd-filters .form-label{
    font-size:.82rem;
    color:#6b7280;
    margin-bottom:4px;
  }
  .sd-filters .form-control,
  .sd-filters .form-select{
    border-radius:10px;
  }

  .btn-purple{
    background:#4a148c;
    border-color:#4a148c;
    color:#fff;
    border-radius:10px;
  }
  .btn-purple:hover{ filter:brightness(.95); color:#fff; }
  .btn-soft{ border-radius:10px; }

  .sd-table-wrap{
    padding: 16px 18px 18px 18px;
    background:#fff;
  }

  table.dataTable thead th{
    background:#111827 !important;
    color:#fff !important;
    border-bottom:0 !important;
    font-weight:600;
  }
  table.dataTable tbody td{ vertical-align:middle; }

  .sd-pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    font-size:.82rem;
    font-weight:600;
    border:1px solid transparent;
    white-space:nowrap;
  }
  .dot{ width:8px; height:8px; border-radius:999px; display:inline-block; }

  .pill-scheduled{ background:#eef2ff; color:#3730a3; border-color:#c7d2fe; }
  .pill-scheduled .dot{ background:#3730a3; }

  .pill-out{ background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
  .pill-out .dot{ background:#f97316; }

  .pill-delivered{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
  .pill-delivered .dot{ background:#10b981; }

  .pill-cancelled{ background:#fef2f2; color:#991b1b; border-color:#fecaca; }
  .pill-cancelled .dot{ background:#ef4444; }

  .fee-badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    font-size:.82rem;
    font-weight:700;
    border:1px solid transparent;
    white-space:nowrap;
  }
  .fee-unpaid{ background:#fffbeb; color:#92400e; border-color:#fde68a; }
  .fee-paid{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
  .fee-unpaid .dot{ background:#f59e0b; }
  .fee-paid .dot{ background:#10b981; }

  /* keep action button neat */
  .sd-actions{ white-space:nowrap; }
  .sd-actions .dropdown-toggle{
    border-radius:10px;
    padding:6px 10px;
    font-weight:700;
  }
  .dropdown-menu{ border-radius:12px; }
  .dropdown-item{ font-weight:600; }

  /* make the datatable search look nicer */
  .dataTables_filter input{
    border-radius:10px !important;
    border:1px solid #e5e7eb !important;
    padding:.35rem .6rem !important;
  }
  .dataTables_length select{
    border-radius:10px !important;
    border:1px solid #e5e7eb !important;
    padding:.25rem .5rem !important;
  }
</style>

<div class="container mt-4">
  <div class="sd-card">

    <!-- Top header -->
    <div class="sd-header">
      <div>
        <h4>
          <span style="font-size:1.1rem;">üöö</span>
          All Scheduled Deliveries
        </h4>
        <div class="sub">Manage delivery requests, update status, mark delivery fee paid, and export reports.</div>
      </div>

      <div class="d-flex gap-2">
        <a class="btn btn-light btn-soft"
           href="{{ url_for('logistics.view_scheduled_deliveries') }}">
          Reset
        </a>
        <a href="{{ url_for('logistics.scheduled_deliveries_pdf', start_date=start_date, end_date=end_date) }}"
           class="btn btn-dark btn-soft">
          Download PDF
        </a>
      </div>
    </div>

    {# ============================================================
       ‚úÖ SUMMARY COUNTERS (Today / Tomorrow / Overdue)
       Requires your global context_processor to inject:
         - sd_today_count, sd_tomorrow_count, sd_overdue_count
       and route should pass today/tomorrow if you want row compare.
       ============================================================ #}
    <div class="px-3 pt-3">
      <div class="row g-2">

        <div class="col-12 col-md-4">
          <div class="card shadow-sm border-0" style="border-radius:14px;">
            <div class="card-body py-2 d-flex align-items-center justify-content-between">
              <div>
                <div class="small text-muted fw-semibold">Today</div>
                <div class="fs-4 fw-bold">{{ sd_today_count|default(0) }}</div>
              </div>
              <div class="fs-3">üìÖ</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="card shadow-sm border-0" style="border-radius:14px;">
            <div class="card-body py-2 d-flex align-items-center justify-content-between">
              <div>
                <div class="small text-muted fw-semibold">Tomorrow</div>
                <div class="fs-4 fw-bold">{{ sd_tomorrow_count|default(0) }}</div>
              </div>
              <div class="fs-3">‚è≠Ô∏è</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="card shadow-sm border border-danger" style="border-radius:14px;">
            <div class="card-body py-2 d-flex align-items-center justify-content-between">
              <div>
                <div class="small text-danger fw-semibold">Overdue</div>
                <div class="fs-4 fw-bold text-danger">{{ sd_overdue_count|default(0) }}</div>
              </div>
              <div class="fs-3">‚ö†Ô∏è</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Filters -->
    <div class="sd-filters">
      <form class="row g-3 align-items-end" method="get">
        <div class="col-12 col-md-3 col-lg-3">
          <label class="form-label">Start date</label>
          <input type="date" name="start_date" class="form-control" value="{{ start_date or '' }}">
        </div>

        <div class="col-12 col-md-3 col-lg-3">
          <label class="form-label">End date</label>
          <input type="date" name="end_date" class="form-control" value="{{ end_date or '' }}">
        </div>

        <div class="col-12 col-md-3 col-lg-3">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="" {% if not status %}selected{% endif %}>All</option>
            <option value="Scheduled" {% if status == "Scheduled" %}selected{% endif %}>Scheduled</option>
            <option value="Out for Delivery" {% if status == "Out for Delivery" %}selected{% endif %}>Out for Delivery</option>
            <option value="Delivered" {% if status == "Delivered" %}selected{% endif %}>Delivered</option>
            <option value="Cancelled" {% if status == "Cancelled" %}selected{% endif %}>Cancelled</option>
          </select>
        </div>

        <div class="col-12 col-md-3 col-lg-3 d-flex gap-2">
          <button type="submit" class="btn btn-purple w-100">Filter</button>
          <a class="btn btn-outline-secondary w-100 btn-soft"
             href="{{ url_for('logistics.view_scheduled_deliveries') }}">
            Clear
          </a>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="sd-table-wrap">
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle" id="allScheduledDeliveriesTable">
          <thead>
            <tr>
              <th style="min-width:140px;">Invoice #</th>
              <th style="min-width:110px;">Date</th>
              <th style="min-width:160px;">Time</th>
              <th style="min-width:130px;">Location</th>
              <th style="min-width:140px;">Directions</th>
              <th style="min-width:110px;">Mobile #</th>
              <th style="min-width:170px;">Person Receiving</th>
              <th style="min-width:130px;">Status</th>
              <th style="min-width:160px;">Customer</th>
              <th style="min-width:150px;">Delivery Fee</th>
              <th style="min-width:130px;">Fee Status</th>
              <th style="min-width:170px;">Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for d in deliveries %}
              {% set d_status = (d.status or "Scheduled") %}
              {% set fee_status = (d.fee_status or "Unpaid") %}

              {# ‚úÖ "Done" statuses for FAFL Scheduled Deliveries #}
              {% set done = d_status in ["Delivered", "Cancelled"] %}

              {# ‚úÖ requires route to pass `today` (date object). If not passed, defaults to none safe. #}
              {% set _today = today if today is defined else none %}
              {% set is_overdue = (not done) and d.scheduled_date and _today and (d.scheduled_date < _today) %}
              {% set is_today = (not done) and d.scheduled_date and _today and (d.scheduled_date == _today) %}

              <tr class="{% if is_overdue %}table-danger{% elif is_today %}table-warning{% endif %}">
                <td class="fw-semibold">{{ d.invoice_number or "‚Äî" }}</td>
                <td>{{ d.scheduled_date.strftime("%Y-%m-%d") if d.scheduled_date else "" }}</td>

                {# ‚úÖ FIXED TIME RANGE DISPLAY (AM/PM) #}
                <td class="text-nowrap">
                  {% if d.scheduled_time_from and d.scheduled_time_to %}
                    {{ fmt_time(d.scheduled_time_from) }} - {{ fmt_time(d.scheduled_time_to) }}
                  {% elif d.scheduled_time %}
                    {{ d.scheduled_time }}
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>

                <td>{{ d.location or "" }}</td>
                <td>{{ d.direction or "" }}</td>
                <td>{{ d.mobile_number or "" }}</td>
                <td>{{ d.person_receiving or "" }}</td>

                <td>
                  {% if d_status == "Scheduled" %}
                    <span class="sd-pill pill-scheduled"><span class="dot"></span>Scheduled</span>
                  {% elif d_status == "Out for Delivery" %}
                    <span class="sd-pill pill-out"><span class="dot"></span>Out for Delivery</span>
                  {% elif d_status == "Delivered" %}
                    <span class="sd-pill pill-delivered"><span class="dot"></span>Delivered</span>
                  {% elif d_status == "Cancelled" %}
                    <span class="sd-pill pill-cancelled"><span class="dot"></span>Cancelled</span>
                  {% else %}
                    <span class="sd-pill pill-scheduled"><span class="dot"></span>{{ d_status }}</span>
                  {% endif %}

                  {# ‚úÖ Extra tags so you NEVER miss these #}
                  {% if is_overdue %}
                    <span class="badge bg-danger ms-2">Overdue</span>
                  {% elif is_today %}
                    <span class="badge bg-warning text-dark ms-2">Today</span>
                  {% endif %}
                </td>

                <td>
                  {{ d.user.full_name or d.user.email if d.user else "N/A" }}
                </td>

                <td class="text-nowrap">
                  {{ d.fee_currency or "JMD" }} {{ "%.2f"|format(d.delivery_fee or 0) }}
                </td>

                <td>
                  {% if fee_status|lower == "paid" %}
                    <span class="fee-badge fee-paid"><span class="dot"></span>Paid</span>
                  {% else %}
                    <span class="fee-badge fee-unpaid"><span class="dot"></span>Unpaid</span>
                  {% endif %}
                </td>

                <td class="sd-actions">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-dark dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                      Manage
                    </button>

                    <ul class="dropdown-menu shadow-sm">

                      <li>
                        <a class="dropdown-item"
                           href="{{ url_for('logistics.scheduled_delivery_view', delivery_id=d.id) }}">
                          <i class="fas fa-eye me-2 text-primary"></i>View Details
                        </a>
                      </li>

                      <li><hr class="dropdown-divider"></li>

                      {% if (d.fee_status or "Unpaid")|lower != "paid" %}
                        <li>
                          <form method="post"
                                action="{{ url_for('logistics.scheduled_delivery_mark_paid', delivery_id=d.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="dropdown-item text-success">
                              <i class="fas fa-check-circle me-2"></i>Mark Fee Paid
                            </button>
                          </form>
                        </li>
                      {% else %}
                        <li>
                          <form method="post"
                                action="{{ url_for('logistics.scheduled_delivery_mark_unpaid', delivery_id=d.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="dropdown-item text-warning">
                              <i class="fas fa-undo me-2"></i>Mark Fee Unpaid
                            </button>
                          </form>
                        </li>
                      {% endif %}

                      <li><hr class="dropdown-divider"></li>

                      {% if d_status == "Scheduled" %}
                        <li>
                          <form method="post"
                                action="{{ url_for('logistics.scheduled_delivery_set_status', delivery_id=d.id, status='Out for Delivery') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="dropdown-item text-warning">
                              <i class="fas fa-truck me-2"></i>Out for Delivery
                            </button>
                          </form>
                        </li>
                      {% endif %}

                      {% if d_status == "Out for Delivery" %}
                        <li>
                          <form method="post"
                                action="{{ url_for('logistics.scheduled_delivery_set_status', delivery_id=d.id, status='Delivered') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="dropdown-item text-success">
                              <i class="fas fa-check me-2"></i>Mark Delivered
                            </button>
                          </form>
                        </li>
                      {% endif %}

                      {% if d_status in ["Scheduled", "Out for Delivery"] %}
                        <li>
                          <form method="post"
                                action="{{ url_for('logistics.scheduled_delivery_set_status', delivery_id=d.id, status='Cancelled') }}"
                                onsubmit="return confirm('Cancel this delivery?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="dropdown-item text-danger">
                              <i class="fas fa-times me-2"></i>Cancel Delivery
                            </button>
                          </form>
                        </li>
                      {% endif %}

                    </ul>
                  </div>
                </td>

              </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function () {
    $('#allScheduledDeliveriesTable').DataTable({
      order: [[1, 'desc']],
      pageLength: 25
      // NOTE: remove responsive:true unless you included the responsive extension JS/CSS
    });
  });
</script>
{% endblock %}