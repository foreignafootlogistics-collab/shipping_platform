{% extends "layout_admin.html" %}
{% block title %}Scheduled Delivery{% endblock %}

{% block content %}
<style>
  .btn-purple{
    background:#4a148c;
    border-color:#4a148c;
    color:#fff;
  }
  .btn-purple:hover{ filter:brightness(.95); color:#fff; }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px; font-weight:700; font-size:.82rem;
    border:1px solid transparent; white-space:nowrap;
  }
  .dot{ width:8px; height:8px; border-radius:999px; display:inline-block; }
  .pill-paid{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
  .pill-paid .dot{ background:#10b981; }
  .pill-unpaid{ background:#fffbeb; color:#92400e; border-color:#fde68a; }
  .pill-unpaid .dot{ background:#f59e0b; }
</style>

<div class="container-fluid">

  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-1">
        <i class="fas fa-truck me-2 text-primary"></i>
        Scheduled Delivery
      </h3>
      <div class="text-muted">
        Delivery ID: <strong>#{{ delivery.id }}</strong>

        {% if delivery.invoice_number %}
          <span class="ms-2">| Invoice: <strong>{{ delivery.invoice_number }}</strong></span>
        {% endif %}

        {% if delivery.status %}
          <span class="badge ms-2
            {% if delivery.status|lower == 'delivered' %} bg-success
            {% elif delivery.status|lower in ['cancelled','canceled'] %} bg-danger
            {% elif delivery.status|lower in ['out for delivery','in progress'] %} bg-warning text-dark
            {% else %} bg-secondary {% endif %}">
            {{ delivery.status }}
          </span>
        {% endif %}
      </div>
    </div>

    <div class="d-flex gap-2 mt-2 mt-md-0">
      <a href="{{ url_for('logistics.view_scheduled_deliveries') }}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Back
      </a>

      {# Fee buttons #}
      {% set fs = (delivery.fee_status or "Unpaid")|lower %}
      {% if fs != "paid" %}
        <form method="post"
              action="{{ url_for('logistics.scheduled_delivery_mark_paid', delivery_id=delivery.id) }}"
              class="m-0"
              onsubmit="return confirm('Mark delivery fee as PAID?');">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-sm btn-success">
            <i class="fas fa-check me-1"></i> Mark Fee Paid
          </button>
        </form>
      {% else %}
        <form method="post"
              action="{{ url_for('logistics.scheduled_delivery_mark_unpaid', delivery_id=delivery.id) }}"
              class="m-0"
              onsubmit="return confirm('Mark delivery fee as UNPAID?');">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-undo me-1"></i> Mark Fee Unpaid
          </button>
        </form>
      {% endif %}
    </div>
  </div>

  <div class="row g-3">

    <!-- Left: Delivery Info -->
    <div class="col-lg-5">

      <!-- Invoice / Fee card -->
      <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="fas fa-receipt me-2 text-muted"></i>Delivery Invoice</h6>
          {% if fs == "paid" %}
            <span class="pill pill-paid"><span class="dot"></span>Paid</span>
          {% else %}
            <span class="pill pill-unpaid"><span class="dot"></span>Unpaid</span>
          {% endif %}
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6">
              <div class="text-muted small">Invoice #</div>
              <div class="fw-semibold">{{ delivery.invoice_number or "—" }}</div>
            </div>
            <div class="col-6 text-end">
              <div class="text-muted small">Amount</div>
              <div class="fw-bold">
                {{ delivery.fee_currency or "JMD" }} {{ "%.2f"|format(delivery.delivery_fee or 0) }}
              </div>
            </div>

            <div class="col-12">
              <div class="text-muted small">Paid At</div>
              <div class="fw-semibold">
                {{ delivery.paid_at.strftime("%Y-%m-%d %H:%M") if delivery.paid_at else "—" }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Delivery Details -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white">
          <h6 class="mb-0"><i class="fas fa-info-circle me-2 text-muted"></i>Delivery Details</h6>
        </div>

        <div class="card-body">
          <div class="row g-3">
            <div class="col-6">
              <div class="text-muted small">Date</div>
              <div class="fw-semibold">
                {{ delivery.scheduled_date.strftime("%Y-%m-%d") if delivery.scheduled_date else "—" }}
              </div>
            </div>
            <div class="col-6">
              <div class="text-muted small">Time</div>
              <div class="fw-semibold">{{ delivery.scheduled_time or "—" }}</div>
            </div>

            <div class="col-12">
              <div class="text-muted small">Customer</div>
              <div class="fw-semibold">
                {{ delivery.user.full_name if delivery.user else "N/A" }}
              </div>
              <div class="text-muted small">
                {{ delivery.user.email if delivery.user and delivery.user.email else "" }}
              </div>
            </div>

            <div class="col-12">
              <div class="text-muted small">Location</div>
              <div class="fw-semibold">{{ delivery.location or "—" }}</div>
              {% if delivery.direction %}
                <div class="text-muted small mt-1">
                  <i class="fas fa-location-arrow me-1"></i>{{ delivery.direction }}
                </div>
              {% endif %}
            </div>

            <div class="col-6">
              <div class="text-muted small">Person Receiving</div>
              <div class="fw-semibold">{{ delivery.person_receiving or "—" }}</div>
            </div>
            <div class="col-6">
              <div class="text-muted small">Mobile</div>
              <div class="fw-semibold">{{ delivery.mobile_number or "—" }}</div>
            </div>
          </div>

          <hr class="my-3">

          <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">Created</div>
            <div class="small">
              {{ delivery.created_at.strftime("%Y-%m-%d %H:%M") if delivery.created_at else "—" }}
            </div>
          </div>
        </div>
      </div>

      <!-- Packages -->
      <div class="card shadow-sm mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Linked Packages</h5>
          <span class="text-muted small">
            {{ delivery.user.full_name if delivery.user else "" }}
          </span>
        </div>

        <div class="card-body">

          <!-- Assign packages -->
          <form method="post" action="{{ url_for('logistics.scheduled_delivery_assign_packages', delivery_id=delivery.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="row g-2 align-items-end">
              <div class="col-12 col-lg-9">
                <label class="form-label small text-muted">Assign packages to this delivery</label>
                <select class="form-select" name="package_ids" multiple size="8">
                  {% for p in eligible_packages %}
                    <option value="{{ p.id }}">
                      {{ p.tracking_number or 'No Tracking' }} |
                      {{ p.description or '' }} |
                      {{ p.weight or 0 }} lb |
                      Status: {{ p.status or '' }}
                    </option>
                  {% endfor %}
                </select>
                <small class="text-muted d-block mt-1">
                  Tip: hold Ctrl (Windows) / Cmd (Mac) to select multiple.
                </small>
              </div>

              <div class="col-12 col-lg-3">
                <button class="btn btn-purple w-100">
                  Assign Selected
                </button>
              </div>
            </div>
          </form>

          <hr class="my-4">

          <!-- Already linked -->
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Tracking #</th>
                  <th>Description</th>
                  <th>Weight</th>
                  <th>Status</th>
                  <th style="width:140px;">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for p in assigned_packages %}
                <tr>
                  <td>{{ p.tracking_number or '' }}</td>
                  <td>{{ p.description or '' }}</td>
                  <td>{{ p.weight or 0 }}</td>
                  <td>{{ p.status or '' }}</td>
                  <td>
                    <form method="post"
                          action="{{ url_for('logistics.scheduled_delivery_unassign_package', delivery_id=delivery.id, package_id=p.id) }}"
                          onsubmit="return confirm('Unassign this package from delivery?');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-outline-danger btn-sm w-100">Unassign</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}

                {% if assigned_packages|length == 0 %}
                <tr>
                  <td colspan="5" class="text-center text-muted py-4">
                    No packages linked yet.
                  </td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

        </div>
      </div>

      <!-- Nice “next actions” card -->
      <div class="card shadow-sm border-0 mt-3">
        <div class="card-body">
          <h6 class="mb-2"><i class="fas fa-bolt me-2 text-warning"></i>Next Actions</h6>
          <ul class="mb-0 small text-muted">
            <li>Assign packages for this customer</li>
            <li>Mark fee paid once collected</li>
            <li>Update status: Scheduled → Out for Delivery → Delivered</li>
          </ul>
        </div>
      </div>

    </div>

    {# If you later want a right-side column, keep your layout ready #}
  </div>

</div>
{% endblock %}