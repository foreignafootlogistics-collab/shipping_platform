{% extends "layout_admin.html" %}
{% block title %}Shipment Log{% endblock %}

{% block content %}
<div class="row">
  <!-- Sidebar: Shipment Batches -->
  <div class="col-md-3">
    <h5 class="fw-bold text-purple">üì¶ Shipment Batches</h5>
    <ul class="list-group shadow-sm">
      {% if shipments %}
        {% for shipment in shipments %}
          <li class="list-group-item border-0 {% if selected_shipment and shipment.id == selected_shipment.id %}active bg-purple text-white{% endif %}">
            <a href="{{ url_for('logistics.logistics_dashboard', shipment_id=shipment.id, tab='shipmentLog') }}"
               class="d-block text-decoration-none {% if selected_shipment and shipment.id == selected_shipment.id %}text-white{% else %}text-dark{% endif %}">
              <strong>{{ shipment.sl_id }}</strong><br>
              <small class="text-muted {% if selected_shipment and shipment.id == selected_shipment.id %}text-light{% endif %}">
                {{ shipment.created_at or '-' }}
              </small>
            </a>
          </li>
        {% endfor %}
      {% else %}
        <li class="list-group-item text-muted">No shipments found.</li>
      {% endif %}
    </ul>
  </div>

  <!-- Main Content -->
  <div class="col-md-9">
    <h5 class="fw-bold mb-3">
      üöö Packages in Shipment:
      <span class="text-purple">{{ selected_shipment.sl_id if selected_shipment else 'N/A' }}</span>
    </h5>

    {% if shipment_packages %}
    <form method="POST" id="shipmentForm" action="{{ url_for('logistics.bulk_shipment_action', shipment_id=selected_shipment.id) }}">
      {{ bulk_form.hidden_tag() }}
      <input type="hidden" name="tab" value="shipmentLog">

      <!-- Bulk Actions -->
      <div class="d-flex justify-content-end align-items-center mb-2 gap-2">
        <select name="action" class="form-select w-auto" required>
          <option value="">Select Action</option>
          <option value="ready">‚úÖ Mark Ready for Pick Up</option>
          <option value="generate_invoice">üßæ Generate Invoices</option>
          <option value="send_email">üìß Send Emails</option>
        </select>
        <button type="submit" class="btn btn-purple btn-sm">Apply</button>
      </div>

      <!-- Packages Table -->
      <div class="table-responsive shadow-sm">
        <table id="shipmentTable" class="table table-bordered table-striped table-hover align-middle table-sm">
          <thead class="bg-purple text-white small">
            <tr>
              <th><input type="checkbox" id="selectAll"></th>
              <th>User</th>
              <th>Package</th>
              <th>House AWB</th>
              <th>Description</th>
              <th>Date Received</th>
              <th>Weight</th>
              <th>Item Value ($)</th>
            </tr>
          </thead>
          <tbody class="small">
            {% for pkg in shipment_packages %}
            <tr>
              <td><input type="checkbox" name="package_ids" value="{{ pkg.id }}" class="package-checkbox"></td>
              <td>
                <strong>{{ pkg.full_name }}</strong><br>
                <small class="text-muted">{{ pkg.registration_number }}</small>
              </td>
              <td>
                {% set status = pkg.status %}
                {% include 'partials/status_tracker.html' with context %}
                <br>
                <small class="text-muted">{{ pkg.tracking_number }}</small>
              </td>
              <td>{{ pkg.house_awb or '-' }}</td>
              <td>{{ pkg.description or '-' }}</td>
              <td>{{ pkg.date_received or '-' }}</td>
              <td>{{ pkg.weight or 0 }} lbs</td>
              <td>${{ "%.2f"|format(pkg.value or 0) }}</td>
            </tr>

            <!-- Inline Pricing -->
            <tr id="pricing_{{ pkg.id }}" class="d-none bg-light small">
              <td colspan="8">
                <div class="row">
                  <div class="col-md-4 border-end">
                    <h6 class="small">Category & Weight</h6>
                    <div class="mb-1">
                      <label class="form-label small">Category</label>
                      <select id="cat_{{ pkg.id }}" class="form-control form-control-sm">
                        {% for cat in categories %}
                          <option value="{{ cat }}" {% if pkg.category == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="mb-1">
                      <label class="form-label small">Actual Weight (lbs)</label>
                      <input type="text" class="form-control form-control-sm" value="{{ pkg.weight }}" readonly>
                    </div>
                  </div>

                  <div class="col-md-8">
                    <h6 class="small">Charges</h6>
                    <div class="row">
                      <div class="col-md-4 mb-1"><label class="small">Duty</label><input id="duty_{{ pkg.id }}" class="form-control form-control-sm"></div>
                      <div class="col-md-4 mb-1"><label class="small">GCT</label><input id="gct_{{ pkg.id }}" class="form-control form-control-sm"></div>
                      <div class="col-md-4 mb-1"><label class="small">Freight</label><input id="freight_{{ pkg.id }}" class="form-control form-control-sm"></div>
                      <div class="col-md-12 mb-1"><label class="small fw-bold text-success">Grand Total</label><input id="grandtotal_{{ pkg.id }}" class="form-control form-control-sm fw-bold text-success"></div>
                    </div>
                    <div class="d-flex justify-content-end gap-2 mt-2">
                      <button type="button" class="btn btn-sm btn-outline-primary" onclick="runCalculator({{ pkg.id }})">‚öôÔ∏è Calculate</button>
                      <button type="button" class="btn btn-sm btn-success" onclick="savePricing({{ pkg.id }})">üíæ Save</button>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
    {% else %}
      <p class="text-muted">No packages in this shipment.</p>
    {% endif %}
  </div>
</div>

<!-- üßæ Invoice Preview Modal -->
{% if invoice_preview %}
<div class="position-fixed top-0 start-0 w-100 h-100" style="background:rgba(0,0,0,.35); z-index:1040;"></div>
<div class="position-fixed top-50 start-50 translate-middle bg-white shadow-lg rounded-3 p-3"
     style="width: 720px; max-height: 80vh; overflow:auto; z-index:1050;">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="m-0">Select Users to Invoice/Bill</h5>
    <button class="btn btn-sm btn-outline-secondary"
            onclick="window.location='{{ url_for('logistics.shipment_log', shipment_id=selected_shipment.id, tab='shipmentLog') }}'">‚úï</button>
  </div>
  <div class="alert alert-info py-2">‚Ä¢ Detained Packages will not be invoiced</div>

  <form method="POST" action="{{ url_for('logistics.finalize_invoices', shipment_id=selected_shipment.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <table class="table table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:36px;"></th>
          <th>Customer</th>
          <th class="text-center">Packages</th>
          <th class="text-end">Due (JMD)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in invoice_preview %}
        <tr>
          <td class="text-center">
            <input type="checkbox" name="user_ids" value="{{ row.user_id }}" checked>
          </td>
          <td>
            <strong>{{ row.registration_number }}</strong> {{ row.full_name }}
            <input type="hidden" name="pkgs_{{ row.user_id }}" value="{{ row.package_ids|join(',') }}">
          </td>
          <td class="text-center">{{ row.package_count }}</td>
          <td class="text-end">JMD {{ "{:,.2f}".format(row.total_due) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="d-flex justify-content-end gap-2 mt-2">
      <button type="submit" class="btn btn-primary">Generate Customer Invoice(s)</button>
      <a class="btn btn-outline-secondary"
         href="{{ url_for('logistics.shipment_log', shipment_id=selected_shipment.id, tab='shipmentLog') }}">Cancel</a>
    </div>
  </form>
</div>
{% endif %}

<script>
$(document).ready(function () {
  // Initialize DataTable
  const table = $('#shipmentTable').DataTable({
    order: [[1, 'asc']],
    pageLength: 10,
    dom: 'Bfrtip',
    buttons: [
      { extend: 'copyHtml5', className: 'btn btn-sm btn-purple' },
      { extend: 'excelHtml5', className: 'btn btn-sm btn-success' },
      { extend: 'csvHtml5', className: 'btn btn-sm btn-info' },
      { extend: 'print', className: 'btn btn-sm btn-secondary' }
    ],
    language: { emptyTable: "No packages in this shipment." }
  });

  // ‚úÖ Select all toggle ‚Äî use delegated handler
  $('#shipmentTable thead').on('change', '#selectAll', function () {
    const checked = this.checked;
    // Use DataTables API to find all current rows, not just visible DOM
    table.rows({ search: 'applied' }).every(function () {
      const $node = $(this.node()).find('.package-checkbox');
      $node.prop('checked', checked);
    });
  });

  // ‚úÖ Update Select-All state when any row checkbox changes
  $('#shipmentTable tbody').on('change', '.package-checkbox', function () {
    const total = table.$('.package-checkbox').length;
    const checked = table.$('.package-checkbox:checked').length;
    $('#selectAll').prop('checked', total > 0 && total === checked);
  });

  // ‚úÖ Resync after redraws (pagination/sort)
  table.on('draw', function () {
    const total = table.$('.package-checkbox').length;
    const checked = table.$('.package-checkbox:checked').length;
    $('#selectAll').prop('checked', total > 0 && total === checked);
  });

  // ‚úÖ Bulk action confirmation
  $('#shipmentForm').on('submit', function (e) {
    const selected = table.$('.package-checkbox:checked').length;
    const action = $('select[name="action"]').val();
    if (!action) {
      e.preventDefault();
      alert("‚ö†Ô∏è Please select an action.");
      return;
    }
    if (selected === 0) {
      e.preventDefault();
      alert("‚ö†Ô∏è Please select at least one package.");
      return;
    }
    if (!confirm(`Perform "${action}" on ${selected} package(s)?`)) {
      e.preventDefault();
    }
  });
});
// Toggle inline pricing
function togglePricing(pkgId){
  document.getElementById("pricing_" + pkgId).classList.toggle("d-none");
}
</script>

<style>
.bg-purple { background-color: #4a148c !important; }
.text-purple { color: #4a148c !important; }
.btn-purple { background-color: #4a148c; color: white; border: none; }
.btn-purple:hover { background-color: #6a1b9a; }
.table-sm th, .table-sm td { padding: 0.25rem 0.4rem; font-size: 0.75rem; }
</style>
{% endblock %}
