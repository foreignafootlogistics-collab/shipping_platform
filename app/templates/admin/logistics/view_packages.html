{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/status.css') }}">

<!-- ====================== -->
<!-- Page Title & Summary   -->
<!-- ====================== -->
<div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
  <h2 class="mb-0">üì¶ View Packages</h2>

  <div class="d-flex flex-wrap align-items-center gap-2">

    <!-- Create Package -->
    <button type="button"
            class="btn btn-purple btn-sm d-inline-flex align-items-center gap-1"
            data-bs-toggle="modal"
            data-bs-target="#createSinglePackageModal"
            title="Create a single package">
      <i class="bi bi-plus-circle"></i>
      <span class="d-none d-md-inline">Create Package</span>
    </button>

    <!-- Top actions -->
    <form method="POST"
          id="bulkActionForm"
          action="{{ url_for('logistics.packages_bulk_action') }}"
          class="m-0">
      {{ bulk_form.hidden_tag() }}
      <input type="hidden" name="bulk_action" id="bulkActionHiddenAction" value="">

      <!-- ‚úÖ KEEP FILTERS/PAGING WHEN YOU POST BULK ACTIONS -->
      <input type="hidden" name="page" value="{{ page }}">
      <input type="hidden" name="per_page" value="{{ per_page }}">
      <input type="hidden" name="date_from" value="{{ date_from or '' }}">
      <input type="hidden" name="date_to" value="{{ date_to or '' }}">
      <input type="hidden" name="house" value="{{ house or '' }}">
      <input type="hidden" name="tracking" value="{{ tracking or '' }}">
      <input type="hidden" name="user_code" value="{{ user_code or '' }}">
      <input type="hidden" name="first_name" value="{{ first_name or '' }}">
      <input type="hidden" name="last_name" value="{{ last_name or '' }}">
      <input type="hidden" name="unassigned_only" value="{{ '1' if unassigned_only else '' }}">
      <input type="hidden" name="epc_only" value="{{ '1' if epc_only else '' }}">

      <div class="d-flex align-items-center action-toolbar shadow-sm">

        <!-- Move to Shipment Log -->
        <button type="submit"
                class="toolbar-btn"
                title="Move to Shipment Log"
                formaction="{{ url_for('logistics.create_shipment') }}"
                formmethod="POST">
          <i class="bi bi-send"></i>
        </button>

        <!-- Email selected packages (Overseas notification) -->
        <button type="submit"
                class="toolbar-btn"
                title="Email selected package details"
                formaction="{{ url_for('logistics.email_selected_packages') }}"
                formmethod="POST">
          <i class="bi bi-envelope"></i>
        </button>

        <!-- Send Invoice Request (stays on bulk_action route) -->
        <button type="submit"
                class="toolbar-btn"
                onclick="document.getElementById('bulkActionHiddenAction').value='send_invoice_request';"
                title="Send Invoice Request">
          <i class="bi bi-file-earmark-text"></i>
        </button>

        <button type="button"
                class="toolbar-btn"
                id="btnFinanceInvoicePreview"
                title="Finance Invoice Preview">
          <i class="bi bi-receipt"></i>
        </button>

        <!-- Bulk Assign to Customer (opens modal) -->
        <button type="button"
                id="openBulkAssignBtn"
                class="toolbar-btn"
                title="Assign selected package(s) to a customer"
                data-bs-toggle="modal"
                data-bs-target="#bulkAssignModal">
          <i class="bi bi-person-check"></i>
        </button>

        <!-- Mark EPC -->
        <button type="submit"
                name="action"
                value="mark_epc"
                class="toolbar-btn toolbar-btn-epc"
                title="Mark selected as EPC">
          <i class="bi bi-star-fill"></i>
        </button>

        <!-- Clear EPC -->
        <button type="submit"
                name="action"
                value="clear_epc"
                class="toolbar-btn"
                title="Clear EPC flag">
          <i class="bi bi-star"></i>
        </button>

      </div>
    </form>

  </div>
</div>
{# ==== Summary just under the heading ==== #}
<div class="alert mb-3 py-2 px-3 d-flex justify-content-between align-items-center"
     style="background-color:#4a148c; color:white; border:none; border-radius:0.5rem;">
  <div>
    <strong>Summary</strong>
    {% if date_from or date_to %}
      ‚Äî for
      {% if date_from %}{{ date_from }}{% else %}‚Ä¶{% endif %}
      {% if date_to %} to {{ date_to }}{% endif %}
    {% else %}
      ‚Äî for all dates
    {% endif %}
  </div>
  <div class="text-end">
    <span class="me-3"><strong>{{ total_packages }}</strong> packages</span>
    <span><strong>{{ "%.2f"|format(total_weight or 0) }}</strong> lbs total</span>
  </div>
</div>

{% if daily_totals and (date_from or date_to) %}
<div class="card shadow-sm mb-3">
  <div class="card-header bg-dark">
    <strong>Per-day breakdown</strong>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-striped mb-0">
        <thead>
          <tr>
            <th style="width: 160px;">Date</th>
            <th class="text-end" style="width: 140px;">Packages</th>
            <th class="text-end" style="width: 180px;">Total Weight (lbs)</th>
          </tr>
        </thead>
        <tbody>
          {% for d in daily_totals %}
          <tr>
            <td>{{ d.day }}</td>
            <td class="text-end">{{ d.count }}</td>
            <td class="text-end">{{ "%.2f"|format(d.total_weight or 0) }}</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="fw-semibold">
            <td class="text-end">Totals:</td>
            <td class="text-end">{{ total_packages }}</td>
            <td class="text-end">{{ "%.2f"|format(total_weight or 0) }}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- ====================== -->
<!-- Filters (moved below)  -->
<!-- ====================== -->
<form id="filterForm"
      method="GET"
      action="{{ url_for('logistics.logistics_dashboard') }}"
      class="row g-3 align-items-end mb-3">

  <input type="hidden" name="tab" value="view_packages">

  <!-- Start Date -->
  <div class="col-12 col-md-2">
    <label for="date_from" class="form-label fw-semibold mb-1">Start Date</label>
    <input type="date" id="date_from" name="date_from"
           class="form-control form-control-sm"
           value="{{ date_from or '' }}">
  </div>

  <!-- End Date -->
  <div class="col-12 col-md-2">
    <label for="date_to" class="form-label fw-semibold mb-1">End Date</label>
    <input type="date" id="date_to" name="date_to"
           class="form-control form-control-sm"
           value="{{ date_to or '' }}">
  </div>

  <!-- House # -->
  <div class="col-12 col-md-4">
    <label for="house" class="form-label fw-semibold mb-1">House #</label>
    <input type="text" id="house" name="house"
           class="form-control form-control-sm"
           placeholder="e.g., 06978687"
           value="{{ house or '' }}">
  </div>

  <!-- Tracking # -->
  <div class="col-12 col-md-4">
    <label for="tracking" class="form-label fw-semibold mb-1">Tracking #</label>
    <input type="text" id="tracking" name="tracking"
           class="form-control form-control-sm"
           placeholder="e.g., 865767565"
           value="{{ tracking or '' }}">
  </div>

  <!-- User Code -->
  <div class="col-12 col-md-4">
    <label for="user_code" class="form-label fw-semibold mb-1">User Code</label>
    <input type="text" id="user_code" name="user_code"
           class="form-control form-control-sm"
           placeholder="e.g., AV34455"
           value="{{ user_code or '' }}">
  </div>

  <!-- User First Name -->
  <div class="col-12 col-md-4">
    <label for="first_name" class="form-label fw-semibold mb-1">User First Name</label>
    <input type="text" id="first_name" name="first_name"
           class="form-control form-control-sm"
           placeholder="First Name"
           value="{{ first_name or '' }}">
  </div>

  <!-- User Last Name -->
  <div class="col-12 col-md-4">
    <label for="last_name" class="form-label fw-semibold mb-1">User Last Name</label>
    <input type="text" id="last_name" name="last_name"
           class="form-control form-control-sm"
           placeholder="Last Name"
           value="{{ last_name or '' }}">
  </div>
  
  <!-- Show Unassigned Only -->
  <div class="col-12 col-md-auto">
    <label class="form-check-label d-flex align-items-center" style="gap:.5rem; padding-top:.35rem;">
      <input type="checkbox"
             class="form-check-input"
             id="filterUnassigned"
             name="unassigned_only"
             value="1"
             {% if unassigned_only %}checked{% endif %}>
      Unassigned Packages
    </label>
  </div>
  
  <div class="col-12 col-md-auto d-flex align-items-center" style="gap:.5rem; padding-top:.35rem;">
    <input type="checkbox"
           class="form-check-input"
           id="filterEpcOnly"
           name="epc_only"
           value="1"
           {% if epc_only %}checked{% endif %}>
    <label class="form-check-label" for="filterEpcOnly">EPC </label>
    <small id="epcCount" class="text-muted ms-2" style="display:none;"></small>
  </div>



  <!-- Toolbar row: left = actions, right = rows-per-page -->
  <div class="col-12">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">

      <!-- Left: Actions -->
      <div class="btn-group btn-group-sm filter-actions" role="group" aria-label="Filter actions">
        <button type="submit" class="btn btn-purple">
          <i class="fas fa-filter me-1"></i> Filter Packages
        </button>

        <a class="btn btn-purple"
           href="{{ url_for('logistics.logistics_dashboard', tab='view_packages') }}">
          <i class="fas fa-filter-circle-xmark me-1"></i> Clear Filter
        </a>

        <a class="btn btn-purple"
           href="{{ url_for('logistics.download_packages',
                            tab='view_packages',
                            date_from=date_from,
                            date_to=date_to,
                            house=house,
                            tracking=tracking,
                            user_code=user_code,
                            first_name=first_name,
                            last_name=last_name,
                            search=search,
                            status=status_filter,
                            per_page=per_page,
                            page=page,
                            unassigned_only='1' if unassigned_only else None) }}">
          <i class="fas fa-download me-1"></i> Download Packages
        </a>

        <!-- Delete uses JS to submit selected IDs to packages_bulk_action -->
        <button type="button" class="btn btn-purple" id="deleteSelectedBtn">
          <i class="fas fa-trash-alt me-1"></i> Delete
        </button>
      </div>

      <!-- Right: Rows per page -->
      <div class="d-flex align-items-center">
        <label for="per_page" class="me-2 mb-0 fw-semibold">Rows / page</label>
        <select id="per_page" name="per_page"
                class="form-select form-select-sm border-purple text-purple fw-semibold"
                style="width:90px;"
                onchange="document.getElementById('filterForm').submit()">
          {% set sizes = allowed_page_sizes or [10,25,50,100,500,1000] %}
          {% for n in sizes %}
            <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>

    </div>
  </div>
</form>

<!-- ====================== -->
<!-- Packages Table         -->
<!-- ====================== -->
<div class="table-responsive">
  <table id="packagesTable" class="table table-bordered table-striped table-hover align-middle w-100">
    <thead class="table-dark">
      <tr>
        <th style="width:70px;">
          <input type="checkbox" id="selectAll"> Actions
        </th>
        <th>User</th>
        <th>Package</th>
        <th id="thHouseAwb" class="th-sort">
          House AWB
          <span class="sort-btns ms-1" role="group" aria-label="Sort House AWB">
            <button type="button" class="sort-btn" data-dir="asc" title="Sort ascending">
              <i class="bi bi-caret-up-fill"></i>
            </button>
            <button type="button" class="sort-btn" data-dir="desc" title="Sort descending">
              <i class="bi bi-caret-down-fill"></i>
            </button>
          </span>
        </th>
        <th>Description</th>
        <th>Date Received</th>
        <th>Weight (lbs)</th>
        <th>Item Value ($)</th>
        <th>Amount Due ($)</th>

        {# Hidden EPC flag column header for filtering #}
        <th data-col="epc-flag" class="d-none">EPC</th>
      </tr>
    </thead>

    {% set mode = "admin" %}
    <tbody>
      {% for pkg in all_packages %}
        {% include "partials/package_row_shared.html" with context %}
      {% endfor %}
    </tbody>
  </table>
</div>


<!-- üìÑ Invoice Preview Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="invoiceModalLabel">
          <i class="fas fa-file-invoice-dollar me-1"></i> Invoice Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="invoiceModalBody">
        <p class="text-muted mb-0">Loading invoice‚Ä¶</p>
      </div>
    </div>
  </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="d-flex justify-content-between align-items-center mt-3" aria-label="Packages pagination">
  <small class="text-muted">
    Showing {{ showing_from }}‚Äì{{ showing_to }} of {{ total_count }}
  </small>

  <ul class="pagination pagination-sm mb-0">
    <!-- First -->
    <li class="page-item {% if page == 1 %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('logistics.logistics_dashboard',
                          tab='view_packages',                          
                          page=1,
                          per_page=per_page,
                          date_from=date_from,
                          date_to=date_to,
                          house=house,
                          tracking=tracking,
                          user_code=user_code,
                          first_name=first_name,
                          last_name=last_name,
                          unassigned_only=('1' if unassigned_only else None),
                          epc_only=('1' if epc_only else None)) }}">
        &laquo;&laquo;
      </a>
    </li>

    <!-- Prev -->
    <li class="page-item {% if page == 1 %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('logistics.logistics_dashboard',
                          tab='view_packages',                          
                          page=(page-1 if page>1 else 1),
                          per_page=per_page,
                          date_from=date_from,
                          date_to=date_to,
                          house=house,
                          tracking=tracking,
                          user_code=user_code,
                          first_name=first_name,
                          last_name=last_name,
                          unassigned_only=('1' if unassigned_only else None),
                          epc_only=('1' if epc_only else None)) }}">
        &laquo;
      </a>
    </li>

    <!-- Page window -->
    {% set start = 1 if total_pages <= 5 else [page-2, 1]|max %}
    {% set end   = total_pages if total_pages <= 5 else [page+2, total_pages]|min %}
    {% for p in range(start, end + 1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link"
           href="{{ url_for('logistics.logistics_dashboard',
                            tab='view_packages',
                            page=p,
                            per_page=per_page,
                            date_from=date_from,
                            date_to=date_to,
                            house=house,
                            tracking=tracking,
                            user_code=user_code,
                            first_name=first_name,
                            last_name=last_name,
                            unassigned_only=('1' if unassigned_only else None),
                            epc_only=('1' if epc_only else None)) }}">
          {{ p }}
        </a>
      </li>
    {% endfor %}

    <!-- Next -->
    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('logistics.logistics_dashboard',
                          tab='view_packages',                          
                          page=(page+1 if page<total_pages else total_pages),
                          per_page=per_page,
                          date_from=date_from,
                          date_to=date_to,
                          house=house,
                          tracking=tracking,
                          user_code=user_code,
                          first_name=first_name,
                          last_name=last_name,
                          unassigned_only=('1' if unassigned_only else None),
                          epc_only=('1' if epc_only else None)) }}">
        &raquo;
      </a>
    </li>

    <!-- Last -->
    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('logistics.logistics_dashboard',
                          tab='view_packages',                          
                          page=total_pages,
                          per_page=per_page,
                          date_from=date_from,
                          date_to=date_to,
                          house=house,
                          tracking=tracking,
                          user_code=user_code,
                          first_name=first_name,
                          last_name=last_name,
                          unassigned_only=('1' if unassigned_only else None),
                          epc_only=('1' if epc_only else None)) }}">
        &raquo;&raquo;
      </a>
    </li>
  </ul>
</nav>
{% else %}
  <small class="text-muted d-block mt-3">
    Showing {{ showing_from }}‚Äì{{ showing_to }} of {{ total_count }}
  </small>
{% endif %}

<!-- ========================= -->
<!-- Attach Invoice Modal (Shared) -->
<!-- ========================= -->
<div class="modal fade" id="attachInvoiceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-paperclip me-1"></i> Attach Invoice / Document
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="attachPkgId" value="">
        <input type="hidden" id="attachCsrfToken" value="{{ csrf_token() }}">

        <div class="mb-2 small text-muted">
          Package ID: <span class="fw-semibold" id="attachPkgLabel">‚Äî</span>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Choose file(s)</label>
          <input type="file"
                 id="attachFiles"
                 class="form-control"
                 accept=".pdf,.png,.jpg,.jpeg,.webp"
                 multiple>
          <div class="form-text">
            Allowed: PDF, PNG, JPG, WEBP
          </div>
        </div>

        <div id="attachUploadStatus" class="small text-muted">Select a file to upload.</div>
      </div>

      <div class="modal-footer">
        <button type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>

        <button type="button"
                class="btn btn-purple"
                id="btnAttachUpload">
          Upload
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Bulk Invoice Preview Modal (shared) -->
<div class="modal fade" id="bulkInvoicePreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Invoice Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p id="detained-note" class="text-muted small mb-2"></p>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Select</th>
                <th>Customer</th>
                <th class="text-center">Packages</th>
                <th class="text-end">Total Due</th>
              </tr>
            </thead>
            <tbody id="inv-prev-tbody"></tbody>
            <tfoot>
              <tr class="table-light">
                <th colspan="3" class="text-end">Total Amount Due</th>
                <th class="text-end" id="inv-prev-total">0.00</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button id="btn-finalize-invoices"
                class="btn btn-purple"
                type="button"
                onclick="finalizeInvoicesFromModal(event)">
          Generate Customer Invoice(s)
        </button>
      </div>
    </div>
  </div>
</div>

{# =============== Bulk Assign Modal =============== #}
<div class="modal fade" id="bulkAssignModal" tabindex="-1" aria-labelledby="bulkAssignLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST"
          action="{{ url_for('logistics.bulk_assign_packages') }}"
          class="modal-content"
          id="bulkAssignForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkAssignLabel">Assign Selected Packages to Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Customer Code (FAFL Reg #) or Email</label>
          <input type="text" name="user_code" class="form-control" placeholder="FAFL10462 or user@domain.com" required>
          <div class="form-text">
            Enter a <b>registration_number</b> (e.g., FAFL10462) or a <b>customer email</b>.
          </div>
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" value="1" id="bulkResetStatus" name="reset_status">
          <label class="form-check-label" for="bulkResetStatus">
            If status is ‚ÄúUnassigned‚Äù, set status to ‚ÄúOverseas‚Äù
          </label>
        </div>

        <div class="small text-muted" id="bulkAssignCount">No packages selected.</div>

        {# Hidden inputs for selected package_ids will be injected here by JS #}
        <div id="bulkAssignSelectedHolder"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-purple">Assign</button>
      </div>
    </form>
  </div>
</div>

<!-- ========================= -->
<!-- Create Single Package Modal -->
<!-- ========================= -->
<div class="modal fade" id="createSinglePackageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <form method="POST"
          action="{{ url_for('logistics.create_single_package_from_view') }}"
          class="modal-content">

      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- keep the user on same filters after submit -->
      <input type="hidden" name="return_tab" value="view_packages">
      <input type="hidden" name="return_page" value="{{ page }}">
      <input type="hidden" name="return_per_page" value="{{ per_page }}">
      <input type="hidden" name="return_date_from" value="{{ date_from or '' }}">
      <input type="hidden" name="return_date_to" value="{{ date_to or '' }}">
      <input type="hidden" name="return_house" value="{{ house or '' }}">
      <input type="hidden" name="return_tracking" value="{{ tracking or '' }}">
      <input type="hidden" name="return_user_code" value="{{ user_code or '' }}">
      <input type="hidden" name="return_first_name" value="{{ first_name or '' }}">
      <input type="hidden" name="return_last_name" value="{{ last_name or '' }}">
      <input type="hidden" name="return_unassigned_only" value="{{ '1' if unassigned_only else '' }}">
      <input type="hidden" name="return_epc_only" value="{{ '1' if epc_only else '' }}">

      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-box-seam me-1"></i> Create Single Package
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- User code (auto-filled from filter; locked by JS) -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Customer Reg # or Email</label>

          <div class="input-group">
            <input type="text"
                   class="form-control"
                   name="user_code"
                   id="createPkgUserCode"
                   placeholder="FAFL10462 or user@email.com"
                   required>
            <button class="btn btn-outline-secondary d-none"
                    type="button"
                    id="unlockCreatePkgUser"
                    title="Edit customer">
              <i class="bi bi-pencil"></i>
            </button>
          </div>

          <div id="createPkgUserDisplay"
               class="small text-muted mt-1 d-none"></div>

          <div class="form-text">
            If you filtered View Packages by a customer, it will auto-fill and lock here.
          </div>
        </div>

        <hr class="my-3">

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Tracking #</label>
            <input type="text" class="form-control" name="tracking_number" placeholder="e.g. 1Z..." required>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">House AWB</label>
            <input type="text" class="form-control" name="house_awb" placeholder="e.g. 06978687">
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Date Received</label>
            <input type="date"
                   class="form-control"
                   name="date_received"
                   value="">
           <div class="form-text">Optional. Leave blank if not received yet.</div>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Description</label>
            <input type="text" class="form-control" name="description" placeholder="e.g. Shoes / Phone case">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">Weight (lbs)</label>
            <input type="number" step="0.01" min="0" class="form-control" name="weight" placeholder="0.00" required>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">Item Value (USD)</label>
            <input type="number" step="0.01" min="0" class="form-control" name="value" placeholder="0.00">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">Status</label>
            <select class="form-select" name="status">
              <option value="Overseas" selected>Overseas</option>
              <option value="Unassigned">Unassigned</option>
              <option value="Ready">Ready</option>
              <option value="Detained">Detained</option>
            </select>
          </div>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-purple">
          <i class="bi bi-check2-circle me-1"></i> Create Package
        </button>
      </div>

    </form>
  </div>
</div>

<script> 
  /* =========================================================
     KEEP DATATABLE STATE (page length, page number, search)
     ========================================================= */
  function savePackagesDTState() {
    try {
      if (!window.jQuery || !$.fn.dataTable) return;
      if (!$.fn.dataTable.isDataTable('#packagesTable')) return;

      const dt = $('#packagesTable').DataTable();
      const st = {
        pageLen: dt.page.len(),
        page: dt.page(),
        search: dt.search()
      };
      localStorage.setItem('VP_PACKAGES_DT_STATE', JSON.stringify(st));
    } catch (e) {}
  }

  function restorePackagesDTState() {
    try {
      if (!window.jQuery || !$.fn.dataTable) return;
      if (!$.fn.dataTable.isDataTable('#packagesTable')) return;

      const raw = localStorage.getItem('VP_PACKAGES_DT_STATE');
      if (!raw) return;

      const st = JSON.parse(raw);
      const dt = $('#packagesTable').DataTable();

      if (st.pageLen) dt.page.len(st.pageLen);
      if (typeof st.search === 'string') dt.search(st.search);

      dt.draw(false);

      if (typeof st.page === 'number') {
        dt.page(st.page).draw(false);
      }
    } catch (e) {}
  }
 
  // Toggle pricing row
  function togglePricing(pkgId) {
    document.getElementById("pricing_" + pkgId)?.classList.toggle("d-none");
  }
  
  /* ================================
   BULK INVOICE PREVIEW + FINALIZE
   (shared across tabs)
   ================================ */

  // helper for JSON POST (only define if not already defined on this page)
  window.postJSON = window.postJSON || (async function(url, body) {
    const r = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify(body)
    });
    if (!r.ok) {
      const txt = await r.text();
      throw new Error('Request failed: ' + txt);
    }
    return r.json();
  });

  async function openInvoicePreview(selectedPkgIds) {
    console.log('openInvoicePreview, ids =', selectedPkgIds);

    const data = await postJSON("{{ url_for('logistics.bulk_invoice_preview') }}", {
      package_ids: selectedPkgIds
    });

    const tbody = document.querySelector('#inv-prev-tbody');
    if (!tbody) {
      alert('Preview table body #inv-prev-tbody not found in DOM.');
      return;
    }
    tbody.innerHTML = '';

    let grand = 0;

    for (const row of (data.rows || [])) {
      grand += Number(row.total_due || 0);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <input type="checkbox" class="inv-user" data-uid="${row.user_id}"
                 data-pkgs="${(row.package_ids || []).join(',')}" checked>
        </td>
        <td><strong>${row.registration_number || ''}</strong> ${row.full_name || ''}</td>
        <td class="text-center">${row.package_count || 0}</td>
        <td class="text-end">${Number(row.total_due || 0).toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    }

    const totalCell = document.getElementById('inv-prev-total');
    if (totalCell) totalCell.textContent = grand.toFixed(2);

    const note = document.getElementById('detained-note');
    if (note) {
      note.textContent = data.detained_skipped
        ? `‚Ä¢ ${data.detained_skipped} detained package(s) skipped`
        : '';
    }

    const modalEl = document.getElementById('bulkInvoicePreviewModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  }

  async function finalizeInvoicesFromModal(ev) {
    if (ev && ev.preventDefault) ev.preventDefault();

    const checks = [...document.querySelectorAll('.inv-user:checked')];
    const selections = checks.map(ch => ({
      user_id: Number(ch.dataset.uid),
      package_ids: (ch.dataset.pkgs || '').split(',').filter(Boolean).map(x => Number(x))
    }));

    if (!selections.length) {
      alert('Select at least one customer.');
      return;
    }

    try {
      const res = await postJSON(
        "{{ url_for('logistics.bulk_invoice_finalize_json') }}",
        { selections }
      );

      if (res.error) {
        alert('‚ö†Ô∏è Server error: ' + res.error);
        return;
      }

      alert(`Created ${res.created} invoice(s).`);

      // refresh so UI updates (invoice_id / amounts)
      setTimeout(() => window.location.reload(), 500);
    } catch (err) {
      console.error(err);
      alert('‚ö†Ô∏è Error generating invoices: ' + (err.message || err));
    }
  }

  // Select All checkboxes
  document.addEventListener('DOMContentLoaded', function () {
    const selectAll = document.getElementById('selectAll');
    if (!selectAll) return;

    selectAll.addEventListener('change', function() {
      document.querySelectorAll('.package-checkbox').forEach(cb => cb.checked = this.checked);
    });
  });

  // Bulk actions must have at least one selected
  const bulkForm = document.getElementById('bulkActionForm');
  bulkForm?.addEventListener('submit', function(e) {
    const selected = Array.from(document.querySelectorAll('.package-checkbox:checked'));
    if (selected.length === 0) {
      e.preventDefault();
      alert("‚ö†Ô∏è Please select at least one package.");
      return;
    }
  });

  // Delete from top bar
  document.getElementById('deleteSelectedBtn')?.addEventListener('click', function () {
    const checkboxes = Array.from(document.querySelectorAll('.package-checkbox:checked'));
    if (checkboxes.length === 0) {
      alert('‚ö†Ô∏è Please select at least one package to delete.');
      return;
    }
    if (!confirm(`Delete ${checkboxes.length} package(s)? This cannot be undone.`)) {
      return;
    }

    const form = document.getElementById('bulkActionForm');
    const actionInput = document.getElementById('bulkActionHiddenAction');
    if (actionInput) actionInput.value = 'delete';

    // remove old injected holder if present
    const holderId = 'selectedIdsContainer';
    document.getElementById(holderId)?.remove();

    // inject selected IDs into form
    const holder = document.createElement('div');
    holder.id = holderId;

    checkboxes.forEach(cb => {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'package_ids';   // ‚úÖ THIS is the key fix
      hidden.value = cb.value;
      holder.appendChild(hidden);
    });

    form.appendChild(holder);

    // optional: preserve DT state if you want
    if (typeof savePackagesDTState === 'function') savePackagesDTState();

    form.submit();
  });

     // Helper: open invoice HTML in Bootstrap modal
  function openInvoiceModalWithHtml(html) {
    const bodyEl = document.getElementById('invoiceModalBody');
    if (bodyEl) {
      bodyEl.innerHTML = html;
    }

    const modalEl = document.getElementById('invoiceModal');
    if (!modalEl) {
      alert("Invoice modal not found in DOM.");
      return;
    }

    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();

    // Wire up Add Payment / Discount / Breakdown inside the newly loaded invoice
    initInlineInvoice();
  }

    // Initialise inline invoice behaviour inside #invoiceModal
  function initInlineInvoice() {
    const modalRoot = document.getElementById('invoiceModal');
    if (!modalRoot) return;

    const payOverlay      = modalRoot.querySelector('#inlinePayOverlay');
    const discountOverlay = modalRoot.querySelector('#inlineDiscountOverlay');
    const bdOverlay       = modalRoot.querySelector('#inlineBreakdownOverlay');

    // helper show/hide
    const showOverlay = (el) => { if (el) el.classList.remove('d-none'); };
    const hideOverlay = (el) => { if (el) el.classList.add('d-none'); };

    // always start closed
    [payOverlay, discountOverlay, bdOverlay].forEach(el => el && el.classList.add('d-none'));

    /* ---------- open / close buttons ---------- */

    // Add Payment
    modalRoot.querySelectorAll('.js-open-pay').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        if (!payOverlay) return;
        showOverlay(payOverlay);
        // ensure display shows current hidden value
        setupPaymentLogic();
      });
    });

    // Discount
    modalRoot.querySelectorAll('.js-open-discount').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        if (!discountOverlay) return;
        showOverlay(discountOverlay);
        setupDiscountLogic();  // recalc amounts
      });
    });

    // Close X buttons on overlays
    modalRoot.querySelectorAll('.fa-inline-close').forEach(btn => {
      btn.addEventListener('click', function () {
        const type = this.getAttribute('data-close');
        if (type === 'pay')      hideOverlay(payOverlay);
        if (type === 'discount') hideOverlay(discountOverlay);
        if (type === 'bd')       hideOverlay(bdOverlay);
      });
    });

    /* ---------- PAYMENT keypad logic ---------- */
    function setupPaymentLogic() {
      if (!payOverlay) return;

      const display = payOverlay.querySelector('#payDisplayInline');
      const hidden  = payOverlay.querySelector('#payAmountInputInline');
      if (!display || !hidden) return;

      let current = hidden.value && hidden.value !== '0' ? String(hidden.value) : '0';

      function updateDisplay() {
        let num = parseFloat(current || '0');
        if (isNaN(num)) num = 0;
        hidden.value = num.toFixed(2);
        display.textContent =
          'JMD ' + num.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
      }

      function pushKey(key) {
        if (key === '.') {
          if (current.includes('.')) return;
          current += '.';
        } else if (key === '00') {
          if (current === '0') return;
          current += '00';
        } else {
          if (current === '0') current = key;
          else current += key;
        }
        updateDisplay();
      }

      // keypad buttons
      payOverlay.querySelectorAll('.payment-key-btn').forEach(btn => {
        btn.onclick = function () {
          pushKey(this.getAttribute('data-key'));
        };
      });

      // quick amounts
      payOverlay.querySelectorAll('.payment-quick-btn[data-quick]').forEach(btn => {
        btn.onclick = function () {
          current = String(this.getAttribute('data-quick') || '0');
          updateDisplay();
        };
      });

      // clear
      const clearBtn = payOverlay.querySelector('#payClearBtnInline');
      if (clearBtn) {
        clearBtn.onclick = function () {
          current = '0';
          updateDisplay();
        };
      }

      // payment method
      const methodInput = payOverlay.querySelector('#payMethodInputInline');
      const methodList  = payOverlay.querySelector('#paymentMethodListInline');
      if (methodInput && methodList) {
        methodList.querySelectorAll('.payment-method-btn').forEach(btn => {
          btn.onclick = function () {
            methodList.querySelectorAll('.payment-method-btn')
                      .forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            methodInput.value = this.getAttribute('data-method') || 'Cash';
          };
        });
      }
      // ---------- NEW: "Authorised by" dropdown + other ----------
      const authSelect = payOverlay.querySelector('#authBySelectInline');
      const authInput  = payOverlay.querySelector('#authByInputInline');
      const authHidden = payOverlay.querySelector('#authByHiddenInline');

      if (authSelect && authHidden) {
        // initialise from current select value
        if (authSelect.value !== '__other__') {
          authHidden.value = authSelect.value;
        }

        authSelect.addEventListener('change', function () {
          if (this.value === '__other__') {
            if (authInput) {
              authInput.classList.remove('d-none');
              authInput.value = '';
              authInput.focus();
            }
            authHidden.value = '';
          } else {
            if (authInput) {
              authInput.classList.add('d-none');
            }
            authHidden.value = this.value;
          }
        });

        if (authInput) {
          authInput.addEventListener('input', function () {
            if (authSelect.value === '__other__') {
              authHidden.value = this.value;
            }
          });
        }
      }
      updateDisplay();
    }

    /* ---------- DISCOUNT tabs logic ---------- */
    function setupDiscountLogic() {
      if (!discountOverlay) return;

      const form     = discountOverlay.querySelector('#inlineDiscountForm');
      if (!form) return;

      const balance  = parseFloat(form.getAttribute('data-balance') || '0') || 0;
      const tabs     = discountOverlay.querySelector('#discountTabsInline');
      const panePct  = discountOverlay.querySelector('#discountPercentPaneInline');
      const paneAmt  = discountOverlay.querySelector('#discountAmountPaneInline');
      const pctInput = discountOverlay.querySelector('#discountPercentInputInline');
      const pctLbl   = discountOverlay.querySelector('#discountPercentAmountInline');
      const amtInput = discountOverlay.querySelector('#discountAmountInputInline');
      const hidden   = discountOverlay.querySelector('#discountHiddenAmountInline');

      let mode = tabs?.querySelector('.discount-tab.active')?.getAttribute('data-mode') || 'percent';

      function formatJMD(v) {
        const n = parseFloat(v || '0') || 0;
        return 'JMD ' + n.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      function recalc() {
        if (!hidden) return;
        if (mode === 'percent') {
          const pct  = parseFloat(pctInput?.value || '0') || 0;
          const disc = Math.max(0, balance * pct / 100);
          hidden.value = disc.toFixed(2);
          if (pctLbl) pctLbl.textContent = formatJMD(disc);
        } else {
          const v = parseFloat(amtInput?.value || '0') || 0;
          hidden.value = v.toFixed(2);
        }
      }

      if (tabs) {
        tabs.querySelectorAll('.discount-tab').forEach(btn => {
          btn.onclick = function () {
            tabs.querySelectorAll('.discount-tab').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            mode = this.getAttribute('data-mode') || 'percent';
            if (panePct && paneAmt) {
              if (mode === 'percent') {
                panePct.classList.remove('d-none');
                paneAmt.classList.add('d-none');
              } else {
                panePct.classList.add('d-none');
                paneAmt.classList.remove('d-none');
              }
            }
            recalc();
          };
        });
      }

      if (pctInput) pctInput.oninput = recalc;
      if (amtInput) amtInput.oninput = recalc;

      recalc();
    }

    /* ---------- Lightning (charges breakdown) ---------- */
    if (bdOverlay) {
      const ids = [
        'bd-duty-inline','bd-gct-inline','bd-freight-inline','bd-handling-inline',
        'bd-scf-inline','bd-envl-inline','bd-caf-inline','bd-stamp-inline',
        'bd-other-inline','bd-total-inline'
      ];
      const setField = (id, val) => {
        const el = bdOverlay.querySelector('#' + id);
        if (el) el.textContent = val;
      };

      modalRoot.querySelectorAll('.js-bd').forEach(btn => {
        btn.addEventListener('click', function () {
          const pkgId = this.getAttribute('data-pkg');
          if (!pkgId) return;

          ids.forEach(id => setField(id, '‚Ä¶'));

          fetch("{{ url_for('admin.invoice_breakdown', package_id=0) }}".replace('0', pkgId))
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(d => {
              const nf = new Intl.NumberFormat();
              setField('bd-duty-inline',     nf.format(d.duty || 0));
              setField('bd-gct-inline',      nf.format(d.gct || 0));
              setField('bd-freight-inline',  nf.format(d.freight || 0));
              setField('bd-handling-inline', nf.format(d.handling || 0));
              setField('bd-scf-inline',      nf.format(d.scf || 0));
              setField('bd-envl-inline',     nf.format(d.envl || 0));
              setField('bd-caf-inline',      nf.format(d.caf || 0));
              setField('bd-stamp-inline',    nf.format(d.stamp || 0));
              setField('bd-other-inline',    nf.format(d.other || 0));
              setField('bd-total-inline',    nf.format(d.total_jmd || 0));
            })
            .catch(() => ids.forEach(id => setField(id, '‚Äî')));

          showOverlay(bdOverlay);
        });
      });
    }
  }


  // View a specific existing invoice (using its invoice_id)
  function viewInvoiceById(invoiceId) {
    const url = "{{ url_for('admin.view_invoice', invoice_id=0) }}?inline=1"
                  .replace('0', String(invoiceId));

    fetch(url)
      .then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.text();
      })
      .then(html => {
        openInvoiceModalWithHtml(html);
      })
      .catch(err => {
        console.error(err);
        alert("Unable to load invoice.");
      });
  }

  // View a customer's current uninvoiced packages as a pro-forma invoice
  function viewInvoiceByUser(userId) {
    const url = "{{ url_for('admin.view_customer_invoice', user_id=0) }}"
                  .replace('0', String(userId));

    fetch(url)
      .then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.text();
      })
      .then(html => {
        openInvoiceModalWithHtml(html);
      })
      .catch(err => {
        console.error(err);
        alert("Unable to load invoice.");
      });
  }


  // ===============================
  // Finance Invoice Preview (View Packages toolbar)
  // ===============================
  document.getElementById('btnFinanceInvoicePreview')?.addEventListener('click', async function () {
    const selected = Array.from(document.querySelectorAll('.package-checkbox:checked'))
                          .map(cb => cb.value);

    if (!selected.length) {
      alert("‚ö†Ô∏è Please select at least one package.");
      return;
    }

    // Reuse the same function from Shipment Log (openInvoicePreview)
    if (typeof openInvoicePreview !== "function") {
      alert("‚ö†Ô∏è Invoice preview function not found. Next step will add the modal + functions here too.");
      return;
    }

    try {
      await openInvoicePreview(selected);
    } catch (err) {
      console.error(err);
      alert("‚ö†Ô∏è Could not load invoice preview.");
    }
  });


  // Open bulk-assign only if at least one package is selected
  document.getElementById('openBulkAssignBtn')?.addEventListener('click', function (e) {
    const selected = Array.from(document.querySelectorAll('.package-checkbox:checked'));
    if (selected.length === 0) {
      e.preventDefault();
      e.stopPropagation();
      alert("‚ö†Ô∏è Please select at least one package to assign.");
      // Programmatically hide the modal if it tried to open
      const el = document.getElementById('bulkAssignModal');
      if (el) {
        const m = bootstrap.Modal.getOrCreateInstance(el);
        m.hide();
      }
      return false;
    }
  });

  // When the modal shows, inject the selected IDs as hidden inputs
  const bulkAssignModal = document.getElementById('bulkAssignModal');
  if (bulkAssignModal) {
    bulkAssignModal.addEventListener('show.bs.modal', function () {
      const holder = document.getElementById('bulkAssignSelectedHolder');
      holder.innerHTML = ''; // clear old
      const selected = Array.from(document.querySelectorAll('.package-checkbox:checked'));
      selected.forEach(cb => {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'package_ids';
        hidden.value = cb.value;
        holder.appendChild(hidden);
      });
      const count = document.getElementById('bulkAssignCount');
      if (count) count.textContent = `${selected.length} package(s) selected.`;
    });
  }


  /* ============================
     EPC filter & count (clean)
     ============================ */
(function () {
  if (!window.jQuery || !$.fn.dataTable) return;

  var table = $.fn.dataTable.isDataTable('#packagesTable')
    ? $('#packagesTable').DataTable()
    : $('#packagesTable').DataTable({
        stateSave: true,
        pageLength: 25,
        order: [],
        columnDefs: [
          { targets: 3, orderable: true } // House AWB
        ]
      });

  restorePackagesDTState();

  // House AWB arrows (delegated)
  (function houseAwbArrowSort(){
    const houseColIndex = 3;
    const container = $(table.table().container());

    container.off('click.houseawb');

    container.on('click.houseawb', 'th#thHouseAwb .sort-btn', function (e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      const dir = ($(this).data('dir') || '').toString().toLowerCase();
      if (dir !== 'asc' && dir !== 'desc') return;

      console.log('House AWB arrow clicked ->', dir);
      table.order([[houseColIndex, dir]]).draw();

      $('th#thHouseAwb .sort-btn[data-dir="asc"]').toggleClass('active', dir === 'asc');
      $('th#thHouseAwb .sort-btn[data-dir="desc"]').toggleClass('active', dir === 'desc');
    });

    container.on('click.houseawb', 'th#thHouseAwb', function (e) {
      if (e.target.closest('.sort-btn')) return;
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
    });

    table.off('order.houseawb').on('order.houseawb', function () {
      const ord = table.order();
      if (!ord || !ord.length) {
        $('th#thHouseAwb .sort-btn').removeClass('active');
        return;
      }
      const col = Number(ord[0][0]);
      const dir = ord[0][1];
      if (col === houseColIndex) {
        $('th#thHouseAwb .sort-btn[data-dir="asc"]').toggleClass('active', dir === 'asc');
        $('th#thHouseAwb .sort-btn[data-dir="desc"]').toggleClass('active', dir === 'desc');
      } else {
        $('th#thHouseAwb .sort-btn').removeClass('active');
      }
    });
  })();

  // EPC filter continues here...
  var $headers    = $('#packagesTable thead th');
  var epcColIndex = $headers.index($headers.filter('[data-col="epc-flag"]'));
  if (epcColIndex < 0) return;

  table.column(epcColIndex).visible(false);

  if (!window.__epcFilterInstalled) {
    $.fn.dataTable.ext.search.push(function (settings, data) {
      if (settings && settings.nTable !== $('#packagesTable')[0]) return true;
      var epcOnly = $('#filterEpcOnly').is(':checked');
      if (!epcOnly) return true;
      var cell = (data[epcColIndex] || '').toString().trim();
      return cell === '1';
    });
    window.__epcFilterInstalled = true;
  }

  var $toggle = $('#filterEpcOnly');
  var $count  = $('#epcCount');

  function updateCount() {
    if ($toggle.is(':checked')) {
      $count.text(table.rows({ search: 'applied' }).count() + ' EPC package(s)').show();
    } else {
      $count.hide();
    }
  }

  table.column(epcColIndex).search('', false, false);

  $toggle.on('change', function () {
    table.draw();
    updateCount();
  });

  if ($toggle.is(':checked')) table.draw();
  updateCount();
})();

/* ==========================
   PACKAGE ATTACHMENTS (ADMIN) - NEW MODAL
   ========================== */
(function attachAdminFilesNew(){
  if (window.__attachAdminFilesNewInstalled) return;
  window.__attachAdminFilesNewInstalled = true;

  const modalEl  = document.getElementById('attachInvoiceModal');
  if (!modalEl) return;

  const pkgIdInput = document.getElementById('attachPkgId');
  const pkgLbl     = document.getElementById('attachPkgLabel');
  const fileInput  = document.getElementById('attachFiles');
  const statusEl   = document.getElementById('attachUploadStatus');
  const uploadBtn  = document.getElementById('btnAttachUpload');

  let currentPkgId = null;

  // Open modal: triggered by paperclip icon
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.js-open-attach');
    if (!btn) return;

    currentPkgId = btn.getAttribute('data-pkg-id') || btn.getAttribute('data-pkg') || '';

    if (pkgIdInput) pkgIdInput.value = currentPkgId;
    if (pkgLbl) pkgLbl.textContent = currentPkgId || '‚Äî';
    if (fileInput) fileInput.value = '';
    if (statusEl) statusEl.textContent = 'Select a file to upload.';

    bootstrap.Modal.getOrCreateInstance(modalEl).show();
  });

  async function doUpload() {
    const pkgId = (currentPkgId || pkgIdInput?.value || '').trim();
    if (!pkgId) { alert('Package id missing.'); return; }

    const files = fileInput?.files;
    if (!files || !files.length) { alert('Please choose at least one file.'); return; }

    const csrf = (document.getElementById('attachCsrfToken')?.value || '').trim();

    const fd = new FormData();
    if (csrf) fd.append('csrf_token', csrf);
    for (const f of files) fd.append('attachments', f);

    if (statusEl) statusEl.textContent = 'Uploading‚Ä¶';

    const url = "{{ url_for('logistics.admin_upload_package_attachments', package_id=0) }}".replace('0', pkgId);

    let res, data = {};
    try {
      res = await fetch(url, {
        method: 'POST',
        headers: { 
          'X-Requested-With': 'XMLHttpRequest',
          ...(csrf ? { 'X-CSRFToken': csrf } : {})
        },
        body: fd
      });
      try { data = await res.json(); } catch (e) {}
    } catch (err) {
      console.error(err);
      if (statusEl) statusEl.textContent = '';
      alert('Upload failed (network error).');
      return;
    }

    if (!res.ok || !data.success) {
      if (statusEl) statusEl.textContent = '';
      alert(data.error || `Upload failed (HTTP ${res.status}).`);
      return;
    }

    if (statusEl) statusEl.textContent = 'Uploaded!';
    bootstrap.Modal.getInstance(modalEl)?.hide();

    savePackagesDTState();
    setTimeout(() => window.location.reload(), 350);
  }

  uploadBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    doUpload();
  });
  fileInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      doUpload();
    }
  });
  modalEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      doUpload();
    }
  });
  modalEl.addEventListener('hidden.bs.modal', () => {
    if (statusEl) statusEl.textContent = 'Select a file to upload.';
    if (fileInput) fileInput.value = '';
  });
})();

/* =====================================================
   AUTO-FILL + LOCK USER FIELD + AJAX NAME LOOKUP
   ===================================================== */
(function enhancedAutoFillUser(){
  const modalEl = document.getElementById('createSinglePackageModal');
  if (!modalEl) return;

  const filterInput = document.querySelector('#filterForm input[name="user_code"]');
  const modalInput  = document.getElementById('createPkgUserCode');
  const displayDiv  = document.getElementById('createPkgUserDisplay');
  const unlockBtn   = document.getElementById('unlockCreatePkgUser');

  const lookupUrl = "{{ url_for('logistics.api_user_lookup') }}";

  function lockField() {
    modalInput.readOnly = true;
    modalInput.classList.add('bg-light');
    unlockBtn.classList.remove('d-none');
  }

  function unlockField() {
    modalInput.readOnly = false;
    modalInput.classList.remove('bg-light');
    unlockBtn.classList.add('d-none');
    displayDiv.classList.add('d-none');
    displayDiv.textContent = '';
  }

  async function lookupAndShow(q) {
    const val = (q || '').trim();
    if (!val) return;

    displayDiv.classList.remove('d-none');
    displayDiv.textContent = "Looking up customer‚Ä¶";

    try {
      const res = await fetch(`${lookupUrl}?q=${encodeURIComponent(val)}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        displayDiv.textContent = `Using customer: ${val} (lookup error)`;
        return;
      }

      if (!data.found || !data.user) {
        displayDiv.textContent = `Using customer: ${val} (not found)`;
        return;
      }

      const u = data.user;
      const name = (u.full_name || '').trim();
      const reg  = (u.registration_number || '').trim();

      // Prefer showing reg + name
      if (reg && name) {
        displayDiv.textContent = `Using customer: ${reg} ‚Äî ${name}`;
      } else if (reg) {
        displayDiv.textContent = `Using customer: ${reg}`;
      } else if (name) {
        displayDiv.textContent = `Using customer: ${val} ‚Äî ${name}`;
      } else {
        displayDiv.textContent = `Using customer: ${val}`;
      }

    } catch (err) {
      console.error(err);
      displayDiv.textContent = `Using customer: ${val} (lookup failed)`;
    }
  }

  // When modal opens, auto-fill from filter and lock
  modalEl.addEventListener('show.bs.modal', function () {
    const filterUserCode = (filterInput?.value || '').trim();

    if (filterUserCode) {
      modalInput.value = filterUserCode;
      lockField();
      lookupAndShow(filterUserCode);
    } else {
      modalInput.value = '';
      unlockField();
    }
  });

  // Pencil unlock
  unlockBtn?.addEventListener('click', function(){
    unlockField();
    modalInput.focus();
  });

  // If user edits manually after unlocking, do lookup after pause
  let t = null;
  modalInput?.addEventListener('input', function(){
    if (modalInput.readOnly) return; // locked = ignore
    clearTimeout(t);
    const v = modalInput.value;
    t = setTimeout(() => lookupAndShow(v), 450);
  });

})();
</script>

<style>
.badge-epc{
  background:#ffc107; color:#000; border:1px solid #4a148c;
  font-size:.65rem; padding:.20rem .40rem; border-radius:4px;
}

.btn-group .btn {
  border-radius: 0;
  border-right: 1px solid #ccc;
}
.btn-group .btn:last-child {
  border-right: none;
}
.btn-outline-light.text-secondary:hover {
  background-color: #6f42c1;
  color: #fff !important;
}
/* Center-align all number columns */
.table td.text-center {
  vertical-align: middle;
  font-weight: 500;
}

/* Segmented control look */
.filter-actions .btn { border-radius: 0; }
.filter-actions .btn + .btn { margin-left: -1px; } /* remove double border */
.filter-actions .btn:first-child {
  border-top-left-radius: .5rem;
  border-bottom-left-radius: .5rem;
}
.filter-actions .btn:last-child {
  border-top-right-radius: .5rem;
  border-bottom-right-radius: .5rem;
}

/* Primary purple color */
.btn-purple {
  background-color: #4a148c;
  color: #fff;
  border: 1px solid #4a148c;
  transition: background-color 0.2s, transform 0.1s;
}
.btn-purple:hover {
  background-color: #6a1b9a;
  border-color: #6a1b9a;
  color: #fff;
  transform: scale(1.02);
}
.border-purple { border-color: #4a148c !important; }
.text-purple { color: #4a148c !important; }

/* Compact pill-style toolbar */
.action-toolbar {
    border-radius: 999px;
    background: #ffffff;
    border: 1px solid #e0d4ff;
    padding: 4px 6px;
    gap: 2px;
}

/* Base button look */
.action-toolbar .toolbar-btn {
    border: none;
    background: transparent;
    padding: 6px 12px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    cursor: pointer;
    transition: background-color 0.15s ease, color 0.15s ease,
                box-shadow 0.15s ease, transform 0.05s ease;
    color: #4b4b4b;
    font-size: 1.1rem;
}

/* Hover & focus */
.action-toolbar .toolbar-btn:hover,
.action-toolbar .toolbar-btn:focus-visible {
    background-color: #f3e8ff;
    color: #4a148c;
    box-shadow: 0 0 0 1px rgba(106, 27, 154, 0.20);
    outline: none;
}

/* Pressed */
.action-toolbar .toolbar-btn:active {
    transform: translateY(1px);
}

/* EPC highlight button (yellow-ish) */
.action-toolbar .toolbar-btn-epc {
    color: #b7791f;
}

.action-toolbar .toolbar-btn-epc:hover,
.action-toolbar .toolbar-btn-epc:focus-visible {
    background-color: #fff7e6;
    color: #d97706;
    box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.35);
}
/* House AWB sort arrows */
.th-sort { white-space: nowrap; }

.sort-btns{
  display: inline-flex;
  flex-direction: column;
  gap: 0;
  vertical-align: middle;
  margin-left: 6px;
}

.sort-btn{
  border: 0;
  background: transparent;
  padding: 0 2px;
  line-height: 0.9;
  color: rgba(255,255,255,.75);
  cursor: pointer;
}

.sort-btn i{
  font-size: .8rem; /* smaller so they fit nicely */
}

.sort-btn:hover { color: #fff; }

.sort-btn.active { color: #ffc107; } /* highlight active direction */
#thHouseAwb .sort-btn { pointer-events: auto; }
#thHouseAwb .sort-btns { pointer-events: auto; }

</style>

{% include 'admin/invoices/_proforma_modal_block.html' %}

{% endblock %}
