{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/status.css') }}">

<!-- ====================== -->
<!-- Page Title & Summary   -->
<!-- ====================== -->
<div class="d-flex justify-content-between align-items-center mb-2">
  <h2 class="mb-0">üì¶ View Packages</h2>

  <!-- Top actions -->
  <form method="POST"
        id="bulkActionForm"
        action="{{ url_for('logistics.packages_bulk_action') }}"
        class="m-0">
    {{ bulk_form.hidden_tag() }}
    <input type="hidden" name="bulk_action" id="bulkActionHiddenAction" value="">

    <div class="d-flex align-items-center action-toolbar shadow-sm">
    
      <!-- Move to Shipment Log -->
      <button type="submit"
              class="toolbar-btn"
              title="Move to Shipment Log"
              formaction="{{ url_for('logistics.create_shipment') }}"
              formmethod="POST">
        <i class="bi bi-send"></i>
      </button>

      <!-- Email selected packages (Overseas notification) -->
      <button type="submit"
              class="toolbar-btn"
              title="Email selected package details"
              formaction="{{ url_for('logistics.email_selected_packages') }}"
              formmethod="POST">
        <i class="bi bi-envelope"></i>
      </button>

      <!-- Send Invoice Request (stays on bulk_action route) -->
      <button type="submit"
              class="toolbar-btn"
              name="action"
              value="send_invoice_request"
              title="Send Invoice Request">
        <i class="bi bi-file-earmark-text"></i>
      </button>

      <!-- Bulk Assign to Customer (opens modal) -->
      <button type="button"
              id="openBulkAssignBtn"
              class="toolbar-btn"
              title="Assign selected package(s) to a customer"
              data-bs-toggle="modal"
              data-bs-target="#bulkAssignModal">
        <i class="bi bi-person-check"></i>
      </button>

      <!-- Mark EPC -->
      <button type="submit"
              name="action"
              value="mark_epc"
              class="toolbar-btn toolbar-btn-epc"
              title="Mark selected as EPC">
        <i class="bi bi-star-fill"></i>
      </button>

      <!-- Clear EPC -->
      <button type="submit"
              name="action"
              value="clear_epc"
              class="toolbar-btn"
              title="Clear EPC flag">
        <i class="bi bi-star"></i>
      </button>

    </div>
  </form>

</div>

{# ==== Summary just under the heading ==== #}
<div class="alert mb-3 py-2 px-3 d-flex justify-content-between align-items-center"
     style="background-color:#4a148c; color:white; border:none; border-radius:0.5rem;">
  <div>
    <strong>Summary</strong>
    {% if date_from or date_to %}
      ‚Äî for
      {% if date_from %}{{ date_from }}{% else %}‚Ä¶{% endif %}
      {% if date_to %} to {{ date_to }}{% endif %}
    {% else %}
      ‚Äî for all dates
    {% endif %}
  </div>
  <div class="text-end">
    <span class="me-3"><strong>{{ total_packages }}</strong> packages</span>
    <span><strong>{{ "%.2f"|format(total_weight or 0) }}</strong> lbs total</span>
  </div>
</div>

{% if daily_totals and (date_from or date_to) %}
<div class="card shadow-sm mb-3">
  <div class="card-header bg-dark">
    <strong>Per-day breakdown</strong>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-striped mb-0">
        <thead>
          <tr>
            <th style="width: 160px;">Date</th>
            <th class="text-end" style="width: 140px;">Packages</th>
            <th class="text-end" style="width: 180px;">Total Weight (lbs)</th>
          </tr>
        </thead>
        <tbody>
          {% for d in daily_totals %}
          <tr>
            <td>{{ d.day }}</td>
            <td class="text-end">{{ d.count }}</td>
            <td class="text-end">{{ "%.2f"|format(d.total_weight or 0) }}</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="fw-semibold">
            <td class="text-end">Totals:</td>
            <td class="text-end">{{ total_packages }}</td>
            <td class="text-end">{{ "%.2f"|format(total_weight or 0) }}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- ====================== -->
<!-- Filters (moved below)  -->
<!-- ====================== -->
<form id="filterForm"
      method="GET"
      action="{{ url_for('logistics.logistics_dashboard') }}"
      class="row g-3 align-items-end mb-3">

  <input type="hidden" name="tab" value="view_packages">

  <!-- Start Date -->
  <div class="col-12 col-md-2">
    <label for="date_from" class="form-label fw-semibold mb-1">Start Date</label>
    <input type="date" id="date_from" name="date_from"
           class="form-control form-control-sm"
           value="{{ date_from or '' }}">
  </div>

  <!-- End Date -->
  <div class="col-12 col-md-2">
    <label for="date_to" class="form-label fw-semibold mb-1">End Date</label>
    <input type="date" id="date_to" name="date_to"
           class="form-control form-control-sm"
           value="{{ date_to or '' }}">
  </div>

  <!-- House # -->
  <div class="col-12 col-md-4">
    <label for="house" class="form-label fw-semibold mb-1">House #</label>
    <input type="text" id="house" name="house"
           class="form-control form-control-sm"
           placeholder="e.g., 06978687"
           value="{{ house or '' }}">
  </div>

  <!-- Tracking # -->
  <div class="col-12 col-md-4">
    <label for="tracking" class="form-label fw-semibold mb-1">Tracking #</label>
    <input type="text" id="tracking" name="tracking"
           class="form-control form-control-sm"
           placeholder="e.g., 865767565"
           value="{{ tracking or '' }}">
  </div>

  <!-- User Code -->
  <div class="col-12 col-md-4">
    <label for="user_code" class="form-label fw-semibold mb-1">User Code</label>
    <input type="text" id="user_code" name="user_code"
           class="form-control form-control-sm"
           placeholder="e.g., AV34455"
           value="{{ user_code or '' }}">
  </div>

  <!-- User First Name -->
  <div class="col-12 col-md-4">
    <label for="first_name" class="form-label fw-semibold mb-1">User First Name</label>
    <input type="text" id="first_name" name="first_name"
           class="form-control form-control-sm"
           placeholder="First Name"
           value="{{ first_name or '' }}">
  </div>

  <!-- User Last Name -->
  <div class="col-12 col-md-4">
    <label for="last_name" class="form-label fw-semibold mb-1">User Last Name</label>
    <input type="text" id="last_name" name="last_name"
           class="form-control form-control-sm"
           placeholder="Last Name"
           value="{{ last_name or '' }}">
  </div>
  
  <!-- Show Unassigned Only -->
  <div class="col-12 col-md-auto">
    <label class="form-check-label d-flex align-items-center" style="gap:.5rem; padding-top:.35rem;">
      <input type="checkbox"
             class="form-check-input"
             id="filterUnassigned"
             name="unassigned_only"
             value="1"
             {% if unassigned_only %}checked{% endif %}>
      Unassigned Packages
    </label>
  </div>
  
  <div class="col-12 col-md-auto d-flex align-items-center" style="gap:.5rem; padding-top:.35rem;">
    <input type="checkbox"
           class="form-check-input"
           id="filterEpcOnly"
           name="epc_only"
           value="1"
           {% if epc_only %}checked{% endif %}>
    <label class="form-check-label" for="filterEpcOnly">EPC </label>
    <small id="epcCount" class="text-muted ms-2" style="display:none;"></small>
  </div>



  <!-- Toolbar row: left = actions, right = rows-per-page -->
  <div class="col-12">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">

      <!-- Left: Actions -->
      <div class="btn-group btn-group-sm filter-actions" role="group" aria-label="Filter actions">
        <button type="submit" class="btn btn-purple">
          <i class="fas fa-filter me-1"></i> Filter Packages
        </button>

        <a class="btn btn-purple"
           href="{{ url_for('logistics.logistics_dashboard', tab='view_packages') }}">
          <i class="fas fa-filter-circle-xmark me-1"></i> Clear Filter
        </a>

        <a class="btn btn-purple"
           href="{{ url_for('logistics.download_packages',
                            tab='view_packages',
                            date_from=date_from,
                            date_to=date_to,
                            house=house,
                            tracking=tracking,
                            user_code=user_code,
                            first_name=first_name,
                            last_name=last_name,
                            search=search,
                            status=status_filter,
                            per_page=per_page,
                            page=page,
                            unassigned_only='1' if unassigned_only else None) }}">
          <i class="fas fa-download me-1"></i> Download Packages
        </a>

        <!-- Delete uses JS to submit selected IDs to packages_bulk_action -->
        <button type="button" class="btn btn-purple" id="deleteSelectedBtn">
          <i class="fas fa-trash-alt me-1"></i> Delete
        </button>
      </div>

      <!-- Right: Rows per page -->
      <div class="d-flex align-items-center">
        <label for="per_page" class="me-2 mb-0 fw-semibold">Rows / page</label>
        <select id="per_page" name="per_page"
                class="form-select form-select-sm border-purple text-purple fw-semibold"
                style="width:90px;"
                onchange="document.getElementById('filterForm').submit()">
          {% set sizes = allowed_page_sizes or [10,25,50,100,500,1000] %}
          {% for n in sizes %}
            <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>

    </div>
  </div>
</form>

<!-- ====================== -->
<!-- Packages Table         -->
<!-- ====================== -->
<div class="table-responsive">
  <table id="packagesTable" class="table table-bordered table-striped table-hover align-middle w-100">
    <thead class="table-dark">
      <tr>
        <th style="width:70px;">
          <input type="checkbox" id="selectAll"> Actions
        </th>
        <th>User</th>
        <th>Package</th>
        <th>House AWB</th>
        <th>Description</th>
        <th>Date Received</th>
        <th>Weight (lbs)</th>
        <th>Item Value ($)</th>
        <th>Amount Due ($)</th>

        {# Hidden EPC flag column header for filtering #}
        <th data-col="epc-flag" class="d-none">EPC</th>
      </tr>
    </thead>

    <tbody>
    {% for pkg in all_packages %}
      <tr>
        <td>
          <input type="checkbox" name="package_ids" value="{{ pkg.id }}" class="package-checkbox" form="bulkActionForm">

          {% if pkg.invoice_id %}
            <!-- ‚úÖ View existing invoice -->
            <a href="#" onclick="viewInvoiceById({{ pkg.invoice_id }}); return false;"
               class="btn btn-sm btn-outline-purple ms-1"
               title="View Existing Invoice">
              <i class="fas fa-file-invoice-dollar"></i>
            </a>
          {% else %}
            <!-- üßæ Create new invoice -->
            <a href="#" onclick="viewInvoiceByUser({{ pkg.user_id }}); return false;"
               class="btn btn-sm btn-outline-purple ms-1"
               title="Preview (Pro-forma)">
              <i class="fas fa-eye"></i>
            </a>
          {% endif %}
        </td>

        <td>
          <strong>
            <a href="{{ url_for('accounts_profiles.view_user', id=pkg.user_id) }}"
               class="text-purple text-decoration-none">
              {{ pkg.full_name }}
            </a>
          </strong><br>
          <small class="text-muted">{{ pkg.registration_number }}</small>
        </td>

        <td>
          {# Provide the exact variable name the partial expects #}
          {% set status = pkg.status %}
          {% include 'partials/status_tracker.html' with context %}
          {% if pkg.user_id == unassigned_id %}
            <span class="badge bg-warning text-dark ms-1">UNASSIGNED</span>
          {% endif %}
          <br>
          <small class="text-muted">{{ pkg.tracking_number }}</small>
        </td>

        <td>
          {{ pkg.house_awb or '-' }}
          {% if pkg ['epc'] %}
            <span class="badge badge-epc ms-1">
              <i class="bi bi-flag-fill" style="font-size:0.60rem;"></i> EPC
            </span>
          {% endif %}
        </td>

        <td>
          <div>{{ pkg.description or '-' }}</div>

          {% if pkg.attachments and pkg.attachments|length > 0 %}
            <div class="mt-1 d-flex flex-wrap gap-2">
              {% for a in pkg.attachments %}
                <a class="badge text-decoration-none"
                   style="background:#f5f0fa; border:1px solid #4a148c; color:#4a148c;"
                   target="_blank"
                   href="{{ url_for('logistics.view_package_attachment', attachment_id=a.id) }}"
                   title="{{ a.original_name or a.file_name }}">
                  <i class="fa-solid fa-paperclip me-1"></i>
                  {{ (a.original_name or 'file')[:18] }}{% if (a.original_name or '')|length > 18 %}‚Ä¶{% endif %}
                </a>
              {% endfor %}
            </div>
          {% endif %}
        </td>



        <td>
          {% if pkg['date_received'] %}
            {{ pkg['date_received']|datetimeformat('%Y-%m-%d') }}
          {% else %}
            -
          {% endif %}
        </td>

        <td>
          {{ pkg.weight }}  ({{ pkg.weight | round(0, 'ceil') }})
          <input type="hidden" id="weight_{{ pkg.id }}" value="{{ pkg.weight }}">
        </td>

        <td class="text-center">{{ pkg.value or 50 }}</td>
        <td class="text-center">{{ pkg.amount_due or 0 }}</td>

        {# Hidden EPC flag cell for filtering (must line up with header) #}
        <td class="d-none">{{ 1 if pkg ['epc'] else 0 }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>


<!-- üìÑ Invoice Preview Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="invoiceModalLabel">
          <i class="fas fa-file-invoice-dollar me-1"></i> Invoice Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="invoiceModalBody">
        <p class="text-muted mb-0">Loading invoice‚Ä¶</p>
      </div>
    </div>
  </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="d-flex justify-content-between align-items-center mt-3" aria-label="Packages pagination">
  <small class="text-muted">
    Showing {{ showing_from }}‚Äì{{ showing_to }} of {{ total_count }}
  </small>

  <ul class="pagination pagination-sm mb-0">
    <!-- First -->
    <li class="page-item {% if page == 1 %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('logistics.logistics_dashboard',
                          tab='view_packages',                          
                          page=1,
                          per_page=per_page,
                          date_from=date_from,
                          date_to=date_to,
                          house=house,
                          tracking=tracking,
                          user_code=user_code,
                          first_name=first_name,
                          last_name=last_name,
                          show_unassigned=request.args.get('show_unassigned')) }}">
        &laquo;&laquo;
      </a>
    </li>

    <!-- Prev -->
    <li class="page-item {% if page == 1 %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('logistics.logistics_dashboard',
                          tab='view_packages',                          
                          page=(page-1 if page>1 else 1),
                          per_page=per_page,
                          date_from=date_from,
                          date_to=date_to,
                          house=house,
                          tracking=tracking,
                          user_code=user_code,
                          first_name=first_name,
                          last_name=last_name,
                          show_unassigned=request.args.get('show_unassigned')) }}">
        &laquo;
      </a>
    </li>

    <!-- Page window -->
    {% set start = 1 if total_pages <= 5 else [page-2, 1]|max %}
    {% set end   = total_pages if total_pages <= 5 else [page+2, total_pages]|min %}
    {% for p in range(start, end + 1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link"
           href="{{ url_for('logistics.logistics_dashboard',
                            tab='view_packages',
                            page=p,
                            per_page=per_page,
                            date_from=date_from,
                            date_to=date_to,
                            house=house,
                            tracking=tracking,
                            user_code=user_code,
                            first_name=first_name,
                            last_name=last_name,
                            show_unassigned=request.args.get('show_unassigned')) }}">
          {{ p }}
        </a>
      </li>
    {% endfor %}

    <!-- Next -->
    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('logistics.logistics_dashboard',
                          tab='view_packages',                          
                          page=(page+1 if page<total_pages else total_pages),
                          per_page=per_page,
                          date_from=date_from,
                          date_to=date_to,
                          house=house,
                          tracking=tracking,
                          user_code=user_code,
                          first_name=first_name,
                          last_name=last_name,
                          show_unassigned=request.args.get('show_unassigned')) }}">
        &raquo;
      </a>
    </li>

    <!-- Last -->
    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('logistics.logistics_dashboard',
                          tab='view_packages',                          
                          page=total_pages,
                          per_page=per_page,
                          date_from=date_from,
                          date_to=date_to,
                          house=house,
                          tracking=tracking,
                          user_code=user_code,
                          first_name=first_name,
                          last_name=last_name,
                          show_unassigned=request.args.get('show_unassigned')) }}">
        &raquo;&raquo;
      </a>
    </li>
  </ul>
</nav>
{% else %}
  <small class="text-muted d-block mt-3">
    Showing {{ showing_from }}‚Äì{{ showing_to }} of {{ total_count }}
  </small>
{% endif %}


{# =============== Bulk Assign Modal =============== #}
<div class="modal fade" id="bulkAssignModal" tabindex="-1" aria-labelledby="bulkAssignLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST"
          action="{{ url_for('logistics.bulk_assign_packages') }}"
          class="modal-content"
          id="bulkAssignForm">
      {{ csrf_token() }}
      <div class="modal-header">
        <h5 class="modal-title" id="bulkAssignLabel">Assign Selected Packages to Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Customer Code or Email</label>
          <input type="text" name="user_code" class="form-control" placeholder="FAFL10462 or user@domain.com" required>
          <div class="form-text">
            Enter a <b>registration_number</b> (e.g., FAFL10462) or a <b>customer email</b>.
          </div>
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" value="1" id="bulkResetStatus" name="reset_status">
          <label class="form-check-label" for="bulkResetStatus">
            If status is ‚ÄúUnassigned‚Äù, set status to ‚ÄúOverseas‚Äù
          </label>
        </div>

        <div class="small text-muted" id="bulkAssignCount">No packages selected.</div>

        {# Hidden inputs for selected package_ids will be injected here by JS #}
        <div id="bulkAssignSelectedHolder"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-purple">Assign</button>
      </div>
    </form>
  </div>
</div>


<script>
  // Toggle pricing row
  function togglePricing(pkgId) {
    document.getElementById("pricing_" + pkgId)?.classList.toggle("d-none");
  }

  
  // Select All checkboxes
  document.getElementById('selectAll').addEventListener('change', function() {
    document.querySelectorAll('.package-checkbox').forEach(cb => cb.checked = this.checked);
  });

  // Bulk actions must have at least one selected
  document.getElementById('bulkActionForm').addEventListener('submit', function(e) {
    const selected = Array.from(document.querySelectorAll('.package-checkbox:checked'));
    if (selected.length === 0) {
      e.preventDefault();
      alert("‚ö†Ô∏è Please select at least one package.");
      return;
    }
  });

  // Delete from top bar
  document.getElementById('deleteSelectedBtn')?.addEventListener('click', function () {
    const checkboxes = Array.from(document.querySelectorAll('.package-checkbox:checked'));
    if (checkboxes.length === 0) {
      alert('‚ö†Ô∏è Please select at least one package to delete.');
      return;
    }
    if (!confirm(`Delete ${checkboxes.length} package(s)? This cannot be undone.`)) {
      return;
    }

    const form = document.getElementById('bulkActionForm');
    const actionInput = document.getElementById('bulkActionHiddenAction');
    if (actionInput) actionInput.value = 'delete';   // handled by packages_bulk_action()

    // Ensure all selected IDs are included
    const holderId = 'selectedIdsContainer';
    document.getElementById(holderId)?.remove();
    const holder = document.createElement('div');
    holder.id = holderId;
    checkboxes.forEach(cb => {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'package_ids';
      hidden.value = cb.value;
      holder.appendChild(hidden);
    });
    form.appendChild(holder);

    form.submit();
  });

     // Helper: open invoice HTML in Bootstrap modal
  function openInvoiceModalWithHtml(html) {
    const bodyEl = document.getElementById('invoiceModalBody');
    if (bodyEl) {
      bodyEl.innerHTML = html;
    }

    const modalEl = document.getElementById('invoiceModal');
    if (!modalEl) {
      alert("Invoice modal not found in DOM.");
      return;
    }

    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();

    // Wire up Add Payment / Discount / Breakdown inside the newly loaded invoice
    initInlineInvoice();
  }

    // Initialise inline invoice behaviour inside #invoiceModal
  function initInlineInvoice() {
    const modalRoot = document.getElementById('invoiceModal');
    if (!modalRoot) return;

    const payOverlay      = modalRoot.querySelector('#inlinePayOverlay');
    const discountOverlay = modalRoot.querySelector('#inlineDiscountOverlay');
    const bdOverlay       = modalRoot.querySelector('#inlineBreakdownOverlay');

    // helper show/hide
    const showOverlay = (el) => { if (el) el.classList.remove('d-none'); };
    const hideOverlay = (el) => { if (el) el.classList.add('d-none'); };

    // always start closed
    [payOverlay, discountOverlay, bdOverlay].forEach(el => el && el.classList.add('d-none'));

    /* ---------- open / close buttons ---------- */

    // Add Payment
    modalRoot.querySelectorAll('.js-open-pay').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        if (!payOverlay) return;
        showOverlay(payOverlay);
        // ensure display shows current hidden value
        setupPaymentLogic();
      });
    });

    // Discount
    modalRoot.querySelectorAll('.js-open-discount').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        if (!discountOverlay) return;
        showOverlay(discountOverlay);
        setupDiscountLogic();  // recalc amounts
      });
    });

    // Close X buttons on overlays
    modalRoot.querySelectorAll('.fa-inline-close').forEach(btn => {
      btn.addEventListener('click', function () {
        const type = this.getAttribute('data-close');
        if (type === 'pay')      hideOverlay(payOverlay);
        if (type === 'discount') hideOverlay(discountOverlay);
        if (type === 'bd')       hideOverlay(bdOverlay);
      });
    });

    /* ---------- PAYMENT keypad logic ---------- */
    function setupPaymentLogic() {
      if (!payOverlay) return;

      const display = payOverlay.querySelector('#payDisplayInline');
      const hidden  = payOverlay.querySelector('#payAmountInputInline');
      if (!display || !hidden) return;

      let current = hidden.value && hidden.value !== '0' ? String(hidden.value) : '0';

      function updateDisplay() {
        let num = parseFloat(current || '0');
        if (isNaN(num)) num = 0;
        hidden.value = num.toFixed(2);
        display.textContent =
          'JMD ' + num.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
      }

      function pushKey(key) {
        if (key === '.') {
          if (current.includes('.')) return;
          current += '.';
        } else if (key === '00') {
          if (current === '0') return;
          current += '00';
        } else {
          if (current === '0') current = key;
          else current += key;
        }
        updateDisplay();
      }

      // keypad buttons
      payOverlay.querySelectorAll('.payment-key-btn').forEach(btn => {
        btn.onclick = function () {
          pushKey(this.getAttribute('data-key'));
        };
      });

      // quick amounts
      payOverlay.querySelectorAll('.payment-quick-btn[data-quick]').forEach(btn => {
        btn.onclick = function () {
          current = String(this.getAttribute('data-quick') || '0');
          updateDisplay();
        };
      });

      // clear
      const clearBtn = payOverlay.querySelector('#payClearBtnInline');
      if (clearBtn) {
        clearBtn.onclick = function () {
          current = '0';
          updateDisplay();
        };
      }

      // payment method
      const methodInput = payOverlay.querySelector('#payMethodInputInline');
      const methodList  = payOverlay.querySelector('#paymentMethodListInline');
      if (methodInput && methodList) {
        methodList.querySelectorAll('.payment-method-btn').forEach(btn => {
          btn.onclick = function () {
            methodList.querySelectorAll('.payment-method-btn')
                      .forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            methodInput.value = this.getAttribute('data-method') || 'Cash';
          };
        });
      }
      // ---------- NEW: "Authorised by" dropdown + other ----------
      const authSelect = payOverlay.querySelector('#authBySelectInline');
      const authInput  = payOverlay.querySelector('#authByInputInline');
      const authHidden = payOverlay.querySelector('#authByHiddenInline');

      if (authSelect && authHidden) {
        // initialise from current select value
        if (authSelect.value !== '__other__') {
          authHidden.value = authSelect.value;
        }

        authSelect.addEventListener('change', function () {
          if (this.value === '__other__') {
            if (authInput) {
              authInput.classList.remove('d-none');
              authInput.value = '';
              authInput.focus();
            }
            authHidden.value = '';
          } else {
            if (authInput) {
              authInput.classList.add('d-none');
            }
            authHidden.value = this.value;
          }
        });

        if (authInput) {
          authInput.addEventListener('input', function () {
            if (authSelect.value === '__other__') {
              authHidden.value = this.value;
            }
          });
        }
      }
      updateDisplay();
    }

    /* ---------- DISCOUNT tabs logic ---------- */
    function setupDiscountLogic() {
      if (!discountOverlay) return;

      const form     = discountOverlay.querySelector('#inlineDiscountForm');
      if (!form) return;

      const balance  = parseFloat(form.getAttribute('data-balance') || '0') || 0;
      const tabs     = discountOverlay.querySelector('#discountTabsInline');
      const panePct  = discountOverlay.querySelector('#discountPercentPaneInline');
      const paneAmt  = discountOverlay.querySelector('#discountAmountPaneInline');
      const pctInput = discountOverlay.querySelector('#discountPercentInputInline');
      const pctLbl   = discountOverlay.querySelector('#discountPercentAmountInline');
      const amtInput = discountOverlay.querySelector('#discountAmountInputInline');
      const hidden   = discountOverlay.querySelector('#discountHiddenAmountInline');

      let mode = tabs?.querySelector('.discount-tab.active')?.getAttribute('data-mode') || 'percent';

      function formatJMD(v) {
        const n = parseFloat(v || '0') || 0;
        return 'JMD ' + n.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      function recalc() {
        if (!hidden) return;
        if (mode === 'percent') {
          const pct  = parseFloat(pctInput?.value || '0') || 0;
          const disc = Math.max(0, balance * pct / 100);
          hidden.value = disc.toFixed(2);
          if (pctLbl) pctLbl.textContent = formatJMD(disc);
        } else {
          const v = parseFloat(amtInput?.value || '0') || 0;
          hidden.value = v.toFixed(2);
        }
      }

      if (tabs) {
        tabs.querySelectorAll('.discount-tab').forEach(btn => {
          btn.onclick = function () {
            tabs.querySelectorAll('.discount-tab').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            mode = this.getAttribute('data-mode') || 'percent';
            if (panePct && paneAmt) {
              if (mode === 'percent') {
                panePct.classList.remove('d-none');
                paneAmt.classList.add('d-none');
              } else {
                panePct.classList.add('d-none');
                paneAmt.classList.remove('d-none');
              }
            }
            recalc();
          };
        });
      }

      if (pctInput) pctInput.oninput = recalc;
      if (amtInput) amtInput.oninput = recalc;

      recalc();
    }

    /* ---------- Lightning (charges breakdown) ---------- */
    if (bdOverlay) {
      const ids = [
        'bd-duty-inline','bd-gct-inline','bd-freight-inline','bd-handling-inline',
        'bd-scf-inline','bd-envl-inline','bd-caf-inline','bd-stamp-inline',
        'bd-other-inline','bd-total-inline'
      ];
      const setField = (id, val) => {
        const el = bdOverlay.querySelector('#' + id);
        if (el) el.textContent = val;
      };

      modalRoot.querySelectorAll('.js-bd').forEach(btn => {
        btn.addEventListener('click', function () {
          const pkgId = this.getAttribute('data-pkg');
          if (!pkgId) return;

          ids.forEach(id => setField(id, '‚Ä¶'));

          fetch("{{ url_for('admin.invoice_breakdown', package_id=0) }}".replace('0', pkgId))
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(d => {
              const nf = new Intl.NumberFormat();
              setField('bd-duty-inline',     nf.format(d.duty || 0));
              setField('bd-gct-inline',      nf.format(d.gct || 0));
              setField('bd-freight-inline',  nf.format(d.freight || 0));
              setField('bd-handling-inline', nf.format(d.handling || 0));
              setField('bd-scf-inline',      nf.format(d.scf || 0));
              setField('bd-envl-inline',     nf.format(d.envl || 0));
              setField('bd-caf-inline',      nf.format(d.caf || 0));
              setField('bd-stamp-inline',    nf.format(d.stamp || 0));
              setField('bd-other-inline',    nf.format(d.other || 0));
              setField('bd-total-inline',    nf.format(d.total_jmd || 0));
            })
            .catch(() => ids.forEach(id => setField(id, '‚Äî')));

          showOverlay(bdOverlay);
        });
      });
    }
  }


  // View a specific existing invoice (using its invoice_id)
  function viewInvoiceById(invoiceId) {
    const url = "{{ url_for('admin.view_invoice', invoice_id=0) }}?inline=1"
                  .replace('0', String(invoiceId));

    fetch(url)
      .then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.text();
      })
      .then(html => {
        openInvoiceModalWithHtml(html);
      })
      .catch(err => {
        console.error(err);
        alert("Unable to load invoice.");
      });
  }

  // View a customer's current uninvoiced packages as a pro-forma invoice
  function viewInvoiceByUser(userId) {
    const url = "{{ url_for('admin.view_customer_invoice', user_id=0) }}"
                  .replace('0', String(userId));

    fetch(url)
      .then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.text();
      })
      .then(html => {
        openInvoiceModalWithHtml(html);
      })
      .catch(err => {
        console.error(err);
        alert("Unable to load invoice.");
      });
  }


  

  // Open bulk-assign only if at least one package is selected
  document.getElementById('openBulkAssignBtn')?.addEventListener('click', function (e) {
    const selected = Array.from(document.querySelectorAll('.package-checkbox:checked'));
    if (selected.length === 0) {
      e.preventDefault();
      e.stopPropagation();
      alert("‚ö†Ô∏è Please select at least one package to assign.");
      // Programmatically hide the modal if it tried to open
      const el = document.getElementById('bulkAssignModal');
      if (el) {
        const m = bootstrap.Modal.getOrCreateInstance(el);
        m.hide();
      }
      return false;
    }
  });

  // When the modal shows, inject the selected IDs as hidden inputs
  const bulkAssignModal = document.getElementById('bulkAssignModal');
  if (bulkAssignModal) {
    bulkAssignModal.addEventListener('show.bs.modal', function () {
      const holder = document.getElementById('bulkAssignSelectedHolder');
      holder.innerHTML = ''; // clear old
      const selected = Array.from(document.querySelectorAll('.package-checkbox:checked'));
      selected.forEach(cb => {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'package_ids';
        hidden.value = cb.value;
        holder.appendChild(hidden);
      });
      const count = document.getElementById('bulkAssignCount');
      if (count) count.textContent = `${selected.length} package(s) selected.`;
    });
  }


document.addEventListener('DOMContentLoaded', function () {
  const deleteBtn     = document.getElementById('deleteSelectedBtn');
  const bulkForm      = document.getElementById('bulkActionForm');
  const hiddenAction  = document.getElementById('bulkActionHiddenAction');

  if (deleteBtn && bulkForm && hiddenAction) {
    deleteBtn.addEventListener('click', function () {
      // set the bulk_action used in packages_bulk_action()
      hiddenAction.value = 'delete';
      bulkForm.submit();
    });
  }
});



  /* ============================
     EPC filter & count (clean)
     ============================ */
  (function () {
    // Init or get DataTable (once)
    var table = $.fn.dataTable.isDataTable('#packagesTable')
      ? $('#packagesTable').DataTable()
      : $('#packagesTable').DataTable({
          stateSave: true,
          pageLength: 25,
          order: []
        });

    // Find hidden EPC column by header attr
    var $headers    = $('#packagesTable thead th');
    var epcColIndex = $headers.index($headers.filter('[data-col="epc-flag"]'));
    if (epcColIndex < 0) return; // safety

    // Keep column hidden but searchable
    table.column(epcColIndex).visible(false);

    // Install a robust custom filter once (trims cell, checks === '1')
    if (!window.__epcFilterInstalled) {
      $.fn.dataTable.ext.search.push(function (settings, data) {
        // Only affect this table
        if (settings && settings.nTable !== $('#packagesTable')[0]) return true;

        var epcOnly = $('#filterEpcOnly').is(':checked');
        if (!epcOnly) return true;

        var cell = (data[epcColIndex] || '').toString().trim();
        return cell === '1';
      });
      window.__epcFilterInstalled = true;
    }

    var $toggle = $('#filterEpcOnly');
    var $count  = $('#epcCount');

    function updateCount() {
      if ($toggle.is(':checked')) {
        $count.text(table.rows({ search: 'applied' }).count() + ' EPC package(s)').show();
      } else {
        $count.hide();
      }
    }

    // Clear any old regex search on the EPC column (defensive)
    table.column(epcColIndex).search('', false, false);

    // Live toggle (no submit required)
    $toggle.on('change', function () {
      table.draw();
      updateCount();
    });

    // If the page loaded with epc_only=1 (server-side), ensure client filter matches
    if ($toggle.is(':checked')) {
      table.draw();
    }
    updateCount();
  })();
</script>

<style>
.badge-epc{
  background:#ffc107; color:#000; border:1px solid #4a148c;
  font-size:.65rem; padding:.20rem .40rem; border-radius:4px;
}

.btn-group .btn {
  border-radius: 0;
  border-right: 1px solid #ccc;
}
.btn-group .btn:last-child {
  border-right: none;
}
.btn-outline-light.text-secondary:hover {
  background-color: #6f42c1;
  color: #fff !important;
}
/* Center-align all number columns */
.table td.text-center {
  vertical-align: middle;
  font-weight: 500;
}

/* Segmented control look */
.filter-actions .btn { border-radius: 0; }
.filter-actions .btn + .btn { margin-left: -1px; } /* remove double border */
.filter-actions .btn:first-child {
  border-top-left-radius: .5rem;
  border-bottom-left-radius: .5rem;
}
.filter-actions .btn:last-child {
  border-top-right-radius: .5rem;
  border-bottom-right-radius: .5rem;
}

/* Primary purple color */
.btn-purple {
  background-color: #4a148c;
  color: #fff;
  border: 1px solid #4a148c;
  transition: background-color 0.2s, transform 0.1s;
}
.btn-purple:hover {
  background-color: #6a1b9a;
  border-color: #6a1b9a;
  color: #fff;
  transform: scale(1.02);
}
.border-purple { border-color: #4a148c !important; }
.text-purple { color: #4a148c !important; }

/* Compact pill-style toolbar */
.action-toolbar {
    border-radius: 999px;
    background: #ffffff;
    border: 1px solid #e0d4ff;
    padding: 4px 6px;
    gap: 2px;
}

/* Base button look */
.action-toolbar .toolbar-btn {
    border: none;
    background: transparent;
    padding: 6px 12px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    cursor: pointer;
    transition: background-color 0.15s ease, color 0.15s ease,
                box-shadow 0.15s ease, transform 0.05s ease;
    color: #4b4b4b;
    font-size: 1.1rem;
}

/* Hover & focus */
.action-toolbar .toolbar-btn:hover,
.action-toolbar .toolbar-btn:focus-visible {
    background-color: #f3e8ff;
    color: #4a148c;
    box-shadow: 0 0 0 1px rgba(106, 27, 154, 0.20);
    outline: none;
}

/* Pressed */
.action-toolbar .toolbar-btn:active {
    transform: translateY(1px);
}

/* EPC highlight button (yellow-ish) */
.action-toolbar .toolbar-btn-epc {
    color: #b7791f;
}

.action-toolbar .toolbar-btn-epc:hover,
.action-toolbar .toolbar-btn-epc:focus-visible {
    background-color: #fff7e6;
    color: #d97706;
    box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.35);
}

</style>

{% include 'admin/invoices/_proforma_modal_block.html' %}

{% endblock %}
