{% extends "layout_admin.html" %}
{% block title %}Message{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="page-narrow">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h4 class="mb-0">Message</h4>
        <div class="text-muted small">
          From/To:
          <strong>{{ other.full_name or "Customer" }}</strong>
          {% if other and other.email %}
            <span class="ms-2">â€¢ {{ other.email }}</span>
          {% endif %}
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        {# Optional Gmail-style actions (only works if you added these routes) #}
        {% if 'admin.message_archive' in (current_app.view_functions or {}) %}
          <form method="POST" action="{{ url_for('admin.message_archive', message_id=m.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-sm btn-outline-secondary" type="submit" title="Archive">
              <i class="bi bi-archive"></i>
            </button>
          </form>
        {% endif %}

        {% if 'admin.message_delete' in (current_app.view_functions or {}) %}
          <form method="POST" action="{{ url_for('admin.message_delete', message_id=m.id) }}" class="d-inline"
                onsubmit="return confirm('Delete this message?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-sm btn-outline-danger" type="submit" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </form>
        {% endif %}

        {# Back button preserves mailbox state (box/search/page/etc) #}
        <a href="{{ url_for('admin.messages',
                            box=request.args.get('box', 'inbox'),
                            q=request.args.get('q'),
                            unread=request.args.get('unread'),
                            archived=request.args.get('archived'),
                            per_page=request.args.get('per_page'),
                            page=request.args.get('page')) }}"
           class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Back
        </a>
      </div>
    </div>

    <!-- Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div class="flex-grow-1">
            <div class="fw-bold">{{ m.subject or "Message" }}</div>
            <div class="text-muted small">
              {{ to_jamaica(m.created_at).strftime('%Y-%m-%d %I:%M %p') if m.created_at else "" }}
              {% if m.sender_id == current_user.id %}
                <span class="ms-2 badge bg-secondary">Sent</span>
              {% else %}
                <span class="ms-2 badge bg-primary">Received</span>
              {% endif %}
            </div>
          </div>

          <div class="text-end">
            {% if m.recipient_id == current_user.id and not m.is_read %}
              <span class="badge" style="background:#FACC15; color:#111827;">Unread</span>
            {% else %}
              <span class="badge" style="background:#15803D;">Read</span>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card-body">
        <div style="white-space: pre-wrap; line-height:1.6;">
          {{ m.body }}
        </div>
      </div>

      <hr class="m-0">

      <div class="card-body bg-light">
        <form method="POST"
              action="{{ url_for('admin.message_reply', message_id=m.id,
                                 box=request.args.get('box', 'inbox'),
                                 q=request.args.get('q'),
                                 unread=request.args.get('unread'),
                                 archived=request.args.get('archived'),
                                 per_page=request.args.get('per_page'),
                                 page=request.args.get('page')) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="mb-2">
            <input type="text" name="subject" class="form-control"
                   placeholder="Subject (optional)"
                   value="{{ m.subject if (m.subject or '').lower().startswith('re:') else 'Re: ' ~ (m.subject or '') }}">
          </div>

          <div class="mb-2">
            <textarea name="body" class="form-control" rows="4"
                      placeholder="Write your reply..." required></textarea>
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-send"></i> Send Reply
            </button>

            <a href="{{ url_for('admin.messages',
                                box=request.args.get('box', 'inbox'),
                                q=request.args.get('q'),
                                unread=request.args.get('unread'),
                                archived=request.args.get('archived'),
                                per_page=request.args.get('per_page'),
                                page=request.args.get('page')) }}"
               class="btn btn-outline-secondary">
              Cancel
            </a>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

