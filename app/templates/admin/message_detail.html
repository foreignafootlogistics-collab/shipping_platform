{% extends "layout_admin.html" %}
{% block title %}Message{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="page-narrow">

    <!-- Top bar -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h4 class="mb-0">Message</h4>
        <div class="text-muted small">
          Conversation with:
          <strong>{{ other.full_name if other else "Customer" }}</strong>
          {% if other and other.email %}
            <span class="ms-2">• {{ other.email }}</span>
          {% endif %}
        </div>
      </div>

      <div class="d-flex gap-2">
        <a href="{{ url_for('admin.messages') }}" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Back to Inbox
        </a>
      </div>
    </div>

    <!-- Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Message card -->
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div class="flex-grow-1">
            <div class="fw-bold fs-5">{{ m.subject or "Message" }}</div>

            <div class="text-muted small mt-1">
              {{ to_jamaica(m.created_at).strftime('%A, %B %d, %Y • %I:%M %p') if m.created_at else "" }}
              <span class="mx-2">•</span>

              {% if m.sender_id == current_user.id %}
                <span>Sent by <b>You</b></span>
              {% else %}
                <span>Received from <b>{{ other.full_name if other else "Customer" }}</b></span>
              {% endif %}
            </div>
          </div>

          <div class="text-end">
            {% set is_unread = (m.recipient_id == current_user.id and not m.is_read) %}
            {% if is_unread %}
              <span class="badge" style="background:#FACC15; color:#111827;">Unread</span>
            {% else %}
              <span class="badge" style="background:#15803D;">Read</span>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card-body">
        <div style="white-space: pre-wrap; line-height:1.65;">
          {{ m.body or "" }}
        </div>
      </div>

      <hr class="m-0">

      <!-- Reply box -->
      <div class="card-body bg-light">
        <form method="POST" action="{{ url_for('admin.message_reply', message_id=m.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="mb-2">
            <input type="text"
                   name="subject"
                   class="form-control"
                   placeholder="Subject (optional)"
                   value="Re: {{ m.subject or '' }}">
          </div>

          <div class="mb-2">
            <textarea name="body"
                      class="form-control"
                      rows="4"
                      placeholder="Write your reply..."
                      required></textarea>
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-send"></i> Send Reply
            </button>

            <a href="{{ url_for('admin.messages') }}" class="btn btn-outline-secondary">
              Cancel
            </a>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<style>
  .page-narrow { max-width: 980px; margin: 0 auto; }
  .card { border-radius: 12px; }
</style>
{% endblock %}



