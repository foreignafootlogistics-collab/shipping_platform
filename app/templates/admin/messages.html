{% extends "layout_admin.html" %}
{% block title %}Messages{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Admin Messages</h3>
    <a href="{{ url_for('admin.messages') }}" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </a>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="row g-3">
    <!-- Inbox & Sent -->
    <div class="col-lg-6">

      <!-- Inbox -->
      <div class="card mb-3">
        <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
          <span><i class="bi bi-inbox me-2"></i>Inbox</span>

          <!-- Unread toggle -->
          <form method="GET" class="m-0">
            <div class="form-check form-check-inline m-0">
              <input class="form-check-input"
                     type="checkbox"
                     name="unread"
                     value="1"
                     id="unreadOnly"
                     onchange="this.form.submit()"
                     {% if request.args.get('unread') == '1' %}checked{% endif %}>
              <label class="form-check-label text-white" for="unreadOnly">
                Unread only
              </label>
            </div>
          </form>
        </div>

        <!-- Inbox Search -->
        <div class="p-2 border-bottom">
          <input type="text" id="inboxSearch" class="form-control form-control-sm"
                 placeholder="Search inbox (subject, sender, preview)...">
        </div>

        <div class="card-body p-0">
          {% if inbox|length == 0 %}
            <p class="text-muted m-3">No messages.</p>
          {% else %}
            <div class="table-responsive">
              <table id="inboxTable" class="table table-hover table-striped mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width: 22%;">Subject</th>
                    <th style="width: 22%;">From</th>
                    <th>Preview</th>
                    <th style="width: 18%;">Date</th>
                    <th style="width: 10%;">Status</th>
                    <th style="width: 10%;">Action</th>
                  </tr>
                </thead>

                <tbody>
                  {% for m in inbox %}
                  <tr class="inbox-row" style="cursor:pointer"
                      onclick="window.location='{{ url_for('admin.view_message', message_id=m.id) }}'">

                    <td class="fw-semibold">{{ m.subject }}</td>

                    <td>
                      {{ m.sender.full_name if m.sender else "Customer" }}
                      {% if m.sender and m.sender.email %}
                        <div class="text-muted small">{{ m.sender.email }}</div>
                      {% endif %}
                    </td>

                    <td class="text-muted small">
                      {{ (m.body or '')[:70] }}{% if (m.body or '')|length > 70 %}…{% endif %}
                    </td>

                    <td>
                      {{ m.created_at.strftime('%Y-%m-%d %I:%M %p') if m.created_at else "" }}
                    </td>

                    <td>
                      {% if not m.is_read %}
                        <span class="badge bg-primary">Unread</span>
                      {% else %}
                        <span class="badge bg-secondary">Read</span>
                      {% endif %}
                    </td>

                    <td>
                      <a class="btn btn-sm btn-outline-primary"
                         href="{{ url_for('admin.view_message', message_id=m.id) }}"
                         onclick="event.stopPropagation();">
                        Reply
                      </a>
                    </td>

                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Sent -->
      <div class="card mb-3">
        <div class="card-header bg-success text-white fw-bold">
          <i class="bi bi-send me-2"></i>Sent Messages
        </div>

        <!-- Sent Search -->
        <div class="p-2 border-bottom">
          <input type="text" id="sentSearch" class="form-control form-control-sm"
                 placeholder="Search sent (subject, recipient, preview)...">
        </div>

        <div class="card-body p-0">
          {% if sent|length == 0 %}
            <p class="text-muted m-3">No sent messages.</p>
          {% else %}
            <div class="table-responsive">
              <table id="sentTable" class="table table-hover table-striped mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width: 22%;">Subject</th>
                    <th style="width: 22%;">To</th>
                    <th>Preview</th>
                    <th style="width: 18%;">Date</th>
                    <th style="width: 10%;">Action</th>
                  </tr>
                </thead>

                <tbody>
                  {% for m in sent %}
                  <tr style="cursor:pointer"
                      onclick="window.location='{{ url_for('admin.view_message', message_id=m.id) }}'">

                    <td class="fw-semibold">{{ m.subject }}</td>

                    <td>
                      {{ m.recipient.full_name if m.recipient else "Customer" }}
                      {% if m.recipient and m.recipient.email %}
                        <div class="text-muted small">{{ m.recipient.email }}</div>
                      {% endif %}
                    </td>

                    <td class="text-muted small">
                      {{ (m.body or '')[:70] }}{% if (m.body or '')|length > 70 %}…{% endif %}
                    </td>

                    <td>
                      {{ m.created_at.strftime('%Y-%m-%d %I:%M %p') if m.created_at else "" }}
                    </td>

                    <td>
                      <a class="btn btn-sm btn-outline-secondary"
                         href="{{ url_for('admin.view_message', message_id=m.id) }}"
                         onclick="event.stopPropagation();">
                        View
                      </a>
                    </td>

                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>

    </div>

    <!-- Compose / Bulk Message -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header bg-info text-white fw-bold">
          <i class="bi bi-megaphone me-2"></i>Send Bulk Message
        </div>

        <div class="card-body">
          <form method="POST" action="{{ url_for('admin.messages') }}">
            {{ form.hidden_tag() }}

            <div class="mb-3">
              {{ form.subject.label(class="form-label") }}
              {{ form.subject(class="form-control", placeholder="Enter subject") }}
              {% for e in form.subject.errors %}
                <div class="text-danger small">{{ e }}</div>
              {% endfor %}
            </div>

            <div class="mb-3">
              {{ form.message.label(class="form-label") }}
              {{ form.message(class="form-control", rows="5", placeholder="Write your message...") }}
              {% for e in form.message.errors %}
                <div class="text-danger small">{{ e }}</div>
              {% endfor %}
            </div>

            <div class="mb-3">
              <label class="form-label">Recipients</label>

              <!-- Recipients Search -->
              <input type="text" id="recipientSearch" class="form-control mb-2"
                     placeholder="Search customers by name or email...">

              <!-- Select/Deselect -->
              <div class="mb-2 d-flex gap-2 flex-wrap">
                <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllBtn">
                  Select All
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllBtn">
                  Deselect All
                </button>
              </div>

              <!-- Checkbox list -->
              <div style="max-height: 260px; overflow-y:auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                {% for value, label in form.user_ids.choices %}
                  <div class="form-check recipient-item" data-label="{{ label|lower }}">
                    <input
                      class="form-check-input user-checkbox"
                      type="checkbox"
                      name="{{ form.user_ids.name }}"
                      value="{{ value }}"
                      id="u_{{ value }}"
                      {% if value in (form.user_ids.data or []) %}checked{% endif %}
                    >
                    <label class="form-check-label" for="u_{{ value }}">
                      {{ label }}
                    </label>
                  </div>
                {% endfor %}
              </div>

              {% for e in form.user_ids.errors %}
                <div class="text-danger small">{{ e }}</div>
              {% endfor %}
            </div>

            <!-- Buttons -->
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> Send
              </button>
              <button type="reset" class="btn btn-outline-secondary">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Quick tips card -->
      <div class="alert alert-light border mt-3 mb-0">
        <div class="fw-semibold mb-1"><i class="bi bi-lightbulb me-2"></i>Tip</div>
        Use <b>Unread only</b> to focus, or search inbox/sent to find messages fast.
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // -------- Bulk recipients: select/deselect + search --------
  const recipientCheckboxes = document.querySelectorAll(".user-checkbox");
  const selectAllBtn = document.getElementById("selectAllBtn");
  const deselectAllBtn = document.getElementById("deselectAllBtn");

  if (selectAllBtn) {
    selectAllBtn.addEventListener("click", () => {
      recipientCheckboxes.forEach(cb => cb.checked = true);
    });
  }

  if (deselectAllBtn) {
    deselectAllBtn.addEventListener("click", () => {
      recipientCheckboxes.forEach(cb => cb.checked = false);
    });
  }

  const recipientSearch = document.getElementById("recipientSearch");
  const recipientItems = document.querySelectorAll(".recipient-item");

  if (recipientSearch) {
    recipientSearch.addEventListener("input", () => {
      const q = recipientSearch.value.toLowerCase().trim();
      recipientItems.forEach(item => {
        const text = item.getAttribute("data-label") || "";
        item.style.display = text.includes(q) ? "" : "none";
      });
    });
  }

  // -------- Inbox search (client-side) --------
  const inboxSearch = document.getElementById("inboxSearch");
  const inboxRows = document.querySelectorAll("#inboxTable tbody tr");

  if (inboxSearch) {
    inboxSearch.addEventListener("input", () => {
      const q = inboxSearch.value.toLowerCase().trim();
      inboxRows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(q) ? "" : "none";
      });
    });
  }

  // -------- Sent search (client-side) --------
  const sentSearch = document.getElementById("sentSearch");
  const sentRows = document.querySelectorAll("#sentTable tbody tr");

  if (sentSearch) {
    sentSearch.addEventListener("input", () => {
      const q = sentSearch.value.toLowerCase().trim();
      sentRows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(q) ? "" : "none";
      });
    });
  }
});
</script>
{% endblock %}
