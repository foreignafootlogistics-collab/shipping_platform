{% extends "layout_admin.html" %}
{% block title %}Notifications{% endblock %}

{% block content %}
<div class="container mt-4">
  {# If your .page-narrow is too tight, this override makes it wider on this page only #}
  <style>
    .page-narrow { max-width: 1200px; }
    .note-meta { font-size: .86rem; color: #6b7280; }
    .badge-pill { border-radius: 999px; padding: .35rem .6rem; font-weight: 600; }
  </style>

  <div class="page-narrow">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="mb-0">Notifications</h3>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('admin.view_notifications') }}">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="row g-4">

      <!-- LEFT: Broadcast log (WIDER) -->
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header text-white py-3" style="background:#4A148C;">
            <div class="d-flex align-items-center justify-content-between">
              <div class="fw-bold">
                <i class="bi bi-broadcast me-2"></i> Broadcast History
              </div>
              <span class="badge badge-pill" style="background:#111827;">No Reply</span>
            </div>
          </div>

          <div class="card-body p-0">
            {% if notes|length == 0 %}
              <p class="text-muted m-4 mb-0">No broadcasts yet.</p>
            {% else %}
              <ul class="list-group list-group-flush">
                {% for n in notes %}
                <li class="list-group-item p-4 d-flex justify-content-between align-items-start gap-3">
                  <div class="flex-grow-1">

                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <div class="fw-semibold text-dark" style="font-size:1.05rem;">
                        {{ n.subject }}
                      </div>
                      <span class="badge badge-pill" style="background:#111827;">Broadcast</span>

                      {# Read/unread badge (for admin view) #}
                      {% if not n.is_read %}
                        <span class="badge badge-pill" style="background:#FACC15; color:#111827;">
                          <i class="bi bi-exclamation-circle me-1"></i> Unread
                        </span>
                      {% else %}
                        <span class="badge badge-pill" style="background:#15803D; color:#fff;">
                          <i class="bi bi-check2-circle me-1"></i> Read
                        </span>
                      {% endif %}
                    </div>

                    <div class="mt-2 text-muted">
                      {{ n.message }}
                    </div>

                    <div class="note-meta mt-2 d-flex align-items-center gap-2 flex-wrap">
                      {# Relative time helper. Needs timezone-aware created_at (you have that). #}
                      {% set diff = (datetime.utcnow().replace(tzinfo=n.created_at.tzinfo) - n.created_at) if n.created_at else None %}
                      {% if diff %}
                        {% set secs = diff.total_seconds() %}
                        {% if secs < 60 %}
                          <span><i class="bi bi-clock me-1"></i>just now</span>
                        {% elif secs < 3600 %}
                          <span><i class="bi bi-clock me-1"></i>{{ (secs // 60)|int }} min ago</span>
                        {% elif secs < 86400 %}
                          <span><i class="bi bi-clock me-1"></i>{{ (secs // 3600)|int }} hr ago</span>
                        {% else %}
                          <span><i class="bi bi-clock me-1"></i>{{ (secs // 86400)|int }} day{% if (secs // 86400)|int != 1 %}s{% endif %} ago</span>
                        {% endif %}
                      {% endif %}

                      <span>•</span>
                      <span>
                        {{ n.created_at.strftime('%Y-%m-%d %I:%M %p') if n.created_at else "" }}
                      </span>

                      {# Delivered count (how many rows share this broadcast signature) #}
                      {# Assumes you pass delivered_map from route; if not, it will show "—" #}
                      {% set delivered = delivered_map.get(n.id) if delivered_map is defined else None %}
                      <span>•</span>
                      <span class="fw-semibold">
                        Delivered to {{ delivered if delivered is not none else "—" }} customers
                      </span>
                    </div>
                  </div>

                  {% if not n.is_read %}
                  <form method="POST" action="{{ url_for('admin.mark_notification_read', nid=n.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-outline-secondary">
                      Mark read
                    </button>
                  </form>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- RIGHT: Send broadcast (BIGGER + STRONGER) -->
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-header text-white fw-bold py-3" style="background:#111827;">
            <i class="bi bi-megaphone me-2"></i> Send Broadcast (No Reply)
          </div>
          <div class="card-body p-4">
            <form method="POST" action="{{ url_for('admin.view_notifications') }}">
              {{ form.hidden_tag() }}

              <div class="mb-3">
                {{ form.subject.label(class="form-label") }}
                {{ form.subject(class="form-control", placeholder="Subject (e.g. Service Update)") }}
                {% for e in form.subject.errors %}
                  <div class="text-danger small">{{ e }}</div>
                {% endfor %}
              </div>

              <div class="mb-3">
                {{ form.message.label(class="form-label") }}
                {{ form.message(class="form-control", rows="10", placeholder="Type announcement for all customers (max 255 chars)...") }}
                {% for e in form.message.errors %}
                  <div class="text-danger small">{{ e }}</div>
                {% endfor %}

                <div class="small text-muted mt-2">
                  Sends to all customers as a notification (no reply option).
                </div>
              </div>

              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-lg" style="background:#4A148C; color:#fff;">
                  <i class="bi bi-send"></i> Send
                </button>
                <button type="reset" class="btn btn-lg btn-outline-secondary">Cancel</button>
              </div>
            </form>
          </div>
        </div>

        <div class="mt-3 p-3 rounded-3" style="background:#fff; border:1px solid #e5e7eb;">
          <div class="small text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Tip: Use notifications for announcements, service updates, warehouse changes, holiday hours, etc.
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}
