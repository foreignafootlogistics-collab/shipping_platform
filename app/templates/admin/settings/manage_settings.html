{# templates/admin/settings/manage_settings.html #}
{% extends 'layout_admin.html' %}
{% block title %}Manage Settings{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  :root { --brand:#4a148c; }
  .help { font-size:.85rem; color:#6c757d; }
  .shadow-soft { box-shadow: 0 6px 16px rgba(0,0,0,.05); }
  .card-hint { background:#f7f4fb; border-left:4px solid var(--brand); }
</style>

<div class="container mt-4">
  <h2 class="mb-4">Manage Settings</h2>

  {# Flash messages #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {# Tabs #}
  <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="company-tab" data-bs-toggle="tab" data-bs-target="#companyInfo" type="button" role="tab">
        Company Info
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="rates-tab" data-bs-toggle="tab" data-bs-target="#ratesFees" type="button" role="tab">
        Rates & Fees
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="branches-tab" data-bs-toggle="tab" data-bs-target="#branchesLocations" type="button" role="tab">
        Branches & Locations
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="terms-tab" data-bs-toggle="tab" data-bs-target="#termsServices" type="button" role="tab">
        Terms & Services
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="display-tab" data-bs-toggle="tab" data-bs-target="#display" type="button" role="tab">
        <i class="bi bi-palette me-1"></i> Display & Formats
      </button>
    </li>
  </ul>

  {# Tab Contents #}
  <div class="tab-content mt-3" id="settingsTabsContent">

    {# ---------------- Company Info ---------------- #}
    <div class="tab-pane fade show active" id="companyInfo" role="tabpanel" aria-labelledby="company-tab">
      <div class="card shadow-soft mb-4">
        <div class="card-body">
          <div class="card card-hint mb-3">
            <div class="card-body py-2">
              <i class="bi bi-info-circle me-2"></i>
              These details appear on invoices, receipts, emails, and the admin sidebar.
            </div>
          </div>

          <div class="row g-3 align-items-center mb-3">
            <div class="col-auto">
              <div class="border rounded p-2 bg-white shadow-sm" style="width:140px;height:140px;display:flex;align-items:center;justify-content:center;">
                {% if settings and settings.logo_path %}
                  <img id="logoPreview" src="{{ url_for('static', filename=settings.logo_path) }}" alt="Logo" style="max-width:100%;max-height:100%;">
                {% else %}
                  <img id="logoPreview" src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="max-width:100%;max-height:100%;">
                {% endif %}
              </div>
            </div>
            <div class="col">
              <form method="post" action="{{ url_for('settings.update_logo') }}" enctype="multipart/form-data" class="d-flex gap-2">
                <input class="form-control" type="file" name="logo_file" accept=".png,.jpg,.jpeg,.gif,.svg,.webp" id="logoInput">
                <button class="btn btn-outline-primary"><i class="bi bi-upload me-1"></i>Upload Logo</button>
              </form>
              <div class="help mt-1">PNG or SVG recommended. Shown in sidebar, invoices and receipts.</div>
            </div>
          </div>

          <form method="POST" action="{{ url_for('settings.update_company_info') }}" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Company Name</label>
              <input type="text" class="form-control" name="company_name" value="{{ settings.company_name if settings else '' }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Contact Email</label>
              <input type="email" class="form-control" name="company_email" value="{{ settings.company_email if settings else '' }}" required>
            </div>
            <div class="col-12">
              <label class="form-label">Address</label>
              <textarea class="form-control" name="company_address" rows="2">{{ settings.company_address if settings else '' }}</textarea>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> Save Company Info</button>
              <button type="reset" class="btn btn-outline-secondary"><i class="bi bi-arrow-counterclockwise me-1"></i> Reset</button>
            </div>
          </form>
        </div>
        <form action="{{ url_for('settings.update_us_address') }}" method="POST" class="card mt-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="card-header" style="background-color:#4a148c; color:white;">
            <strong>US Warehouse Address</strong>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Street</label>
              <input type="text"
                     name="us_street"
                     class="form-control"
                     value="{{ settings.us_street or '' }}"
                     placeholder="3200 NW 112th Avenue">
            </div>

            <div class="mb-3">
              <label class="form-label">Suite Prefix (before Reg #)</label>
              <input type="text"
                     name="us_suite_prefix"
                     class="form-control"
                     value="{{ settings.us_suite_prefix or '' }}"
                     placeholder="KCDA-FAFL# ">
              <small class="text-muted">
                Example rendering: <code>{{ settings.us_suite_prefix or 'KCDA-FAFL# ' }}{{ '{REG#}' }}</code>
              </small>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">City</label>
                <input type="text"
                       name="us_city"
                       class="form-control"
                       value="{{ settings.us_city or '' }}"
                       placeholder="Doral">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">State</label>
                <input type="text"
                       name="us_state"
                       class="form-control"
                       value="{{ settings.us_state or '' }}"
                       placeholder="Florida">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">ZIP</label>
                <input type="text"
                       name="us_zip"
                       class="form-control"
                       value="{{ settings.us_zip or '' }}"
                       placeholder="33172">
              </div>
            </div>
          </div>
          <div class="card-footer text-end">
            <button type="submit" class="btn" style="background-color:#4a148c; color:white;">
              Save US Address
            </button>
          </div>
        </form>
      </div>
    </div>
    
    {# ---------------- Rates & Fees ---------------- #}
    <div class="tab-pane fade" id="ratesFees" role="tabpanel" aria-labelledby="rates-tab">
      <div class="card shadow-soft mb-4">
        <div class="card-body">

          <form method="POST" action="{{ url_for('settings.update_rates') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="card card-hint mb-3">
              <div class="card-body py-2 small">
                <i class="bi bi-calculator me-2"></i>
                Configure your freight brackets and customs / duty rules used by the calculator.
              </div>
            </div>

            <!-- Inner tabs: Freight / Customs -->
            <ul class="nav nav-tabs mb-3">
              <li class="nav-item">
                <button class="nav-link active"
                        type="button"
                        data-bs-toggle="tab"
                        data-bs-target="#tab-freight">
                  Freight
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link"
                        type="button"
                        data-bs-toggle="tab"
                        data-bs-target="#tab-customs">
                  Customs/Duty
                </button>
              </li>
            </ul>

            <div class="tab-content">

              {# ===== FREIGHT TAB ===== #}
              <div class="tab-pane fade show active" id="tab-freight">
                <div class="row g-3 mb-3">
                  <!-- keep your simple base / handling here too -->
                  <div class="col-md-4">
                    <label class="form-label small">Base Rate (JMD / lb)</label>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text">JMD</span>
                      <input type="number" step="0.01"
                             class="form-control"
                             name="base_rate"
                             value="{{ settings.base_rate or 0 }}">
                    </div>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label small">Handling Fee (JMD)</label>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text">JMD</span>
                      <input type="number" step="0.01"
                             class="form-control"
                             name="handling_fee"
                             value="{{ settings.handling_fee or 0 }}">
                    </div>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label small">Special Bill freight Below 1lb (JMD)</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="special_below_1lb_jmd"
                           value="{{ settings.special_below_1lb_jmd or 0 }}">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label small">JMD Charge Per 0.1 lb Below 1lb</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="per_0_1lb_below_1lb_jmd"
                           value="{{ settings.per_0_1lb_below_1lb_jmd or 0 }}">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label small">Minimum Billable Weight</label>
                    <input type="number"
                           class="form-control form-control-sm"
                           name="min_billable_weight"
                           value="{{ settings.min_billable_weight or 1 }}">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label small">Weight Rounding Method</label>
                    <select name="weight_round_method" class="form-select form-select-sm">
                      <option value="round_up"
                        {% if settings.weight_round_method == 'round_up' %}selected{% endif %}>
                        Always Round Up
                      </option>
                      <option value="nearest"
                        {% if settings.weight_round_method == 'nearest' %}selected{% endif %}>
                        Nearest Pound
                      </option>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">JMD Per Lb rate above 100Lbs</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="per_lb_above_100_jmd"
                           value="{{ settings.per_lb_above_100_jmd or 0 }}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">JMD Handling Fee above 100Lbs</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="handling_above_100_jmd"
                           value="{{ settings.handling_above_100_jmd or 0 }}">
                  </div>
                </div>

                <!-- Per-lb brackets 1–50 -->
                <div class="table-responsive">
                  <table class="table table-sm table-striped align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Pounds</th>
                        <th>Kilograms</th>
                        <th>Freight Charge (JMD)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for r in admin_rates %}
                      <tr>
                        <td>{{ r.max_weight }}</td>
                        <td>{{ (r.max_weight * 0.454)|round(2) }}</td>
                        <td>
                          <input type="number" step="0.01"
                                 class="form-control form-control-sm text-end"
                                 name="rate_{{ r.max_weight }}"
                                 value="{{ r.rate or 0 }}">
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>

              {# ===== CUSTOMS / DUTY TAB ===== #}
              <div class="tab-pane fade" id="tab-customs">

                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox"
                         id="customs_enabled"
                         name="customs_enabled"
                         {% if settings.customs_enabled %}checked{% endif %}>
                  <label class="form-check-label" for="customs_enabled">
                    Customs Duty Enabled
                  </label>
                </div>

                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label small">Customs Exchange Rate</label>
                    <input type="number" step="0.0001"
                           class="form-control form-control-sm"
                           name="customs_exchange_rate"
                           value="{{ settings.customs_exchange_rate or settings.usd_to_jmd or 165 }}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Customs Diminimis Point (USD)</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="diminis_point_usd"
                           value="{{ settings.diminis_point_usd or 100 }}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">GCT 25 (%)</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="gct_25_rate"
                           value="{{ settings.gct_25_rate or 25 }}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">GCT 15 (%)</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="gct_15_rate"
                           value="{{ settings.gct_15_rate or 15 }}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Customs CAF Residential (JMD)</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="caf_residential_jmd"
                           value="{{ settings.caf_residential_jmd or 2500 }}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Customs CAF Commercial (JMD)</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="caf_commercial_jmd"
                           value="{{ settings.caf_commercial_jmd or 5000 }}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Default Duty Rate (%)</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="default_duty_rate"
                           value="{{ settings.default_duty_rate or 20 }}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Customs Insurance Rate (%)</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="insurance_rate"
                           value="{{ settings.insurance_rate or 1 }}">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label small">Customs SCF Rate (%)</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="scf_rate"
                           value="{{ settings.scf_rate or 0.3 }}">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label small">Customs ENVL Rate (%)</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="envl_rate"
                           value="{{ settings.envl_rate or 0.5 }}">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label small">Stamp Duty (JMD)</label>
                    <input type="number" step="0.01"
                           class="form-control form-control-sm"
                           name="stamp_duty_jmd"
                           value="{{ settings.stamp_duty_jmd or 100 }}">
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-3 d-flex justify-content-between align-items-center">
              <a class="btn btn-outline-secondary btn-sm"
                 href="{{ url_for('admin.view_rates') }}">
                <i class="bi bi-table me-1"></i> View Rate Table
              </a>

              <button type="submit" class="btn btn-purple">
                <i class="bi bi-check2-circle me-1"></i> Save Rates
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>

    {# -------------- Branches & Locations -------------- #}
    <div class="tab-pane fade" id="branchesLocations" role="tabpanel" aria-labelledby="branches-tab">
      <div class="card shadow-soft mb-4">
        <div class="card-body">
          <div class="card card-hint mb-3">
            <div class="card-body py-2">
              <i class="bi bi-geo-alt me-2"></i>
              Keep one branch per line. Example: <code>Kingston HQ — 12 Port Lane, (876) 955-0123</code>
            </div>
          </div>

          <form method="POST" action="{{ url_for('settings.update_branches') }}">
            <label class="form-label">Branches</label>
            <textarea class="form-control" name="branches" rows="6" placeholder="Kingston HQ — 12 Port Lane, (876) 955-0123&#10;Montego Bay — ...">{{ settings.branches if settings else '' }}</textarea>
            <div class="d-flex gap-2 mt-3">
              <button type="submit" class="btn btn-info text-white"><i class="bi bi-check2-circle me-1"></i> Save Branches & Locations</button>
              <button type="reset" class="btn btn-outline-secondary"><i class="bi bi-arrow-counterclockwise me-1"></i> Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {# ---------------- Terms & Services ---------------- #}
    <div class="tab-pane fade" id="termsServices" role="tabpanel" aria-labelledby="terms-tab">
      <div class="card shadow-soft mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-lg-6">
              <form method="post" action="{{ url_for('settings.update_terms') }}">
                <label class="form-label">Terms & Services</label>
                <textarea id="termsInput" class="form-control autosize" name="terms" rows="12"
                          placeholder="Enter your standard shipping terms, payment terms, insurance policy, prohibited items, etc.">{{ settings.terms if settings else '' }}</textarea>
                <div class="d-flex gap-2 mt-3">
                  <button class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> Save Terms</button>
                  <button class="btn btn-outline-secondary" type="reset"><i class="bi bi-arrow-counterclockwise me-1"></i> Reset</button>
                  <button type="button" id="previewBtn" class="btn btn-outline-dark">
                    <i class="bi bi-eye me-1"></i> Preview
                  </button>
                </div>
              </form>
            </div>
            <div class="col-lg-6">
              <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <strong>Live Preview</strong>
                  <span class="small text-muted">Rendered HTML</span>
                </div>
                <div id="termsPreview" class="card-body" style="min-height: 280px; overflow:auto;">
                  <!-- preview content appears here -->
                </div>
              </div>
            </div>
          </div> <!-- /row -->
        </div>
      </div>
    </div>

    {# -------------- Display & Formats -------------- #}
    <div class="tab-pane fade" id="display" role="tabpanel" aria-labelledby="display-tab">
      <div class="card shadow-soft mb-4">
        <div class="card-body">
          <div class="card card-hint mb-3">
            <div class="card-body py-2">
              <i class="bi bi-gear me-2"></i>
              Choose default currency & date format for admin/customer UIs & PDFs.
            </div>
          </div>

          <form method="post" action="{{ url_for('settings.update_display') }}" class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Currency Code</label>
              <input type="text" class="form-control" name="currency_code"
                     value="{{ settings.currency_code if settings else 'USD' }}" placeholder="USD / JMD">
            </div>
            <div class="col-md-3">
              <label class="form-label">Currency Symbol</label>
              <input type="text" class="form-control" name="currency_symbol"
                     value="{{ settings.currency_symbol if settings else '$' }}" placeholder="$ / J$">
            </div>
            <div class="col-md-3">
              <label class="form-label">USD → JMD Rate</label>
              <div class="input-group">
                <span class="input-group-text">1 USD =</span>
                <input type="number" step="0.0001" class="form-control" name="usd_to_jmd"
                       value="{{ settings.usd_to_jmd if settings else 155 }}">
                <span class="input-group-text">JMD</span>
              </div>
              <div class="help mt-1">Used by toggles on dashboards (display only).</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Date Format</label>
              <input type="text" class="form-control" name="date_format"
                     value="{{ settings.date_format if settings else '%Y-%m-%d' }}" placeholder="%Y-%m-%d">
              <div class="help mt-1">Python/strftime format (e.g., %d %b %Y).</div>
            </div>

            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> Save Display</button>
            </div>
          </form>

        </div>
      </div>
    </div>

  </div> {# /tab-content #}

</div> {# /container #}
{% endblock %}

{% block scripts %}
<script>
  // Logo live preview
  const logoInput = document.getElementById('logoInput');
  if (logoInput) {
    logoInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const img = document.getElementById('logoPreview');
      if (img) img.src = url;
    });
  }

  // Terms live preview (naive; for admin only)
  const termsInput  = document.getElementById('termsInput');
  const termsPreview= document.getElementById('termsPreview');
  const previewBtn  = document.getElementById('previewBtn');
  function renderTerms(){ if(termsPreview && termsInput){ termsPreview.innerHTML = termsInput.value; } }
  if (previewBtn){ previewBtn.addEventListener('click', renderTerms); }
  renderTerms();

  // (Optional) remember active tab
  const key='faf_settings_tab';
  const tabs = document.querySelectorAll('#settingsTabs button[data-bs-toggle="tab"]');
  tabs.forEach(btn=>{
    btn.addEventListener('shown.bs.tab', e => localStorage.setItem(key, e.target.getAttribute('data-bs-target')));
  });
  const saved = localStorage.getItem(key);
  if(saved){
    const t = document.querySelector(`#settingsTabs button[data-bs-target="${saved}"]`);
    if(t){ new bootstrap.Tab(t).show(); }
  }

  // Autosize textareas
  function autosize(el){ el.style.height='auto'; el.style.height = (el.scrollHeight)+'px'; }
  document.querySelectorAll('.autosize').forEach(t=>{ autosize(t); t.addEventListener('input',()=>autosize(t)); });
</script>
{% endblock %}

<style>
  .btn-purple{ background:#4a148c; color:#fff; }
  .btn-purple:hover{ background:#3b0f70; color:#fff; }
</style>

