{% extends 'layout_customer.html' %}
{% block title %}Customer Dashboard - Foreign A Foot Logistics{% endblock %}

{% block content %}
<div class="container main-dashboard">

  <!-- Greeting -->
  <div class="dashboard-greeting mb-3">
    <h4 class="mb-0">Welcome, {{ user.full_name }} ({{ user.registration_number }})</h4>
  </div>

  <!-- Profile & Shipping -->
  <div class="row dashboard-section">
    
    <!-- My Profile -->
    <div class="col-lg-6 mb-3">
      <div class="card-box profile-card-container h-100">
        <div class="top-bar-heading">My Profile</div>
        <div class="profile-card">

          <!-- Profile Avatar -->
          <div class="profile-avatar text-center">
            {% if profile_picture %}
             <img src="{{ url_for('static', filename='profile_pics/' + profile_picture) }}" 
                  alt="Profile Picture" 
                  class="img-fluid rounded-circle mb-2">
          {% else %}
            {% set colors = ['#FFEB3B', '#4CAF50'] %} {# yellow and green #}
            {% set color_index = current_user.id % 2 %}
            <div class="rounded-circle mb-2 d-flex align-items-center justify-content-center profile-initials-avatar"
                style="
                  width:100px; 
                  height:100px; 
                  font-weight:bold; 
                  font-size:2rem; 
                  color:#000; 
                  background-color: {{ colors[color_index] }};
                  border: 3px solid #4a148c; /* purple border to tie in theme */
                  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
                  cursor: pointer;
       ">
              {{ current_user.full_name[:1]|upper }}{{ current_user.full_name.split(' ')[-1][:1]|upper }}
            </div>
          {% endif %}

         <form action="{{ url_for('customer.upload_profile_pic') }}" method="POST" enctype="multipart/form-data">
           <input type="file" name="profile_pic" accept="image/*" class="form-control form-control-sm mb-2" required>
           <button type="submit" class="btn btn-dashboard w-100">Upload</button>
         </form>
       </div>


          <!-- Profile Details -->
          <div class="profile-details mt-3">
            <div class="profile-row">
              <div class="label">Name</div>
              <div class="value">{{ user[0] }}</div>
            </div>

            <div class="profile-row">
              <div class="label">Email</div>
              <div class="value">{{ user[1] }}</div>
            </div>

            <div class="profile-row">
              <div class="label">Mobile</div>
              <div class="value">{{ user[2] }}</div>
            </div>

            <div class="profile-row">
              <div class="label">Registration</div>
              <div class="value">{{ user[3] }}</div>
            </div>

            <div class="mt-3 d-flex align-items-center">
              <label class="label me-2 mb-0">Referral Code:</label>
              <span class="badge referral-code-badge" id="referralCode">{{ referral_code }}</span>
              <button class="btn btn-dashboard-outline ms-2" title="Copy Code" onclick="copyReferralCode()">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Shipping Address -->
    <div class="col-lg-6 mb-3">
      <div class="card-box shipping-card h-100 p-3 border rounded shadow-sm bg-white">

        <!-- Top Bar -->
        <div class="top-bar d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
          <div class="fw-bold" style="color:#4a148c;">Addresses</div>
          <div class="d-flex gap-2">
            <button id="overseas-btn" class="btn btn-sm btn-dasboard" title="Overseas Address">
              <i class="fas fa-globe"></i>
            </button>
            <button id="home-btn" class="btn btn-sm btn-outline-secondary" title="Home Address">
              <i class="fas fa-home"></i>
            </button>
          </div>
        </div>

        <!-- Overseas Address -->
        <div id="overseas-address" class="overseas-address-grid">
          <div>
            <div class="label fw-bold text-muted">Recipient</div>
            <div class="value">{{ us_address.recipient }}</div>

            <div class="label fw-bold text-muted mt-2">Street</div>
            <div class="value">{{ us_address.address_line1 }}</div>
          </div>
          <div>
            <div class="label fw-bold text-muted">Suite</div>
            <div class="value">{{ us_address.address_line2 }}</div>

            <div class="label fw-bold text-muted mt-2">City/State/ZIP</div>
            <div class="value">{{ us_address.city }}, {{ us_address.state }} {{ us_address.zip }}</div>
          </div>
        </div>

        <!-- Home Address -->
        <div id="home-address" style="display:none;">
          <div class="label fw-bold text-muted mb-2">Home Address</div>
          <div class="value mb-3">
            {{ home_address if home_address else "Not set" }}
          </div>
          <a href="{{ url_for('customer.update_delivery_address') }}" class="btn btn-dashboard-outline btn-sm">
            <i class="fas fa-edit"></i> Edit
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row dashboard-section quick-stats">
    <div class="col-md-3 mb-3">
      <div class="stat">
        <h3>{{ overseas_packages }}</h3>
        <span>Overseas</span>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="stat">
        <h3>{{ ready_to_pickup }}</h3>
        <span>Ready to Pick Up</span>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="stat">
        <h3>{{ total_shipped }}</h3>
        <span>Total Shipped</span>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="stat">
        <h3>${{ "%.2f"|format(wallet_balance) }}</h3>
        <span>Wallet Balance</span>
      </div>
    </div>
  </div>

  <!-- Ready for Pick Up Packages -->
<div class="dashboard-section">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h3>READY PACKAGES</h3>
    <a href="{{ url_for('customer.schedule_delivery_overview') }}" class="btn btn-dashboard btn-sm">
      Schedule Delivery
    </a>
  </div>

  <div class="ready-packages">
    <table class="table table-hover table-striped">
      <thead class="table-dark">
        <tr>
          <th>House AWB / Status</th>
          <th>Description</th>
          <th>Tracking Number</th>
          <th>Weight</th>
          <th>Received Date</th>
          <th>Amount Due</th>
        </tr>
      </thead>
      <tbody>
        {% if ready_packages %}
          {% for pkg in ready_packages %}
            <tr>
              <td>
                {{ pkg.house_awb }}<br>
                <small class="text-muted">Status: {{ pkg.status }}</small>
              </td>
              <td>{{ pkg.description }}</td>
              <td>{{ pkg.tracking_number }}</td>
              <td>{{ pkg.weight }}</td>
              <td>{{ pkg.received_date }}</td>
              <td>${{ "%.2f"|format(pkg.amount_due) }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="6" class="text-center">No packages ready for pick up.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>


<!-- Toggle & Copy & Calculator Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Toggle Addresses
  const overseasBtn = document.getElementById("overseas-btn");
  const homeBtn = document.getElementById("home-btn");
  const overseasAddress = document.getElementById("overseas-address");
  const homeAddress = document.getElementById("home-address");

  overseasBtn.addEventListener("click", function () {
    overseasAddress.style.display = "grid";
    homeAddress.style.display = "none";
  });
  homeBtn.addEventListener("click", function () {
    overseasAddress.style.display = "none";
    homeAddress.style.display = "block";
  });

  // Copy Referral Code
  const copyBtn = document.getElementById("copyReferralBtn");
  if(copyBtn){
    copyBtn.addEventListener("click", function(){
      const code = document.getElementById("referralCode").innerText;
      navigator.clipboard.writeText(code).then(() => alert("Referral code copied!"));
    });
  }

  
});
</script>

<style>
.dashboard-greeting {
  font-weight: 600;
  font-size: 1.2rem;
  margin-left: 10px;
}

/* Profile details inline label-value pairs */
.profile-row {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid #ddd;
  align-items: center;
}

.label {
  font-weight: 600;
  color: #555;
  min-width: 130px;
}

.value {
  flex-grow: 1;
  color: #333;
  text-align: left;
  word-wrap: break-word;
}

.profile-initials-avatar {
  transition: transform 0.3s ease, box-shadow 0.3s ease, filter 0.3s ease;
}

.profile-initials-avatar:hover {
  transform: scale(1.1);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  filter: brightness(1.1);
}

</style>
{% endblock %}