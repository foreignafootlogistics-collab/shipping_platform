{# app/templates/customer/customer_packages.html #}
{% extends "layout_customer.html" %}
{% block title %}My Packages{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/status.css') }}">

<div class="container mt-4">
  <h2 class="mb-4">My Packages</h2>

  {# Flash messages #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {# Filter #}
  <form method="get" action="{{ url_for('customer.view_packages') }}" class="row g-2 mb-3">
    <div class="col-md-2">
      <input type="text" name="tracking_number" value="{{ tracking_number }}" class="form-control" placeholder="Tracking #">
    </div>
    <div class="col-md-2">
      <select name="status" class="form-control">
        <option value="">All Status</option>
        <option value="Overseas" {% if status_filter=='Overseas' %}selected{% endif %}>Overseas</option>
        <option value="Ready for Pick Up" {% if status_filter=='Ready for Pick Up' %}selected{% endif %}>Ready for Pick Up</option>
        <option value="Delivered" {% if status_filter=='Delivered' %}selected{% endif %}>Delivered</option>
      </select>
    </div>
    <div class="col-md-2">
      <input type="date" name="date_from" value="{{ date_from }}" class="form-control">
    </div>
    <div class="col-md-2">
      <input type="date" name="date_to" value="{{ date_to }}" class="form-control">
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-dashboard w-100">Filter</button>
    </div>
  </form>

  {# Table #}
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th style="width:60px;" class="text-center">Docs</th>
          <th>House AWB / Status</th>
          <th>Description</th>
          <th>Tracking Number</th>
          <th class="text-center">Weight (LBS)</th>
          <th class="text-center">Date Received</th>
          <th class="text-center">Amount Due</th>
        </tr>
      </thead>

      <tbody>
        {% for pkg in packages %}
        <tr>
          {# Docs (modal trigger) #}
          <td class="text-center align-middle">
            <button type="button"
                    class="btn btn-sm btn-outline-secondary"
                    data-bs-toggle="modal"
                    data-bs-target="#docsModal{{ pkg.id }}"
                    title="Upload Invoices / Declared Value">
              <i class="fas fa-file-upload"></i>
            </button>

            {% if pkg.attachments and pkg.attachments|length > 0 %}
              <i class="fas fa-paperclip text-success ms-1" title="Attachments available"></i>
            {% endif %}
          </td>

          {# House AWB / Status + VAL line #}
          <td>
            {{ pkg.house_awb or "-" }}

            {% set s = (pkg.status or '') %}
            <div class="progress mt-1">
              {% if s == 'Overseas' %}
                <div class="progress-bar bg-danger" style="width:33.33%"></div>
              {% elif s == 'Ready for Pick Up' %}
                <div class="progress-bar bg-primary" style="width:66.66%"></div>
              {% elif s == 'Delivered' %}
                <div class="progress-bar bg-success" style="width:100%"></div>
              {% else %}
                <div class="progress-bar bg-secondary" style="width:20%"></div>
              {% endif %}
            </div>

            <small class="text-muted d-block">{{ s }}</small>

            {% set dv = (pkg.declared_value if pkg.declared_value is not none else 65) %}
            <div class="small text-muted mt-1">VAL: ${{ "%.2f"|format(dv) }}</div>
          </td>

          {# Description + attachment links #}
          <td>
            {{ pkg.description or "-" }}

            {% if pkg.attachments and pkg.attachments|length > 0 %}
              <div class="small mt-1">
                {% for a in pkg.attachments %}
                  <a class="me-2"
                     target="_blank"
                     href="{{ url_for('static', filename='invoices/' ~ a.file_name) }}">
                    <i class="fas fa-paperclip"></i> Doc {{ loop.index }}
                  </a>
                {% endfor %}
              </div>
            {% endif %}
          </td>

          <td>{{ pkg.tracking_number or "-" }}</td>

          <td class="text-center">
            {% if pkg.weight is not none %}
              {{ (pkg.weight|float)|round(0,'ceil')|int }}
            {% else %}
              —
            {% endif %}
          </td>

          <td class="text-center">
            {% if pkg.received_date %}
              {{ pkg.received_date.strftime("%Y-%m-%d") }}
            {% else %}
              —
            {% endif %}
          </td>

          <td class="text-center">
            {% if (pkg.status or '') == 'Ready for Pick Up' %}
              {{ (pkg.amount_due or 0)|jmd }}
            {% else %}
              {{ 0|jmd }}
            {% endif %}
          </td>
        </tr>

        {# =========================
           Modal (MUST be inside loop)
           ========================= #}
        <div class="modal fade" id="docsModal{{ pkg.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <form method="POST"
                    enctype="multipart/form-data"
                    action="{{ url_for('customer.package_upload_docs', pkg_id=pkg.id) }}">
                {{ form.csrf_token }}

                <div class="modal-header">
                  <h5 class="modal-title">Upload Invoices / Declared Value</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Declared Value (USD)</label>
                      <input class="form-control"
                             type="number"
                             name="declared_value"
                             step="0.01"
                             min="0"
                             value="{{ pkg.declared_value if pkg.declared_value is not none else 65 }}">
                      <div class="form-text">This updates the “VAL: $xx.xx” shown under status.</div>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Invoice File 1</label>
                      <input class="form-control" type="file" name="invoice_file_1" accept=".pdf,.jpg,.jpeg,.png">

                      <label class="form-label mt-2">Invoice File 2</label>
                      <input class="form-control" type="file" name="invoice_file_2" accept=".pdf,.jpg,.jpeg,.png">

                      <label class="form-label mt-2">Invoice File 3</label>
                      <input class="form-control" type="file" name="invoice_file_3" accept=".pdf,.jpg,.jpeg,.png">
                    </div>

                    <div class="col-12">
                      <div class="fw-semibold mb-1">Existing Attachments</div>
                      {% if pkg.attachments and pkg.attachments|length > 0 %}
                        <ul class="mb-0">
                          {% for a in pkg.attachments %}
                            <li>
                              <a target="_blank" href="{{ url_for('static', filename='invoices/' ~ a.file_name) }}">
                                {{ a.original_name or a.file_name }}
                              </a>
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <div class="text-muted">No attachments yet.</div>
                      {% endif %}
                    </div>

                  </div>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary">Save</button>
                </div>

              </form>
            </div>
          </div>
        </div>
        {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted">No packages found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# Pagination #}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link"
             href="?page={{ p }}&status={{ status_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&tracking_number={{ tracking_number }}">
            {{ p }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </nav>
</div>
{% endblock %}

