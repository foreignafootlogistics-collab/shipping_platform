{# app/templates/customer/customer_packages.html #}
{% extends "layout_customer.html" %}
{% block title %}My Packages{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/status.css') }}">

<div class="container mt-4">

  <!-- Header row: title left, show dropdown right -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">My Packages</h2>

    <!-- Show dropdown (like Transactions) -->
    <form method="get" action="{{ url_for('customer.view_packages') }}" class="d-flex align-items-center gap-2">
      <span class="small text-muted mb-0">Show</span>

      <select name="per_page"
              class="form-select form-select-sm"
              style="width:110px;"
              onchange="this.form.submit()">
        {% for n in [10,25,50,100,500] %}
          <option value="{{ n }}" {% if per_page|int == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>

      {# Preserve filters when changing per_page #}
      <input type="hidden" name="tracking_number" value="{{ tracking_number }}">
      <input type="hidden" name="status" value="{{ status_filter }}">
      <input type="hidden" name="date_from" value="{{ date_from }}">
      <input type="hidden" name="date_to" value="{{ date_to }}">

      {# Reset to first page when changing show #}
      <input type="hidden" name="page" value="1">
    </form>
  </div>

  {# Flash messages #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {# Filter (NO Show here anymore) #}
  <form method="get" action="{{ url_for('customer.view_packages') }}" class="row g-2 mb-3">
    <div class="col-md-3">
      <input type="text" name="tracking_number" value="{{ tracking_number }}" class="form-control" placeholder="Tracking #">
    </div>

    <div class="col-md-3">
      <select name="status" class="form-control">
        <option value="">All Status</option>
        <option value="Overseas" {% if status_filter=='Overseas' %}selected{% endif %}>Overseas</option>
        <option value="Ready for Pick Up" {% if status_filter=='Ready for Pick Up' %}selected{% endif %}>Ready for Pick Up</option>
        <option value="Delivered" {% if status_filter=='Delivered' %}selected{% endif %}>Delivered</option>
      </select>
    </div>

    <div class="col-md-2">
      <input type="date" name="date_from" value="{{ date_from }}" class="form-control">
    </div>

    <div class="col-md-2">
      <input type="date" name="date_to" value="{{ date_to }}" class="form-control">
    </div>

    {# Keep per_page when filtering #}
    <input type="hidden" name="per_page" value="{{ per_page }}">

    <div class="col-md-2 d-flex gap-2">
      <button type="submit" class="btn btn-dashboard w-100">
        Filter
      </button>

      <a href="{{ url_for('customer.view_packages', per_page=per_page) }}"
         class="btn btn-outline-secondary w-100">
        Clear
      </a>
    </div>

  </form>

  {# Table #}
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th style="width:70px;" class="text-center">Docs</th>
          <th>House AWB / Status</th>
          <th>Description</th>
          <th>Tracking Number</th>
          <th class="text-center">Weight (LBS)</th>
          <th class="text-center">Date Received</th>
          <th class="text-center">Amount Due</th>
        </tr>
      </thead>

      {% set mode = "customer" %}
      <tbody>
        {% for pkg in packages %}
          {% include "partials/package_row_shared.html" with context %}
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# Pagination #}
  {% if total_pages > 1 %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link"
             href="?page={{ p }}&status={{ status_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&tracking_number={{ tracking_number }}&per_page={{ per_page }}">
            {{ p }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </nav>
  {% endif %}
</div>

{# =========================
   Modals AFTER table (valid HTML)
   ========================= #}
{% for pkg in packages %}
{% set s = (pkg.status or '') %}
{% set lock_docs = (s == 'Ready for Pick Up' or s == 'Delivered') %}
<div class="modal fade" id="docsModal{{ pkg.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="POST"
            enctype="multipart/form-data"
            action="{{ url_for('customer.package_upload_docs', pkg_id=pkg.id) }}">
        {{ form.csrf_token }}

        <div class="modal-header">
          <h5 class="modal-title">Upload Invoices / Declared Value</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          {% if lock_docs %}
            <div class="alert alert-secondary py-2 mb-3">
              <i class="fas fa-lock me-1"></i>
              This package is <strong>{{ s }}</strong>, so invoices & declared value are locked.
            </div>
          {% endif %}

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Declared Value (USD)</label>
              <input class="form-control"
                     type="number"
                     name="declared_value"
                     step="0.01"
                     min="0"
                     value="{{ pkg.declared_value if pkg.declared_value is not none else (pkg.value if pkg.value is not none else 0) }}"
                     {% if lock_docs %}disabled{% endif %}>
              <div class="form-text">This updates the “VAL: $xx.xx” shown under status.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Invoice File 1</label>
              <input class="form-control" type="file" name="invoice_file_1" accept=".pdf,.jpg,.jpeg,.png" {% if lock_docs %}disabled{% endif %}>

              <label class="form-label mt-2">Invoice File 2</label>
              <input class="form-control" type="file" name="invoice_file_2" accept=".pdf,.jpg,.jpeg,.png" {% if lock_docs %}disabled{% endif %}>

              <label class="form-label mt-2">Invoice File 3</label>
              <input class="form-control" type="file" name="invoice_file_3" accept=".pdf,.jpg,.jpeg,.png" {% if lock_docs %}disabled{% endif %}>
            </div>

            <div class="col-12">
              <div class="fw-semibold mb-1">Existing Attachments</div>

              {% if pkg.attachments and pkg.attachments|length > 0 %}
                <div class="d-flex flex-wrap gap-2">
                  {% for a in pkg.attachments %}
                    <div class="d-inline-flex align-items-center gap-1">
                    {% set f = (a.file_name or '')|string %}
                    {% if f.startswith("http://") or f.startswith("https://") %}
                      <a class="btn btn-sm btn-outline-secondary"
                         target="_blank"
                         rel="noopener"
                         href="{{ f }}"
                         title="{{ a.original_name or a.file_name }}">
                        <i class="fas fa-file-alt me-1"></i> View
                      </a>
                    {% else %}
                      <a class="btn btn-sm btn-outline-secondary"
                         target="_blank"
                         rel="noopener"
                         href="{{ url_for('customer.view_package_attachment', attachment_id=a.id) }}"
                         title="{{ a.original_name or a.file_name }}">
                        <i class="fas fa-file-alt me-1"></i> View
                      </a>

                      <form method="POST"
                            action="{{ url_for('customer.delete_package_attachment_customer', attachment_id=a.id) }}"
                            style="display:inline;"
                            onsubmit="return confirm('Delete this attachment?');">
                        {{ form.csrf_token }}

                        <button type="submit"
                                class="btn btn-sm"
                                style="background:#fff; border:1px solid #dc3545; color:#dc3545; padding:.2rem .40rem;"
                                title="Delete attachment"
                                {% if lock_docs %}disabled{% endif %}>
                          <i class="fa-solid fa-xmark"></i>
                        </button>
                      </form>

                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="text-muted">No attachments yet.</div>
              {% endif %}

            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" {% if lock_docs %}disabled{% endif %}>Save</button>
        </div>

      </form>
    </div>
  </div>
</div>
{% endfor %}

<style>
.pkg-attachment {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 34px;
  height: 34px;
  border-radius: 999px;
  background-color: #f3e5f5;
  color: #4a148c;
  border: 1px solid #e1bee7;
  transition: all 0.15s ease-in-out;
  text-decoration: none;
}
.pkg-attachment i { font-size: 0.95rem; }
.pkg-attachment:hover {
  background-color: #4a148c;
  color: #fff;
  border-color: #4a148c;
  transform: translateY(-1px);
}
.btn-outline-secondary {
  --bs-btn-color: #374151;
  --bs-btn-border-color: #d1d5db;
}

</style>

{% endblock %}
