{% extends "layout_customer.html" %}
{% block title %}Messages{% endblock %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h3 class="mb-0">Messages</h3>
      <div class="text-muted small">Inbox & Sent • Click a message to open</div>
    </div>

    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('customer.view_messages') }}">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </a>
  </div>

  <!-- Flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="row g-3">

    <!-- LEFT: Inbox + Sent (gmail-ish list) -->
    <div class="col-lg-7">

      <!-- Inbox -->
      <div class="card shadow-sm mb-3">
        <div class="card-header text-white d-flex align-items-center justify-content-between"
             style="background:#4A148C;">
          <div class="fw-bold"><i class="bi bi-inbox me-2"></i>Inbox</div>
        </div>

        <div class="card-body p-0">
          {% if inbox|length == 0 %}
            <div class="p-3 text-muted">No messages.</div>
          {% else %}
            <div class="list-group list-group-flush">
              {% for m in inbox %}
                {% set is_unread = (not m.is_read) %}
                <a class="list-group-item list-group-item-action d-flex align-items-start gap-2"
                   href="{{ url_for('customer.customer_message_detail', msg_id=m.id) }}"
                   style="{% if is_unread %}background:#fff7d6;{% endif %}">

                  <div style="width:14px; padding-top:6px;">
                    {% if is_unread %}
                      <span class="d-inline-block rounded-circle" style="width:10px; height:10px; background:#2563EB;"></span>
                    {% else %}
                      <span class="d-inline-block rounded-circle" style="width:10px; height:10px; background:#E5E7EB;"></span>
                    {% endif %}
                  </div>

                  <div class="flex-grow-1 overflow-hidden">
                    <div class="d-flex justify-content-between gap-2">
                      <div class="text-truncate {% if is_unread %}fw-bold{% else %}fw-semibold{% endif %}">
                        Administrator
                      </div>
                      <div class="small text-muted flex-shrink-0">
                        {{ to_jamaica(m.created_at).strftime('%Y-%m-%d %I:%M %p') if m.created_at else '' }}
                      </div>
                    </div>

                    <div class="text-truncate {% if is_unread %}fw-bold{% else %}fw-normal{% endif %}">
                      {{ m.subject or "Message" }}
                      <span class="text-muted fw-normal">— {{ (m.body or '')[:90] }}{% if m.body and m.body|length > 90 %}…{% endif %}</span>
                    </div>

                    <div class="mt-1">
                      {% if is_unread %}
                        <span class="badge" style="background:#FACC15; color:#111827;">Unread</span>
                      {% else %}
                        <span class="badge" style="background:#15803D;">Read</span>
                      {% endif %}
                    </div>
                  </div>

                </a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Sent -->
      <div class="card shadow-sm">
        <div class="card-header text-white d-flex align-items-center justify-content-between"
             style="background:#15803D;">
          <div class="fw-bold"><i class="bi bi-send me-2"></i>Sent</div>
        </div>

        <div class="card-body p-0">
          {% if sent|length == 0 %}
            <div class="p-3 text-muted">No sent messages.</div>
          {% else %}
            <div class="list-group list-group-flush">
              {% for m in sent %}
                <a class="list-group-item list-group-item-action d-flex align-items-start gap-2"
                   href="{{ url_for('customer.customer_message_detail', msg_id=m.id) }}">

                  <div style="width:14px; padding-top:6px;">
                    <span class="d-inline-block rounded-circle" style="width:10px; height:10px; background:#E5E7EB;"></span>
                  </div>

                  <div class="flex-grow-1 overflow-hidden">
                    <div class="d-flex justify-content-between gap-2">
                      <div class="text-truncate fw-semibold">
                        <span class="text-muted">To:</span> Administrator
                      </div>
                      <div class="small text-muted flex-shrink-0">
                        {{ to_jamaica(m.created_at).strftime('%Y-%m-%d %I:%M %p') if m.created_at else '' }}
                      </div>
                    </div>

                    <div class="text-truncate">
                      {{ m.subject or "Message" }}
                      <span class="text-muted">— {{ (m.body or '')[:90] }}{% if m.body and m.body|length > 90 %}…{% endif %}</span>
                    </div>

                    <div class="mt-1">
                      <span class="badge bg-secondary">Sent</span>
                    </div>
                  </div>

                </a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

    </div>

    <!-- RIGHT: Compose -->
    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold" style="background:#111827;">
          <i class="bi bi-pencil-square me-2"></i>New Message
        </div>

        <div class="card-body">
          <form method="POST" action="{{ url_for('customer.view_messages') }}">
            {{ form.hidden_tag() }}

            <div class="mb-3">
              {{ form.subject.label(class="form-label") }}
              {{ form.subject(class="form-control", placeholder="Subject") }}
              {% for e in form.subject.errors %}
                <div class="text-danger small">{{ e }}</div>
              {% endfor %}
            </div>

            <div class="mb-3">
              {{ form.body.label(class="form-label") }}
              {{ form.body(class="form-control", rows=6, placeholder="Write your message...") }}
              {% for e in form.body.errors %}
                <div class="text-danger small">{{ e }}</div>
              {% endfor %}
            </div>

            <button class="btn" type="submit" style="background:#4A148C; color:#fff;">
              <i class="bi bi-send"></i> Send
            </button>
          </form>

          <hr>
          <div class="small text-muted">
            Tip: Click a message to open it and reply.
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  .card { border-radius: 12px; }
</style>
{% endblock %}

