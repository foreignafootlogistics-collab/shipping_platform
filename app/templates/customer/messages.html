{% extends "layout_customer.html" %}
{% block title %}Messages{% endblock %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Messages</h3>

    {# Thread shortcut (opens the admin thread) #}
    {% if admin %}
      <a class="btn btn-sm btn-outline-secondary"
         href="{{ url_for('customer.customer_message_thread', admin_id=admin.id) }}">
        <i class="bi bi-chat-dots"></i> Open Thread
      </a>
    {% endif %}
  </div>

  <!-- Flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="row g-3">

    <!-- Inbox + Sent -->
    <div class="col-lg-7">

      <!-- Inbox -->
      <div class="card shadow-sm mb-3">
        <div class="card-header text-white d-flex align-items-center justify-content-between"
             style="background:#4A148C;">
          <div class="fw-bold"><i class="bi bi-inbox me-2"></i>Inbox</div>
        </div>

        <div class="card-body p-0">
          {% if inbox|length == 0 %}
            <p class="text-muted m-3 mb-0">No messages.</p>
          {% else %}
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width:55%;">Subject</th>
                    <th style="width:20%;">From</th>
                    <th style="width:25%;">Date</th>                    
                  </tr>
                </thead>
                <tbody>
                  {% for m in inbox %}
                  <tr style="cursor:pointer"
                      onclick="window.location='{{ url_for('customer.customer_message_thread', admin_id=m.sender_id) }}'">
                    <td class="fw-semibold">
                      {{ m.subject or "Message" }}

                      {% if not m.is_read %}
                        <span class="badge ms-2" style="background:#FACC15; color:#111827;">
                          Unread
                        </span>
                      {% else %}
                        <span class="badge ms-2" style="background:#15803D;">
                          Read
                        </span>
                      {% endif %}

                      <div class="text-muted small mt-1">
                        {{ (m.body or '')[:80] }}{% if m.body and m.body|length > 80 %}…{% endif %}
                      </div>
                    </td>

                    <td class="fw-semibold">
                      Administrator
                    </td>

                    <td class="text-muted small">
                      {{ to_jamaica(m.created_at).strftime('%Y-%m-%d %I:%M %p') if m.created_at else '' }}
                    </td>                    
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Sent -->
      <div class="card shadow-sm">
        <div class="card-header text-white d-flex align-items-center justify-content-between"
             style="background:#15803D;">
          <div class="fw-bold"><i class="bi bi-send me-2"></i>Sent</div>
        </div>

        <div class="card-body p-0">
          {% if sent|length == 0 %}
            <p class="text-muted m-3 mb-0">No sent messages.</p>
          {% else %}
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width:55%;">Subject</th>
                    <th style="width:20%;">To</th>
                    <th style="width:25%;">Date</th>
                  </tr>
                </thead>
                <tbody>
                  {% for m in sent %}
                  <tr style="cursor:pointer"
                      onclick="window.location='{{ url_for('customer.customer_message_thread', admin_id=m.recipient_id) }}'">
                    <td class="fw-semibold">
                      {{ m.subject or "Message" }}
                      <div class="text-muted small mt-1">
                        {{ (m.body or '')[:90] }}{% if m.body and m.body|length > 90 %}…{% endif %}
                      </div>
                    </td>

                    <td class="fw-semibold">
                      Administrator
                    </td>

                    <td class="text-muted small">
                      {{ to_jamaica(m.created_at).strftime('%Y-%m-%d %I:%M %p') if m.created_at else '' }}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>

    </div>

    <!-- Compose -->
    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold" style="background:#111827;">
          <i class="bi bi-pencil-square me-2"></i>New Message
        </div>

        <div class="card-body">
          <form method="POST" action="{{ url_for('customer.view_messages') }}">
            {{ form.hidden_tag() }}

            <div class="mb-3">
              {{ form.subject.label(class="form-label") }}
              {{ form.subject(class="form-control", placeholder="Subject") }}
              {% for e in form.subject.errors %}
                <div class="text-danger small">{{ e }}</div>
              {% endfor %}
            </div>

            <div class="mb-3">
              {{ form.body.label(class="form-label") }}
              {{ form.body(class="form-control", rows=6, placeholder="Write your message...") }}
              {% for e in form.body.errors %}
                <div class="text-danger small">{{ e }}</div>
              {% endfor %}
            </div>

            <button class="btn" type="submit"
                    style="background:#4A148C; color:#fff;">
              <i class="bi bi-send"></i> Send
            </button>
          </form>

          {% if admin %}
            <hr>
            <div class="small text-muted">
              Tip: Use the thread view for replies + full history.
            </div>
            <a class="btn btn-sm btn-outline-primary mt-2"
               href="{{ url_for('customer.customer_message_thread', admin_id=admin.id) }}">
              Open thread with Admin
            </a>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  .card {
    border-radius: 10px;
  }
  .table td, .table th {
    padding: 0.6rem 0.75rem;
  }
</style>

{% endblock %}


