{% extends "layout_customer.html" %}
{% block title %}Package Detail{% endblock %}

{% block content %}
<h2>Package Details</h2>

<ul class="list-unstyled">
  <li><strong>Invoice:</strong>
    {% if pkg.invoice_file %}
      {% set f = (pkg.invoice_file or '')|string %}
      {% if f.startswith("http://") or f.startswith("https://") %}
        <a href="{{ f }}" target="_blank" rel="noopener">View Invoice</a>
      {% else %}
        {# legacy disk file (if you still have it) #}
        <a href="{{ url_for('uploads.invoice_file', filename=f) }}" target="_blank" rel="noopener">View Invoice</a>
      {% endif %}
    {% else %}
      <span class="text-muted">Not uploaded</span>
    {% endif %}
  </li>

  <li><strong>House AWB:</strong> {{ pkg.house_awb or "-" }}</li>
  <li><strong>Status:</strong> {{ pkg.status or "-" }}</li>
  <li><strong>Description:</strong> {{ pkg.description or "-" }}</li>
  <li><strong>Tracking Number:</strong> {{ pkg.tracking_number or "-" }}</li>
  <li><strong>Weight:</strong>
    {% if pkg.weight is not none %}
      {{ (pkg.weight|float)|round(0, 'ceil') }} lbs
    {% else %}
      <span class="text-muted">Not available</span>
    {% endif %}
  </li>
  <li><strong>Date Received:</strong>
    {% if pkg.received_date %}
      {{ pkg.received_date }} {# stored as text in DB; shown as-is #}
    {% else %}
      <span class="text-muted">Not available</span>
    {% endif %}
  </li>
  <li><strong>Declared Value (USD):</strong>
    ${{ "%.2f"|format(pkg.declared_value if pkg.declared_value is not none else 0) }}
  </li>
  <li><strong>Amount Due:</strong>
    {% if (pkg.status or '')|lower == 'ready for pick up' %}
      {{ (pkg.amount_due or 0)|jmd }}
    {% else %}
      {{ 0|jmd }}
    {% endif %}
  </li>
</ul>

{# Allow submit only while Overseas #}
{% if (pkg.status or '')|lower == 'overseas' %}
  <hr>
  <h3>Submit Invoice & Declared Value</h3>

  <form method="POST"
        enctype="multipart/form-data"
        action="{{ url_for('customer.package_detail', pkg_id=pkg.id) }}"
        class="mb-3">
    {{ form.hidden_tag() }}

    <div class="mb-3">
      {{ form.declared_value.label(class="form-label") }}
      {{ form.declared_value(class="form-control", value=(pkg.declared_value if pkg.declared_value is not none else 0)) }}
      {% if form.declared_value.errors %}
        <div class="text-danger small">{{ form.declared_value.errors[0] }}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      {{ form.invoice_file.label(class="form-label") }}
      {{ form.invoice_file(class="form-control") }}
      {% if form.invoice_file.errors %}
        <div class="text-danger small">{{ form.invoice_file.errors[0] }}</div>
      {% endif %}
    </div>

    <button type="submit" class="btn btn-primary">Submit</button>
    <a class="btn btn-outline-secondary"
       href="{{ url_for('customer.submit_invoice', package_id=pkg.id) }}">
      Use full-page uploader
    </a>
  </form>
{% endif %}

<a href="{{ url_for('customer.view_packages') }}">‚Üê Back to Packages</a>
{% endblock %}
