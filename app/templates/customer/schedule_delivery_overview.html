{% extends "layout_customer.html" %}
{% block title %}Schedule Delivery{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>ðŸ“¦ Schedule Delivery</h2>
  <p class="text-muted">Add a delivery date/time and location. Weâ€™ll arrange delivery to you.</p>

  <button class="btn btn-primary mb-3" id="scheduleDeliveryBtn">+ Schedule New Delivery</button>

  <div id="scheduleDeliveryForm" class="card p-3 mb-4" style="display:none;">
    <div class="row g-2">
      <div class="col-md-2"><input type="date" id="deliveryDate" class="form-control" required></div>
      <div class="col-md-2"><input type="time" id="deliveryTime" class="form-control" required></div>
      <div class="col-md-3"><input type="text" id="deliveryLocation" placeholder="Location" class="form-control" required></div>
      <div class="col-md-3"><input type="text" id="deliveryDirections" placeholder="Directions (optional)" class="form-control"></div>
      <div class="col-md-2"><input type="text" id="deliveryMobile" placeholder="Mobile # (optional)" class="form-control"></div>
      <div class="col-md-3 mt-2"><input type="text" id="deliveryPerson" placeholder="Person Receiving (optional)" class="form-control"></div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-success" id="saveScheduleDelivery" type="button">Save</button>
      <button class="btn btn-secondary" id="cancelScheduleDelivery" type="button">Cancel</button>
    </div>

    <small id="scheduleDeliveryMsg" class="text-danger mt-2" style="display:none;"></small>
  </div>

  <table class="table table-striped" id="scheduledDeliveriesList">
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Location</th>
        <th>Person Receiving</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for delivery in deliveries %}
      <tr>
        <td>{{ delivery.scheduled_date.strftime("%Y-%m-%d") if delivery.scheduled_date else "" }}</td>
        <td>{{ delivery.scheduled_time or "" }}</td>
        <td>{{ delivery.location or "" }}</td>
        <td>{{ delivery.person_receiving or "" }}</td>
        <td>Scheduled</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
const btnShow   = document.getElementById("scheduleDeliveryBtn");
const formWrap  = document.getElementById("scheduleDeliveryForm");
const btnSave   = document.getElementById("saveScheduleDelivery");
const btnCancel = document.getElementById("cancelScheduleDelivery");
const msgEl     = document.getElementById("scheduleDeliveryMsg");

function showMsg(text){
  msgEl.textContent = text || "";
  msgEl.style.display = text ? "block" : "none";
}

btnShow.onclick = () => {
  showMsg("");
  formWrap.style.display = "block";
  btnShow.style.display = "none";
};

btnCancel.onclick = () => {
  showMsg("");
  formWrap.style.display = "none";
  btnShow.style.display = "inline-block";
};

btnSave.onclick = async () => {
  showMsg("");

  const schedule_date = document.getElementById("deliveryDate").value;
  const schedule_time = document.getElementById("deliveryTime").value; // "HH:MM"
  const location      = document.getElementById("deliveryLocation").value.trim();
  const direction     = document.getElementById("deliveryDirections").value.trim();
  const mobile_number = document.getElementById("deliveryMobile").value.trim();
  const person_receiving = document.getElementById("deliveryPerson").value.trim();

  if (!schedule_date || !schedule_time || !location) {
    showMsg("Please enter Schedule Date, Time, and Location.");
    return;
  }

  try {
    const res = await fetch("{{ url_for('customer.schedule_delivery_add') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        schedule_date,
        schedule_time,
        location,
        direction,
        mobile_number,
        person_receiving
      })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.success) {
      showMsg(data.message || "Failed to schedule delivery.");
      return;
    }

    // easiest + consistent
    window.location.reload();

  } catch (e) {
    showMsg("Network error. Please try again.");
  }
};
</script>
{% endblock %}
