{% extends 'layout_customer.html' %}
{% block title %}Schedule Delivery{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Schedule Delivery</h2>
  <p>Arrange to have your packages delivered at a date and time convenient for you.</p>

  <button id="scheduleDeliveryBtn" class="btn btn-dashboard mb-3">ðŸ“… Schedule Delivery</button>

  <div id="scheduleDeliveryForm" style="display:none;">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Schedule Date</th>
          <th>Time</th>
          <th>Location</th>
          <th>Directions</th>
          <th>Mobile #</th>
          <th>Person Receiving</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="date" id="deliveryDate" class="form-control" required></td>
          <td><input type="time" id="deliveryTime" class="form-control" required></td>
          <td><input type="text" id="deliveryLocation" class="form-control" placeholder="Delivery Location" required></td>
          <td><input type="text" id="deliveryDirections" class="form-control" placeholder="Directions"></td>
          <td><input type="text" id="deliveryMobile" class="form-control" placeholder="Mobile #"></td>
          <td><input type="text" id="deliveryPerson" class="form-control" placeholder="Person Receiving"></td>
        </tr>
      </tbody>
    </table>

    <div class="d-flex gap-2">
      <button type="button" class="btn btn-success" id="saveScheduleDelivery">Save</button>
      <button type="button" class="btn btn-danger" id="cancelScheduleDelivery">Cancel</button>
    </div>

    <div id="scheduleDeliveryMsg" class="alert alert-danger mt-3" style="display:none;"></div>
  </div>  {# âœ… IMPORTANT: closed properly #}

  <h4 class="mt-5">Upcoming Scheduled Deliveries</h4>
  <table class="table table-striped" id="scheduledDeliveriesList">
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Location</th>
        <th>Person Receiving</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for delivery in deliveries %}
      <tr>
        <td>{{ delivery.scheduled_date.strftime("%Y-%m-%d") if delivery.scheduled_date else "" }}</td>
        <td>{{ delivery.scheduled_time or "" }}</td>
        <td>{{ delivery.location or "" }}</td>
        <td>{{ delivery.person_receiving or "" }}</td>
        <td>Scheduled</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btnShow   = document.getElementById("scheduleDeliveryBtn");
  const formWrap  = document.getElementById("scheduleDeliveryForm");
  const btnSave   = document.getElementById("saveScheduleDelivery");
  const btnCancel = document.getElementById("cancelScheduleDelivery");
  const msgEl     = document.getElementById("scheduleDeliveryMsg");

  function showMsg(text){
    msgEl.textContent = text || "";
    msgEl.style.display = text ? "block" : "none";
  }

  btnShow.addEventListener("click", () => {
    showMsg("");
    formWrap.style.display = "block";
    btnShow.style.display = "none";
  });

  btnCancel.addEventListener("click", () => {
    showMsg("");
    formWrap.style.display = "none";
    btnShow.style.display = "inline-block";
  });

  btnSave.addEventListener("click", async () => {
    showMsg("");

    const schedule_date = document.getElementById("deliveryDate").value;
    const schedule_time = document.getElementById("deliveryTime").value; // HH:MM
    const location      = (document.getElementById("deliveryLocation").value || "").trim();
    const direction     = (document.getElementById("deliveryDirections").value || "").trim();
    const mobile_number = (document.getElementById("deliveryMobile").value || "").trim();
    const person_receiving = (document.getElementById("deliveryPerson").value || "").trim();

    if (!schedule_date || !schedule_time || !location) {
      showMsg("Please enter Date, Time, and Location.");
      return;
    }

    btnSave.disabled = true;
    btnSave.textContent = "Saving...";

    try {
      const res = await fetch("{{ url_for('customer.schedule_delivery_add') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          schedule_date,
          schedule_time,
          location,
          direction,
          mobile_number,
          person_receiving
        })
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.success) {
        showMsg(data.message || `Failed (${res.status})`);
        return;
      }

      window.location.reload();

    } catch (e) {
      console.error(e);
      showMsg("Network error. Please try again.");
    } finally {
      btnSave.disabled = false;
      btnSave.textContent = "Save";
    }
  });
});
</script>
{% endblock %}

