{% extends 'layout_customer.html' %}
{% block title %}Schedule Delivery{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2>Schedule Delivery</h2>
  <p>Arrange to have your packages delivered at a date and time convenient for you. Choose a location, provide directions, and confirm the recipientâ€™s details.</p>

  <!-- Show form button -->
  <button id="scheduleDeliveryBtn" class="btn btn-dashboard mb-3">ðŸ“… Schedule Delivery</button>

  <!-- Inline form table -->
  <div id="scheduleDeliveryForm" style="display:none;">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Schedule Date</th>
          <th>Time</th>
          <th>Location</th>
          <th>Directions</th>
          <th>Mobile #</th>
          <th>Person Receiving</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="date" id="deliveryDate" class="form-control"></td>
          <td><input type="time" id="deliveryTime" class="form-control"></td>
          <td><input type="text" id="deliveryLocation" class="form-control" placeholder="Delivery Location"></td>
          <td><input type="text" id="deliveryDirections" class="form-control" placeholder="Directions"></td>
          <td><input type="text" id="deliveryMobile" class="form-control" placeholder="Mobile #"></td>
          <td><input type="text" id="deliveryPerson" class="form-control" placeholder="Person Receiving"></td>
        </tr>
      </tbody>
    </table>
    <button class="btn btn-success" id="saveScheduleDelivery">Save</button>
    <button type="button" class="btn btn-danger" id="cancelScheduleDelivery">Cancel</button>
  </div>

  <!-- Existing scheduled deliveries -->
  <h4 class="mt-5">Upcoming Scheduled Deliveries</h4>
  <table class="table table-striped" id="scheduledDeliveriesList">
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Location</th>
        <th>Person Receiving</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for delivery in deliveries %}
      <tr>
        <td>{{ delivery.date }}</td>
        <td>{{ delivery.time }}</td>
        <td>{{ delivery.location }}</td>
        <td>{{ delivery.person_receiving }}</td>
        <td>{{ delivery.status }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
const btnShow   = document.getElementById("scheduleDeliveryBtn");
const formWrap  = document.getElementById("scheduleDeliveryForm");
const btnSave   = document.getElementById("saveScheduleDelivery");
const btnCancel = document.getElementById("cancelScheduleDelivery");
const msgDiv    = document.getElementById("resultMessage"); // âœ… make sure this exists in your HTML

function showMsg(html, type="danger") {
  if (!msgDiv) return;
  msgDiv.innerHTML = html ? `<div class="alert alert-${type}">${html}</div>` : "";
}

btnShow.addEventListener("click", function () {
  showMsg("");
  formWrap.style.display = "block";
  btnShow.style.display = "none";
});

btnCancel.addEventListener("click", function () {
  showMsg("");
  formWrap.style.display = "none";
  btnShow.style.display = "inline-block";
});

btnSave.addEventListener("click", async function () {
  showMsg("");

  // âœ… match your backend keys exactly
  const schedule_date    = document.getElementById("deliveryDate").value;
  const schedule_time    = document.getElementById("deliveryTime").value;
  const location         = (document.getElementById("deliveryLocation").value || "").trim();
  const direction        = (document.getElementById("deliveryDirections").value || "").trim();
  const mobile_number    = (document.getElementById("deliveryMobile").value || "").trim();
  const person_receiving = (document.getElementById("deliveryPerson").value || "").trim();

  if (!schedule_date || !schedule_time || !location) {
    showMsg("Missing required fields: date, time, and location.", "warning");
    return;
  }

  try {
    const res = await fetch("{{ url_for('customer.schedule_delivery_add') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        schedule_date,
        schedule_time,
        location,
        direction,
        mobile_number,
        person_receiving
      })
    });

    // âœ… ALWAYS read raw response first (so you see real errors)
    const raw = await res.text();
    let data = {};
    try { data = JSON.parse(raw); } catch (e) {}

    if (!res.ok) {
      showMsg(data.message || raw || `HTTP ${res.status}`, "danger");
      return;
    }

    if (!data.success) {
      showMsg(data.message || "Failed to schedule delivery.", "danger");
      return;
    }

    // âœ… simplest: reload so the table updates from DB
    window.location.reload();

  } catch (err) {
    showMsg("Network error. Please try again.", "danger");
  }
});
</script>
{% endblock %}
