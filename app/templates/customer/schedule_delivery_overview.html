{% extends 'layout_customer.html' %}
{% block title %}Schedule Delivery{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Schedule Delivery</h2>
  <p>Arrange to have your packages delivered at a date and time convenient for you.</p>

  <!-- âœ… Delivery Fee Banner (dynamic) -->
  <div class="alert alert-warning d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3"
       style="border-radius: 14px;">
    <div class="d-flex align-items-center gap-2">
      <span style="font-size:1.1rem;">ðŸšš</span>
      <div>
        <div class="fw-bold">
          Delivery Fee: {{ fee_currency }} {{ "%.2f"|format(delivery_fee|float) }}
        </div>
        <div class="small text-muted">
          This fee will be added to your delivery request and must be paid before delivery.
        </div>
      </div>
    </div>
    <span class="badge bg-dark">Payable on request</span>
  </div>

  <button id="scheduleDeliveryBtn" class="btn btn-dashboard mb-3">ðŸ“… Schedule Delivery</button>

  <div id="scheduleDeliveryForm" style="display:none;">
    <input type="hidden" id="csrf_token" value="{{ csrf_token() }}">

    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Schedule Date</th>
          <th>Time From</th>
          <th>Time To</th>
          <th>Location</th>
          <th>Directions</th>
          <th>Mobile #</th>
          <th>Person Receiving</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="date" id="deliveryDate" class="form-control" required></td>
          <td><input type="time" id="deliveryTimeFrom" class="form-control" required></td>
          <td><input type="time" id="deliveryTimeTo" class="form-control" required></td>
          <td><input type="text" id="deliveryLocation" class="form-control" placeholder="Delivery Location" required></td>
          <td><input type="text" id="deliveryDirections" class="form-control" placeholder="Directions"></td>
          <td><input type="text" id="deliveryMobile" class="form-control" placeholder="Mobile #"></td>
          <td><input type="text" id="deliveryPerson" class="form-control" placeholder="Person Receiving"></td>
        </tr>
      </tbody>
    </table>

    <div class="d-flex gap-2">
      <button type="button" class="btn btn-success" id="saveScheduleDelivery">Save</button>
      <button type="button" class="btn btn-danger" id="cancelScheduleDelivery">Cancel</button>
    </div>

    <div id="scheduleDeliveryMsg" class="alert alert-danger mt-3" style="display:none;"></div>
  </div>  {# âœ… IMPORTANT: closed properly #}

  <h4 class="mt-5">Upcoming Scheduled Deliveries</h4>
  <table class="table table-striped" id="scheduledDeliveriesList">
    <thead>
      <tr>
        <th>Invoice #</th>
        <th>Date</th>
        <th>Time</th>
        <th>Location</th>
        <th>Person Receiving</th>
        <th>Delivery Fee</th>
        <th>Fee Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for delivery in deliveries %}
      <tr>
        <td class="fw-semibold">
          {{ delivery.invoice_number or "â€”" }}
        </td>
        <td>{{ delivery.scheduled_date.strftime("%Y-%m-%d") if delivery.scheduled_date else "" }}</td>
        <td class="text-nowrap">
          {% if delivery.scheduled_time_from and delivery.scheduled_time_to %}
            {{ delivery.scheduled_time_from }} - {{ delivery.scheduled_time_to }}
          {% else %}
            {{ delivery.scheduled_time or "" }}
          {% endif %}
        </td>
        <td>{{ delivery.location or "" }}</td>
        <td>{{ delivery.person_receiving or "" }}</td>

        <td>
          {{ delivery.fee_currency or "JMD" }}
          {{ "%.2f"|format(delivery.delivery_fee or 0) }}
        </td>
        <td>
          {% set fs = delivery.fee_status or "Unpaid" %}
          {% if fs|lower == "paid" %}
            <span class="badge bg-success">Paid</span>
          {% elif fs|lower == "waived" %}
            <span class="badge bg-secondary">Waived</span>
          {% elif fs|lower == "refunded" %}
            <span class="badge bg-info text-dark">Refunded</span>
          {% else %}
            <span class="badge bg-warning text-dark">Unpaid</span>
          {% endif %}
        </td>

        <td>
          <div class="d-flex flex-wrap gap-2">          
            
            <a class="btn btn-sm btn-outline-primary"
               href="{{ url_for('customer.delivery_invoice_view', delivery_id=delivery.id) }}">
              View Invoice
            </a>
            

            {% if (delivery.status or "Scheduled") in ["Scheduled", "Out for Delivery"] %}
              <button class="btn btn-sm btn-danger"
                      onclick="cancelDelivery({{ delivery.id }})">
                Cancel
              </button>
            {% else %}
              <span class="text-muted">â€”</span>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btnShow   = document.getElementById("scheduleDeliveryBtn");
  const formWrap  = document.getElementById("scheduleDeliveryForm");
  const btnSave   = document.getElementById("saveScheduleDelivery");
  const btnCancel = document.getElementById("cancelScheduleDelivery");
  const msgEl     = document.getElementById("scheduleDeliveryMsg");

  function showMsg(text) {
    if (!msgEl) return;
    msgEl.textContent = text || "";
    msgEl.style.display = text ? "block" : "none";
  }

  btnShow.addEventListener("click", () => {
    showMsg("");
    formWrap.style.display = "block";
    btnShow.style.display = "none";
  });

  btnCancel.addEventListener("click", () => {
    showMsg("");
    formWrap.style.display = "none";
    btnShow.style.display = "inline-block";
  });

  btnSave.addEventListener("click", async (e) => {
    e.preventDefault();
    showMsg("");

    const schedule_date = (document.getElementById("deliveryDate").value || "").trim();
    const schedule_time_from = (document.getElementById("deliveryTimeFrom").value || "").trim();
    const schedule_time_to   = (document.getElementById("deliveryTimeTo").value || "").trim();
    const location      = (document.getElementById("deliveryLocation").value || "").trim();
    const direction     = (document.getElementById("deliveryDirections").value || "").trim();
    const mobile_number = (document.getElementById("deliveryMobile").value || "").trim();
    const person_receiving = (document.getElementById("deliveryPerson").value || "").trim();

    const csrfToken = (document.getElementById("csrf_token")?.value || "").trim();

    if (!schedule_date || !schedule_time_from || !schedule_time_to || !location) {
      showMsg("Please enter Schedule Date, Time From, Time To, and Location.");
      return;
    }

    btnSave.disabled = true;
    btnSave.textContent = "Saving...";

    try {
      const res = await fetch("{{ url_for('customer.schedule_delivery_add') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({
          schedule_date,
          time_from: schedule_time_from,
          time_to: schedule_time_to,
          location,
          direction,
          mobile_number,
          person_receiving
        })
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.success) {
        showMsg(data.message || `Failed (${res.status})`);
        console.log("Schedule delivery error payload:", data);
        return;
      }

      window.location.reload();

    } catch (err) {
      console.error("Schedule Delivery Save error:", err);
      showMsg("Network error. Please try again.");
    } finally {
      btnSave.disabled = false;
      btnSave.textContent = "Save";
    }
  });
});

async function cancelDelivery(deliveryId){
  if (!confirm("Cancel this scheduled delivery?")) return;

  const csrfToken = (document.getElementById("csrf_token")?.value || "").trim();

  try {
    const res = await fetch(`/customer/schedule-delivery/${deliveryId}/cancel`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken
      }
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.success) {
      alert(data.message || "Failed to cancel.");
      return;
    }
    window.location.reload();
  } catch (e) {
    alert("Network error.");
  }
}
</script>
{% endblock %}
