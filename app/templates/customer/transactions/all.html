{# customer/transactions/all.html #}
{% extends "layout_customer.html" %}
{% block title %}Transactions - Foreign A Foot Logistics{% endblock %}

{% block content %}
<div class="container my-4 txn-wrap">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="fw-bold mb-0">Transactions</h3>
      <div class="text-muted small">Billing history, receipts, and invoice records</div>
    </div>

    <!-- Per-page (keeps filters) -->
    <form method="GET" class="d-flex align-items-center gap-2">
      <input type="hidden" name="q" value="{{ q or '' }}">
      <input type="hidden" name="status" value="{{ status or '' }}">
      <input type="hidden" name="days" value="{{ days or '' }}">
      <input type="hidden" name="page" value="1">

      <span class="small text-muted">Show</span>
      <select name="per_page" class="form-select form-select-sm txn-perpage" onchange="this.form.submit()">
        {% for opt in per_page_options %}
          <option value="{{ opt }}" {% if opt == per_page %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </form>
  </div>

  <!-- Summary cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 pill-icon bg-purple text-white">üì¶</div>
          <div>
            <small class="text-muted">Total Shipments</small>
            <div class="h4 fw-bold mb-0">{{ total_shipments }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 pill-icon bg-warning text-white">üí∏</div>
          <div>
            <small class="text-muted">Total Owed (JMD)</small>
            <div class="h4 fw-bold mb-0">{{ "{:,.2f}".format(total_owed) }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 pill-icon bg-success text-white">üìë</div>
          <div>
            <small class="text-muted">Billing Records</small>
            <div class="h4 fw-bold mb-0">{{ billing_records }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 pill-icon bg-danger text-white">‚ö†Ô∏è</div>
          <div>
            <small class="text-muted">Pending</small>
            <div class="h4 fw-bold mb-0">{{ pending_count }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters (WORKING) -->
  <form method="GET" class="card shadow-sm border-0 mb-4 txn-filters">
    <div class="card-body">
      <input type="hidden" name="page" value="1">
      <input type="hidden" name="per_page" value="{{ per_page }}">

      <div class="row g-2 align-items-center">
        <div class="col-md-5">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input name="q" value="{{ q or '' }}" class="form-control"
                   placeholder="Search by Invoice ID / Reference...">

          </div>
        </div>

        <div class="col-md-3">
          <select name="status" class="form-select">
            <option value="" {% if not status %}selected{% endif %}>All Status</option>
            <option value="paid" {% if status=='paid' %}selected{% endif %}>Paid</option>
            <option value="pending" {% if status=='pending' %}selected{% endif %}>Pending</option>
            <option value="partial" {% if status=='partial' %}selected{% endif %}>Partial</option>
          </select>
        </div>

        <div class="col-md-2">
          <select name="days" class="form-select">
            <option value="" {% if not days %}selected{% endif %}>All time</option>
            <option value="7" {% if days==7 %}selected{% endif %}>Last 7 days</option>
            <option value="30" {% if days==30 %}selected{% endif %}>Last 30 days</option>
          </select>
        </div>

        <div class="col-md-2 d-flex gap-2">
          <button class="btn btn-purple w-100" type="submit">
            Apply
          </button>
          <a class="btn btn-outline-secondary w-100"
             href="{{ url_for('customer.transactions_all', per_page=per_page, page=1) }}">
            Reset
          </a>
        </div>
      </div>

      {% if q or status or days %}
      <div class="mt-3 d-flex flex-wrap gap-2 small">
        {% if q %}<span class="chip">Search: <strong>{{ q }}</strong></span>{% endif %}
        {% if status %}<span class="chip">Status: <strong>{{ status|upper }}</strong></span>{% endif %}
        {% if days %}<span class="chip">Range: <strong>{{ days }} days</strong></span>{% endif %}
      </div>
      {% endif %}
    </div>
  </form>

  <!-- Desktop table -->
  <div class="card shadow-sm txn-card d-none d-md-block">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0 txn-table">
        <thead class="table-purple text-white">
          <tr>
            <th style="width:120px;">Type</th>
            <th>Reference</th>
            <th style="width:210px;">Date</th>
            <th style="width:150px;">Status</th>
            <th style="width:140px;">Method</th>
            <th style="width:170px;" class="text-end">Amount Due</th>
            <th style="width:170px;" class="text-end">Amount Paid</th>
            <th style="width:170px;" class="text-end">Amount Owed</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr class="transaction-row" data-url="{{ r.view_url }}" data-pdf="{{ r.pdf_url }}">
            <td>
              {% set st = (r.status or '')|lower %}
              {% set is_paid = (st == 'paid') %}
              <span class="d-inline-flex align-items-center gap-2">
                {% if is_paid %}
                  <i class="bi bi-lock-fill text-success" title="Closed / Paid"></i>
                {% else %}
                  <i class="bi bi-unlock-fill text-warning" title="Open / Pending"></i>
                {% endif %}
                <span class="badge rounded-pill bg-purple">Invoice</span>
              </span>
            </td>


            <td>
              <div class="ref-main">{{ r.reference_main }}</div>
              {% if r.reference_sub %}
                <div class="ref-sub">{{ r.reference_sub }}</div>
              {% endif %}

              <div class="mt-1 d-flex gap-3 small">
                <a href="#" class="txn-open text-primary">
                  <i class="bi bi-eye-fill"></i> View
                </a>                
              </div>
            </td>

            <td class="text-nowrap">
              {% if r.date %}
                {{ r.date.strftime("%b %d, %Y") }} ‚Ä¢ {{ r.date.strftime("%I:%M %p").lstrip("0") }}
              {% endif %}
            </td>

            <td class="text-nowrap">
              {% set st = (r.status or '')|lower %}
              {% if st == 'paid' %}
                <span class="badge bg-success">PAID</span>
              {% elif st == 'partial' %}
                <span class="badge bg-info text-dark">PARTIAL</span>
              {% else %}
                <span class="badge bg-warning text-dark">PENDING</span>
              {% endif %}
            </td>

            <td class="text-nowrap">
              {% set st = (r.status or '')|lower %}
              {% if st == 'pending' %}
                <span class="text-warning fw-semibold">Awaiting Payment</span>
              {% else %}
                {{ r.method if r.method else "‚Äî" }}
              {% endif %}
            </td>
            <td class="text-end fw-bold">J$ {{ "{:,.2f}".format(r.amount_due or 0) }}</td>

            <td class="text-end fw-bold">J$ {{ "{:,.2f}".format(r.amount_paid or 0) }}</td>

            <td class="text-end fw-bold">
              <span class="px-2 py-1 d-inline-block {% if (r.amount_owed or 0) > 0 %}text-danger txn-owed{% endif %}">
                J$ {{ "{:,.2f}".format(r.amount_owed or 0) }}
              </span>
            </td>

          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center py-4 text-muted">No transactions found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Mobile cards -->
  <div class="d-md-none">
    {% for r in rows %}
      <div class="card shadow-sm mb-3 transaction-card" data-url="{{ r.view_url }}" data-pdf="{{ r.pdf_url }}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            {% set is_paid = ((r.status or '')|lower == 'paid') %}
            <span class="badge bg-purple rounded-pill d-inline-flex align-items-center gap-2">
              {% if is_paid %}
                <i class="bi bi-lock-fill"></i>
              {% else %}
                <i class="bi bi-unlock-fill"></i>
              {% endif %}
              Invoice
            </span>

            {% set st = (r.status or '')|lower %}
            {% if st == 'paid' %}
              <span class="badge bg-success">PAID</span>
            {% elif st == 'partial' %}
              <span class="badge bg-info text-dark">PARTIAL</span>
            {% else %}
              <span class="badge bg-warning text-dark">PENDING</span>
            {% endif %}
          </div>

          <div class="mt-2 fw-bold ref-main">{{ r.reference_main }}</div>
          {% if r.reference_sub %}<div class="small text-muted">{{ r.reference_sub }}</div>{% endif %}

          <div class="small text-muted mt-2">
            {% if r.date %}
               {{ r.date.strftime("%b %d, %Y") }} ‚Ä¢ {{ r.date.strftime("%I:%M %p").lstrip("0") }}
            {% endif %}
          </div>

          <div class="mt-2 small">
            <div class="d-flex justify-content-between">
              <span class="text-muted">Amount Due</span>
              <span class="fw-bold">J$ {{ "{:,.2f}".format(r.amount_due or 0) }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-muted">Amount Paid</span>
              <span class="fw-bold">J$ {{ "{:,.2f}".format(r.amount_paid or 0) }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-muted">Amount Owed</span>
              <span class="fw-bold {% if (r.amount_owed or 0) > 0 %}text-danger{% endif %}">
                J$ {{ "{:,.2f}".format(r.amount_owed or 0) }}
             </span>
            </div>
          </div>

          <div class="small text-muted mt-2">
            <span class="me-2">Method:</span>
            {% set st = (r.status or '')|lower %}
            {% if st == 'pending' %}
              <span class="text-warning fw-semibold">Awaiting Payment</span>
            {% else %}
              {{ r.method or "‚Äî" }}
            {% endif %}
          </div>          
          <div class="mt-2 d-flex gap-3 small">
            <a href="#" class="txn-open text-primary">
              <i class="bi bi-eye-fill"></i> View
            </a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Pagination (preserve filters) -->
  {% if total_pages > 1 %}
  <nav class="d-flex justify-content-center mt-3" aria-label="Transactions pagination">
    <ul class="pagination pagination-sm mb-0">
      <li class="page-item {% if page <= 1 %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('customer.transactions_all', page=page-1, per_page=per_page, q=q, status=status, days=days) }}">
          &laquo;
        </a>
      </li>

      <li class="page-item disabled">
        <span class="page-link">Page {{ page }} of {{ total_pages }}</span>
      </li>

      <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('customer.transactions_all', page=page+1, per_page=per_page, q=q, status=status, days=days) }}">
          &raquo;
        </a>
      </li>
    </ul>
  </nav>
  {% endif %}

</div>

<!-- ================= RIGHT SLIDE PANEL (MOCKUP STYLE) ================= -->
<div class="txn-overlay" id="txnOverlay" aria-hidden="true"></div>

<aside class="txn-panel" id="txnPanel" aria-hidden="true">
  <div class="txn-panel-header bg-purple text-white">
    <div>
      <div class="small opacity-75">Transaction Details</div>
      <div class="fw-bold" id="panelTitle">‚Äî</div>
    </div>
    <button class="btn btn-sm btn-light" id="panelClose" type="button" aria-label="Close">‚úï</button>
  </div>

  <div class="txn-panel-body">
    <div class="txn-panel-meta">
      <div class="small text-muted">Customer</div>
      <div class="fw-bold">{{ current_user.full_name }} ‚Ä¢ {{ current_user.registration_number }}</div>
    </div>

    <div class="txn-panel-actions">
      <a href="#" class="btn btn-outline-secondary btn-sm w-100" id="panelPdfBtn" target="_blank" rel="noopener" style="display:none;">
        <i class="bi bi-file-earmark-pdf"></i> Open PDF
      </a>
    </div>

    <div class="txn-panel-content" id="panelBody">
      <div class="text-center py-5 text-muted">Select a transaction to view details.</div>
    </div>
  </div>
</aside>

<script>
(function(){
  const panel = document.getElementById("txnPanel");
  const overlay = document.getElementById("txnOverlay");
  const closeBtn = document.getElementById("panelClose");
  const body = document.getElementById("panelBody");
  const title = document.getElementById("panelTitle");
  const pdfBtn = document.getElementById("panelPdfBtn");

  function openPanel() {
    panel.classList.add("open");
    overlay.classList.add("show");
    panel.setAttribute("aria-hidden", "false");
    overlay.setAttribute("aria-hidden", "false");
    document.body.classList.add("no-scroll");
  }

  function closePanel() {
    panel.classList.remove("open");
    overlay.classList.remove("show");
    panel.setAttribute("aria-hidden", "true");
    overlay.setAttribute("aria-hidden", "true");
    document.body.classList.remove("no-scroll");
  }

  async function loadDetails(url) {
    body.innerHTML = `
      <div class="p-3">
        <div class="skeleton sk-line"></div>
        <div class="skeleton sk-line"></div>
        <div class="skeleton sk-line w-75"></div>
        <div class="skeleton sk-box mt-3"></div>
      </div>
    `;
    try {
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest", "X-Panel": "1" } });
      if (!res.ok) {
        body.innerHTML = `<div class="alert alert-danger m-3 mb-0">Failed to load (HTTP ${res.status}).</div>`;
        return;
      }
      body.innerHTML = await res.text();
    } catch (e) {
      body.innerHTML = `<div class="alert alert-danger m-3 mb-0">Failed to load details.</div>`;
    }
  }

  document.addEventListener("click", (e) => {
    const trigger = e.target.closest(".transaction-row, .transaction-card");
    const openLink = e.target.closest(".txn-open");
    if (!trigger && !openLink) return;

    // if they clicked the "View" link, still open panel
    const row = openLink ? e.target.closest(".transaction-row, .transaction-card") : trigger;
    if (!row) return;

    e.preventDefault();

    const url = row.getAttribute("data-url");
    const pdf = row.getAttribute("data-pdf") || "";
    const ref = row.querySelector(".ref-main") ? row.querySelector(".ref-main").innerText.trim() : "Details";

    title.textContent = ref;

    if (pdf) {
      pdfBtn.style.display = "";
      pdfBtn.href = pdf;
    } else {
      pdfBtn.style.display = "none";
      pdfBtn.href = "#";
    }

    openPanel();
    if (url) loadDetails(url);
  });

  closeBtn.addEventListener("click", closePanel);
  overlay.addEventListener("click", closePanel);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closePanel();
  });
})();
</script>

<style>
  :root{
    --fafl-purple:#4A148C;
  }
  .bg-purple{ background: var(--fafl-purple) !important; }
  .btn-purple{ background: var(--fafl-purple); color:#fff; border:1px solid var(--fafl-purple); }
  .btn-purple:hover{ filter: brightness(.92); color:#fff; }

  .txn-wrap{ max-width:1100px; }
  .pill-icon{ width:48px; height:48px; display:flex; align-items:center; justify-content:center; border-radius:14px; font-size:20px; }

  .chip{
    border:1px solid #e5e7eb;
    background:#f8fafc;
    padding:.35rem .6rem;
    border-radius:999px;
  }

  .txn-card{
    overflow:hidden;
    border:1px solid #e5e7eb;
    border-radius:14px;
  }
  .txn-table thead th{ padding:.85rem .85rem; white-space:nowrap; }
  .txn-table tbody td{ padding:.8rem .85rem; }
  .table-purple th{ background: var(--fafl-purple) !important; color:#fff; }
  .transaction-row:hover td{ background:#f7f3ff; cursor:pointer; }

  .ref-main{ font-weight:800; }
  .ref-sub{ font-size:.82rem; color:#6b7280; }

  /* Panel + overlay like mockup */
  .no-scroll{ overflow:hidden; }
  .txn-overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.35);
    opacity:0; pointer-events:none;
    transition:.2s ease;
    z-index:1049;
  }
  .txn-overlay.show{ opacity:1; pointer-events:auto; }

  .txn-panel{
    position:fixed; top:0; right:-460px;
    width:460px; height:100vh;
    background:#fff;
    box-shadow:-12px 0 30px rgba(0,0,0,.18);
    transition:.25s ease;
    z-index:1050;
    display:flex; flex-direction:column;
  }
  .txn-panel.open{ right:0; }

  .txn-panel-header{
    padding:14px 16px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .txn-panel-body{ padding:14px 16px; overflow:auto; }
  .txn-panel-meta{
    padding:12px 12px;
    border:1px solid #e5e7eb;
    border-radius:14px;
    background:#fafafa;
    margin-bottom:12px;
  }
  .txn-panel-actions{ margin-bottom:12px; }

  /* Make whatever your partial returns look ‚Äúpremium‚Äù */
  .txn-panel-content .card{ border-radius:14px !important; }
  .txn-panel-content table{ width:100%; }
  .txn-panel-content .table{ margin-bottom:0; }
  .txn-panel-content .table th{ background:#f3f4f6; }
  .txn-panel-content hr{ opacity:.15; }

  /* Skeleton */
  .skeleton{ background:linear-gradient(90deg,#f2f2f2,#e9e9e9,#f2f2f2); background-size:200% 100%; animation:shimmer 1.2s infinite; border-radius:10px; }
  .sk-line{ height:14px; margin:10px 0; }
  .sk-box{ height:140px; }
  .w-75{ width:75%; }
  @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

  @media (max-width: 576px){
    .txn-panel{ width:100%; right:-100%; }
  }

  .txn-table td.text-nowrap { letter-spacing: .2px; }
  .txn-owed{
    background:#fff7ed;
    border-radius:8px;
 }
 .txn-table thead th{
   position: sticky;
   top: 0;
   z-index: 2;
   background: var(--fafl-purple) !important;
 }

</style>
{% endblock %}

