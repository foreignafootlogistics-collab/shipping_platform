{# app/templates/partials/package_row_shared.html #}

{% set _id = pkg.id if pkg.id is defined else pkg.get('id') %}
{% set _user_id = pkg.user_id if pkg.user_id is defined else pkg.get('user_id') %}
{% set _invoice_id = pkg.invoice_id if pkg.invoice_id is defined else pkg.get('invoice_id') %}

{% set _full_name = pkg.full_name if pkg.full_name is defined else pkg.get('full_name') %}
{% set _reg = pkg.registration_number if pkg.registration_number is defined else pkg.get('registration_number') %}

{% set _status = pkg.status if pkg.status is defined else pkg.get('status') %}
{% set _tracking = pkg.tracking_number if pkg.tracking_number is defined else pkg.get('tracking_number') %}
{% set _house = pkg.house_awb if pkg.house_awb is defined else pkg.get('house_awb') %}
{% set _desc = pkg.description if pkg.description is defined else pkg.get('description') %}

{% set _date_received = pkg.date_received if pkg.date_received is defined else pkg.get('date_received') %}
{% set _weight = pkg.weight if pkg.weight is defined else pkg.get('weight') %}

{% set _declared = pkg.declared_value if pkg.declared_value is defined else pkg.get('declared_value') %}
{% set _value = pkg.value if pkg.value is defined else pkg.get('value') %}
{% set _amount_due = pkg.amount_due if pkg.amount_due is defined else pkg.get('amount_due') %}

{% set _attachments = pkg.attachments if pkg.attachments is defined else pkg.get('attachments') %}
{% set _epc = pkg.epc if pkg.epc is defined else pkg.get('epc') %}

{% set dv = _declared if _declared is not none else (_value if _value is not none else 0) %}
{% set _invoice_total = pkg.invoice_total if pkg.invoice_total is defined else pkg.get('invoice_total') %}
{% set _invoice_paid  = pkg.invoice_paid if pkg.invoice_paid is defined else pkg.get('invoice_paid') %}
<tr>

{% if mode == "admin" %}

{# ===================== ADMIN MODE ===================== #}

<td>
  <input type="checkbox"
         name="package_ids"
         value="{{ _id }}"
         class="package-checkbox"
         form="bulkActionForm">

  <div class="d-flex flex-column align-items-start gap-1 mt-1">

    {# SMALLER CALCULATOR (top) #}
    {% if _invoice_id %}
      <a href="#"
         onclick="viewInvoiceById({{ _invoice_id }}); return false;"
         class="btn btn-sm btn-outline-purple p-1"
         title="View Existing Invoice">
        <i class="fas fa-calculator fa-sm"></i>
      </a>
    {% else %}
      <a href="#"
         onclick="viewInvoiceByUser({{ _user_id }}); return false;"
         class="btn btn-sm btn-outline-purple p-1"
         title="Preview (Pro-forma)">
        <i class="fas fa-calculator fa-sm"></i>
      </a>
    {% endif %}

    {# NEW: SMALL ATTACH ICON BELOW CALCULATOR #}
    <button type="button"
            class="btn btn-sm btn-outline-secondary p-1 js-open-attach"
            title="Attach Invoice"
            data-bs-toggle="modal"
            data-bs-target="#attachInvoiceModal"
            data-pkg-id="{{ _id }}">
      <i class="fas fa-paperclip fa-sm"></i>
    </button>

  </div>
</td>

<td>
  <strong>
    <a href="{{ url_for('accounts_profiles.view_user', id=_user_id) }}"
       class="text-purple text-decoration-none">
      {{ _full_name or '-' }}
    </a>
  </strong><br>
  <small class="text-muted">{{ _reg or '-' }}</small>
</td>

<td>
  {% set status = _status %}
  {% include 'partials/status_vars.html' %}
  {% include 'partials/status_tracker.html' with context %}
  <br>
  <small class="text-muted">{{ _tracking or '-' }}</small>
</td>

<td>
  {{ _house or '-' }}
  {% if _epc %}
    <span class="badge badge-epc ms-1">
      <i class="bi bi-flag-fill" style="font-size:0.60rem;"></i> EPC
    </span>
  {% endif %}
</td>

<td>
  <div>{{ _desc or '-' }}</div>

  {% if _attachments and (_attachments|length > 0) %}
    <div class="mt-1 d-flex flex-wrap gap-2">
      {% for a in _attachments %}
        {% set aid = a.id if a.id is defined else a.get('id') %}
        {% set aname = (a.original_name if a.original_name is defined else a.get('original_name')) %}
        {% set fname = (a.file_name if a.file_name is defined else a.get('file_name')) %}

        <div class="d-inline-flex align-items-center gap-1">
          <a class="btn btn-sm"
             style="background:#f5f0fa; border:1px solid #4a148c; color:#4a148c; padding:.2rem .45rem;"
             target="_blank"
             href="{{ url_for('logistics.view_package_attachment', attachment_id=aid) }}"
             title="{{ aname or fname }}">
            <i class="fa-solid fa-file-lines"></i>
          </a>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</td>

<td>
  {% if _date_received %}
    {% if _date_received.strftime is defined %}
      {{ _date_received.strftime("%Y-%m-%d") }}
    {% else %}
      {{ (_date_received|string)[:10] }}
    {% endif %}
  {% else %}
    -
  {% endif %}
</td>

<td>
  {% if _weight is not none %}
    {{ _weight }} ({{ (_weight|float)|round(0,'ceil')|int }})
    <input type="hidden" id="weight_{{ _id }}" value="{{ _weight }}">
  {% else %}
    -
  {% endif %}
</td>

<td class="text-center">
  {{ "%.2f"|format(dv or 0) }}
</td>

<td class="text-center">
  {{ "%.2f"|format(_amount_due if _amount_due is not none else 0) }}
</td>

<td class="d-none">{{ 1 if _epc else 0 }}</td>

{% else %}

{# ===================== CUSTOMER MODE ===================== #}

{% set lock_docs = (status_l in ['ready for pick up', 'delivered']) %}
{% set is_paid = (status_l in ['delivered']) %}
{% set amount_to_show = (_amount_due if _amount_due is not none else 0) %}
{% set show_amount = (_invoice_id is not none) %}

<td class="text-center align-middle">
  <button type="button"
          class="btn btn-sm btn-outline-secondary {% if lock_docs %}disabled{% endif %}"
          data-bs-toggle="modal"
          data-bs-target="#docsModal{{ _id }}"
          title="Upload Invoices">
    <i class="fas {% if lock_docs %}fa-lock{% else %}fa-file-upload{% endif %}"></i>
  </button>

  {% if _attachments and (_attachments|length > 0) %}
    <div class="small text-success mt-1">
      <i class="fas fa-check-circle"></i>
    </div>
  {% endif %}
</td>

<td class="pkg-cell">
  {% set status = _status %}
  {% include "partials/status_vars.html" %}
  <strong>{{ _house or "-" }}</strong><br>
  {% include "partials/status_tracker.html" with context %}
  <div class="small text-muted mt-1">VAL: ${{ "%.2f"|format(dv or 0) }}</div>
</td>

<td>
  {{ _desc or "-" }}

  {% if _attachments and (_attachments|length > 0) %}
    <div class="small mt-1 d-flex gap-2 flex-wrap">
      {% for a in _attachments %}
        {% set aid = a.id if a.id is defined else a.get('id') %}
        {% set fname = (a.file_name if a.file_name is defined else a.get('file_name')) %}
        {% set f = (fname or '')|string %}

        {% if f.startswith("http://") or f.startswith("https://") %}
          <a class="pkg-attachment" href="{{ f }}" target="_blank">
            <i class="fas fa-file-alt"></i>
          </a>
        {% else %}
          <a class="pkg-attachment"
             href="{{ url_for('customer.view_package_attachment', attachment_id=aid) }}"
             target="_blank">
            <i class="fas fa-file-alt"></i>
          </a>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
</td>

<td>{{ _tracking or "-" }}</td>

<td class="text-center">
  {% if _weight is not none %}
    {{ (_weight|float)|round(0,'ceil')|int }}
  {% else %}
    —
  {% endif %}
</td>

<td class="text-center">
  {% if _date_received %}
    {% if _date_received.strftime is defined %}
      {{ _date_received.strftime("%Y-%m-%d") }}
    {% else %}
      {{ (_date_received|string)[:10] }}
    {% endif %}
  {% else %}
    —
  {% endif %}
</td>

<td class="text-center">

  {% set status_l = (_status or '')|lower %}
  {% set has_invoice = (_invoice_id is not none and _invoice_id != 0) %}

  {# values from fetch_packages_normalized #}
  {% set inv_total   = pkg.invoice_total if pkg.invoice_total is defined else pkg.get('invoice_total') %}
  {% set inv_paid    = pkg.invoice_paid_sum if pkg.invoice_paid_sum is defined else pkg.get('invoice_paid_sum') %}
  {% set inv_balance = pkg.invoice_balance if pkg.invoice_balance is defined else pkg.get('invoice_balance') %}
  {% set inv_is_paid = pkg.invoice_paid if pkg.invoice_paid is defined else pkg.get('invoice_paid') %}

  {# PACKAGE amount (top line) #}
  {% set package_due = (_amount_due if _amount_due is not none else 0) %}

  {# fallbacks #}
  {% set inv_total = inv_total if inv_total is not none else package_due %}
  {% set inv_paid = inv_paid if inv_paid is not none else 0 %}
  {% set inv_balance = inv_balance if inv_balance is not none else inv_total %}
  {% set inv_is_paid = true if inv_is_paid else false %}

  {# partial paid #}
  {% set is_partial = (has_invoice and (inv_paid|float > 0) and (inv_balance|float > 0)) %}

  {# ===================== NOT INVOICED ===================== #}
  {% if not has_invoice %}

    {% if status_l == 'overseas' %}
      <span class="text-muted small">Awaiting Processing</span>

    {% elif status_l == 'received at local port' %}
      <span class="text-warning small fw-semibold">Processing Charges</span>

    {% else %}
      &nbsp;  {# blank, no dash #}
    {% endif %}

  {# ===================== INVOICED ===================== #}
  {% else %}

    {# READY FOR PICK UP #}
    {% if status_l == 'ready for pick up' %}
      <div class="fw-semibold text-danger">
        {{ package_due|jmd }}
      </div>

      <div class="small text-muted mt-1">
        Invoice Total {{ (inv_total or 0)|jmd }}
      </div>

      {% if is_partial %}
        <div class="small text-primary mt-1 fw-semibold">
          Partial Paid • Paid {{ (inv_paid or 0)|jmd }}
        </div>
      {% endif %}

    {# DELIVERED #}
    {% elif status_l == 'delivered' %}
      <div class="fw-semibold text-danger">
        {{ package_due|jmd }}
      </div>

      <div class="small text-muted mt-1">
        Invoice Total {{ (inv_total or 0)|jmd }}
      </div>

      {% if inv_is_paid or (inv_balance|float <= 0.00001) %}
        <div class="mt-1 d-flex justify-content-center">
          <img
            src="{{ url_for('static', filename='images/paid-stamp.png') }}"
            alt="PAID"
            style="height:36px; opacity:0.85; transform: rotate(-8deg);"
          >
        </div>

      {% elif is_partial %}
        <div class="small text-primary mt-1 fw-semibold">
          Partial Paid • Paid {{ (inv_paid or 0)|jmd }}
        </div>

      {% else %}
        <div class="small text-danger mt-1 fw-semibold">
          Balance {{ (inv_balance or 0)|jmd }}
        </div>
      {% endif %}

    {# OTHER INVOICED STATUSES #}
    {% else %}
      <div class="fw-semibold text-danger">
        {{ package_due|jmd }}
      </div>

      <div class="small text-muted mt-1">
        Invoice Total {{ (inv_total or 0)|jmd }}
      </div>

      {% if is_partial %}
        <div class="small text-primary mt-1 fw-semibold">
          Partial Paid • Paid {{ (inv_paid or 0)|jmd }}
        </div>
      {% endif %}
    {% endif %}

  {% endif %}

</td>

{% endif %}
</tr>
