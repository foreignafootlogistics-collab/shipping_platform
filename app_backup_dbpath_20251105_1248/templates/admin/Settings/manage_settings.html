{# templates/admin/settings/manage_settings.html #}
{% extends 'layout_admin.html' %}
{% block title %}Manage Settings{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  :root { --brand:#4a148c; }
  .help { font-size:.85rem; color:#6c757d; }
  .shadow-soft { box-shadow: 0 6px 16px rgba(0,0,0,.05); }
  .card-hint { background:#f7f4fb; border-left:4px solid var(--brand); }
</style>

<div class="container mt-4">
  <h2 class="mb-4">Manage Settings</h2>

  {# Flash messages #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {# Tabs #}
  <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="company-tab" data-bs-toggle="tab" data-bs-target="#companyInfo" type="button" role="tab">
        Company Info
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="rates-tab" data-bs-toggle="tab" data-bs-target="#ratesFees" type="button" role="tab">
        Rates & Fees
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="branches-tab" data-bs-toggle="tab" data-bs-target="#branchesLocations" type="button" role="tab">
        Branches & Locations
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="terms-tab" data-bs-toggle="tab" data-bs-target="#termsServices" type="button" role="tab">
        Terms & Services
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="display-tab" data-bs-toggle="tab" data-bs-target="#display" type="button" role="tab">
        <i class="bi bi-palette me-1"></i> Display & Formats
      </button>
    </li>
  </ul>

  {# Tab Contents #}
  <div class="tab-content mt-3" id="settingsTabsContent">

    {# ---------------- Company Info ---------------- #}
    <div class="tab-pane fade show active" id="companyInfo" role="tabpanel" aria-labelledby="company-tab">
      <div class="card shadow-soft mb-4">
        <div class="card-body">
          <div class="card card-hint mb-3">
            <div class="card-body py-2">
              <i class="bi bi-info-circle me-2"></i>
              These details appear on invoices, receipts, emails, and the admin sidebar.
            </div>
          </div>

          <div class="row g-3 align-items-center mb-3">
            <div class="col-auto">
              <div class="border rounded p-2 bg-white shadow-sm" style="width:140px;height:140px;display:flex;align-items:center;justify-content:center;">
                {% if settings and settings.logo_path %}
                  <img id="logoPreview" src="{{ url_for('static', filename=settings.logo_path) }}" alt="Logo" style="max-width:100%;max-height:100%;">
                {% else %}
                  <img id="logoPreview" src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="max-width:100%;max-height:100%;">
                {% endif %}
              </div>
            </div>
            <div class="col">
              <form method="post" action="{{ url_for('settings.update_logo') }}" enctype="multipart/form-data" class="d-flex gap-2">
                <input class="form-control" type="file" name="logo_file" accept=".png,.jpg,.jpeg,.gif,.svg,.webp" id="logoInput">
                <button class="btn btn-outline-primary"><i class="bi bi-upload me-1"></i>Upload Logo</button>
              </form>
              <div class="help mt-1">PNG or SVG recommended. Shown in sidebar, invoices and receipts.</div>
            </div>
          </div>

          <form method="POST" action="{{ url_for('settings.update_company_info') }}" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Company Name</label>
              <input type="text" class="form-control" name="company_name" value="{{ settings.company_name if settings else '' }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Contact Email</label>
              <input type="email" class="form-control" name="company_email" value="{{ settings.company_email if settings else '' }}" required>
            </div>
            <div class="col-12">
              <label class="form-label">Address</label>
              <textarea class="form-control" name="company_address" rows="2">{{ settings.company_address if settings else '' }}</textarea>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> Save Company Info</button>
              <button type="reset" class="btn btn-outline-secondary"><i class="bi bi-arrow-counterclockwise me-1"></i> Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {# ---------------- Rates & Fees ---------------- #}
    <div class="tab-pane fade" id="ratesFees" role="tabpanel" aria-labelledby="rates-tab">
      <div class="card shadow-soft mb-4">
        <div class="card-body">
          <div class="card card-hint mb-3">
            <div class="card-body py-2">
              <i class="bi bi-calculator me-2"></i>
              Base rate typically drives freight; handling fee is applied per package.
            </div>
          </div>

          <form method="POST" action="{{ url_for('settings.update_rates') }}" class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Base Rate (JMD/lb)</label>
              <div class="input-group">
                <span class="input-group-text">JMD</span>
                <input type="number" step="0.01" class="form-control" name="base_rate" value="{{ settings.base_rate if settings else 0 }}">
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Handling Fee (JMD)</label>
              <div class="input-group">
                <span class="input-group-text">JMD</span>
                <input type="number" step="0.01" class="form-control" name="handling_fee" value="{{ settings.handling_fee if settings else 0 }}">
              </div>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-success"><i class="bi bi-check2-circle me-1"></i> Save Rates & Fees</button>
              <a class="btn btn-outline-secondary" href="{{ url_for('admin.view_rates') }}">
                <i class="bi bi-table me-1"></i> Manage Rate Brackets
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>

    {# -------------- Branches & Locations -------------- #}
    <div class="tab-pane fade" id="branchesLocations" role="tabpanel" aria-labelledby="branches-tab">
      <div class="card shadow-soft mb-4">
        <div class="card-body">
          <div class="card card-hint mb-3">
            <div class="card-body py-2">
              <i class="bi bi-geo-alt me-2"></i>
              Keep one branch per line. Example: <code>Kingston HQ — 12 Port Lane, (876) 955-0123</code>
            </div>
          </div>

          <form method="POST" action="{{ url_for('settings.update_branches') }}">
            <label class="form-label">Branches</label>
            <textarea class="form-control" name="branches" rows="6" placeholder="Kingston HQ — 12 Port Lane, (876) 955-0123&#10;Montego Bay — ...">{{ settings.branches if settings else '' }}</textarea>
            <div class="d-flex gap-2 mt-3">
              <button type="submit" class="btn btn-info text-white"><i class="bi bi-check2-circle me-1"></i> Save Branches & Locations</button>
              <button type="reset" class="btn btn-outline-secondary"><i class="bi bi-arrow-counterclockwise me-1"></i> Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {# ---------------- Terms & Services ---------------- #}
    <div class="tab-pane fade" id="termsServices" role="tabpanel" aria-labelledby="terms-tab">
      <div class="card shadow-soft mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-lg-6">
              <form method="post" action="{{ url_for('settings.update_terms') }}">
                <label class="form-label">Terms & Services</label>
                <textarea id="termsInput" class="form-control autosize" name="terms" rows="12"
                          placeholder="Enter your standard shipping terms, payment terms, insurance policy, prohibited items, etc.">{{ settings.terms if settings else '' }}</textarea>
                <div class="d-flex gap-2 mt-3">
                  <button class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> Save Terms</button>
                  <button class="btn btn-outline-secondary" type="reset"><i class="bi bi-arrow-counterclockwise me-1"></i> Reset</button>
                  <button type="button" id="previewBtn" class="btn btn-outline-dark">
                    <i class="bi bi-eye me-1"></i> Preview
                  </button>
                </div>
              </form>
            </div>
            <div class="col-lg-6">
              <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <strong>Live Preview</strong>
                  <span class="small text-muted">Rendered HTML</span>
                </div>
                <div id="termsPreview" class="card-body" style="min-height: 280px; overflow:auto;">
                  <!-- preview content appears here -->
                </div>
              </div>
            </div>
          </div> <!-- /row -->
        </div>
      </div>
    </div>

    {# -------------- Display & Formats -------------- #}
    <div class="tab-pane fade" id="display" role="tabpanel" aria-labelledby="display-tab">
      <div class="card shadow-soft mb-4">
        <div class="card-body">
          <div class="card card-hint mb-3">
            <div class="card-body py-2">
              <i class="bi bi-gear me-2"></i>
              Choose default currency & date format for admin/customer UIs & PDFs.
            </div>
          </div>

          <form method="post" action="{{ url_for('settings.update_display') }}" class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Currency Code</label>
              <input type="text" class="form-control" name="currency_code"
                     value="{{ settings.currency_code if settings else 'USD' }}" placeholder="USD / JMD">
            </div>
            <div class="col-md-3">
              <label class="form-label">Currency Symbol</label>
              <input type="text" class="form-control" name="currency_symbol"
                     value="{{ settings.currency_symbol if settings else '$' }}" placeholder="$ / J$">
            </div>
            <div class="col-md-3">
              <label class="form-label">USD → JMD Rate</label>
              <div class="input-group">
                <span class="input-group-text">1 USD =</span>
                <input type="number" step="0.0001" class="form-control" name="usd_to_jmd"
                       value="{{ settings.usd_to_jmd if settings else 155 }}">
                <span class="input-group-text">JMD</span>
              </div>
              <div class="help mt-1">Used by toggles on dashboards (display only).</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Date Format</label>
              <input type="text" class="form-control" name="date_format"
                     value="{{ settings.date_format if settings else '%Y-%m-%d' }}" placeholder="%Y-%m-%d">
              <div class="help mt-1">Python/strftime format (e.g., %d %b %Y).</div>
            </div>

            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> Save Display</button>
            </div>
          </form>

        </div>
      </div>
    </div>

  </div> {# /tab-content #}

</div> {# /container #}
{% endblock %}

{% block scripts %}
<script>
  // Logo live preview
  const logoInput = document.getElementById('logoInput');
  if (logoInput) {
    logoInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const img = document.getElementById('logoPreview');
      if (img) img.src = url;
    });
  }

  // Terms live preview (naive; for admin only)
  const termsInput  = document.getElementById('termsInput');
  const termsPreview= document.getElementById('termsPreview');
  const previewBtn  = document.getElementById('previewBtn');
  function renderTerms(){ if(termsPreview && termsInput){ termsPreview.innerHTML = termsInput.value; } }
  if (previewBtn){ previewBtn.addEventListener('click', renderTerms); }
  renderTerms();

  // (Optional) remember active tab
  const key='faf_settings_tab';
  const tabs = document.querySelectorAll('#settingsTabs button[data-bs-toggle="tab"]');
  tabs.forEach(btn=>{
    btn.addEventListener('shown.bs.tab', e => localStorage.setItem(key, e.target.getAttribute('data-bs-target')));
  });
  const saved = localStorage.getItem(key);
  if(saved){
    const t = document.querySelector(`#settingsTabs button[data-bs-target="${saved}"]`);
    if(t){ new bootstrap.Tab(t).show(); }
  }

  // Autosize textareas
  function autosize(el){ el.style.height='auto'; el.style.height = (el.scrollHeight)+'px'; }
  document.querySelectorAll('.autosize').forEach(t=>{ autosize(t); t.addEventListener('input',()=>autosize(t)); });
</script>
{% endblock %}
