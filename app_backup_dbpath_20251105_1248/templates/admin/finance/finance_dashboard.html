{# templates/admin/finance/finance_dashboard.html #}
{% extends 'layout_admin.html' %}
{% block title %}Finance Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<style>
  :root { --brand:#4a148c; --ink:#2f2b3a; }
  .brand{ color:var(--brand)!important; }
  .card-kpi{ border-left:4px solid var(--brand); transition:transform .2s ease, box-shadow .2s ease; }
  .card-kpi:hover{ transform:translateY(-3px); box-shadow:0 .5rem 1rem rgba(0,0,0,.15); }
  .hover-shadow:hover .fs-4{ text-decoration:underline; }
  .table thead.table-dark{ background:var(--ink); }
  .nav-tabs .nav-link.active{ color:#fff; background:var(--brand); border-color:var(--brand); }
  .nav-tabs .nav-link{ color:var(--brand); }
  .chip{ display:inline-block; padding:.25rem .5rem; border-radius:50rem; background:#f1f1f1; font-size:.8rem; }
</style>

<div class="container mt-4">
  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0"><span class="brand">Foreign A Foot</span> • Finance Dashboard</h3>
    <div class="d-flex align-items-center gap-3">
      <div class="small text-muted">Period: <strong>{{ start }}</strong> → <strong>{{ end }}</strong></div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="currencyToggle">
        <label class="form-check-label" for="currencyToggle"><span id="currLabel">JMD</span> ↔ USD</label>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <form class="row g-2 align-items-end mb-4" method="get">
    <div class="col-auto">
      <label class="form-label mb-0">Month</label>
      <input type="month" class="form-control" name="month" value="{{ start[:7] if start else '' }}">
    </div>
    <div class="col-auto">
      <label class="form-label mb-0">Start</label>
      <input type="date" class="form-control" name="start" value="{{ start }}">
    </div>
    <div class="col-auto">
      <label class="form-label mb-0">End</label>
      <input type="date" class="form-control" name="end" value="{{ end }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary"><i class="bi bi-funnel"></i> Apply</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('finance.finance_dashboard') }}"><i class="bi bi-arrow-counterclockwise"></i> Reset</a>
    </div>
  </form>

  {% set role = (user_role|default('Admin'))|string|lower %}

  <!-- KPI Cards -->
  <div class="row g-3 mb-4">
    {% if role in ['admin','financemanager','clerk'] %}
    <div class="col-md-3">
      <a href="{{ url_for('finance.monthly_income') }}" class="text-decoration-none">
        <div class="card card-kpi shadow-sm h-100 hover-shadow">
          <div class="card-body">
            <div class="text-muted">Paid</div>
            <div class="fs-4 fw-bold brand money" data-jmd="{{ (total_paid or 0)|float }}">0</div>
          </div>
        </div>
      </a>
    </div>
    {% endif %}

    {% if role in ['admin','financemanager'] %}
    <div class="col-md-3">
      <a href="{{ url_for('finance.add_expense') }}" class="text-decoration-none">
        <div class="card card-kpi shadow-sm h-100 hover-shadow">
          <div class="card-body">
            <div class="text-muted">Expenses</div>
            <div class="fs-4 fw-bold text-danger money" data-jmd="{{ (total_expenses or 0)|float }}">0</div>
          </div>
        </div>
      </a>
    </div>
    {% endif %}

    {% if role in ['admin','financemanager','clerk'] %}
    <div class="col-md-3">
      <div class="card card-kpi shadow-sm h-100 hover-shadow position-relative">
        <div class="card-body">
          <div class="text-muted">Amount Due (Issued/Unpaid)</div>
          <a
            href="{{ url_for('finance.unpaid_invoices', start=start, end=end, status='pending,issued,unpaid') }}"
            class="stretched-link text-decoration-none"
            title="Open receivables for this period"
          ></a>
          <div class="fs-4 fw-bold text-warning money" data-jmd="{{ (total_amount_due or 0)|float }}">0</div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if role in ['admin','financemanager'] %}
    <div class="col-md-3">
      <a href="{{ url_for('finance.monthly_profit_loss') }}" class="text-decoration-none">
        <div class="card card-kpi shadow-sm h-100 hover-shadow">
          <div class="card-body">
            <div class="text-muted">Net (Paid − Expenses)</div>
            {% set _net = (net or 0)|float %}
            <div class="fs-4 fw-bold money {{ 'text-success' if _net>=0 else 'text-danger' }}" data-jmd="{{ _net }}">0</div>
            <div class="small"><span class="chip" id="currChip">JMD</span></div>
          </div>
        </div>
      </a>
    </div>
    {% endif %}
  </div>

  <!-- Charts + Aging -->
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Paid Trend</h6>
            <span class="small text-muted">Daily</span>
          </div>
          <canvas id="paidChart" height="120"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="mb-3">Expense Mix</h6>
          <canvas id="expenseChart" height="140"></canvas>
        </div>
      </div>
    </div>

    {% if role in ['admin','clerk'] %}
    <div class="col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="mb-3">A/R Aging</h6>
          <ul class="list-group small">
            <li class="list-group-item d-flex justify-content-between">
              <span>0–30</span>
              <strong class="money" data-jmd="{{ (aging['0-30'] or 0)|float }}">0</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>31–60</span>
              <strong class="money" data-jmd="{{ (aging['31-60'] or 0)|float }}">0</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>61–90</span>
              <strong class="money" data-jmd="{{ (aging['61-90'] or 0)|float }}">0</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>91+</span>
              <strong class="money" data-jmd="{{ (aging['91+'] or 0)|float }}">0</strong>
            </li>
          </ul>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Top Customers -->
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Top Customers (Paid)</h6>
          </div>
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr><th>Customer</th><th class="text-end">Paid</th></tr>
            </thead>
            <tbody>
              {% for r in top_customers %}
              <tr>
                <td>{{ r.customer }}</td>
                <td class="text-end money" data-jmd="{{ (r.total or 0)|float }}">0</td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="text-muted text-center">No data.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs: Tables -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#paidTab" type="button">Paid Invoices</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#dueTab" type="button">Amount Due (Issued)</button></li>
  </ul>

  <div class="tab-content border border-top-0 rounded-bottom p-3 bg-white shadow-sm">
    <div class="tab-pane fade show active" id="paidTab">
      <div class="table-responsive">
        <table id="paidTable" class="table table-striped table-hover align-middle w-100">
          <thead class="table-dark">
            <tr><th>Invoice #</th><th>Customer</th><th class="text-end">Amount</th><th>Date Paid</th></tr>
          </thead>
          <tbody>
            {% for r in paid_rows %}
            <tr>
              <td><a href="{{ url_for('admin.view_invoice', invoice_id=r['invoice_id']) }}" class="text-decoration-none">{{ r['invoice_number'] or r['invoice_id'] }}</a></td>
              <td>{{ r['customer'] }}</td>
              <td class="text-end money" data-jmd="{{ (r['amount'] or 0)|float }}">0</td>
              <td>{{ r['date_paid'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="tab-pane fade" id="dueTab">
      <div class="table-responsive">
        <table id="dueTable" class="table table-striped table-hover align-middle w-100">
          <thead class="table-dark">
            <tr><th>Invoice #</th><th>Customer</th><th class="text-end">Amount Due</th><th>Date Issued</th></tr>
          </thead>
          <tbody>
            {% for r in due_rows %}
            <tr>
              <td><a href="{{ url_for('admin.view_invoice', invoice_id=r['invoice_id']) }}" class="text-decoration-none">{{ r['invoice_number'] or r['invoice_id'] }}</a></td>
              <td>{{ r['customer'] }}</td>
              <td class="text-end money" data-jmd="{{ (r['amount_due'] or 0)|float }}">0</td>
              <td>{{ r['date_issued'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
  /* ---------- Currency Toggle (JMD base) ---------- */
  const USD_TO_JMD = {{ usd_to_jmd|float }};
  const moneyEls = () => document.querySelectorAll('.money');
  const currLabel = document.getElementById('currLabel');
  const currChip  = document.getElementById('currChip');
  const toggle    = document.getElementById('currencyToggle');

  function fmt(n, curr) {
    const v = Number(n || 0);
    return (curr === 'USD') ? v.toFixed(2) : v.toLocaleString(undefined, {maximumFractionDigits:0});
  }

  function renderCurrency(curr){
    moneyEls().forEach(el => {
      const jmd = parseFloat(el.getAttribute('data-jmd') || '0'); // base = JMD
      const val = (curr === 'USD') ? (jmd / USD_TO_JMD) : jmd;
      el.textContent = fmt(val, curr);
    });
    if (currLabel) currLabel.textContent = curr;
    if (currChip)  currChip.textContent  = curr;
    localStorage.setItem('faf_currency', curr);
  }

  const saved = localStorage.getItem('faf_currency') || 'JMD';
  if (toggle) toggle.checked = (saved === 'USD');       // checked = show USD
  renderCurrency(saved);
  if (toggle) toggle.addEventListener('change', () =>
    renderCurrency(toggle.checked ? 'USD' : 'JMD')
  );

  /* ---------- Charts ---------- */
  const paidCtx = document.getElementById('paidChart').getContext('2d');
  new Chart(paidCtx, {
    type: 'line',
    data: { labels: {{ paid_labels|tojson }},
      datasets: [{ label:'Paid', data: {{ paid_values|tojson }}, tension:.25, fill:false }] },
    options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
  });

  const expenseCtx = document.getElementById('expenseChart').getContext('2d');
  new Chart(expenseCtx, {
    type: 'doughnut',
    data: { labels: {{ exp_labels|tojson }}, datasets: [{ data: {{ exp_values|tojson }} }] },
    options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
  });

  /* ---------- DataTables ---------- */
  const dtOpts = {
    pageLength: 10,
    dom: 'Bfrtip',
    buttons: ['copyHtml5','excelHtml5','csvHtml5','print'],
    columnDefs: [{ targets: [2], className: 'text-end' }]
  };
  $(function(){
    $('#paidTable').DataTable(dtOpts);
    $('#dueTable').DataTable(dtOpts);
  });
</script>
{% endblock %}


