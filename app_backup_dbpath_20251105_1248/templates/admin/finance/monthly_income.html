{% extends 'layout_admin.html' %}
{% block title %}Monthly Income{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Monthly Income</h2>

  <ul class="nav nav-tabs" id="incomeTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="paid-tab" data-bs-toggle="tab" data-bs-target="#paid" type="button" role="tab">Paid</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="due-tab" data-bs-toggle="tab" data-bs-target="#due" type="button" role="tab">Amount Due</button>
    </li>
  </ul>

  <div class="tab-content mt-3" id="incomeTabsContent">
    <!-- PAID TAB -->
    <div class="tab-pane fade show active" id="paid" role="tabpanel" aria-labelledby="paid-tab">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Paid Invoices ({{ incomes|length }})</h5>
            <p class="fw-bold text-success mb-0">Total Paid: ${{ '%.2f'|format(total_income) }}</p>
          </div>

          <div class="table-responsive mb-4">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Invoice ID</th>
                  <th>Customer</th>
                  <th>Amount</th>
                  <th>Date Paid</th>
                </tr>
              </thead>
              <tbody>
                {% for income in incomes %}
                <tr>
                  <td>{{ income.invoice_number }}</td>
                  <td>{{ income.customer_name }}</td>
                  <td>${{ '%.2f'|format(income.amount) }}</td>
                  <td>{{ income.date_paid|default('-', true) }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4" class="text-center text-muted">No paid invoices for this month.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Daily Paid Overview</h5>
              <canvas id="incomeChart" height="100"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AMOUNT DUE TAB -->
    <div class="tab-pane fade" id="due" role="tabpanel" aria-labelledby="due-tab">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Invoices Issued (Unpaid) This Month ({{ due_rows|length }})</h5>
            <p class="fw-bold text-warning mb-0">Total Amount Due: ${{ '%.2f'|format(total_amount_due) }}</p>
          </div>

          <div class="table-responsive mb-4">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Invoice ID</th>
                  <th>Customer</th>
                  <th>Amount Due</th>
                  <th>Date Issued</th>
                </tr>
              </thead>
              <tbody>
                {% for row in due_rows %}
                <tr>
                  <td>{{ row.invoice_number }}</td>
                  <td>{{ row.customer_name }}</td>
                  <td>${{ '%.2f'|format(row.amount_due) }}</td>
                  <td>{{ row.date_issued|default('-', true) }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4" class="text-center text-muted">No unpaid invoices issued this month.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Daily Issued Amount Due</h5>
              <canvas id="dueChart" height="100"></canvas>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Paid
  const paidCtx = document.getElementById('incomeChart').getContext('2d');
  new Chart(paidCtx, {
    type: 'bar',
    data: {
      labels: {{ chart_labels | tojson }},
      datasets: [{ label: 'Daily Paid ($)', data: {{ chart_values | tojson }}, borderRadius: 5, barThickness: 40 }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });

  // Amount Due (issued)
  const dueCtx = document.getElementById('dueChart').getContext('2d');
  new Chart(dueCtx, {
    type: 'bar',
    data: {
      labels: {{ due_labels | tojson }},
      datasets: [{ label: 'Daily Amount Due Issued ($)', data: {{ due_values | tojson }}, borderRadius: 5, barThickness: 40 }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
{% endblock %}
