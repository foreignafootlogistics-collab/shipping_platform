{% extends 'layout_admin.html' %}
{% block title %}Generate Invoice{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mb-4">üßæ Generate Invoice for {{ user.full_name }}</h2>

  <!-- Use Flask-WTF form (CSRF included) -->
  <form method="POST" novalidate>
    {{ form.hidden_tag() }}

    <!-- User Info -->
    <div class="mb-3">
      <strong>User:</strong> {{ user.full_name }} ({{ user.registration_number }})
    </div>

    {% if packages %}
    <!-- Packages Table -->
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>House AWB</th>
          <th>Tracking #</th>
          <th>Description / Category</th>
          <th>Weight (lb)</th>
          <th>Invoice Value (USD)</th>
          <th class="text-end">Due (JMD)</th>  {# NEW #}
        </tr>
      </thead>
      <tbody>
        {% set total_due = 0 %}
        {% for pkg in packages %}
          {% set _due = (pkg.amount_due or 0) %}
          {% set total_due = total_due + _due %}
          <tr>
            <td>{{ pkg.house_awb or '-' }}</td>
            <td>{{ pkg.tracking_number or '-' }}</td>
            <td>{{ pkg.description or 'N/A' }}</td>
            <td>{{ pkg.weight or '0' }}</td>
            <td>${{ "%.2f"|format(pkg.value or 0) }}</td>
            <td class="text-end fw-bold">JMD {{ "%.2f"|format(_due) }}</td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="table-light">
          <th colspan="5" class="text-end">Total Amount Due</th>
          <th class="text-end text-danger">JMD {{ "%.2f"|format(total_due) }}</th>
        </tr>
      </tfoot>
    </table>
    {% else %}
      <div class="alert alert-warning">‚ö†Ô∏è No packages available to invoice.</div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="mt-3 d-flex gap-2">
      {{ form.submit(class="btn btn-success") }}
      <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
        <i class="fas fa-times"></i> Cancel
      </a>
    </div>
  </form>
</div>
{% endblock %}
