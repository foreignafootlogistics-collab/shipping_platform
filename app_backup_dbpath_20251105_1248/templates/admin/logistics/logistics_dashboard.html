{% extends "layout_admin.html" %}
{% block title %}Manage Logistics{% endblock %}

{% block content %}
<div class="container mt-4 logistics-dashboard">

  <!-- Header -->
  <h2 class="mb-4 text-white p-3 rounded shadow-sm logistics-header">üì¶ Logistics</h2>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Tabs -->
  <ul class="nav nav-tabs logistics-tabs" id="logisticsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if tab == 'prealert' %}active{% endif %}"
              id="prealerts-tab"
              data-bs-toggle="tab"
              data-bs-target="#prealerts"
              type="button"
              role="tab">Pre-Alert Shipments</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if tab == 'view_packages' %}active{% endif %}"
              id="view-tab"
              data-bs-toggle="tab"
              data-bs-target="#viewPackages"
              type="button"
              role="tab">View Packages</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if tab == 'shipmentLog' %}active{% endif %}"
              id="shipment-tab"
              data-bs-toggle="tab"
              data-bs-target="#shipmentLog"
              type="button"
              role="tab">Shipment Log</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if tab == 'uploadPackages' %}active{% endif %}"
              id="upload-tab"
              data-bs-toggle="tab"
              data-bs-target="#uploadPackages"
              type="button"
              role="tab">Upload Packages</button>
    </li>
  </ul>

  <!-- Tab content (wraps ALL panes) -->
  <div class="tab-content mt-3" id="logisticsTabsContent">

    <!-- Pre-Alerts -->
    <div class="tab-pane fade {% if tab == 'prealert' %}show active{% endif %}"
         id="prealerts" role="tabpanel" aria-labelledby="prealerts-tab">
      {% include "admin/logistics/prealerts.html" %}
    </div>

    <!-- View Packages -->
    <div class="tab-pane fade {% if tab == 'view_packages' %}show active{% endif %}"
         id="viewPackages" role="tabpanel" aria-labelledby="view-tab">
      {% include "admin/logistics/view_packages.html" %}
    </div>

    <!-- Shipment Log -->
    <div class="tab-pane fade {% if tab == 'shipmentLog' %}show active{% endif %}"
         id="shipmentLog" role="tabpanel" aria-labelledby="shipment-tab">

      <div class="row mb-3">

        <!-- Sidebar: Shipments -->
        <div class="col-md-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-purple mb-0">üì¶ Shipment Batches</h5>

            <!-- Toolbar -->
            <div class="btn-group btn-group-sm" role="group" aria-label="Shipment toolbar">
              <!-- Create new shipment (go to View Packages to select) -->
              <form method="POST"
                    action="{{ url_for('logistics.create_empty_shipment') }}"
                    class="d-inline">
                {{ bulk_form.hidden_tag() }}
                <button type="submit" class="btn btn-outline-primary" title="Create a blank shipment log">
                  <i class="fas fa-plus"></i>
                </button>
              </form>


              <!-- Search packages (open modal) -->
              <button class="btn btn-outline-success" title="Search packages"
                      data-bs-toggle="modal" data-bs-target="#shipmentSearchModal">
                <i class="fas fa-search"></i>
              </button>

              <!-- Delete selected shipment (open modal) -->
              <button class="btn btn-outline-danger" title="Delete current shipment"
                      data-bs-toggle="modal" data-bs-target="#deleteShipmentModal"
                      {% if not selected_shipment %}disabled{% endif %}>
                <i class="fas fa-trash-alt"></i>
              </button>

              <!-- (Optional) filters toggle if you add any later -->
              <!-- <button class="btn btn-outline-secondary" title="Filters" data-bs-toggle="collapse" data-bs-target="#batchFilters">
                <i class="fas fa-filter"></i>
              </button> -->
            </div>
          </div>

          <ul class="list-group shadow-sm">
            {% if shipments %}
              {% for s in shipments %}
                <li class="list-group-item d-flex justify-content-between align-items-start border-0
                           {% if selected_shipment and s.id == (selected_shipment.id if selected_shipment else None) %}active bg-purple text-white{% endif %}">
                  <a class="flex-grow-1 text-decoration-none
                            {% if selected_shipment and s.id == (selected_shipment.id if selected_shipment else None) %}text-white{% else %}text-dark{% endif %}"
                     href="{{ url_for('logistics.logistics_dashboard', tab='shipmentLog', shipment_id=s.id) }}">
                    <strong>{{ s.sl_id }}</strong><br>
                    <small class="text-muted {% if selected_shipment and s.id == (selected_shipment.id if selected_shipment else None) %}text-light{% endif %}">
                      {{ (s.created_at or now()) | datetimeformat('%Y-%m-%d %H:%M') }}
                    </small>
                  </a>
                  {# üö´ No per-item delete button here anymore #}
                </li>
              {% endfor %}
            {% else %}
              <li class="list-group-item text-muted">
                No shipment batches found.
                <br>
                <a href="{{ url_for('logistics.logistics_dashboard', tab='view_packages') }}"
                   class="btn btn-sm btn-purple mt-2">‚ûï Create Shipment</a>
              </li>
            {% endif %}
          </ul>
        </div>


        <!-- Main: Packages -->
        <div class="col-md-9">

          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold text-purple mb-0">
              üöö Shipment Packages
              {% if selected_shipment %}- <span>{{ selected_shipment.sl_id }}</span>{% endif %}
            </h5>

            {% if selected_shipment %}
            <!-- Bulk action form wraps the whole table so checkboxes submit -->
            <form method="POST"
                  id="shipmentForm"
                  class="d-flex align-items-center gap-2"
                  action="{{ url_for('logistics.bulk_shipment_action', shipment_id=selected_shipment.id) }}">
              {{ bulk_form.hidden_tag() }}
              <input type="hidden" name="tab" value="shipmentLog">
              <select name="action" class="form-select w-auto" required>
                <option value="" selected disabled>Select Action</option>
                <option value="calc_outstanding">üßÆ Calculate Outstanding</option>
                <option value="save_calculated">üíæ Save Calculated</option>
                <option value="move">üîÅ Move to Shipment‚Ä¶</option>
                <option value="ready">‚úÖ Mark Ready for Pick Up</option>
                <option value="generate_invoice">üßæ Generate Invoices</option>
                <option value="notify_ready">üì£ Email: Ready for Pick-Up</option>
                <option value="send_invoices">üìß Email: Invoices (Totals)</option>
                <option value="remove_from_shipment">üóë Remove from this Shipment</option>
              </select>
              <button type="submit" class="btn btn-purple btn-sm">Apply</button>
          </div>

          {% if shipment_packages %}
          <div class="table-responsive shadow-sm">
            <table id="shipmentTable" class="table table-bordered table-striped table-hover align-middle table-sm">
              <thead class="bg-purple text-white small">
                <tr>
                  <th style="width:30px;">
                     <input type="checkbox" id="selectAll" />
                  </th>
                  <th>Action</th>
                  <th>User</th>
                  <th>Package</th>
                  <th>House AWB</th>
                  <th>Description</th>
                  <th>Date Received</th>
                  <th>Weight</th>
                  <th>Item Value ($)</th>
                  <th>Outstanding ($)</th>                  
                </tr>
              </thead>
              <tbody class="small">
                {% for pkg in shipment_packages %}
                <tr>
                  <td>
                    <input type="checkbox" name="package_ids" value="{{ pkg.id }}" class="package-checkbox" />
                  </td>
                  <td class="text-center">
                    <button type="button"
                            class="btn btn-sm btn-outline-primary"
                            onclick="togglePricing({{ pkg.id }})">‚öôÔ∏è</button>
                  </td>
                  <td>
                    <strong>{{ pkg.full_name }}</strong><br>
                    <small class="text-muted">{{ pkg.registration_number }}</small>
                  </td>
                  <td>
                    {% set status = pkg.status %}
                    {% include 'partials/status_tracker.html' with context %}
                    <br>
                    <small class="text-muted">{{ pkg.tracking_number }}</small>
                  </td>
                  <td>{{ pkg.house_awb or '-' }}</td>
                  <td>{{ pkg.description or '-' }}</td>
                  <td>{{ pkg.date_received.strftime('%Y-%m-%d') if pkg.date_received else '-' }}</td>
                  <td><input id="weight_{{ pkg.id }}" type="number" class="form-control form-control-sm text-end" value="{{ pkg.weight or 0 }}"></td>
                  <td><input id="value_{{ pkg.id }}"  type="number" class="form-control form-control-sm text-end" value="{{ pkg.value  or 50 }}"></td>
                  <td><input id="amount_due_{{ pkg.id }}" type="number" class="form-control form-control-sm text-end" value="{{ pkg.amount_due or 0 }}" readonly></td>
                </tr>                
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <p class="text-muted">No packages in this shipment.</p>
          {% endif %}

          </form>  {# closes form opened near the bulk actions #}
          {% endif %} {# end if selected_shipment #}

        </div>
      </div>
      

      {% for pkg in shipment_packages %}
      <div id="pricing_{{ pkg.id }}" class="d-none bg-light small border rounded p-3 my-2">
        <div class="row">
          <div class="col-md-4 border-end">
            <div class="mb-1">
              <label class="small">Category</label>
              <select id="cat_{{ pkg.id }}" class="form-control form-control-sm">
                {% for cat in categories %}
                  <option value="{{ cat }}" {% if pkg.category == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-1">
              <label class="small">Invoice USD</label>
              <input id="pricing_value_{{ pkg.id }}" type="number" step="0.01" class="form-control form-control-sm"
                     value="{{ pkg.value or 50 }}">
            </div>
            <div class="mb-1">
              <label class="small">Weight (lbs)</label>
              <input id="pricing_weight_{{ pkg.id }}" type="number" step="0.01" class="form-control form-control-sm"
                     value="{{ pkg.weight or 0 }}">
            </div>
          </div>

          <div class="col-md-8">
            <div class="row g-2">
              <!-- üëâ Make all these editable so we can manually key customs/freight if desired -->
              <div class="col-md-4"><label class="small">Duty</label>
                <input id="duty_{{ pkg.id }}" type="number" step="0.01" class="form-control form-control-sm">
              </div>
              <div class="col-md-4"><label class="small">SCF</label>
                <input id="scf_{{ pkg.id }}" type="number" step="0.01" class="form-control form-control-sm">
              </div>
              <div class="col-md-4"><label class="small">ENVL</label>
                <input id="envl_{{ pkg.id }}" type="number" step="0.01" class="form-control form-control-sm">
              </div>
              <div class="col-md-4"><label class="small">CAF</label>
                <input id="caf_{{ pkg.id }}" type="number" step="0.01" class="form-control form-control-sm">
              </div>
              <div class="col-md-4"><label class="small">GCT</label>
                <input id="gct_{{ pkg.id }}" type="number" step="0.01" class="form-control form-control-sm">
              </div>
              <div class="col-md-4"><label class="small">Stamp</label>
                <input id="stamp_{{ pkg.id }}" type="number" step="0.01" class="form-control form-control-sm">
              </div>

              <div class="col-md-6"><label class="small fw-bold">Customs Total</label>
                <input id="customs_total_{{ pkg.id }}" type="number" step="0.01"
                       class="form-control form-control-sm fw-bold">
              </div>
              <div class="col-md-3"><label class="small">Freight</label>
                <input id="freight_{{ pkg.id }}" type="number" step="0.01" class="form-control form-control-sm">
              </div>
              <div class="col-md-3"><label class="small">Handling</label>
                <input id="handling_{{ pkg.id }}" type="number" step="0.01" class="form-control form-control-sm">
              </div>

              <div class="col-md-6"><label class="small fw-bold">Freight Total</label>
                <input id="freight_total_{{ pkg.id }}" type="number" step="0.01"
                       class="form-control form-control-sm fw-bold">
              </div>

              <!-- ‚úÖ NEW: Other Charges -->
              <div class="col-md-6"><label class="small">Other Charges</label>
                <input id="other_charges_{{ pkg.id }}" type="number" step="0.01"
                       class="form-control form-control-sm" value="{{ pkg.other_charges or 0 }}">
              </div>

              <div class="col-md-6"><label class="small fw-bold text-success">Grand Total</label>
                <input id="grandtotal_{{ pkg.id }}" type="number" step="0.01"
                       class="form-control form-control-sm fw-bold text-success">
              </div>
            </div>

            <div class="d-flex flex-wrap justify-content-end gap-2 mt-2">
              <!-- Existing auto-calc -->
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="runCalculator({{ pkg.id }})">
                ‚öôÔ∏è Calculate
              </button>

              <!-- ‚úÖ NEW: Save only item value (invoice USD) -->
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="saveValueOnly({{ pkg.id }})">
                üíæ Save Value Only
              </button>

              <!-- ‚úÖ NEW: Save manual charges (no auto-calc) -->
              <button type="button" class="btn btn-sm btn-success" onclick="saveManualCharges({{ pkg.id }})">
                üíæ Save Charges
              </button>
            </div>
          </div>
        </div>
      </div>

      {% endfor %}

      
      <!-- Move to Shipment Modal -->
      <div class="modal fade" id="moveShipmentModal" tabindex="-1" aria-labelledby="moveShipmentLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
          <div class="modal-content">
            <form method="POST" action="{{ url_for('logistics.move_packages_between_shipments') }}" id="moveShipmentForm">
              <div class="modal-header">
                <h5 class="modal-title" id="moveShipmentLabel">Move Packages</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="from_shipment_id" value="{{ selected_shipment_id or 0 }}">
                <input type="hidden" name="package_ids" id="move_package_ids" value="">

                <label class="form-label small">Destination Shipment</label>
                <select class="form-select form-select-sm" name="to_shipment_id" required>
                  <option value="">Select‚Ä¶</option>
                  {% for s in shipments %}
                    {% if not selected_shipment or s.id != selected_shipment.id %}
                      <option value="{{ s.id }}">{{ s.sl_id }}</option>
                    {% endif %}
                  {% endfor %}
                </select>

                <div class="form-text mt-2">
                  Selected packages will be moved to the chosen shipment.
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-purple btn-sm">Move</button>
              </div>
            </form>
          </div>
        </div>
      </div>
 

      <!-- Search Packages Modal -->
      <div class="modal fade" id="shipmentSearchModal" tabindex="-1" aria-labelledby="shipmentSearchLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="shipmentSearchLabel">Search Packages</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <form id="shipmentSearchForm" class="row g-2 mb-3">
                <div class="col-md-6">
                  <label class="form-label small mb-0">Customer Name</label>
                  <input type="text" class="form-control form-control-sm" name="name" placeholder="e.g., Jane Doe">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-0">Registration #</label>
                  <input type="text" class="form-control form-control-sm" name="reg" placeholder="e.g., FA12345">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-0">Tracking #</label>
                  <input type="text" class="form-control form-control-sm" name="tracking" placeholder="e.g., 1Z...">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-0">House AWB</label>
                  <input type="text" class="form-control form-control-sm" name="house" placeholder="e.g., 06978687">
                </div>

                <div class="col-12 d-flex justify-content-end">
                  <button type="submit" class="btn btn-sm btn-purple">Search</button>
                </div>
              </form>

              <div class="table-responsive">
                <table class="table table-sm table-striped align-middle mb-0" id="shipmentSearchResults">
                  <thead class="table-light">
                    <tr>
                      <th>Customer</th>
                      <th>Reg #</th>
                      <th>Tracking #</th>
                      <th>House AWB</th>
                      <th>Description</th>
                      <th>Shipment Batch</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="6" class="text-muted">Enter criteria and click Search.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Shipment Batch Modal -->
      <div class="modal fade" id="deleteShipmentModal" tabindex="-1" aria-labelledby="deleteShipmentLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
          <div class="modal-content">
            <form method="POST" action="{{ url_for('logistics.delete_shipment', shipment_id=(selected_shipment.id if selected_shipment else 0)) }}">
              <div class="modal-header">
                <h5 class="modal-title" id="deleteShipmentLabel">Delete Shipment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                {% if selected_shipment %}
                  <p class="mb-0">Delete <strong>{{ selected_shipment.sl_id }}</strong>?</p>
                  <small class="text-muted">Packages stay in the system; only the batch is removed.</small>
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% else %}
                  <p class="mb-0 text-muted">Select a shipment on the left first.</p>
                {% endif %}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger btn-sm" {% if not selected_shipment %}disabled{% endif %}>Delete</button>
              </div>
            </form>
          </div>
        </div>
      </div>


      <!-- Bulk Invoice Preview (modal-only, no page reload) -->
      <div class="modal fade" id="bulkInvoicePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Invoice Preview</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <p id="detained-note" class="text-muted small mb-2"></p>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Select</th>
                      <th>Customer</th>
                      <th class="text-center">Packages</th>
                      <th class="text-end">Total Due</th>
                    </tr>
                  </thead>
                  <tbody id="inv-prev-tbody"></tbody>
                  <tfoot>
                    <tr class="table-light">
                      <th colspan="3" class="text-end">Total Amount Due</th>
                      <th class="text-end" id="inv-prev-total">0.00</th>
                    </tr>
                  </tfoot>       
                </table>
              </div>
            </div>

            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button class="btn btn-purple" id="btn-finalize-invoices">Finalize Invoices</button>
            </div>
          </div>
        </div>
      </div>
    
    </div>

    <!-- Upload -->
    <div class="tab-pane fade {% if tab == 'uploadPackages' %}show active{% endif %}"
         id="uploadPackages" role="tabpanel" aria-labelledby="upload-tab">

      <div class="card shadow-sm mt-3 border-0">
        <div class="card-header text-white"
             style="background-color:#4a148c; border-top-left-radius:.5rem; border-top-right-radius:.5rem;">
          <h4 class="mb-0">Upload Packages from Excel/CSV</h4>
        </div>

        <div class="card-body p-4">

          <!-- 1) Upload-for-Preview Form -->
          <form id="uploadForm"
                method="POST"
                enctype="multipart/form-data"
                action="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}">
            {{ upload_form.hidden_tag() }}
            <input type="hidden" name="tab" value="uploadPackages">
            <input type="hidden" name="stage" value="preview">

            <div class="mb-3">
              {{ upload_form.file.label(class_="form-label") }}
              {{ upload_form.file(class_="form-control", accept=".xlsx,.csv") }}
              {% for error in upload_form.file.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>

            <div class="d-flex align-items-center gap-2">
              {{ upload_form.submit(class_="btn btn-purple", id="uploadBtn", value="Preview All") }}
              <a href="{{ url_for('static', filename='templates/sample_upload.xlsx') }}"
                 class="btn btn-outline-purple">Download Sample</a>
              <div id="spinner" class="spinner-border text-purple ms-2" role="status" style="display:none;">
                <span class="visually-hidden">Uploading...</span>
              </div>
            </div>
          </form>

          <!-- Messages -->
          {% if message %}
            <div class="alert alert-success mt-4">{{ message }}</div>
          {% endif %}
          {% if errors and errors|length %}
            <div class="alert alert-danger mt-4">
              <ul class="mb-0">
                {% for error in errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          <!-- 2) Full Preview Table + Confirm -->
          {% if preview_headers and preview_rows %}
          <hr class="my-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h5 class="mb-0">Preview All Rows</h5>
            {% if summary_counts %}
              <div class="small">
                <span class="badge badge-purple">Total: {{ summary_counts.total }}</span>
                <span class="badge badge-purple-soft">Valid: {{ summary_counts.valid }}</span>
                <span class="badge bg-danger">Invalid: {{ summary_counts.invalid }}</span>
              </div>
            {% endif %}
            {% if preview_token and summary_counts and summary_counts.invalid %}
              <a class="btn btn-sm btn-outline-danger"
                 href="{{ url_for('logistics.download_preview_invalid', token=preview_token) }}">
                <i class="fas fa-file-csv me-1"></i> Download Invalid Rows
              </a>
            {% endif %}
           </div>
          </div>

          <div class="table-responsive border rounded shadow-sm">
            <table id="previewTable" class="table table-sm table-bordered table-striped align-middle mb-0">
              <thead class="bg-purple text-white">
                <tr>
                  <th style="width:30px;"><input type="checkbox" id="selectAllPreview"></th>
                  {% for h in preview_headers %}
                    <th>{{ h }}</th>
                  {% endfor %}
                  <th>Status</th>
                  <th style="display:none;">__row_index</th> <!-- hidden index col -->
                </tr>
              </thead>
              <tbody>
                {% for row in preview_rows %}
                  {% set i = loop.index0 %}
                  {% set errs = preview_errors.get(i) if preview_errors else None %}
                  <tr class="{% if errs %}table-danger{% else %}table-light{% endif %}">
                    <td>
                      <input type="checkbox"
                             class="row-select"
                             value="{{ i }}"
                             {% if not errs %}checked{% endif %}>
                    </td>

                    {% for h in preview_headers %}
                      {% set val = row.get(h) %}
                      <td class="{% if errs and ('Missing ' ~ h.replace('_',' ').title()) in errs %}bg-warning-subtle{% endif %}">
                        {{ '' if val is none else val }}
                      </td>
                    {% endfor %}

                    <td>
                      {% if not errs %}
                        <span class="badge badge-purple">Valid</span>
                      {% else %}
                        <span class="badge bg-danger">Invalid</span>
                        <div class="small text-muted mt-1">
                          {% for e in errs %}
                            <div>‚Ä¢ {{ e }}</div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </td>

                    <!-- hidden index cell -->
                    <td style="display:none;">{{ i }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Confirm form -->
          <form id="confirmForm" method="POST"
                action="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}"
                class="mt-3 d-flex flex-wrap align-items-end gap-2">
            {{ upload_form.csrf_token }}
            <input type="hidden" name="tab" value="uploadPackages">
            <input type="hidden" name="stage" value="confirm">
            <input type="hidden" name="preview_token" value="{{ preview_token }}">
            <input type="hidden" id="selectedIndicesInput" name="selected_indices" value="[]">

            <div>
              <label class="form-label mb-1 text-purple">Batch Size (optional)</label>
              <input type="number" name="batch_size" class="form-control form-control-sm border-purple" placeholder="e.g. 50">
              <div class="form-text">Limit per submit to avoid timeouts.</div>
            </div>

            <div class="ms-auto d-flex align-items-center gap-2">
              <button type="button" id="selectValidBtn" class="btn btn-outline-purple btn-sm">
                Select All Valid
              </button>
              <button type="submit" class="btn btn-purple btn-sm">
                <i class="fas fa-check-circle me-1"></i> Import Selected
              </button>
              <a href="{{ url_for('logistics.logistics_dashboard', tab='uploadPackages') }}"
                 class="btn btn-outline-danger btn-sm"
                 onclick="return confirm('Cancel this upload and discard preview?');">
                <i class="fas fa-times-circle me-1"></i> Cancel Upload
              </a>
            </div>
          </form>
          {% endif %}
        </div> <!-- /card-body -->
      </div>   <!-- /card -->
    </div>     <!-- /uploadPackages tab-pane -->

  
  </div> <!-- ‚úÖ CLOSE .tab-content here -->
</div>  <!-- /container -->

<!-- JS -->
<script>
const categoryRates = {{ CATEGORIES|tojson }};
const USD_TO_JMD    = {{ USD_TO_JMD }};

async function postJSON(url, body) {
  const r = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

// Open preview modal using JSON API
async function openInvoicePreview(selectedPkgIds) {
  const data = await postJSON("{{ url_for('logistics.bulk_invoice_preview') }}", { package_ids: selectedPkgIds });

  const tbody = document.querySelector('#inv-prev-tbody');
  if (!tbody) {
    alert('Preview table body #inv-prev-tbody not found in DOM.');
    return;
  }
  tbody.innerHTML = '';

  let grand = 0;

  for (const row of (data.rows || [])) {
    grand += Number(row.total_due || 0);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="checkbox" class="inv-user" data-uid="${row.user_id}"
               data-pkgs="${row.package_ids.join(',')}" checked>
      </td>
      <td><strong>${row.registration_number || ''}</strong> ${row.full_name || ''}</td>
      <td class="text-center">${row.package_count}</td>
      <td class="text-end">${Number(row.total_due || 0).toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  }

  const totalCell = document.getElementById('inv-prev-total');
  if (totalCell) totalCell.textContent = grand.toFixed(2);

  const note = document.getElementById('detained-note');
  if (note) note.textContent = data.detained_skipped ? `‚Ä¢ ${data.detained_skipped} detained package(s) skipped` : '';

  const modalEl = document.getElementById('bulkInvoicePreviewModal');
  const modal = new bootstrap.Modal(modalEl);
  modal.show();
}

// Finalize invoices from the modal
async function finalizeInvoicesFromModal() {
  const checks = [...document.querySelectorAll('.inv-user:checked')];
  const selections = checks.map(ch => ({
    user_id: Number(ch.dataset.uid),
    package_ids: ch.dataset.pkgs.split(',').map(x => Number(x))
  }));

  if (!selections.length) {
    alert('Select at least one customer.');
    return;
  }

  const res = await postJSON("{{ url_for('logistics.bulk_invoice_finalize_json') }}", { selections });
  alert(`Created ${res.created} invoice(s).`);
  setTimeout(() => window.location.reload(), 500);
}

// Wire the modal's finalize button
document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'btn-finalize-invoices') {
    finalizeInvoicesFromModal().catch(err => alert(err));
  }
});

let dt = null;
let dtInitialized = false;

function initShipmentTable() {
  if (dtInitialized) return;
  const $table = $('#shipmentTable');
  if (!$table.length) return;

  if ($.fn.DataTable.isDataTable('#shipmentTable')) return;

  dt = $table.DataTable({
    // default page size
    pageLength: 10,

    // allow user to pick sizes
    lengthChange: true,
    lengthMenu: [[10, 25, 50, 100, 500], [10, 25, 50, 100, 500]],

    // put Buttons on the left, page-length on the right
  dom:
      "<'row g-2 align-items-center mb-2'<'col-md-6'B><'col-md-6 text-md-end'l>>" +
      "rt" +
      "<'row align-items-center mt-2'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",

    order: [[2, 'asc']],
    buttons: [
      { extend: 'copyHtml5',  className: 'btn btn-sm btn-purple'   },
      { extend: 'excelHtml5', className: 'btn btn-sm btn-success'  },
      { extend: 'csvHtml5',   className: 'btn btn-sm btn-info'     },
      { extend: 'print',      className: 'btn btn-sm btn-secondary'}
    ],
    columnDefs: [
      { orderable: false, targets: [0, 1] } // ‚Üê disable sort on Select + Action
    ],
    rowCallback: function (row) {
      if ($(row).hasClass('no-dt') || $(row).hasClass('d-none')) {
        return false;
      }
    },
    language: { emptyTable: 'No packages in this shipment.' }
  });

 // ‚úÖ Insert this snippet here:
  $('#shipmentTable').off('change', '#selectAll').on('change', '#selectAll', function () {
    const checked = this.checked;
    if (!dt) return;
    dt.rows({ search: 'applied', page: 'current' }).nodes().to$()
      .find('input.package-checkbox')
      .prop('checked', checked);
  })

 // ‚úÖ Working Select-All toggle
$('#selectAll').off('change').on('change', function () {
  const checked = this.checked;
  if (!dt) return;
  // select checkboxes only in visible page
  dt.rows({ search: 'applied', page: 'current' }).nodes().to$()
    .find('input.package-checkbox')
    .prop('checked', checked);
});

// ‚úÖ Update selectAll when any checkbox changes
$('#shipmentTable tbody').off('change', '.package-checkbox').on('change', '.package-checkbox', function () {
  const allBoxes = dt.$('.package-checkbox').length;
  const checkedBoxes = dt.$('.package-checkbox:checked').length;
  $('#selectAll').prop('checked', allBoxes > 0 && allBoxes === checkedBoxes);
});


  // NEW: stop header clicks from triggering sort
  $(document).on('click', '#shipmentTable thead th:first-child, #selectAll', function (e) {
    e.stopPropagation();
  });

  
  dt.on('draw', function () {
    const total   = dt.$('.package-checkbox').length;
    const checked = dt.$('.package-checkbox:checked').length;
    $('#selectAll').prop('checked', total > 0 && total === checked);
  });

  // ‚úÖ Beautify the page-length dropdown (top-right)
  $('#shipmentTable_wrapper .dataTables_length select')
    .addClass('form-select form-select-sm');
  $('#shipmentTable_wrapper .dataTables_length label')
    .addClass('mb-0 small');

  dtInitialized = true;
}

$(document).ready(function () {
  // If Shipment tab is already active, init immediately.
  if (document.querySelector('#shipmentLog.tab-pane.show.active')) {
    initShipmentTable();
  }

  // Init when the Shipment tab is shown
  $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
    const target = $(e.target).attr('data-bs-target');
    if (target === '#shipmentLog') {
      initShipmentTable();
      if (dt) dt.columns.adjust().draw(false);
    }
  });

  // Bulk action submit
  $('#shipmentForm').on('submit', async function (e) {
    const action = $(this).find('select[name="action"]').val();
    if (!action) {
      e.preventDefault();
      alert('‚ö†Ô∏è Please select an action.');
      return;
    }

    const ids = dt ? dt.$('.package-checkbox:checked').map(function(){ return this.value; }).get()
                   : $('.package-checkbox:checked').map(function(){ return this.value; }).get();

    if (!ids.length) {
      e.preventDefault();
      alert('‚ö†Ô∏è Please select at least one package.');
      return;
    }
    if (action === 'generate_invoice') {
  e.preventDefault();
  const ids = dt
    ? dt.$('.package-checkbox:checked').map(function(){ return this.value; }).get()
    : $('.package-checkbox:checked').map(function(){ return this.value; }).get();

  if (!ids.length) {
    alert('‚ö†Ô∏è Please select at least one package.');
    return;
  }

  openInvoicePreview(ids).catch(err => {
    console.error(err);
    alert('‚ö†Ô∏è Could not load invoice preview.');
  });
  return;
}

    // üî¢ Bulk calculate outstanding
    if (action === 'calc_outstanding') {
      e.preventDefault();

      const rows = ids.map(id => {
        const { category, invoice, weight } = readRowInputs(id);
        return { pkg_id: parseInt(id, 10), category, invoice, weight };
      });

      try {
        const res = await fetch('{{ url_for("logistics.bulk_calc_outstanding") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
          body: JSON.stringify({ rows })
        });
        if (!res.ok) throw new Error('Bulk calculation failed');
        const data = await res.json();

        (data.results || []).forEach(r => {
          const id = r.pkg_id;
          const amount = parseFloat(r.grand_total || r.amount_due || 0) || 0;

          const amountEl = document.getElementById(`amount_due_${id}`);
          if (amountEl) amountEl.value = amount.toFixed(2);

          const grandEl  = document.getElementById(`grandtotal_${id}`);
          if (grandEl) grandEl.value = amount.toFixed(2);

          if (r.breakdown) {
            const map = {
              duty: 'duty_', scf: 'scf_', envl: 'envl_', caf: 'caf_', gct: 'gct_', stamp: 'stamp_',
              customs_total: 'customs_total_', freight: 'freight_', handling: 'handling_', freight_total: 'freight_total_'
            };
            Object.entries(map).forEach(([k, prefix]) => {
              const el = document.getElementById(prefix + id);
              if (el && r.breakdown[k] != null) el.value = Number(r.breakdown[k]).toFixed(2);
            });
          }
        });

        alert(`Calculated outstanding for ${data.results?.length || 0} package(s).`);

        // Optional: immediately persist each computed amount_due
        // for (const r of data.results || []) {
        //   const updUrl = '{{ url_for("logistics.api_update_package", pkg_id=0) }}'.replace(/\/0$/, '/' + r.pkg_id);
        //   await fetch(updUrl, {
        //     method: 'POST',
       //     headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
        //     body: JSON.stringify({ value: r.invoice, amount_due: r.grand_total })
        //   });
        // }

      } catch (err) {
        console.error(err);
        alert('‚ö†Ô∏è Error during bulk calculation. See console.');
      }
      return;
    }
    if (action === 'save_calculated') {
  e.preventDefault();

  // Build rows from current inputs in the table
  const rows = ids.map(id => {
    const getNum = (sel) => parseFloat((document.getElementById(sel + id)?.value || 0)) || 0;
    return {
      pkg_id: parseInt(id, 10),
      value:       getNum('value_') || getNum('pricing_value_'),
      amount_due:  getNum('amount_due_') || getNum('grandtotal_'),
      duty:        getNum('duty_'),
      scf:         getNum('scf_'),
      envl:        getNum('envl_'),
      caf:         getNum('caf_'),
      gct:         getNum('gct_'),
      stamp:       getNum('stamp_'),
      freight:     getNum('freight_'),
      handling:    getNum('handling_'),
      category:    (document.getElementById('cat_' + id)?.value || 'Other'),
      weight:      parseFloat((document.getElementById('weight_' + id)?.value || 0)) || 0
      // If you keep "other charges" separately and have a column, include it here.
    };
  });

  try {
    const res = await fetch('{{ url_for("logistics.bulk_save_packages") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
      body: JSON.stringify({ rows })
    });
    if (!res.ok) throw new Error('Bulk save failed');
    const data = await res.json();
    alert(`Saved ${data.updated} package(s).`);
  } catch (err) {
    console.error(err);
    alert('‚ö†Ô∏è Error during bulk save. See console.');
  }
  return;
}

    if (action === 'move') {
    e.preventDefault();
    // fill the hidden field in the modal and show it
    document.getElementById('move_package_ids').value = ids.join(',');
    const modal = new bootstrap.Modal(document.getElementById('moveShipmentModal'));
    modal.show();
    return;
    }

    $('#selectedIdsContainer').remove();
    const $holder = $('<div id="selectedIdsContainer" />');
    ids.forEach(id => $holder.append($('<input>', { type: 'hidden', name: 'package_ids', value: id })));
    $(this).append($holder);

    if (action === 'create_shipment') {
      e.preventDefault();
      window.location.href = "{{ url_for('logistics.logistics_dashboard', tab='view_packages', create_shipment=1) }}";
      return;
    }

    if (!confirm(`Perform "${action}" on ${ids.length} package(s)?`)) {
      e.preventDefault();
    }
  });
});

// Helper: read row inputs with sensible defaults
function readRowInputs(pkgId) {
  const catEl     = document.getElementById(`cat_${pkgId}`);
  const valEl     = document.getElementById(`pricing_value_${pkgId}`) || document.getElementById(`value_${pkgId}`);
  const weightEl  = document.getElementById(`pricing_weight_${pkgId}`) || document.getElementById(`weight_${pkgId}`);

  const category  = (catEl && catEl.value) ? catEl.value : 'Other';
  const invoice   = parseFloat((valEl && valEl.value) ? valEl.value : 0) || 0;
  const weight    = parseFloat((weightEl && weightEl.value) ? weightEl.value : 0) || 0;

  return { category, invoice, weight };
}


// Charges calculator
async function runCalculator(pkgId) {
  const cat     = document.getElementById(`cat_${pkgId}`).value;
  const invoice = parseFloat(document.getElementById(`pricing_value_${pkgId}`).value || 0);
  const weight  = parseFloat(document.getElementById(`pricing_weight_${pkgId}`).value || 0);

  try {
    const res = await fetch("{{ url_for('logistics.api_calculate_charges') }}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
      body: JSON.stringify({ category: cat, invoice: invoice, weight: weight })
    });
    if (!res.ok) throw new Error('Network response was not ok');
    const data = await res.json();

    document.getElementById(`duty_${pkgId}`).value          = data.duty.toFixed(2);
    document.getElementById(`scf_${pkgId}`).value           = data.scf.toFixed(2);
    document.getElementById(`envl_${pkgId}`).value          = data.envl.toFixed(2);
    document.getElementById(`caf_${pkgId}`).value           = data.caf.toFixed(2);
    document.getElementById(`gct_${pkgId}`).value           = data.gct.toFixed(2);
    document.getElementById(`stamp_${pkgId}`).value         = data.stamp.toFixed(2);
    document.getElementById(`customs_total_${pkgId}`).value = data.customs_total.toFixed(2);
    document.getElementById(`freight_${pkgId}`).value       = data.freight.toFixed(2);
    document.getElementById(`handling_${pkgId}`).value      = data.handling.toFixed(2);
    document.getElementById(`freight_total_${pkgId}`).value = data.freight_total.toFixed(2);
    document.getElementById(`grandtotal_${pkgId}`).value    = data.grand_total.toFixed(2);
  } catch (err) {
    console.error(err);
    alert('‚ö†Ô∏è Error calculating charges. See console.');
  }
}

// Save pricing
const updateUrlTemplate = "{{ url_for('logistics.api_update_package', pkg_id=0) }}";

async function savePricing(pkgId) {
  const invoice = parseFloat(document.getElementById(`pricing_value_${pkgId}`).value || 0);
  const grand   = parseFloat(document.getElementById(`grandtotal_${pkgId}`).value || 0);

  const updateUrl = updateUrlTemplate.replace(/\/0$/, `/${pkgId}`);

  try {
    const res = await fetch(updateUrl, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}' 
      },
      body: JSON.stringify({ value: invoice, amount_due: grand })
    });

    if (!res.ok) throw new Error('Update API failed');
    await res.json();

    const amountField = document.getElementById(`amount_due_${pkgId}`);
    if (amountField) amountField.value = grand.toFixed(2);

    alert(`üíæ Package ${pkgId} updated. Amount Due: $${grand.toFixed(2)}`);
  } catch (err) {
    console.error(err);
    alert('‚ö†Ô∏è Error saving pricing. See console.');
  }
}
function readNumber(id) {
  const el = document.getElementById(id);
  return el ? (parseFloat(el.value || '0') || 0) : 0;
}

async function saveValueOnly(pkgId) {
  const invoice = readNumber(`pricing_value_${pkgId}`) || readNumber(`value_${pkgId}`);
  const url = "{{ url_for('logistics.api_update_package', pkg_id=0) }}".replace(/\/0$/, `/${pkgId}`);

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ value: invoice }) // only value
    });
    if (!res.ok) throw new Error('Save Value Only failed');
    await res.json();

    alert(`Saved invoice value ($${invoice.toFixed(2)}) for package ${pkgId}.`);
  } catch (e) {
    console.error(e);
    alert('‚ö†Ô∏è Could not save invoice value.');
  }
}

async function saveManualCharges(pkgId) {
  // read all visible fields (manually keyed or previously calculated)
  const payload = {
    category: (document.getElementById(`cat_${pkgId}`)?.value) || undefined,
    value: readNumber(`pricing_value_${pkgId}`) || readNumber(`value_${pkgId}`),
    weight: readNumber(`pricing_weight_${pkgId}`) || readNumber(`weight_${pkgId}`),

    duty: readNumber(`duty_${pkgId}`),
    scf: readNumber(`scf_${pkgId}`),
    envl: readNumber(`envl_${pkgId}`),
    caf: readNumber(`caf_${pkgId}`),
    gct: readNumber(`gct_${pkgId}`),
    stamp: readNumber(`stamp_${pkgId}`),

    customs_total: readNumber(`customs_total_${pkgId}`),
    freight: readNumber(`freight_${pkgId}`),
    handling: readNumber(`handling_${pkgId}`),
    freight_total: readNumber(`freight_total_${pkgId}`),

    other_charges: readNumber(`other_charges_${pkgId}`),

    // if the user typed a grand total, we‚Äôll respect it; otherwise compute a safe sum
    grand_total: (function () {
      const gt = readNumber(`grandtotal_${pkgId}`);
      if (gt > 0) return gt;
      const sum = (
        readNumber(`customs_total_${pkgId}`) +
        readNumber(`freight_${pkgId}`) +
        readNumber(`handling_${pkgId}`) +
        readNumber(`other_charges_${pkgId}`)
      );
      return sum;
    })()
  };

  // also reflect amount_due on the row ‚ÄúOutstanding ($)‚Äù column
  payload.amount_due = payload.grand_total;

  const url = "{{ url_for('logistics.api_update_package', pkg_id=0) }}".replace(/\/0$/, `/${pkgId}`);

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('Save manual charges failed');
    await res.json();

    const amountField = document.getElementById(`amount_due_${pkgId}`);
    if (amountField) amountField.value = (payload.amount_due || 0).toFixed(2);

    const grandEl = document.getElementById(`grandtotal_${pkgId}`);
    if (grandEl) grandEl.value = (payload.grand_total || 0).toFixed(2);

    alert(`Saved charges for package ${pkgId}.`);
  } catch (e) {
    console.error(e);
    alert('‚ö†Ô∏è Could not save charges.');
  }
}

// --- Auto-sum helper for manual entry ---
function bindAutoSum(pkgId) {
  const ids = [
    `customs_total_${pkgId}`,
    `freight_${pkgId}`,
    `handling_${pkgId}`,
    `other_charges_${pkgId}`
  ];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', () => {
      const sum = ids.reduce((acc, x) => acc + readNumber(x), 0);
      const gt = document.getElementById(`grandtotal_${pkgId}`);
      if (gt) gt.value = sum.toFixed(2);
    });
  });
}

// --- Modified togglePricing to activate autosum ---
function togglePricing(pkgId) {
  const row = document.getElementById('pricing_' + pkgId);
  if (!row) return;
  row.classList.toggle('d-none');
  if (!row.classList.contains('d-none')) bindAutoSum(pkgId);
}

// Upload spinner UX
(function () {
  const form = document.getElementById('uploadForm');
  const spinner = document.getElementById('spinner');
  const uploadBtn = document.getElementById('uploadBtn');

  if (form) {
    form.addEventListener('submit', () => {
      if (uploadBtn) uploadBtn.disabled = true;
      if (spinner) spinner.style.display = 'inline-block';
    });
  }

  window.addEventListener('pageshow', () => {
    if (uploadBtn) uploadBtn.disabled = false;
    if (spinner) spinner.style.display = 'none';
  });
})();


// --- Helpers ---
function activateTabByTarget(targetSelector) {
  if (!targetSelector) return;

  const trigger   = document.querySelector(`#logisticsTabs button[data-bs-target="${targetSelector}"]`);
  const pane      = document.querySelector(targetSelector);
  const container = document.getElementById('logisticsTabsContent');

  if (!trigger || !pane || !container) return;

  // Clear existing actives
  document.querySelectorAll('#logisticsTabs .nav-link.active').forEach(b => b.classList.remove('active'));
  container.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show','active'));

  // Activate via Bootstrap API
  const tab = new bootstrap.Tab(trigger);
  tab.show();
}

// Map server "tab" -> pane id
const TAB_MAP = {
  prealert:      '#prealerts',
  view_packages: '#viewPackages',
  shipmentLog:   '#shipmentLog',
  uploadPackages:'#uploadPackages'
};

document.addEventListener('DOMContentLoaded', function () {
  // Rescue: ensure all panes are inside the content container
  const container = document.getElementById('logisticsTabsContent');
  if (container) {
    document.querySelectorAll('.tab-pane[role="tabpanel"]').forEach(pane => {
      if (!container.contains(pane)) container.appendChild(pane);
    });
  }

  // Preferred order: 1) localStorage  2) server tab  3) current active  4) first tab
  const saved = localStorage.getItem('activeLogisticsTab');

  const serverTabKey = "{{ tab or '' }}";           // e.g. "shipmentLog" or "view_packages"
  const serverTarget = TAB_MAP[serverTabKey] || null;

  const currentActiveBtn = document.querySelector('#logisticsTabs .nav-link.active');
  const currentTarget = currentActiveBtn ? currentActiveBtn.getAttribute('data-bs-target') : null;

  const firstBtn = document.querySelector('#logisticsTabs button[data-bs-toggle="tab"]');
  const firstTarget = firstBtn ? firstBtn.getAttribute('data-bs-target') : null;

  const preferredTarget = saved || serverTarget || currentTarget || firstTarget;

  // Activate after layout is ready
  setTimeout(() => activateTabByTarget(preferredTarget), 0);

  // Save on tab change
  document.querySelectorAll('#logisticsTabs button[data-bs-toggle="tab"]').forEach(btn => {
    btn.addEventListener('shown.bs.tab', e => {
      const target = e.target.getAttribute('data-bs-target');
      if (target) localStorage.setItem('activeLogisticsTab', target);
    });
  });
});


document.addEventListener('DOMContentLoaded', function () {
  const tableEl = document.getElementById('previewTable');
  if (!tableEl) return;

  const dt = $(tableEl).DataTable({
    pageLength: 25,
    lengthMenu: [10, 25, 50, 100, 250, 500],
    order: [],
    dom: 'Bfrtip',
    buttons: [
      { extend: 'copyHtml5',  className: 'btn btn-sm btn-secondary' },
      { extend: 'excelHtml5', className: 'btn btn-sm btn-success'  },
      { extend: 'csvHtml5',   className: 'btn btn-sm btn-info'     },
      { extend: 'print',      className: 'btn btn-sm btn-outline-secondary'}
    ]
  });

  const selectAll = document.getElementById('selectAllPreview');
  if (selectAll) {
    selectAll.addEventListener('change', function () {
      dt.rows({ search: 'applied' }).nodes().to$()
        .find('input.row-select')
        .prop('checked', this.checked);
    });
  }

  const selectValidBtn = document.getElementById('selectValidBtn');
  if (selectValidBtn) {
    selectValidBtn.addEventListener('click', function () {
      dt.rows().every(function () {
        const $row = $(this.node());
        const isInvalid = $row.hasClass('table-danger');
        $row.find('input.row-select').prop('checked', !isInvalid);
      });
    });
  }

  const confirmForm   = document.getElementById('confirmForm');
  const selectedInput = document.getElementById('selectedIndicesInput');

  if (confirmForm && selectedInput) {
    confirmForm.addEventListener('submit', function (e) {
      const selectedIdx = dt
        .rows()
        .nodes()
        .to$()
        .find('input.row-select:checked')
        .map(function(){ return parseInt(this.value, 10); })
        .get();

      if (!selectedIdx.length) {
        e.preventDefault();
        alert('Select at least one valid row to import.');
        return;
      }

      selectedInput.value = JSON.stringify(selectedIdx);
    });
  }
});


document.getElementById('shipmentSearchForm')?.addEventListener('submit', async function (e) {
  e.preventDefault();
  const params = new URLSearchParams(new FormData(this));
  const res = await fetch('{{ url_for("logistics.search_shipment_packages") }}?' + params.toString(), {
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  });
  const data = await res.json();

  const tbody = document.querySelector('#shipmentSearchResults tbody');
  tbody.innerHTML = '';

  if (!data.rows || !data.rows.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-muted">No results.</td></tr>';
    return;
  }

  for (const r of data.rows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.full_name || '-'}</td>
      <td>${r.registration_number || '-'}</td>
      <td>${r.tracking_number || '-'}</td>
      <td>${r.house_awb || '-'}</td>
      <td>${r.description || '-'}</td>
      <td>${r.sl_id || '-'}</td>
    `;
    tbody.appendChild(tr);
  }
});


</script>

<style>
  .logistics-header { background-color: #4a148c; }
  .logistics-tabs .nav-link { color: #4a148c; font-weight: 500; }
  .logistics-tabs .nav-link.active { background-color: #4a148c; color: #fff !important; }
  .bg-purple { background-color: #4a148c !important; }
  .text-purple { color: #4a148c !important; }
  .btn-purple { background-color: #4a148c; color: white; border: none; }
  .btn-purple:hover { background-color: #6a1b9a; }
  .table-hover tbody tr:hover { background-color: #f3e5f5; }
  .table-sm th, .table-sm td { padding: 0.25rem 0.4rem; font-size: 0.75rem; }
  .no-dt { }
  .badge-purple-soft {
    background: rgba(74, 20, 140, 0.12);
    color: #4a148c;
    border: 1px solid rgba(74, 20, 140, 0.3);
  }

  /* ‚úÖ Hide inactive panes completely; show only the active one */
  #logisticsTabsContent > .tab-pane:not(.active) {
    display: none !important;
    visibility: hidden !important;
  }
  #logisticsTabsContent > .tab-pane.active {
    display: block !important;
    visibility: visible !important;
  }

  /* Make invalid rows easy to spot */
  #previewTable tbody tr.table-danger td {
    border-top: 2px solid #dc3545;
    border-bottom: 2px solid #dc3545;
  }
  /* Subtle background for valid rows */
  #previewTable tbody tr.table-light td {
    background-color: #f8f9fa;
  }

  .text-purple { color: #4a148c !important; }
  .bg-purple { background-color: #4a148c !important; }
  .border-purple { border-color: #4a148c !important; }

  .btn-purple {
    background-color: #4a148c; color: #fff;
    border: 1px solid #4a148c; transition: .2s;
  }
  .btn-purple:hover { background-color: #6a1b9a; border-color: #6a1b9a; color: #fff; }

  .btn-outline-purple {
    background: transparent; color: #4a148c;
    border: 1px solid #4a148c; transition: .2s;
  }
  .btn-outline-purple:hover { background-color: #4a148c; color: #fff; }

  .badge-purple {
    background-color: #4a148c; color: #fff;
  }
  .badge-purple-soft {
    background-color: rgba(74,20,140,.12);
    color: #4a148c; border: 1px solid rgba(74,20,140,.25);
  }

  /* Table header already purple via .bg-purple; keep numbers aligned */
  #previewTable td, #previewTable th { vertical-align: middle; }

#shipmentTable thead th * {
  pointer-events: auto !important;
}

</style>
{% endblock %}

