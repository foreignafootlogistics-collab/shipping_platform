{% extends 'layout_customer.html' %}
{% block title %}Authorized Pickup Person{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2>Authorized Pickup Person</h2>
  <p>You may authorize someone to collect your packages on your behalf. They must present a valid photo ID at pickup.</p>

  <!-- Button to show form -->
  <button id="addPersonBtn" class="btn btn-dashboard mb-3">âž• Add Authorized Person</button>

  <!-- Inline form table -->
  <div id="addPersonForm" style="display:none;">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Full Name</th>
          <th>Email</th>
          <th>Phone #</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="text" id="authFullName" class="form-control" placeholder="Full Name"></td>
          <td><input type="email" id="authEmail" class="form-control" placeholder="Email"></td>
          <td><input type="text" id="authPhone" class="form-control" placeholder="Phone #"></td>
        </tr>
      </tbody>
    </table>
    <button class="btn btn-success" id="saveAuthorizedPerson">Save</button>
    <button type="button" class="btn btn-danger" id="cancelAddPerson">Cancel</button>
  </div>

  <!-- Existing list -->
  <h4 class="mt-5">Currently Authorized Persons</h4>
  <table class="table table-striped" id="authorizedPickupList">
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Email</th>
        <th>Phone #</th>
      </tr>
    </thead>
    <tbody>
      {% for person in authorized_persons %}
      <tr>
        <td>{{ person.full_name }}</td>
        <td>{{ person.email }}</td>
        <td>{{ person.phone }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.getElementById("addPersonBtn").addEventListener("click", function() {
  document.getElementById("addPersonForm").style.display = "block";
  this.style.display = "none";
});
document.getElementById("cancelAddPerson").addEventListener("click", function() {
  document.getElementById("addPersonForm").style.display = "none";
  document.getElementById("addPersonBtn").style.display = "inline-block";
});
document.getElementById("saveAuthorizedPerson").addEventListener("click", function() {
  const full_name = document.getElementById("authFullName").value;
  const email = document.getElementById("authEmail").value;
  const phone = document.getElementById("authPhone").value;

  fetch("{{ url_for('customer.authorized_pickup_add') }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ full_name, email, phone })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      const table = document.querySelector("#authorizedPickupList tbody");
      const row = `<tr>
        <td>${data.person.full_name}</td>
        <td>${data.person.email}</td>
        <td>${data.person.phone}</td>
      </tr>`;
      table.insertAdjacentHTML("beforeend", row);
      document.getElementById("addPersonForm").style.display = "none";
      document.getElementById("addPersonBtn").style.display = "inline-block";
    }
  });
});
</script>
{% endblock %}
